<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Visionary Youth Group ‚Äî Member Dashboard</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
     <style>
    :root{
      --dark:#164e2a;
      --accent:#2e7d32;
      --gold:#ffcc00;
      --bg1:#e9ffec;
      --card:#ffffff;
      --muted:#6b7280;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:'Poppins',sans-serif;background:linear-gradient(120deg,var(--bg1),#f6fff6);color:#123;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }

    /* Top bar */
    .topbar{
      position:fixed;left:0;right:0;top:0;height:64px;background:linear-gradient(90deg,var(--dark),#26734d);color:#fff;
      display:flex;align-items:center;justify-content:space-between;padding:0 18px;z-index:1200;
      box-shadow:0 6px 20px rgba(6,50,20,0.12);
    }
    .brand{display:flex;align-items:center;gap:12px}
    .brand h1{font-size:1.05rem;margin:0;font-weight:700}
    .hamburger{font-size:1.6rem;cursor:pointer}
    .user-area{display:flex;align-items:center;gap:12px}
    .avatar-wrap{width:44px;height:44px;border-radius:8px;overflow:hidden;background:#fff;display:flex;align-items:center;justify-content:center}
    .avatar-wrap img{width:100%;height:100%;object-fit:cover;display:block}
    .user-info{text-align:right;font-size:0.95rem}
    .user-info small{display:block;color:rgba(255,255,255,0.85)}

    /* Menu overlay */
    .menu{
      position:fixed;top:64px;left:12px;background:rgba(255,255,255,0.98);max-width:320px;border-radius:8px;padding:8px;
      box-shadow:0 8px 30px rgba(0,0,0,0.12);display:none;z-index:1199;
    }
    .menu a{display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;color:#123;text-decoration:none}
    .menu a:hover{background:#f1fff1}

    /* Layout */
    .page{
      max-width:1200px;margin:92px auto 48px;padding:0 18px;
      display:grid;grid-template-columns:repeat(12,1fr);gap:18px;
    }

    /* Hero / summary */
    .hero{grid-column:span 12;background:var(--card);border-radius:12px;padding:16px;display:flex;justify-content:space-between;align-items:center;gap:16px;box-shadow:0 8px 20px rgba(6,50,20,0.03)}
    .welcome{display:flex;flex-direction:column}
    .welcome h2{margin:0;color:var(--dark)}
    .quick-actions{display:flex;gap:10px}

    /* cards */
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 8px 20px rgba(6,50,20,0.05);overflow:hidden}
    .balances-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px}
    .balance{background:linear-gradient(180deg,#f3fff3,#ffffff);padding:12px;border-radius:10px;text-align:center}
    .balance .label{color:var(--muted);font-size:0.95rem}
    .balance .value{font-weight:700;font-size:1.25rem;color:var(--accent);margin-top:8px}


    /* split grid */
    .big{grid-column:span 8}
    .side{grid-column:span 4}

    /* form */
    .form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .form-grid .full{grid-column:1/-1}
    input, select, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;font-size:0.95rem}
    textarea{min-height:100px;resize:vertical}
    .btn{background:var(--accent);color:white;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700}
    .btn.secondary{background:#fff;color:var(--accent);border:1px solid #e3f1e3}
    .muted{color:var(--muted)}

    /* small screens adjustments */
    @media (max-width:1000px){
      .big{grid-column:span 12}
      .side{grid-column:span 12}
      .form-grid{grid-template-columns:1fr}
      .menu{left:8px;right:8px;max-width:unset}
    }

    /* toast */
    #toast{position:fixed;right:18px;bottom:18px;background:#28a745;color:#fff;padding:10px 14px;border-radius:8px;display:none;z-index:2000}

    /* hidden sections toggle */
    .hidden-section{display:none}
    .visible-section{display:block}
    .section-head{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .small-note{font-size:12px;color:var(--muted)}

    /* responsive loan item */
    .loan-item{display:flex;justify-content:space-between;gap:12px;align-items:center;padding:12px;border-radius:8px;background:#fbfff9;margin-bottom:10px}
    .loan-item .left{flex:1}
    .loan-item .right{min-width:180px;text-align:right}
  </style>
</head>
<body>

  </style>
</head>
<body>

  <!-- Topbar -->
  <div class="topbar">
    <div class="brand">
      <div style="font-size:22px">üëÅÔ∏è</div>
      <h1>Visionary Youth Group</h1>
    </div>
    <div class="user-area">
      <div class="avatar-wrap" id="topAvatar" title="Profile photo"></div>
      <div class="user-info">
        <div id="topEmail">‚Äî</div>
        <small id="topStatus">Status: <strong style="color:#9ff2b8">Active</strong></small>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <button id="downloadStatementTop" title="Download Account Statement" class="btn secondary"><i class="fas fa-file-pdf"></i>&nbsp;Statement</button>
        <i class="fas fa-bars hamburger hamburgerAction" role="button" aria-label="Menu" style="font-size:20px;color:#fff;margin-left:6px"></i>
      </div>
    </div>
  </div>

  <!-- Menu -->
  <div class="menu" id="menu" aria-hidden="true">
    <a href="#" data-target="overview" class="menu-item"><i class="fas fa-home"></i> Overview</a>
    <a href="#" data-target="balancesCard" class="menu-item"><i class="fas fa-wallet"></i> Balances</a>
    <a href="#" id="menuMyLoans" class="menu-item"><i class="fas fa-money-bill-wave"></i> My Loans</a>
    <a href="#" id="menuSelfServe" class="menu-item"><i class="fas fa-tools"></i> Self Serve</a>
    <a href="#" id="menuProfile" class="menu-item"><i class="fas fa-user-edit"></i> Update Profile</a>
    <a href="#" data-target="withdraw-section" class="menu-item"><i class="fas fa-hand-holding-usd"></i> Withdrawals</a>
    <a href="#" id="menuLogout"><i class="fas fa-sign-out-alt"></i> Logout</a>
  </div>

  <!-- Main page -->
  <main class="page" id="pageRoot">
  <main class="page" id="pageRoot">     <!-- hero -->     <div class="hero card" id="overview">       <div class="welcome">         <h2 id="welcomeName">Welcome, Member</h2>         <div style="color:var(--muted);margin-top:6px">Quick snapshot ‚Äî all amounts shown in <strong>Ksh</strong></div>         <div style="margin-top:6px;font-size:0.9rem">Points: <strong id="pointsDisplay">0</strong></div>       </div>       <div class="quick-actions">         <button id="applyLoanBtnTop" class="btn"><i class="fas fa-file-signature"></i>&nbsp;Apply Loan</button>         <button id="quickStatement" class="btn secondary"><i class="fas fa-file-download"></i>&nbsp;Statement</button>       </div>     </div>      <!-- balances summary -->     <div class="card big" id="balancesCard">       <h2>Balances</h2>       <div class="balances-grid">         <div class="balance"><div class="label">Monthly Savings</div><div class="value" id="monthlyVal">Ksh 0</div></div>         <div class="balance"><div class="label">Weekly Savings</div><div class="value" id="weeklyVal">Ksh 0</div></div>         <div class="balance"><div class="label">Shares</div><div class="value" id="sharesVal">Ksh 0</div></div>         <div class="balance"><div class="label">Dividends</div><div class="value" id="dividendsVal">Ksh 0</div></div>         <div class="balance"><div class="label">Total Loans</div><div class="value" id="totalLoansVal">Ksh 0</div></div>         <div class="balance"><div class="label">Unpaid Balances</div><div class="value" id="unpaidVal">Ksh 0</div></div>         <div class="balance"><div class="label">Outstanding Loans</div><div class="value" id="outstandingLoansVal">Ksh 0</div></div>       </div>     </div>       <!-- right side: payments, notifications, profile -->     <aside class="card side">       <h3>Pay / Quick Actions</h3>        <!-- M-Pesa general payment -->       <div style="margin-top:8px">         <label class="muted">Pay via M-Pesa (General)</label>         <input id="mpesaPhone" placeholder="07XXXXXXXX" />         <input id="mpesaAmount" placeholder="Amount (Ksh)" type="number" />         <input id="mpesaAccount" placeholder="Account / Remarks (optional)" />         <div style="display:flex;gap:8px;margin-top:8px">           <button id="mpesaPayBtn" class="btn">Pay (M-Pesa)</button>           <button id="mpesaLogBtn" class="btn secondary">Log Payment</button>         </div>       </div>        <!-- notifications -->       <div style="margin-top:14px">         <h4 style="margin:0 0 8px 0">üîî Notifications</h4>         <div id="notifWrapper" style="max-height:220px;overflow:auto;border-radius:8px;padding:6px;background:#fbfff9">           <ul id="notifList" style="list-style:none;margin:0;padding:0">             <li>Loading notifications...</li>           </ul>         </div>         <div style="margin-top:8px;display:flex;gap:8px">           <button id="markAllRead" class="btn secondary">Mark all read</button>         </div>       </div>        <!-- points -->       <div style="margin-top:14px">         <h4 style="margin:0 0 6px 0">üéØ Points</h4>         <div id="pointsBox" style="padding:10px;background:#fff;border-radius:8px">           <div style="font-size:1.5rem;font-weight:700" id="pointsBoxValue">0</div>           <div class="muted" style="font-size:0.9rem">Member activity score</div>         </div>       </div>        <!-- small profile quick -->       <div style="margin-top:14px">         <h4 style="margin:0 0 6px 0">Profile</h4>         <div style="display:flex;gap:8px;align-items:center">           <div class="avatar-wrap" id="miniAvatar"></div>           <div>             <div id="miniName">‚Äî</div>             <small id="miniEmail" class="muted">‚Äî</small>           </div>         </div>         <div style="margin-top:8px;display:flex;gap:8px">           <button id="saveProfile" class="btn">Save profile</button>           <button id="choosePhotoBtn" class="btn secondary">Upload photo</button>           <input id="photoUploadInput" type="file" accept="image/*" style="display:none" />         </div>       </div>     </aside>       <!-- Self Serve (toggle) -->     <section class="card big hidden-section" id="selfServeSection">       <div class="section-head">         <h2>Self Serve</h2>         <div class="small-note">Download loan statements and quick tools</div>       </div>        <div style="margin-top:12px" id="selfServeContent">         <div style="margin-bottom:12px">           <button id="selfDownloadAllLoanStatements" class="btn secondary"><i class="fas fa-file-pdf"></i> Download All Loan Statements (PDF)</button>           <button id="selfRecentActivity" class="btn"><i class="fas fa-list"></i> Recent Activity</button>         </div>         <div id="selfServeList">Loading‚Ä¶</div>       </div>     </section>      <!-- Update Profile (toggle) -->     <section class="card side hidden-section" id="profileSection" style="padding-bottom:18px">       <div class="section-head">         <h2>Update Profile</h2>         <div class="small-note">Click Save to persist changes</div>       </div>        <form id="updateProfileForm" style="margin-top:12px">         <div class="form-grid">           <div>             <label class="small-note">Full Name</label>             <input id="profile_fullName" placeholder="Full name" />           </div>           <div>             <label class="small-note">Member No.</label>             <input id="profile_memberNo" placeholder="Member number" />           </div>           <div>             <label class="small-note">ID / Passport</label>             <input id="profile_id" placeholder="ID number" />           </div>           <div>             <label class="small-note">Email</label>             <input id="profile_email" placeholder="Email address" />           </div>           <div>             <label class="small-note">Phone</label>             <input id="profile_phone" placeholder="07XXXXXXXX" />           </div>           <div>             <label class="small-note">Date of Birth</label>             <input id="profile_dob" type="date" />           </div>           <div class="full">             <label class="small-note">Date Joined</label>             <input id="profile_yearJoined" type="date" />           </div>         </div>          <div style="margin-top:12px;display:flex;gap:8px">           <button id="saveProfileFormBtn" type="button" class="btn">Save</button>           <button id="cancelProfileBtn" type="button" class="btn secondary">Cancel</button>         </div>       </form>     </section>      <!-- Withdraw section placeholder (kept for your original flow) -->     <section id="withdraw-section" class="hidden-section card side">       <h3>Withdraw</h3>       <div class="muted">Withdraw interface (use your existing withdraw form here)</div>     </section>    </main>

  <div id="toast">Toast</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getDatabase, ref, onValue, get, push, set, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    const { jsPDF } = window.jspdf;

    const firebaseConfig = {
      apiKey: "AIzaSyA_OCu7HQ5HCH2OYx5dQ2Z1r7YPwQJave4",
      authDomain: "visionary-youth-grou-2024.firebaseapp.com",
      databaseURL: "https://visionary-youth-grou-2024-default-rtdb.firebaseio.com",
      projectId: "visionary-youth-grou-2024",
      storageBucket: "visionary-youth-grou-2024.appspot.com",
      messagingSenderId: "372978592717",
      appId: "1:372978592717:web:1c15aec728ee5f854f3284"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // UI refs
    const menu = document.getElementById('menu');
    const toast = document.getElementById('toast');
    const topEmail = document.getElementById('topEmail');
    const welcomeName = document.getElementById('welcomeName');
    const pointsDisplay = document.getElementById('pointsDisplay');
    const topAvatar = document.getElementById('topAvatar');
    const miniAvatar = document.getElementById('miniAvatar');
    const miniName = document.getElementById('miniName');
    const miniEmail = document.getElementById('miniEmail');

    const notifList = document.getElementById('notifList');
    const markAllReadBtn = document.getElementById('markAllRead');

    const mpesaPhone = document.getElementById('mpesaPhone');
    const mpesaAmount = document.getElementById('mpesaAmount');
    const mpesaAccount = document.getElementById('mpesaAccount');
    const mpesaPayBtn = document.getElementById('mpesaPayBtn');
    const mpesaLogBtn = document.getElementById('mpesaLogBtn');

    const choosePhotoBtn = document.getElementById('choosePhotoBtn');
    const photoInput = document.getElementById('photoUploadInput');
    const saveProfileBtn = document.getElementById('saveProfile');

    const myLoansSection = document.getElementById('myLoansSection');
    const myLoansList = document.getElementById('myLoansList');
    const selfServeSection = document.getElementById('selfServeSection');
    const selfServeList = document.getElementById('selfServeList');
    const profileSection = document.getElementById('profileSection');

    const applyLoanBtnTop = document.getElementById('applyLoanBtnTop');
    const selfDownloadAllLoanStatements = document.getElementById('selfDownloadAllLoanStatements');

    const saveProfileFormBtn = document.getElementById('saveProfileFormBtn');
    const cancelProfileBtn = document.getElementById('cancelProfileBtn');

    let currentUid = null;

    function showToast(msg,t=3000){ toast.textContent=msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none',t); }
    function formatKsh(n){ return 'Ksh '+(Number(n)||0).toLocaleString('en-KE'); }
    function safeText(s){ return String(s||''); }

    // ===== Menu toggle
    document.querySelectorAll('.hamburgerAction').forEach(h=> h.addEventListener('click',()=> menu.style.display = menu.style.display==='block'?'none':'block'));

    // ===== Toggle sections from menu
    document.getElementById('menuMyLoans').addEventListener('click', e=>{
      e.preventDefault();
      [myLoansSection,selfServeSection,profileSection].forEach(s=>s.classList.add('hidden-section'));
      myLoansSection.classList.remove('hidden-section');
      myLoansSection.classList.add('visible-section');
      menu.style.display='none';
      loadMemberLoans();
    });
    document.getElementById('menuSelfServe').addEventListener('click', e=>{
      e.preventDefault();
      [myLoansSection,selfServeSection,profileSection].forEach(s=>s.classList.add('hidden-section'));
      selfServeSection.classList.remove('hidden-section');
      selfServeSection.classList.add('visible-section');
      menu.style.display='none';
    });
    document.getElementById('menuProfile').addEventListener('click', e=>{
      e.preventDefault();
      [myLoansSection,selfServeSection,profileSection].forEach(s=>s.classList.add('hidden-section'));
      profileSection.classList.remove('hidden-section');
      profileSection.classList.add('visible-section');
      menu.style.display='none';
    });

    // ===== Auth state
    onAuthStateChanged(auth, async user=>{
      if(!user){ location.href='index.html'; return; }
      currentUid = user.uid;
      topEmail.textContent = user.email || '‚Äî';
      welcomeName.textContent = (user.displayName||user.email||'Member').split('@')[0];
      miniEmail.textContent = user.email||'‚Äî';

      // Profile
      onValue(ref(db, `members/${currentUid}/profile`), snap=>{
        if(!snap.exists()) return;
        const p = snap.val();
        if(p.name) { welcomeName.textContent=p.name; miniName.textContent=p.name; document.getElementById('profile_fullName') && (document.getElementById('profile_fullName').value=p.name);}
        if(p.phone) document.getElementById('profile_phone') && (document.getElementById('profile_phone').value=p.phone);
        if(p.id) document.getElementById('profile_id') && (document.getElementById('profile_id').value=p.id);
        if(p.yearJoined) document.getElementById('profile_yearJoined') && (document.getElementById('profile_yearJoined').value=p.yearJoined);
        if(p.dob) document.getElementById('profile_dob') && (document.getElementById('profile_dob').value=p.dob);
        if(p.status) document.getElementById('topStatus') && (document.getElementById('topStatus').innerHTML=`Status: <strong style="color:#9ff2b8">${p.status}</strong>`);
        if(p.memberNo) document.getElementById('profile_memberNo') && (document.getElementById('profile_memberNo').value=p.memberNo);
        if(p.email) document.getElementById('profile_email') && (document.getElementById('profile_email').value=p.email);
      });

      // Profile photo
      onValue(ref(db, `members/${currentUid}/photoURL`), snap=>{
        const url = snap.exists()?snap.val():null;
        if(url){ topAvatar.innerHTML=`<img src="${url}" alt="avatar">`; miniAvatar.innerHTML=topAvatar.innerHTML;}
        else { topAvatar.innerHTML=`<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:var(--dark)"><i class="fas fa-user"></i></div>`; miniAvatar.innerHTML=topAvatar.innerHTML;}
      });

      // Balances
      onValue(ref(db, `members/${currentUid}/savings/monthly`), s=>document.getElementById('monthlyVal').textContent=formatKsh(s.exists()?s.val():0));
      onValue(ref(db, `members/${currentUid}/savings/weekly`), s=>document.getElementById('weeklyVal').textContent=formatKsh(s.exists()?s.val():0));
      onValue(ref(db, `members/${currentUid}/shares/total`), s=>document.getElementById('sharesVal').textContent=formatKsh(s.exists()?s.val():0));
      onValue(ref(db, `members/${currentUid}/shares/dividends`), s=>document.getElementById('dividendsVal').textContent=formatKsh(s.exists()?s.val():0));
      onValue(ref(db, `members/${currentUid}/unpaidBalances`), s=>document.getElementById('unpaidVal').textContent=formatKsh(s.exists()?s.val():0));
      onValue(ref(db, `members/${currentUid}/loans/total`), s=>{ const val=s.exists()?s.val():{}; document.getElementById('totalLoansVal').textContent=formatKsh(val.total||0); });
      onValue(ref(db, `members/${currentUid}/outstandingLoans`), s=>document.getElementById('outstandingLoansVal').textContent=formatKsh(s.exists()?s.val():0));

      // Notifications
      onValue(ref(db, `members/${currentUid}/notifications`), snap=>{
        notifList.innerHTML='';
        if(!snap.exists()){ notifList.innerHTML='<li class="muted">No notifications</li>'; return;}
        Object.entries(snap.val()).sort((a,b)=>(b[1].ts||0)-(a[1].ts||0)).forEach(([id,n])=>{
          const li=document.createElement('li');
          li.style.padding='8px'; li.style.borderBottom='1px solid #eef6ee';
          li.innerHTML=`<div style="display:flex;justify-content:space-between;gap:8px">
            <div><strong style="color:${n.read?'#6b7280':'#146c2b'}">${safeText(n.title)}</strong><br>
            <small class="muted">${new Date(n.ts||Date.now()).toLocaleString()}</small>
            <div style="margin-top:6px">${safeText(n.message||'')}</div></div>
            <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
              <button class="btn secondary mark-read" data-id="${id}">${n.read?'Read':'Mark read'}</button>
            </div>
          </div>`;
          notifList.appendChild(li);
        });
        document.querySelectorAll('.mark-read').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const id=btn.dataset.id;
            if(!id) return;
            await update(ref(db, `members/${currentUid}/notifications/${id}`),{read:true});
            showToast('Marked read');
          });
        });
      });

      markAllReadBtn.addEventListener('click', async ()=>{
        const s = await get(ref(db, `members/${currentUid}/notifications`));
        if(!s.exists()) return showToast('No notifications');
        const updates={};
        Object.keys(s.val()).forEach(id=>updates[`members/${currentUid}/notifications/${id}/read`]=true);
        await update(ref(db), updates);
        showToast('All marked read');
      });

      // ===== M-Pesa, Photo, Profile Save etc. listeners
      mpesaPayBtn.addEventListener('click', async ()=>{
        if(!currentUid) return alert('Not signed in');
        const phone = mpesaPhone.value.trim();
        const amount = Number(mpesaAmount.value||0);
        if(!phone || !amount) return alert('Invalid input');
        showToast('STK Push requested');
      });
      mpesaLogBtn.addEventListener('click', async ()=>{
        showToast('Payment logged');
      });
      choosePhotoBtn.addEventListener('click', ()=>photoInput.click());
      photoInput.addEventListener('change', async ()=>{ showToast('Photo uploaded'); });
      saveProfileBtn.addEventListener('click', async ()=>{ showToast('Profile saved'); });
      saveProfileFormBtn.addEventListener('click', async ()=>{ showToast('Profile updated'); });
      cancelProfileBtn.addEventListener('click', ()=>{ profileSection.classList.add('hidden-section'); profileSection.classList.remove('visible-section'); });

    }); // end auth

    // ===== Load member loans
    async function loadMemberLoans(){
      myLoansList.innerHTML='Loading...';
    }

  </script>
</body>
</html>

