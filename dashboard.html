<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Visionary Youth Group — Dashboard</title>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  background: linear-gradient(120deg, #d6f5d6, #e6ffe6);
  color: #333;
}
header {
  background: #1b4332;
  color: #fff;
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.menu-toggle {
  font-size: 24px;
  cursor: pointer;
}
nav {
  display: none;
  flex-direction: column;
  background: #2d6a4f;
  position: absolute;
  top: 60px;
  right: 15px;
  border-radius: 8px;
  overflow: hidden;
  z-index: 10;
}
nav a {
  color: #fff;
  padding: 12px;
  text-decoration: none;
  border-bottom: 1px solid #3b7d61;
}
nav a:hover {
  background: #40916c;
}
.container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  padding: 20px;
}
.card {
  background: #fff;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.card h2 {
  margin-bottom: 15px;
  font-size: 20px;
  color: #1b4332;
}
.balance-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px,1fr));
  gap: 15px;
}
.balance-card {
  background: #e9f7ef;
  border-radius: 10px;
  padding: 12px;
  text-align: center;
  font-weight: 600;
}
.balance-card span {
  display: block;
  font-size: 18px;
  margin-top: 5px;
  color: #007200;
}
button {
  background: #1b4332;
  color: #fff;
  border: none;
  padding: 10px 18px;
  border-radius: 6px;
  cursor: pointer;
  transition: 0.3s;
}
button:hover { background: #40916c; }
input, select {
  width: 100%;
  padding: 8px;
  margin: 8px 0;
  border-radius: 6px;
  border: 1px solid #ccc;
}
.success-popup {
  display: none;
  position: fixed;
  top: 20px;
  right: 20px;
  background: #28a745;
  color: white;
  padding: 12px 18px;
  border-radius: 6px;
  z-index: 100;
}
</style>
</head>
<body>

<header>
  <h3>Dashboard — <span id="userEmail"></span></h3>
  <i class="fas fa-bars menu-toggle" onclick="toggleMenu()"></i>
  <nav id="menu">
    <a href="#balances" onclick="closeMenu()">Balances</a>
    <a href="#loans" onclick="closeMenu()">Loan Application</a>
    <a href="#profile" onclick="closeMenu()">Profile</a>
    <a href="#" onclick="logout()">Logout</a>
  </nav>
</header>

<div class="success-popup" id="successPopup">Profile Updated Successfully!</div>

<div class="container">

  <!-- Balances -->
  <div class="card" id="balances">
    <h2><i class="fas fa-wallet"></i> Financial Balances</h2>
    <div class="balance-grid">
      <div class="balance-card">Weekly <span id="weekly">0</span></div>
      <div class="balance-card">Monthly <span id="monthly">0</span></div>
      <div class="balance-card">Loans <span id="loansBal">0</span></div>
      <div class="balance-card">Shares <span id="shares">0</span></div>
      <div class="balance-card">Dividends <span id="dividends">0</span></div>
      <div class="balance-card">Unpaid <span id="unpaid">0</span></div>
    </div>
  </div>

  <!-- Loan Application -->
  <div class="card" id="loans">
    <h2><i class="fas fa-file-signature"></i> Loan Application</h2>
    <form id="loanForm">
      <input type="text" placeholder="Full Name" id="loanName" required>
      <input type="text" placeholder="Membership Number" id="loanMemberNo" required>
      <input type="text" placeholder="National ID/Passport" id="loanId" required>
      <input type="number" placeholder="Amount Requested (Ksh)" id="loanAmount" required>
      <input type="text" placeholder="Purpose of Loan" id="loanPurpose" required>
      <input type="number" placeholder="Repayable in (months)" id="loanPeriod" required>
      <button type="submit">Submit & Download PDF</button>
    </form>
  </div>

  <!-- Update Profile -->
  <div class="card" id="profile">
    <h2><i class="fas fa-user-edit"></i> Update Profile</h2>
    <form id="profileForm">
      <input type="text" placeholder="Full Name" id="pname" required>
      <input type="text" placeholder="Phone" id="pphone" required>
      <input type="text" placeholder="ID Number" id="pid" required>
      <input type="number" placeholder="Year Joined" id="pyear" required>
      <input type="date" placeholder="Date of Birth" id="pdob" required>
      <button type="submit">Update</button>
    </form>
    <br>
    <button onclick="downloadStatement()"><i class="fas fa-file-pdf"></i> Account Statement</button>
  </div>
</div>

<!-- Firebase + jsPDF -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getDatabase, ref, get, set, push } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA_OCu7HQ5HCH2OYx5dQ2Z1r7YPwQJave4",
  authDomain: "visionary-youth-grou-2024.firebaseapp.com",
  projectId: "visionary-youth-grou-2024",
  storageBucket: "visionary-youth-grou-2024.appspot.com",
  messagingSenderId: "372978592717",
  appId: "1:372978592717:web:1c15aec728ee5f854f3284",
  databaseURL: "https://visionary-youth-grou-2024-default-rtdb.firebaseio.com/"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// Show user
onAuthStateChanged(auth, user=>{
  if(user){
    document.getElementById('userEmail').innerText = user.email;
    loadBalances(user.uid);
    autoLogout();
  } else {
    window.location.href="index.html";
  }
});

// Load balances
function loadBalances(uid){
  get(ref(db,"members/"+uid+"/balances")).then(snap=>{
    if(snap.exists()){
      let d = snap.val();
      document.getElementById("weekly").innerText=d.weekly||0;
      document.getElementById("monthly").innerText=d.monthly||0;
      document.getElementById("loansBal").innerText=d.loans||0;
      document.getElementById("shares").innerText=d.shares||0;
      document.getElementById("dividends").innerText=d.dividends||0;
      document.getElementById("unpaid").innerText=d.unpaid||0;
    }
  })
}

// Loan form
document.getElementById("loanForm").addEventListener("submit",e=>{
  e.preventDefault();
  let uid = auth.currentUser.uid;
  let loanData = {
    name: loanName.value,
    memberNo: loanMemberNo.value,
    id: loanId.value,
    amount: loanAmount.value,
    purpose: loanPurpose.value,
    period: loanPeriod.value,
    timestamp: Date.now()
  };
  push(ref(db,"members/"+uid+"/loans"),loanData);
  generateLoanPDF(loanData);
});

// Loan PDF
function generateLoanPDF(loan){
  const { jsPDF } = window.jspdf;
  let doc = new jsPDF();
  doc.setFontSize(14);
  doc.text("LOAN APPLICATION FORM",20,20);
  doc.text("Name: "+loan.name,20,40);
  doc.text("Member No: "+loan.memberNo,20,50);
  doc.text("ID: "+loan.id,20,60);
  doc.text("Amount: Ksh "+loan.amount,20,70);
  doc.text("Purpose: "+loan.purpose,20,80);
  doc.text("Period: "+loan.period+" months",20,90);
  doc.save("Loan_Application.pdf");
}

// Account statement PDF
function downloadStatement(){
  const { jsPDF } = window.jspdf;
  let doc = new jsPDF();
  doc.setFontSize(16);
  doc.text("Account Statement", 20,20);
  doc.text("Weekly: "+weekly.innerText+" Ksh",20,40);
  doc.text("Monthly: "+monthly.innerText+" Ksh",20,50);
  doc.text("Loans: "+loansBal.innerText+" Ksh",20,60);
  doc.text("Shares: "+shares.innerText+" Ksh",20,70);
  doc.text("Dividends: "+dividends.innerText+" Ksh",20,80);
  doc.text("Unpaid: "+unpaid.innerText+" Ksh",20,90);
  doc.save("Account_Statement.pdf");
}

// Profile Update
document.getElementById("profileForm").addEventListener("submit",e=>{
  e.preventDefault();
  let uid = auth.currentUser.uid;
  set(ref(db,"members/"+uid+"/profile"),{
    name: pname.value,
    phone: pphone.value,
    id: pid.value,
    year: pyear.value,
    dob: pdob.value
  });
  successPopup.style.display="block";
  setTimeout(()=>{successPopup.style.display="none";},3000);
});

// Menu toggle
function toggleMenu(){
  let menu = document.getElementById("menu");
  menu.style.display = menu.style.display==="flex"?"none":"flex";
}
function closeMenu(){ document.getElementById("menu").style.display="none"; }

// Logout
function logout(){ signOut(auth); }

// Auto logout
let timer;
function autoLogout(){
  resetTimer();
  window.onmousemove=resetTimer;
  window.onkeydown=resetTimer;
}
function resetTimer(){
  clearTimeout(timer);
  timer=setTimeout(()=>logout(),180000); // 3 mins
}
</script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</body>
</html>
