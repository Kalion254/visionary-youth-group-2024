<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Visionary Youth Group — Dashboard</title>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  background: #e6f9e6;
  color: #333;
}
header {
  background: #222;
  color: #fff;
  padding: 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.menu-toggle {
  font-size: 22px;
  cursor: pointer;
}
nav {
  display: none;
  flex-direction: column;
  background: #333;
  position: absolute;
  top: 60px;
  right: 10px;
  border-radius: 8px;
  overflow: hidden;
}
nav a {
  color: #fff;
  padding: 12px;
  text-decoration: none;
  border-bottom: 1px solid #444;
}
nav a:hover {
  background: #444;
  color: #ffcc00;
}
section {
  padding: 25px;
  margin: 20px;
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}
h2 {
  margin-bottom: 15px;
  color: #007bff;
}
button {
  background: #333;
  color: #ffcc00;
  border: none;
  padding: 10px 18px;
  border-radius: 6px;
  cursor: pointer;
  transition: 0.3s;
}
button:hover { background: #555; color: #ff6600; }
input, textarea {
  width: 100%;
  padding: 8px;
  margin: 8px 0;
  border-radius: 6px;
  border: 1px solid #ccc;
}
.success-popup {
  display: none;
  position: fixed;
  top: 20px;
  right: 20px;
  background: #28a745;
  color: white;
  padding: 12px 18px;
  border-radius: 6px;
  z-index: 100;
}
</style>
</head>
<body>

<header>
  <h3>Dashboard — <span id="userEmail"></span> (<span id="memberStatus">Active</span>)</h3>
  <i class="fas fa-bars menu-toggle" onclick="toggleMenu()"></i>
  <nav id="menu">
    <a href="#balances">Balances</a>
    <a href="#loans">Loan Application</a>
    <a href="#statement">Account Statement</a>
    <a href="#profile">Update Profile</a>
    <a href="#" onclick="logout()">Logout</a>
  </nav>
</header>

<div class="success-popup" id="successPopup">Profile Updated Successfully!</div>

<!-- Balances -->
<section id="balances">
  <h2><i class="fas fa-wallet"></i> Financial Balances (Ksh)</h2>
  <p>Weekly Savings: <strong id="weekly">0</strong></p>
  <p>Monthly Savings: <strong id="monthly">0</strong></p>
  <p>Loans: <strong id="loansBal">0</strong></p>
  <p>Shares: <strong id="shares">0</strong></p>
  <p>Dividends: <strong id="dividends">0</strong></p>
  <p>Unpaid Balances: <strong id="unpaid">0</strong></p>
</section>

<!-- Loan Application -->
<section id="loans">
  <h2><i class="fas fa-file-signature"></i> Loan Application</h2>
  <form id="loanForm">
    <h3>Applicant Information</h3>
    <input type="text" placeholder="Full Name" id="loanName" required>
    <input type="text" placeholder="Membership Number" id="loanMemberNo" required>
    <input type="text" placeholder="National ID/Passport" id="loanId" required>
    <input type="text" placeholder="Marital Status" required>
    <input type="date" placeholder="Date of Birth" required>
    <input type="text" placeholder="Phone" required>
    <input type="email" placeholder="Email" required>
    <textarea placeholder="Current Address" required></textarea>

    <h3>Employment Information</h3>
    <input type="text" placeholder="Employer" required>
    <input type="text" placeholder="Position" required>
    <input type="number" placeholder="Monthly Income" required>

    <h3>Other Income Sources</h3>
    <input type="text" placeholder="Income Source 1">
    <input type="text" placeholder="Income Source 2">

    <h3>Loan Details</h3>
    <input type="number" placeholder="Amount Requested (Ksh)" id="loanAmount" required>
    <input type="text" placeholder="Purpose of Loan" required>
    <input type="number" placeholder="Repayable in (months)" required>

    <h3>Other Loans/Debts</h3>
    <input type="text" placeholder="Institution / Amount">
    
    <button type="submit">Submit & Download PDF</button>
  </form>
</section>

<!-- Account Statement -->
<section id="statement">
  <h2><i class="fas fa-file-pdf"></i> Account Statement</h2>
  <button onclick="downloadStatement()">Download Statement (PDF)</button>
</section>

<!-- Update Profile -->
<section id="profile">
  <h2><i class="fas fa-user-edit"></i> Update Profile</h2>
  <form id="profileForm">
    <input type="text" placeholder="Full Name" required>
    <input type="text" placeholder="Phone" required>
    <button type="submit">Update</button>
  </form>
</section>

<!-- Firebase + jsPDF -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getDatabase, ref, get, set, push } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA_OCu7HQ5HCH2OYx5dQ2Z1r7YPwQJave4",
  authDomain: "visionary-youth-grou-2024.firebaseapp.com",
  projectId: "visionary-youth-grou-2024",
  storageBucket: "visionary-youth-grou-2024.appspot.com",
  messagingSenderId: "372978592717",
  appId: "1:372978592717:web:1c15aec728ee5f854f3284",
  databaseURL: "https://visionary-youth-grou-2024-default-rtdb.firebaseio.com/"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// Show user
onAuthStateChanged(auth, user=>{
  if(user){
    document.getElementById('userEmail').innerText = user.email;
    loadBalances(user.uid);
    autoLogout();
  } else {
    window.location.href="index.html";
  }
});

// Load balances
function loadBalances(uid){
  get(ref(db,"members/"+uid+"/balances")).then(snap=>{
    if(snap.exists()){
      let data = snap.val();
      document.getElementById("weekly").innerText=data.weekly||0;
      document.getElementById("monthly").innerText=data.monthly||0;
      document.getElementById("loansBal").innerText=data.loans||0;
      document.getElementById("shares").innerText=data.shares||0;
      document.getElementById("dividends").innerText=data.dividends||0;
      document.getElementById("unpaid").innerText=data.unpaid||0;
    }
  })
}

// Loan form
document.getElementById("loanForm").addEventListener("submit",e=>{
  e.preventDefault();
  let uid = auth.currentUser.uid;
  let loanData = {
    name: document.getElementById("loanName").value,
    memberNo: document.getElementById("loanMemberNo").value,
    id: document.getElementById("loanId").value,
    amount: document.getElementById("loanAmount").value,
    purpose: e.target.querySelector("input[placeholder='Purpose of Loan']").value,
    timestamp: Date.now()
  };
  push(ref(db,"members/"+uid+"/loans"),loanData);
  generateLoanPDF(loanData);
});

// PDF Loan Application
function generateLoanPDF(loan){
  const { jsPDF } = window.jspdf;
  let doc = new jsPDF();
  doc.setFontSize(14);
  doc.text("ARCHDIOCESE OF NAIROBI",20,20);
  doc.text("LOAN APPLICATION FORM",20,30);
  doc.text("Name: "+loan.name,20,50);
  doc.text("Member No: "+loan.memberNo,20,60);
  doc.text("ID: "+loan.id,20,70);
  doc.text("Amount: Ksh "+loan.amount,20,80);
  doc.text("Purpose: "+loan.purpose,20,90);
  doc.text("Signature: _____________   Date: ____________",20,110);
  doc.save("Loan_Application.pdf");
}

// Account statement PDF
function downloadStatement(){
  const { jsPDF } = window.jspdf;
  let doc = new jsPDF();
  doc.setFontSize(16);
  doc.text("Account Statement", 20,20);
  doc.text("Weekly: "+document.getElementById("weekly").innerText+" Ksh",20,40);
  doc.text("Monthly: "+document.getElementById("monthly").innerText+" Ksh",20,50);
  doc.text("Loans: "+document.getElementById("loansBal").innerText+" Ksh",20,60);
  doc.text("Shares: "+document.getElementById("shares").innerText+" Ksh",20,70);
  doc.text("Dividends: "+document.getElementById("dividends").innerText+" Ksh",20,80);
  doc.text("Unpaid: "+document.getElementById("unpaid").innerText+" Ksh",20,90);
  doc.save("Account_Statement.pdf");
}

// Profile Update
document.getElementById("profileForm").addEventListener("submit",e=>{
  e.preventDefault();
  let uid = auth.currentUser.uid;
  set(ref(db,"members/"+uid+"/profile"),{
    name: e.target[0].value,
    phone: e.target[1].value
  });
  document.getElementById("successPopup").style.display="block";
  setTimeout(()=>{document.getElementById("successPopup").style.display="none";},3000);
});

// Menu toggle
function toggleMenu(){
  let menu = document.getElementById("menu");
  menu.style.display = menu.style.display==="flex"?"none":"flex";
}

// Logout
function logout(){
  signOut(auth);
}

// Auto logout
let timer;
function autoLogout(){
  resetTimer();
  window.onmousemove=resetTimer;
  window.onkeydown=resetTimer;
}
function resetTimer(){
  clearTimeout(timer);
  timer=setTimeout(()=>logout(),180000); // 3 mins
}
</script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</body>
</html>
