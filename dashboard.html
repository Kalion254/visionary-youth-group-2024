<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Visionary Youth Group — Member Dashboard</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- AOS (animations) -->
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    :root{
      --primary:#164e2a;
      --accent:#2e7d32;
      --gold:#ffcc00;
      --bg1:#e9ffec;
      --card:#ffffff;
      --muted:#6b7280;
      --glass-border: rgba(6,50,20,0.06);
      --radius:14px;
      --shadow: 0 10px 30px rgba(2,48,22,0.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:'Poppins',sans-serif;background:linear-gradient(135deg,var(--bg1),#f6fff6);color:#122;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }

    /* Topbar */
    .topbar{
      position:fixed;left:0;right:0;top:0;height:72px;background:linear-gradient(90deg,var(--primary),#26734d);
      color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 20px;z-index:1200;box-shadow:0 12px 40px rgba(2,48,22,0.12);
    }
    .brand{display:flex;gap:12px;align-items:center}
    .brand h1{margin:0;font-size:1rem}
    .user-area{display:flex;gap:12px;align-items:center}

    /* Layout */
    .layout{display:flex;gap:18px;min-height:100vh;padding-top:92px;padding-left:18px;padding-right:18px}
    aside.sidebar{
      width:72px;border-radius:12px;background:linear-gradient(180deg,#fff,#f6fff6);padding:10px;box-shadow:var(--shadow);
      display:flex;flex-direction:column;gap:8px;align-items:center;position:fixed;left:18px;top:84px;bottom:24px;z-index:1000;
    }
    .sidebar .btnIcon{width:48px;height:48px;border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid var(--glass-border);background:#fff}
    .sidebar .btnIcon.active{background:var(--primary);color:#fff}
    main.page{flex:1;margin-left:110px;max-width:1200px;margin-right:18px}

    .card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow);margin-bottom:18px}
    h2{margin:0;color:var(--primary);font-size:1.05rem}
    .muted{color:var(--muted)}

    /* Hero / balances */
    .hero{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:18px}
    .balancesGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-top:12px}
    .balance{padding:12px;border-radius:10px;background:linear-gradient(180deg,#f7fff8,#fff);border:1px solid var(--glass-border)}
    .balance .label{color:var(--muted);font-size:0.9rem}
    .balance .value{font-weight:800;font-size:1.2rem;color:var(--accent);margin-top:6px}

    /* action bar */
    .action-bar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;padding:12px;border-radius:12px;background:linear-gradient(90deg,#fff,#f6fff6);border:1px solid var(--glass-border)}
    .action-item{flex:1;min-width:120px}

    /* wizard */
    .wizard{margin-top:8px}
    .wizard-steps{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
    .wizard-step{padding:8px;border-radius:8px;background:#f5fff5;color:var(--muted);font-weight:700}
    .wizard-step.active{background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff}

    .wizard-panel{display:none;animation:fadeIn .28s}
    .wizard-panel.active{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

    /* table */
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px;border-bottom:1px solid #edf7ee;text-align:left;font-size:0.95rem}
    th{color:var(--muted);font-weight:700}

    /* downloads */
    .downloads{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
    .download-card{padding:12px;border-radius:10px;border:1px solid var(--glass-border);display:flex;flex-direction:column;gap:8px}

    /* responsive */
    @media (max-width:1000px){
      aside.sidebar{display:none}
      main.page{margin-left:0}
    }
    @media (max-width:600px){
      .hero{flex-direction:column;align-items:flex-start}
      .action-bar{flex-direction:column}
    }

    /* small helpers */
    .btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid var(--glass-border);color:var(--primary)}
    .small{font-size:0.9rem}
    .toast{position:fixed;right:18px;bottom:18px;background:var(--primary);color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:2200}
    input,select,textarea{padding:10px;border-radius:8px;border:1px solid #e6f3ea;font-size:0.95rem;width:100%}
  </style>
</head>
<body>

  <!-- topbar -->
  <div class="topbar">
    <div class="brand">
      <i class="fas fa-seedling" style="font-size:1.25rem;color:var(--gold)"></i>
      <div>
        <h1>Visionary Youth Group</h1>
        <div style="font-size:0.85rem;color:rgba(255,255,255,0.9)">Member Portal</div>
      </div>
    </div>

    <div class="user-area">
      <div id="agmInfo" style="font-size:0.92rem;color:rgba(255,255,255,0.95)">AGM: <span id="agmCountdown">—</span></div>
      <button class="btn ghost" id="downloadsToggle"><i class="fas fa-download"></i>&nbsp;Downloads</button>
      <div id="topAvatar" style="width:44px;height:44px;border-radius:8px;background:#fff;display:flex;align-items:center;justify-content:center;overflow:hidden">
        <i class="fas fa-user" style="color:var(--primary)"></i>
      </div>
    </div>
  </div>

  <div class="layout">
    <!-- sidebar -->
    <aside class="sidebar" aria-hidden="false">
      <div class="btnIcon active" data-target="overview" title="Overview"><i class="fas fa-home"></i></div>
      <div class="btnIcon" data-target="balances" title="Balances"><i class="fas fa-wallet"></i></div>
      <div class="btnIcon" data-target="loan-section" title="Loans"><i class="fas fa-file-signature"></i></div>
      <div class="btnIcon" data-target="withdraw-section" title="Withdraw"><i class="fas fa-hand-holding-usd"></i></div>
      <div class="btnIcon" data-target="downloadsSection" title="Downloads"><i class="fas fa-download"></i></div>
      <div class="btnIcon" data-target="profile-area" title="Profile"><i class="fas fa-user-edit"></i></div>
    </aside>

    <!-- main page -->
    <main class="page">

      <!-- OVERVIEW HERO -->
      <section id="overview" class="card hero" data-aos="fade-up">
        <div>
          <div style="display:flex;gap:10px;align-items:center">
            <div id="welcomeName" style="font-weight:800;font-size:1.05rem">Welcome, Member</div>
            <div id="memberStatus" style="padding:6px 10px;border-radius:8px;background:#f0fff4;color:var(--primary);font-weight:700">Active</div>
          </div>
          <div style="margin-top:6px;color:var(--muted)">Snapshot — amounts in <strong>Ksh</strong></div>
          <div style="margin-top:8px;font-size:0.95rem">Points: <strong id="pointsDisplay">0</strong> • <span id="memberSince" class="muted">Joined: —</span></div>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn" id="openLoanWizardBtn"><i class="fas fa-file-signature"></i>&nbsp;Apply Loan</button>
          <button class="btn ghost" id="downloadStatementQuick"><i class="fas fa-file-pdf"></i>&nbsp;Statement</button>
        </div>
      </section>

      <!-- BALANCES -->
      <section id="balances" class="card" data-aos="fade-up">
        <h2>Balances & Accounts</h2>
        <div class="balancesGrid" style="margin-top:12px">
          <div class="balance"><div class="label">Monthly Savings</div><div class="value" id="monthlyVal">Ksh 0</div></div>
          <div class="balance"><div class="label">Weekly Savings</div><div class="value" id="weeklyVal">Ksh 0</div></div>
          <div class="balance"><div class="label">Shares</div><div class="value" id="sharesVal">Ksh 0</div></div>
          <div class="balance"><div class="label">Dividends</div><div class="value" id="dividendsVal">Ksh 0</div></div>
          <div class="balance"><div class="label">Total Loans</div><div class="value" id="totalLoansVal">Ksh 0</div></div>
          <div class="balance"><div class="label">Outstanding</div><div class="value" id="outstandingLoansVal">Ksh 0</div></div>
        </div>
      </section>

      <!-- ACTION BAR -->
      <section class="card action-bar" data-aos="fade-up">
        <div class="action-item">
          <div class="small">Next Installment</div>
          <div id="nextInstallment" style="font-weight:700">Ksh 0</div>
          <div id="nextInstallmentDate" class="muted small">—</div>
        </div>
        <div class="action-item">
          <div class="small">Loan Stage</div>
          <div id="loanStage" style="font-weight:700">—</div>
        </div>
        <div class="action-item">
          <div class="small">Interest</div>
          <div id="loanInterest" style="font-weight:700">—</div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn" id="mpesaPayBtn"><i class="fas fa-money-bill-wave"></i>&nbsp;Pay (M-Pesa)</button>
          <button class="btn ghost" id="manageLoanBtn">Manage Loan</button>
        </div>
      </section>

      <!-- ACTIVITY & TRANSACTIONS -->
      <section class="card" data-aos="fade-up">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2>Recent Activity & Transactions</h2>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="actFilter" style="padding:8px;border-radius:8px;border:1px solid var(--glass-border)">
              <option value="all">All</option><option value="loan">Loans</option><option value="deposit">Deposits</option><option value="withdraw">Withdrawals</option>
            </select>
            <button class="btn ghost" id="refreshActivity">Refresh</button>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 360px;gap:12px;margin-top:12px">
          <div>
            <ul id="activityList" class="muted" style="margin:0;padding-left:12px"></ul>
            <div style="margin-top:12px">
              <h3 class="small">Transaction History</h3>
              <div style="overflow:auto;margin-top:8px">
                <table id="txTable">
                  <thead><tr><th>Date</th><th>Desc</th><th>Debit</th><th>Credit</th><th>Balance</th></tr></thead>
                  <tbody id="txBody"><tr><td colspan="5" class="muted">Loading transactions…</td></tr></tbody>
                </table>
              </div>
              <div style="margin-top:8px;display:flex;gap:8px">
                <button class="btn ghost" id="downloadTxPdf">Download PDF</button>
                <button class="btn" id="refreshTx">Refresh</button>
              </div>
            </div>
          </div>

          <aside>
            <div class="card" style="margin-bottom:12px">
              <h3 class="small">Notifications</h3>
              <div id="notificationsList" style="max-height:220px;overflow:auto;padding-top:8px">
                <div class="muted">Loading...</div>
              </div>
            </div>

            <div class="card">
              <h3 class="small">Downloads</h3>
              <div style="display:flex;gap:8px;margin-bottom:8px">
                <button class="btn ghost" id="uploadFileBtn"><i class="fas fa-upload"></i>&nbsp;Upload</button>
                <button class="btn" id="refreshDownloadsBtn">Refresh</button>
              </div>
              <div id="downloadsList" class="downloads"><div class="muted">Loading files…</div></div>
            </div>
          </aside>
        </div>
      </section>

      <!-- LOAN WIZARD (hidden by default) -->
      <section id="loan-section" class="card" data-aos="fade-up">
        <h2>Loan Application — Wizard</h2>
        <div class="wizard">
          <div class="wizard-steps" id="loanWizardSteps">
            <div class="wizard-step active" data-step="1">1. Applicant</div>
            <div class="wizard-step" data-step="2">2. Employment</div>
            <div class="wizard-step" data-step="3">3. Loan</div>
            <div class="wizard-step" data-step="4">4. Guarantors</div>
            <div class="wizard-step" data-step="5">5. Confirm</div>
          </div>

          <form id="loanWizardForm">
            <div class="wizard-panel active" data-step="1">
              <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
                <input name="selfHelpGroup" placeholder="Self-help group">
                <input name="memberName" placeholder="Full name" required>
                <input name="membershipNumber" placeholder="Membership No">
                <input name="nationalId" placeholder="National ID / Passport">
                <input name="dob" type="date">
                <input name="phone" placeholder="Phone" required>
                <input name="email" type="email" placeholder="Email">
              </div>
              <div style="margin-top:10px;display:flex;gap:8px">
                <button type="button" class="btn ghost" data-action="next">Next</button>
              </div>
            </div>

            <div class="wizard-panel" data-step="2">
              <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
                <input name="employer" placeholder="Employer / Business">
                <input name="position" placeholder="Position">
                <input name="periodEmployment" placeholder="Period in months/years">
                <input name="monthlyIncome" placeholder="Monthly income (Ksh)" required>
                <input name="income1" placeholder="Other income 1">
                <input name="income2" placeholder="Other income 2">
              </div>
              <div style="margin-top:10px;display:flex;gap:8px">
                <button type="button" class="btn ghost" data-action="prev">Prev</button>
                <button type="button" class="btn" data-action="next">Next</button>
              </div>
            </div>

            <div class="wizard-panel" data-step="3">
              <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
                <input name="amountFigures" placeholder="Amount (Ksh)" required>
                <input name="amountWords" placeholder="Amount in words" required>
                <input name="purpose" placeholder="Purpose" required>
                <input name="repayableMonths" placeholder="Repayable (months)" required>
              </div>
              <div style="margin-top:10px;display:flex;gap:8px">
                <button type="button" class="btn ghost" data-action="prev">Prev</button>
                <button type="button" class="btn" data-action="next">Next</button>
              </div>
            </div>

            <div class="wizard-panel" data-step="4">
              <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
                <input name="g_mno_1" placeholder="G1 MNo">
                <input name="g_name_1" placeholder="G1 Name">
                <input name="g_phone_1" placeholder="G1 Phone">
                <input name="g_amount_1" placeholder="G1 Amount">
                <input name="g_mno_2" placeholder="G2 MNo">
                <input name="g_name_2" placeholder="G2 Name">
                <input name="g_phone_2" placeholder="G2 Phone">
                <input name="g_amount_2" placeholder="G2 Amount">
                <input name="g_mno_3" placeholder="G3 MNo">
                <input name="g_name_3" placeholder="G3 Name">
                <input name="g_phone_3" placeholder="G3 Phone">
                <input name="g_amount_3" placeholder="G3 Amount">
              </div>
              <div style="margin-top:10px;display:flex;gap:8px">
                <button type="button" class="btn ghost" data-action="prev">Prev</button>
                <button type="button" class="btn" data-action="next">Next</button>
              </div>
            </div>

            <div class="wizard-panel" data-step="5">
              <div class="muted">Please confirm all details are correct. Submitting will save the application to the RTDB and generate a PDF for your records.</div>
              <div style="margin-top:10px;display:flex;align-items:center;gap:8px">
                <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="loanAgree" required> I agree to the terms</label>
                <div style="margin-left:auto;display:flex;gap:8px">
                  <button type="button" class="btn ghost" data-action="prev">Prev</button>
                  <button type="submit" class="btn" id="submitLoanWizard">Submit Application</button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </section>

      <!-- WITHDRAWAL WIZARD -->
      <section id="withdraw-section" class="card" data-aos="fade-up">
        <h2>Voluntary Withdrawable Savings (Wizard)</h2>
        <form id="withdrawForm" style="display:grid;gap:8px">
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
            <input name="w_memberName" placeholder="Member Name" required>
            <input name="w_membershipNumber" placeholder="Membership Number" required>
            <input name="w_idNumber" placeholder="ID / Passport" required>
            <input name="w_phone" placeholder="Phone" required>
            <input name="w_amountFigures" placeholder="Amount (Ksh)" required>
            <input name="w_amountWords" placeholder="Amount in words" required>
            <input name="w_reason" placeholder="Reason for withdrawal" class="full" style="grid-column:1/ -1">
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn" type="submit">Submit & Download PDF</button>
            <button type="button" class="btn ghost" id="previewWithdraw">Preview PDF</button>
          </div>
        </form>
      </section>

      <!-- PROFILE -->
      <section id="profile-area" class="card" data-aos="fade-up">
        <h2>Update Profile</h2>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px;margin-top:8px">
          <input id="pf_fullName" placeholder="Full name">
          <input id="pf_phone" placeholder="Phone">
          <input id="pf_id" placeholder="ID Number">
          <input id="pf_yearJoined" placeholder="Year Joined">
          <input id="pf_dob" type="date" placeholder="Date of Birth">
        </div>
        <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
          <input type="file" id="photoInput" accept="image/*" style="display:none">
          <button class="btn ghost" id="choosePhotoBtn"><i class="fas fa-camera"></i>&nbsp;Upload Photo</button>
          <button class="btn" id="saveProfileBtn">Save Profile</button>
        </div>
        <div class="muted small" style="margin-top:8px">Profile info saved to Realtime Database; photos go to Storage.</div>
      </section>

      <!-- RECOMMENDATIONS & INTERACTIVITY -->
      <section class="card" data-aos="fade-up">
        <h2>Interactive Suggestions</h2>
        <ul>
          <li class="muted">Add two-factor login for stronger security (Auth + SMS)</li>
          <li class="muted">Enable auto STK callbacks on backend to reconcile M-Pesa payments</li>
          <li class="muted">Add filtering / export on transactions with date ranges</li>
          <li class="muted">Add admin approval flows (applications → approved/disbursed) with role-based rules</li>
          <li class="muted">Add receipts storage and allow members to upload proof documents</li>
        </ul>
      </section>

    </main>
  </div>

  <div id="toast" class="toast"></div>

  <!-- SCRIPTS -->
  <script type="module">
    // Run after DOM loads
    window.addEventListener('DOMContentLoaded', async () => {
      // Firebase modular imports
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      import { getDatabase, ref, onValue, get, push, set, update, child } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
      import { getStorage, ref as sRef, uploadBytes, getDownloadURL, listAll } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

      const { jsPDF } = window.jspdf;

      // ----------------- CONFIG -----------------
      // Using the config you pasted earlier. Replace these values with your own if needed.
      const firebaseConfig = {
        apiKey: "AIzaSyA_OCu7HQ5HCH2OYx5dQ2Z1r7YPwQJave4",
        authDomain: "visionary-youth-grou-2024.firebaseapp.com",
        databaseURL: "https://visionary-youth-grou-2024-default-rtdb.firebaseio.com",
        projectId: "visionary-youth-grou-2024",
        storageBucket: "visionary-youth-grou-2024.appspot.com",
        messagingSenderId: "372978592717",
        appId: "1:372978592717:web:1c15aec728ee5f854f3284"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getDatabase(app);
      const storage = getStorage(app);

      // ----------------- HELPERS -----------------
      const toastEl = document.getElementById('toast');
      function showToast(msg, t=3000){ toastEl.textContent = msg; toastEl.style.display='block'; setTimeout(()=> toastEl.style.display='none', t); }
      function formatKsh(n){ const num = Number(n||0); return 'Ksh ' + num.toLocaleString('en-KE'); }
      function safe(id){ return document.getElementById(id) || null; }
      function confettiBurst(){ try{ confetti({particleCount:40,spread:80}); }catch(e){} }

      // ----------------- UI WIRING -----------------
      // Sidebar navigation
      document.querySelectorAll('.sidebar .btnIcon').forEach(b=>{
        b.addEventListener('click', ()=> {
          document.querySelectorAll('.sidebar .btnIcon').forEach(x=>x.classList.remove('active'));
          b.classList.add('active');
          const target = b.dataset.target;
          const el = document.getElementById(target);
          if(el) el.scrollIntoView({behavior:'smooth',block:'start'});
        });
      });

      // AGM countdown (fixed date from your context)
      (function agm(){
        const target = new Date('2025-12-14T13:30:00+03:00').getTime();
        const el = safe('agmCountdown');
        if(!el) return;
        setInterval(()=> {
          const now = Date.now();
          let diff = Math.max(0, target - now);
          const d = Math.floor(diff/(1000*60*60*24)); diff -= d*(1000*60*60*24);
          const h = Math.floor(diff/(1000*60*60)); diff -= h*(1000*60*60);
          const m = Math.floor(diff/(1000*60));
          el.textContent = `${d}d ${h}h ${m}m`;
        },1000);
      })();

      // Quick download/statement handlers
      safe('downloadStatementQuick') && safe('downloadStatementQuick').addEventListener('click', async ()=>{
        const uid = currentUid || null;
        if(!uid) return alert('Sign in to download statement');
        const doc = await buildStatementPdf(uid);
        doc.save(`Account_Statement_${uid}.pdf`);
        showToast('Statement generated');
      });

      // mpesa pay placeholder
      safe('mpesaPayBtn') && safe('mpesaPayBtn').addEventListener('click', async ()=>{
        const amount = prompt('Enter amount (Ksh)', '100');
        if(!amount || isNaN(Number(amount))) return alert('Invalid amount');
        const phone = prompt('Enter phone (2547xxxxxxxx)', '');
        if(!phone) return alert('Phone required');
        showToast('Requesting STK push (backend required)');
        // send to your backend - placeholder
        try{
          await fetch('/mpesa/stk/push', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ phone, amount, uid: currentUid || 'demo' })});
          showToast('STK Push initiated — check phone');
          confettiBurst();
        }catch(e){
          console.warn('M-Pesa call failed (expected in local testing)', e);
          alert('STK push failed (no backend). Implement /mpesa/stk/push in your server.');
        }
      });

      // Downloads toggle
      safe('downloadsToggle') && safe('downloadsToggle').addEventListener('click', ()=> {
        const el = safe('downloadsList');
        if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
      });

      // upload file
      safe('uploadFileBtn') && safe('uploadFileBtn').addEventListener('click', ()=>{
        safe('photoInput').click(); // reuse photo input for uploads optionally
      });

      // refresh downloads
      safe('refreshDownloadsBtn') && safe('refreshDownloadsBtn').addEventListener('click', ()=> refreshDownloadsList());

      // upload (dedicated)
      safe('uploadFileBtn') && safe('uploadFileBtn').addEventListener('click', ()=>{
        const inp = document.createElement('input'); inp.type='file'; inp.accept='application/pdf,image/*';
        inp.onchange = async (e)=> {
          const f = e.target.files[0]; if(!f) return;
          if(!currentUid) return alert('Sign in to upload');
          const path = `members/${currentUid}/uploads/${Date.now()}_${f.name}`;
          const ref = sRef(storage, path);
          try{
            await uploadBytes(ref, f);
            const url = await getDownloadURL(ref);
            const idxRef = push(refDatabase(`members/${currentUid}/uploadsIndex`));
            await set(idxRef, { name: f.name, url, ts: Date.now() });
            showToast('Uploaded');
            confettiBurst();
            refreshDownloadsList();
          }catch(err){ console.error(err); alert('Upload failed'); }
        };
        inp.click();
      });

      // Choose photo
      safe('choosePhotoBtn') && safe('choosePhotoBtn').addEventListener('click', ()=> safe('photoInput').click());
      safe('photoInput') && safe('photoInput').addEventListener('change', async (e)=> {
        const file = e.target.files[0]; if(!file) return;
        if(!currentUid) return alert('Sign in to upload photo');
        try{
          const path = `members/${currentUid}/photo_${Date.now()}`;
          const sref = sRef(storage, path);
          await uploadBytes(sref, file);
          const url = await getDownloadURL(sref);
          await set(refDatabase(`members/${currentUid}/photoURL`), url);
          safe('topAvatar').innerHTML = `<img src="${url}" alt="avatar" style="width:100%;height:100%;object-fit:cover">`;
          showToast('Photo uploaded');
        }catch(err){ console.error(err); alert('Photo upload failed'); }
      });

      // Save profile
      safe('saveProfileBtn') && safe('saveProfileBtn').addEventListener('click', async ()=>{
        if(!currentUid) return alert('Sign in first');
        const payload = {
          name: safe('pf_fullName').value||'',
          phone: safe('pf_phone').value||'',
          id: safe('pf_id').value||'',
          yearJoined: safe('pf_yearJoined').value||'',
          dob: safe('pf_dob').value||'',
          status: 'Active',
          joinedAt: Date.now()
        };
        try{
          await set(refDatabase(`members/${currentUid}/profile`), payload);
          showToast('Profile saved');
          confettiBurst();
        }catch(err){ console.error(err); alert('Failed to save profile'); }
      });

      // download tx pdf
      safe('downloadTxPdf') && safe('downloadTxPdf').addEventListener('click', async ()=>{
        if(!currentUid) return alert('Sign in to export transactions');
        const snapshot = await get(refDatabase(`members/${currentUid}/transactions`));
        if(!snapshot.exists()) return alert('No transactions');
        const txs = Object.values(snapshot.val()).sort((a,b)=> (a.ts||0)-(b.ts||0));
        const doc = new jsPDF({unit:'pt',format:'a4'});
        let y=40;
        doc.setFontSize(16); doc.text('Account Transactions', 300, y, {align:'center'}); y+=30; doc.setFontSize(10);
        txs.forEach(t=>{
          const line = `${new Date(t.ts).toLocaleDateString()} • ${t.desc||''} • Debit:${t.debit||'-'} • Credit:${t.credit||'-'} • Bal:${t.balance||0}`;
          const w = doc.splitTextToSize(line,520);
          doc.text(w,36,y); y += w.length*12;
          if(y>720){ doc.addPage(); y=40; }
        });
        doc.save(`transactions_${currentUid}.pdf`);
        showToast('Transactions exported');
      });

      // ----------------- RTDB / STORAGE HELPERS -----------------
      function refDatabase(path){ return ref(db, path); }

      // Refresh downloads list: prefer members/{uid}/uploadsIndex then fallback to storage list
      async function refreshDownloadsList(){
        const container = safe('downloadsList'); if(!container) return;
        container.innerHTML = '<div class="muted">Loading files…</div>';
        if(!currentUid){ container.innerHTML = '<div class="muted">Sign in to see files</div>'; return; }
        try{
          const idxSnap = await get(refDatabase(`members/${currentUid}/uploadsIndex`));
          container.innerHTML = '';
          if(idxSnap.exists()){
            const items = Object.entries(idxSnap.val()).sort((a,b)=> (b[1].ts||0)-(a[1].ts||0));
            items.forEach(([k,v])=>{
              const card = document.createElement('div'); card.className='download-card';
              card.innerHTML = `<strong>${v.name||k}</strong><div class="muted small">${new Date(v.ts||Date.now()).toLocaleString()}</div><div style="margin-top:auto;display:flex;gap:8px"><button class="btn ghost" onclick="window.open('${v.url}','_blank')">Open</button><button class="btn" onclick="window.open('${v.url}','_blank')">Download</button></div>`;
              container.appendChild(card);
            });
            return;
          }
          // fallback to storage folder
          const folder = `members/${currentUid}/uploads`;
          const listRef = sRef(storage, folder);
          const res = await listAll(listRef);
          container.innerHTML = '';
          if(!res.items.length){ container.innerHTML = '<div class="muted">No files uploaded</div>'; return; }
          for(const item of res.items.reverse()){
            const url = await getDownloadURL(item);
            const card = document.createElement('div'); card.className='download-card';
            card.innerHTML = `<strong>${item.name}</strong><div class="muted small">Uploaded file</div><div style="margin-top:auto;display:flex;gap:8px"><button class="btn ghost" onclick="window.open('${url}','_blank')">Open</button><button class="btn" onclick="window.open('${url}','_blank')">Download</button></div>`;
            container.appendChild(card);
          }
        }catch(err){ console.error('refreshDownloadsList',err); container.innerHTML = '<div class="muted">Failed to load files</div>'; }
      }

      // ----------------- AUTH & RTDB LISTENERS -----------------
      // Local state
      let currentUid = null;

      onAuthStateChanged(auth, async (user) => {
        if(!user){ console.warn('Not signed in. Some features require login.'); /* leave in demo state */ return; }
        currentUid = user.uid;

        // load profile
        onValue(refDatabase(`members/${currentUid}/profile`), snap=>{
          if(!snap.exists()) return;
          const p = snap.val();
          if(p.name) safe('welcomeName').textContent = p.name;
          if(p.name) safe('pf_fullName').value = p.name;
          if(p.phone) safe('pf_phone').value = p.phone;
          if(p.id) safe('pf_id').value = p.id;
          if(p.yearJoined) safe('pf_yearJoined').value = p.yearJoined;
          if(p.dob) safe('pf_dob').value = p.dob;
          if(p.status) safe('memberStatus').textContent = p.status;
          if(p.joinedAt) safe('memberSince').textContent = `Joined: ${new Date(p.joinedAt).getFullYear()}`;
        });

        // photo
        onValue(refDatabase(`members/${currentUid}/photoURL`), snap=>{
          if(!snap.exists()) return;
          const url = snap.val();
          safe('topAvatar').innerHTML = `<img src="${url}" alt="avatar" style="width:100%;height:100%;object-fit:cover">`;
        });

        // points
        onValue(refDatabase(`members/${currentUid}/points`), snap=>{
          const p = snap.exists() ? Number(snap.val()||0) : 0;
          safe('pointsDisplay').textContent = p;
        });

        // balances
        onValue(refDatabase(`members/${currentUid}/savings/monthly`), snap=>{
          const v = snap.exists() ? (typeof snap.val()==='number' ? snap.val() : computeAmount(snap.val())) : 0;
          safe('monthlyVal').textContent = formatKsh(v);
        });
        onValue(refDatabase(`members/${currentUid}/savings/weekly`), snap=>{
          const v = snap.exists() ? (typeof snap.val()==='number' ? snap.val() : computeAmount(snap.val())) : 0;
          safe('weeklyVal').textContent = formatKsh(v);
        });
        onValue(refDatabase(`members/${currentUid}/shares/total`), snap=>{
          const v = snap.exists()? Number(snap.val()||0) : 0; safe('sharesVal').textContent = formatKsh(v);
        });
        onValue(refDatabase(`members/${currentUid}/shares/dividends`), snap=>{
          const v = snap.exists()? Number(snap.val()||0) : 0; safe('dividendsVal').textContent = formatKsh(v);
        });

        // loans summary
        onValue(refDatabase(`members/${currentUid}/loans/summary`), snap=>{
          const s = snap.exists()? snap.val() : {};
          safe('totalLoansVal').textContent = formatKsh(s.total||0);
          safe('outstandingLoansVal').textContent = formatKsh(s.outstanding||0);
          safe('loanStage').textContent = s.stage || '—';
          safe('loanInterest').textContent = s.interest ? `${s.interest}%` : '—';
          safe('nextInstallment').textContent = formatKsh(s.nextInstallment||0);
          safe('nextInstallmentDate').textContent = s.nextDue ? new Date(s.nextDue).toLocaleDateString() : '—';
        });

        // notifications
        onValue(refDatabase(`notifications`), snap=>{
          const list = safe('notificationsList'); if(!list) return;
          list.innerHTML = '';
          if(!snap.exists()){ list.innerHTML = '<div class="muted">No notifications</div>'; return; }
          const arr = Object.values(snap.val()).sort((a,b)=> (b.ts||0)-(a.ts||0));
          arr.slice(0,10).forEach(n=>{
            const el = document.createElement('div'); el.style.padding='8px'; el.style.borderRadius='8px'; el.style.border='1px solid #ecf8ef'; el.style.marginBottom='8px';
            el.innerHTML = `<strong style="color:var(--primary)">${n.title||'Update'}</strong><div class="muted small">${n.message||''}</div><small class="muted">${new Date(n.ts||Date.now()).toLocaleString()}</small>`;
            list.appendChild(el);
          });
        });

        // activity log
        onValue(refDatabase(`members/${currentUid}/activityLog`), snap=>{
          const el = safe('activityList'); if(!el) return; el.innerHTML = '';
          if(!snap.exists()){ el.innerHTML = '<li class="muted">No activity</li>'; return; }
          const arr = Object.values(snap.val()).sort((a,b)=> (b.ts||0)-(a.ts||0));
          arr.slice(0,20).forEach(it=>{
            const li = document.createElement('li'); li.style.marginBottom='6px'; li.style.color='var(--muted)';
            li.innerHTML = `<strong>${it.text}</strong> • <small class="muted">${new Date(it.ts||Date.now()).toLocaleString()}</small>`;
            el.appendChild(li);
          });
        });

        // transactions
        onValue(refDatabase(`members/${currentUid}/transactions`), snap=>{
          const tb = safe('txBody'); if(!tb) return; tb.innerHTML = '';
          if(!snap.exists()){ tb.innerHTML = '<tr><td colspan="5" class="muted">No transactions</td></tr>'; return; }
          const arr = Object.values(snap.val()).sort((a,b)=> (b.ts||0)-(a.ts||0));
          arr.slice(0,200).forEach(tx=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${new Date(tx.ts||Date.now()).toLocaleDateString()}</td><td>${tx.desc||''}</td><td>${tx.debit?formatKsh(tx.debit):'-'}</td><td>${tx.credit?formatKsh(tx.credit):'-'}</td><td>${formatKsh(tx.balance||0)}</td>`;
            tb.appendChild(tr);
          });
        });

        // downloads
        refreshDownloadsList();

      }); // end auth listener

      // helper: compute amount from snapshot objects
      function computeAmount(obj){
        if(!obj) return 0;
        if(typeof obj === 'number') return obj;
        let total = 0;
        Object.values(obj).forEach(v=>{
          if(typeof v === 'number') total += v;
          else if(v && typeof v === 'object' && ('amount' in v)) total += Number(v.amount||0);
          else if(v && typeof v === 'object') Object.values(v).forEach(c=>{ if(c && typeof c === 'object' && ('amount' in c)) total += Number(c.amount||0); });
        });
        return total;
      }

      // ----------------- Wizard navigation & submit -----------------
      (function loanWizard(){
        const panels = Array.from(document.querySelectorAll('#loanWizardForm .wizard-panel'));
        const steps = Array.from(document.querySelectorAll('#loanWizardSteps .wizard-step'));
        let cur = 0;
        function show(i){
          panels.forEach(p=>p.classList.remove('active'));
          steps.forEach(s=>s.classList.remove('active'));
          panels[i].classList.add('active'); steps[i].classList.add('active');
          cur = i; window.scrollTo({top:0,behavior:'smooth'});
        }
        document.querySelectorAll('#loanWizardForm [data-action]').forEach(btn=>{
          btn.addEventListener('click', (e)=>{
            const action = btn.dataset.action;
            if(action === 'next') show(Math.min(panels.length-1, cur+1));
            if(action === 'prev') show(Math.max(0, cur-1));
          });
        });
        safe('openLoanWizardBtn') && safe('openLoanWizardBtn').addEventListener('click', ()=> { document.getElementById('loan-section').scrollIntoView({behavior:'smooth'}); show(0); });
        // form submit
        const form = safe('loanWizardForm');
        form && form.addEventListener('submit', async (e)=>{
          e.preventDefault();
          if(!currentUid) return alert('Sign in to submit application');
          const chk = document.getElementById('loanAgree');
          if(!chk || !chk.checked) return alert('Please agree to terms');
          const data = Object.fromEntries(new FormData(form).entries());
          const guarantors = [];
          for(let i=1;i<=3;i++) guarantors.push({ mno: data[`g_mno_${i}`]||'', name: data[`g_name_${i}`]||'', phone: data[`g_phone_${i}`]||'', amount: data[`g_amount_${i}`]||'' });
          data.guarantors = guarantors; data.appliedAt = Date.now(); data.status = 'Pending';
          try{
            const appRef = push(refDatabase(`members/${currentUid}/loans/applications`));
            await set(appRef, data);
            // update loans summary
            const sRef = refDatabase(`members/${currentUid}/loans/summary`);
            const sSnap = await get(sRef);
            const s = sSnap.exists() ? sSnap.val() : { total:0, outstanding:0 };
            s.total = Number(s.total||0) + Number(data.amountFigures||0);
            s.outstanding = Number(s.outstanding||0) + Number(data.amountFigures||0);
            await set(sRef, s);
            // activity & points
            const actRef = push(refDatabase(`members/${currentUid}/activityLog`));
            await set(actRef, { text: `Submitted loan application ${data.amountFigures}`, ts: Date.now() });
            const ptsSnap = await get(refDatabase(`members/${currentUid}/points`));
            const pts = ptsSnap.exists() ? Number(ptsSnap.val()||0) : 0;
            await set(refDatabase(`members/${currentUid}/points`), pts + 5);
            // generate pdf
            const pdf = buildLoanPdf(data);
            pdf.save(`Loan_${(data.memberName||currentUid).replace(/\s+/g,'_')}_${appRef.key}.pdf`);
            showToast('Application submitted');
            confettiBurst();
            form.reset();
          }catch(err){ console.error(err); alert('Failed to submit application'); }
        });

        // loan PDF builder (simple)
        function buildLoanPdf(data){
          const doc = new jsPDF({unit:'pt',format:'a4'}); let y=40,left=36;
          doc.setFillColor(46,125,50); doc.rect(0,0,595,56,'F'); doc.setFontSize(14); doc.setTextColor(255,255,255); doc.text('VISIONARY YOUTH GROUP',300,36,{align:'center'}); doc.setTextColor(0,0,0);
          y = 80; doc.setFontSize(12); doc.text('Loan Application', left, y); y+=16;
          const lines = [`Name: ${data.memberName||''}`, `Membership No: ${data.membershipNumber||''}`, `Amount: Ksh ${data.amountFigures||''}`, `Purpose: ${data.purpose||''}`, `Applied: ${new Date(data.appliedAt||Date.now()).toLocaleString()}`];
          lines.forEach(l=>{ const wrapped = doc.splitTextToSize(l,520); doc.text(wrapped, left, y); y += wrapped.length*12; });
          return doc;
        }
      })();

      // ----------------- Withdrawal handlers -----------------
      (function withdraw(){
        const form = safe('withdrawForm');
        safe('previewWithdraw') && safe('previewWithdraw').addEventListener('click', (e)=>{
          e.preventDefault();
          const data = Object.fromEntries(new FormData(form).entries());
          const doc = buildWithdrawPdf(data);
          doc.save(`Withdrawal_PREVIEW.pdf`);
        });
        form && form.addEventListener('submit', async (e)=>{
          e.preventDefault();
          if(!currentUid) return alert('Sign in to submit');
          const data = Object.fromEntries(new FormData(form).entries());
          data.submittedAt = Date.now();
          try{
            const refApp = push(refDatabase(`members/${currentUid}/withdrawals`));
            await set(refApp, data);
            // activity + points
            const act = push(refDatabase(`members/${currentUid}/activityLog`));
            await set(act, { text: `Submitted withdrawal ${data.w_amountFigures}`, ts: Date.now() });
            const ptsSnap = await get(refDatabase(`members/${currentUid}/points`)); const pts = ptsSnap.exists()? Number(ptsSnap.val()||0):0; await set(refDatabase(`members/${currentUid}/points`), pts+4);
            const doc = buildWithdrawPdf(data);
            doc.save(`Withdrawal_${(data.w_memberName||currentUid).replace(/\s+/g,'_')}.pdf`);
            showToast('Withdrawal submitted');
            confettiBurst();
            form.reset();
          }catch(err){ console.error(err); alert('Failed to submit withdrawal'); }
        });

        function buildWithdrawPdf(data){
          const doc = new jsPDF({unit:'pt',format:'a4'}); let y=40,left=36;
          doc.setFillColor(46,125,50); doc.rect(0,0,595,56,'F'); doc.setTextColor(255,255,255); doc.setFontSize(14); doc.text('VOLUNTARY WITHDRAWAL',300,36,{align:'center'}); doc.setTextColor(0,0,0);
          y=80; doc.setFontSize(12); const lines = [`Member: ${data.w_memberName||''}`, `Membership No: ${data.w_membershipNumber||''}`, `ID: ${data.w_idNumber||''}`, `Phone: ${data.w_phone||''}`, `Amount: Ksh ${data.w_amountFigures||''}`, `Reason: ${data.w_reason||''}`];
          lines.forEach(l=>{ const w = doc.splitTextToSize(l,520); doc.text(w,left,y); y += w.length*12; });
          return doc;
        }
      })();

      // ----------------- Utility PDF: account statement -----------------
      async function buildStatementPdf(uid){
        if(!uid) throw new Error('uid required');
        const profileSnap = await get(refDatabase(`members/${uid}/profile`));
        const txSnap = await get(refDatabase(`members/${uid}/transactions`));
        const monthlySnap = await get(refDatabase(`members/${uid}/savings/monthly`));
        const weeklySnap = await get(refDatabase(`members/${uid}/savings/weekly`));
        const sharesSnap = await get(refDatabase(`members/${uid}/shares`));
        const doc = new jsPDF({unit:'pt',format:'a4'}); let y=40,left=36;
        doc.setFillColor(46,125,50); doc.rect(0,0,595,56,'F'); doc.setTextColor(255,255,255); doc.setFontSize(16); doc.text('ACCOUNT STATEMENT',300,36,{align:'center'}); doc.setTextColor(0,0,0);
        y=80; doc.setFontSize(10);
        const p = profileSnap.exists()? profileSnap.val() : {};
        doc.text(`Member: ${p.name||'—'}`, left, y); y+=12; doc.text(`Date: ${new Date().toLocaleDateString()}`, left, y); y+=18;
        const monthly = monthlySnap.exists()? computeAmount(monthlySnap.val()) : 0;
        const weekly = weeklySnap.exists()? computeAmount(weeklySnap.val()) : 0;
        const sharesVal = sharesSnap.exists()? (sharesSnap.val().total || sharesSnap.val() || 0) : 0;
        doc.text(`Monthly Savings: ${formatKsh(monthly)}`, left, y); y+=12;
        doc.text(`Weekly Savings: ${formatKsh(weekly)}`, left, y); y+=12;
        doc.text(`Shares: ${formatKsh(sharesVal)}`, left, y); y+=12;
        doc.text('Recent Transactions:', left, y); y+=12;
        if(txSnap.exists()){
          const txs = Object.values(txSnap.val()).slice(-10);
          txs.forEach(t=>{
            const line = `${new Date(t.ts||Date.now()).toLocaleDateString()} • ${t.desc||''} • ${t.debit?formatKsh(t.debit):'-'} / ${t.credit?formatKsh(t.credit):'-'}`;
            const w = doc.splitTextToSize(line,520); doc.text(w,left,y); y += w.length*12;
            if(y>720){ doc.addPage(); y=40; }
          });
        } else {
          doc.text('No transactions', left, y); y+=12;
        }
        return doc;
      }

      // ----------------- Refresh helpers -----------------
      safe('refreshDownloadsBtn') && safe('refreshDownloadsBtn').addEventListener('click', refreshDownloadsList);
      safe('refreshTx') && safe('refreshTx').addEventListener('click', ()=> showToast('Refreshed'));

      async function refreshDownloadsList(){ await refreshDownloadsListCore(); }
      async function refreshDownloadsListCore(){
        const container = safe('downloadsList'); if(!container) return;
        container.innerHTML = '<div class="muted">Loading files…</div>';
        if(!currentUid){ container.innerHTML = '<div class="muted">Sign in to see files</div>'; return; }
        try{
          const idxSnap = await get(refDatabase(`members/${currentUid}/uploadsIndex`));
          container.innerHTML = '';
          if(idxSnap.exists()){
            const items = Object.entries(idxSnap.val()).sort((a,b)=> (b[1].ts||0)-(a[1].ts||0));
            items.forEach(([k,v])=>{
              const card = document.createElement('div'); card.className='download-card';
              card.innerHTML = `<strong>${v.name||k}</strong><div class="muted small">${new Date(v.ts||Date.now()).toLocaleString()}</div><div style="margin-top:auto;display:flex;gap:8px"><button class="btn ghost" onclick="window.open('${v.url}','_blank')">Open</button><button class="btn" onclick="window.open('${v.url}','_blank')">Download</button></div>`;
              container.appendChild(card);
            });
            return;
          }
          // fallback to storage folder
          const listRef = sRef(storage, `members/${currentUid}/uploads`);
          const res = await listAll(listRef);
          container.innerHTML = '';
          if(!res.items.length){ container.innerHTML = '<div class="muted">No files uploaded</div>'; return; }
          for(const item of res.items.reverse()){
            const url = await getDownloadURL(item);
            const card = document.createElement('div'); card.className='download-card';
            card.innerHTML = `<strong>${item.name}</strong><div class="muted small">Uploaded file</div><div style="margin-top:auto;display:flex;gap:8px"><button class="btn ghost" onclick="window.open('${url}','_blank')">Open</button><button class="btn" onclick="window.open('${url}','_blank')">Download</button></div>`;
            container.appendChild(card);
          }
        }catch(err){ console.error(err); container.innerHTML = '<div class="muted">Failed to load files</div>'; }
      }

      // small initial call: show toast
      showToast('Dashboard ready', 1400);

      // init AOS if available
      try{ if(window.AOS) AOS.init({duration:700, once:true}); }catch(e){}
    }); // end DOMContentLoaded
  </script>

  <!-- AOS -->
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
</body>
</html>
