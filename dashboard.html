<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Visionary Youth Group — Dashboard</title>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- jsPDF (single include only) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{
    --dark:#164e2a;
    --accent:#2e7d32;
    --gold:#ffcc00;
    --bg1:#e9ffec;
    --card:#ffffff;
    --muted:#6b7280;
  }
  *{box-sizing:border-box}
  body{
    margin:0;font-family:'Poppins',sans-serif;background:linear-gradient(120deg,var(--bg1),#f6fff6);color:#123;
  }
  /* Top bar */
  .topbar{
    position:fixed;left:0;right:0;top:0;height:64px;background:linear-gradient(90deg,var(--dark),#26734d);color:#fff;
    display:flex;align-items:center;justify-content:space-between;padding:0 18px;z-index:1200;
    box-shadow:0 6px 20px rgba(6,50,20,0.12);
  }
  .brand{display:flex;align-items:center;gap:12px}
  .brand h1{font-size:1.05rem;margin:0;font-weight:700}
  .hamburger{font-size:1.6rem;cursor:pointer}
  .user-info{text-align:right;font-size:0.95rem}
  .user-info small{display:block;color:rgba(255,255,255,0.85)}

  /* Menu overlay */
  .menu{
    position:fixed;top:64px;left:0;right:0;background:rgba(255,255,255,0.98);max-width:320px;border-radius:8px;padding:8px;
    box-shadow:0 8px 30px rgba(0,0,0,0.12);display:none;z-index:1199;right:18px;
  }
  .menu a{display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;color:#123;text-decoration:none}
  .menu a:hover{background:#f1fff1}

  /* Layout */
  .page{
    max-width:1200px;margin:92px auto 48px;padding:0 18px;
    display:grid;grid-template-columns:repeat(12,1fr);gap:18px;
  }

  /* Hero / summary */
  .hero{grid-column:span 12;background:var(--card);border-radius:12px;padding:16px;display:flex;justify-content:space-between;align-items:center;gap:16px}
  .welcome{display:flex;flex-direction:column}
  .welcome h2{margin:0;color:var(--dark)}
  .quick-actions{display:flex;gap:10px}

  /* cards */
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 8px 20px rgba(6,50,20,0.05);}
  .balances-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px}
  .balance{background:linear-gradient(180deg,#f3fff3,#ffffff);padding:12px;border-radius:10px;text-align:center}
  .balance .label{color:var(--muted);font-size:0.95rem}
  .balance .value{font-weight:700;font-size:1.25rem;color:var(--accent);margin-top:8px}

  /* loan application large area */
  .big{grid-column:span 8}
  .side{grid-column:span 4}

  /* form */
  .form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .form-grid .full{grid-column:1/-1}
  input, select, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;font-size:0.95rem}
  textarea{min-height:100px;resize:vertical}
  .btn{background:var(--accent);color:white;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700}
  .btn.secondary{background:#fff;color:var(--accent);border:1px solid #e3f1e3}

  /* Voluntary Withdrawal Application specifics - kept styles */
  /* loan stages */
  .stages{display:flex;gap:10px;align-items:center;justify-content:space-between}
  .stage{flex:1;padding:10px;border-radius:8px;background:#f5faf5;text-align:center}
  .stage.active{background:var(--dark);color:white;font-weight:700}
  .stage.done{background:#27ae60;color:white}

  /* guarantors table */
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border:1px solid #e6f0ea;font-size:0.9rem;text-align:left}

  @media (max-width:1000px){
    .big{grid-column:span 12}
    .side{grid-column:span 12}
    .form-grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>

  <div class="topbar">
    <div class="brand">
      <i class="fas fa-seedling" style="font-size:1.25rem;color:var(--gold)"></i>
      <h1>Visionary Youth Group</h1>
    </div>

    <div style="display:flex;gap:12px;align-items:center">
      <div class="user-info">
        <div id="topEmail">—</div>
        <small id="topStatus">Status: <strong style="color:#9ff2b8">Active</strong></small>
      </div>

      <div style="display:flex;align-items:center;gap:10px">
        <button id="downloadStatementTop" title="Download Account Statement" class="btn secondary"><i class="fas fa-file-pdf"></i>&nbsp;Statement</button>
        <i class="fas fa-bars hamburger hamburgerAction" role="button" aria-label="Menu" style="font-size:20px;color:#fff;margin-left:6px"></i>
      </div>
    </div>
  </div>

  <div class="menu" id="menu" aria-hidden="true">
    <a href="#" data-target="overview"><i class="fas fa-home"></i> Overview</a>
    <a href="#" data-target="balances"><i class="fas fa-wallet"></i> Balances</a>
    <a href="#" data-target="loan-section"><i class="fas fa-file-signature"></i> Loan Application</a>
    <a href="#" data-target="loansList"><i class="fas fa-money-bill-wave"></i> Loans</a>
    <a href="#" data-target="profile-area"><i class="fas fa-user-edit"></i> Update Profile</a>
    <a href="#" id="menuLogout"><i class="fas fa-sign-out-alt"></i> Logout</a>
  </div>

  <main class="page" id="pageRoot">
    <!-- hero -->
    <div class="hero card" id="overview">
      <div class="welcome">
        <h2 id="welcomeName">Welcome, Member</h2>
        <div style="color:var(--muted);margin-top:6px">Quick snapshot — all amounts shown in <strong>Ksh</strong></div>
      </div>
      <div class="quick-actions">
        <button id="quickApply" class="btn"><i class="fas fa-file-signature"></i>&nbsp;Apply Loan</button>
        <button id="quickStatement" class="btn secondary"><i class="fas fa-file-download"></i>&nbsp;Statement</button>
      </div>
    </div>

    <!-- balances summary -->
    <div class="card big" id="balancesCard">
      <h2>Balances</h2>
      <div class="balances-grid">
        <div class="balance"><div class="label">Monthly Savings</div><div class="value" id="monthlyVal">Ksh 0</div></div>
        <div class="balance"><div class="label">Weekly Savings</div><div class="value" id="weeklyVal">Ksh 0</div></div>
        <div class="balance"><div class="label">Shares</div><div class="value" id="sharesVal">Ksh 0</div></div>
        <div class="balance"><div class="label">Dividends</div><div class="value" id="dividendsVal">Ksh 0</div></div>
        <div class="balance"><div class="label">Total Loans</div><div class="value" id="totalLoansVal">Ksh 0</div></div>
        <div class="balance"><div class="label">Unpaid Balances</div><div class="value" id="unpaidVal">Ksh 0</div></div>
        <div class="balance"><div class="label">Outstanding Loans</div><div class="value" id="outstandingLoansVal">Ksh 0</div></div>
      </div>
    </div>

    <!-- loan application big form -->
    <section class="card big" id="loan-section" aria-labelledby="loanHeading">
      <h2 id="loanHeading"><i class="fas fa-file-signature"></i> Loan Application (Official Form)</h2>

      <form id="fullLoanForm">
        <!-- header -->
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div>
            <div style="font-weight:800">VISIONARY YOUTH GROUP 2024</div>
            <div style="font-weight:700;color:var(--muted)">SOCIAL PROMOTION REGISTERED TRUSTEES</div>
          </div>
          <div style="text-align:right;font-size:0.9rem">
            <div>Loan Number: <span id="loanNoDisplay">—</span></div>
            <div>Serial No: <span id="serialNo">—</span></div>
            <div style="margin-top:8px;font-size:0.8rem"><small>FOR OFFICIAL USE ONLY</small></div>
          </div>
        </div>

        <!-- APPLICANT INFORMATION -->
        <h3>APPLICANT INFORMATION</h3>
        <div class="form-grid">
          <input class="full" name="selfHelpGroup" placeholder="Name of Self-Help Group" required>
          <input name="memberName" placeholder="Name of Applicant" required>
          <input name="membershipNumber" placeholder="Membership Number (M/No)" required>
          <input name="nationalId" placeholder="National ID / Passport No" required>
          <select name="maritalStatus" required>
            <option value="">Marital Status</option>
            <option>Single</option><option>Married</option><option>Widow</option><option>Others</option>
          </select>
          <input name="dob" type="date" placeholder="Date of Birth" required>
          <input name="county" placeholder="County" required>
          <input name="town" placeholder="City / Town" required>
          <input name="currentAddress" placeholder="Current Address" required>
          <input name="areaResidence" placeholder="Area of Residence" required>
          <input name="phone" placeholder="Phone" required>
          <input name="email" type="email" placeholder="E-mail" required>
          <select name="ownedRented">
            <option value="">Owned / Rented</option>
            <option>Owned</option><option>Rented</option>
          </select>
          <input name="monthlyRent" placeholder="Monthly payment or rent">
        </div>

        <!-- EMPLOYMENT -->
        <h3>EMPLOYMENT INFORMATION (WHERE APPLICABLE)</h3>
        <div class="form-grid">
          <input name="employer" placeholder="Current Employer">
          <input name="position" placeholder="Position">
          <input name="periodEmployment" placeholder="Period in Current Employment">
          <input name="employerAddress" placeholder="Employer Address">
          <input name="monthlyIncome" placeholder="Monthly Income (Ksh)" required>
        </div>

        <!-- OTHER SOURCES -->
        <h3>OTHER SOURCES OF INCOME</h3>
        <div class="form-grid">
          <input name="income1" placeholder="Income source 1 (Ksh)">
          <input name="income2" placeholder="Income source 2 (Ksh)">
          <input name="income3" placeholder="Income source 3 (Ksh)">
        </div>

        <!-- LOAN APPLICATION -->
        <h3>LOAN APPLICATION</h3>
        <div class="form-grid">
          <input name="amountFigures" placeholder="Amount Requested (Figures, Ksh)" required>
          <input name="amountWords" placeholder="Amount in words" required>
          <input name="purpose" placeholder="Purpose of the Loan" required>
          <input name="repayableMonths" placeholder="Repayable in monthly instalments (months)" required>
        </div>

        <!-- OTHER LOANS -->
        <h3>OTHER LOANS / DEBTS / OBLIGATIONS</h3>
        <div class="form-grid">
          <input name="otherLoan1" placeholder="Institution / Amount">
          <input name="otherLoan2" placeholder="Institution / Amount">
        </div>

        <!-- GUARANTORS -->
        <h3>GUARANTORS (Fill details, sign after applicant enters amount)</h3>
        <table>
          <thead>
            <tr><th>M No.</th><th>Name in Full</th><th>Cell Phone</th><th>ID No.</th><th>Group Name</th><th>Amount Offered (Ksh)</th></tr>
          </thead>
          <tbody id="guarantorRows">
            <!-- 3 default rows -->
            <tr>
              <td><input name="g_mno_1" placeholder="MNo"></td>
              <td><input name="g_name_1" placeholder="Full name"></td>
              <td><input name="g_phone_1" placeholder="Phone"></td>
              <td><input name="g_id_1" placeholder="ID No"></td>
              <td><input name="g_group_1" placeholder="SHG Name"></td>
              <td><input name="g_amount_1" placeholder="Ksh"></td>
            </tr>
            <tr>
              <td><input name="g_mno_2" placeholder="MNo"></td>
              <td><input name="g_name_2" placeholder="Full name"></td>
              <td><input name="g_phone_2" placeholder="Phone"></td>
              <td><input name="g_id_2" placeholder="ID No"></td>
              <td><input name="g_group_2" placeholder="SHG Name"></td>
              <td><input name="g_amount_2" placeholder="Ksh"></td>
            </tr>
            <tr>
              <td><input name="g_mno_3" placeholder="MNo"></td>
              <td><input name="g_name_3" placeholder="Full name"></td>
              <td><input name="g_phone_3" placeholder="Phone"></td>
              <td><input name="g_id_3" placeholder="ID No"></td>
              <td><input name="g_group_3" placeholder="SHG Name"></td>
              <td><input name="g_amount_3" placeholder="Ksh"></td>
            </tr>
          </tbody>
        </table>

        <!-- TERMS -->
        <h3>TERMS &amp; CONDITIONS — Applicant Commitment</h3>
        <textarea name="terms" readonly>
Please read the full terms on the system: you must have 6 consecutive months savings, savings cover a third of guarantorship, loans above Ksh 10,000 require bank statements, school fees loan evidence required, cancellations fee may apply, CRB checks permitted.
        </textarea>

        <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
          <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="agreeTerms" required> I have read and agree to the Terms & Conditions</label>
          <div style="margin-left:auto;display:flex;gap:8px">
            <button class="btn" type="button" id="previewLoanPdf">Preview PDF</button>
            <button class="btn" type="submit" id="submitLoanBtn">Submit Application & Download PDF</button>
          </div>
        </div>
      </form>
    </section>

    <!-- New Withdrawable Form -->
    <section class="card big" id="withdraw-section">
      <h2><i class="fas fa-hand-holding-usd"></i> Voluntary Withdrawable Savings Form</h2>
      
      <form id="withdrawForm">
        <div class="form-grid">
          <input class="full" name="memberName" placeholder="Member Name" required>
          <input name="membershipNumber" placeholder="Membership Number" required>
          <input name="idNumber" placeholder="ID / Passport Number" required>
          <input name="phone" placeholder="Phone Number" required>
          <input name="amountFigures" placeholder="Amount Requested (Figures, Ksh)" required>
          <input name="amountWords" placeholder="Amount in Words" required>
          <input class="full" name="reason" placeholder="Reason for Withdrawal" required>
        </div>

        <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
          <button class="btn" type="button" id="previewWithdrawPdf">Preview PDF</button>
          <button class="btn" type="submit" id="submitWithdrawBtn">Submit & Download PDF</button>
        </div>
      </form>
    </section>

    <!-- side panel: loans summary & account statement -->
    <aside class="card side" id="sidePanel">
      <h2>Loans & Status</h2>

      <div id="loansListArea">Loading loans…</div>

      <hr style="margin:12px 0">
      <div style="display:flex;gap:8px">
        <button id="downloadStatement" class="btn secondary"><i class="fas fa-file-pdf"></i>&nbsp;Download Statement</button>
        <button id="downloadApplications" class="btn"><i class="fas fa-download"></i>&nbsp;My Applications</button>
      </div>
    </aside>

    <!-- profile area -->
    <section class="card" id="profile-area">
      <h2><i class="fas fa-user-edit"></i> Update Profile</h2>
      <div class="form-grid" style="margin-top:10px">
        <input class="full" id="profile_fullName" placeholder="Full name">
        <input id="profile_phone" placeholder="Phone">
        <input id="profile_id" placeholder="ID Number">
        <input id="profile_yearJoined" placeholder="Year Joined (e.g. 2021)">
        <input id="profile_dob" type="date" placeholder="Date of Birth">
      </div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="saveProfile" class="btn">Save Profile</button>
        <button id="profileStatement" class="btn secondary">Account Statement</button>
      </div>
    </section>
  </main>

  <div id="toast" style="position:fixed;right:18px;bottom:18px;background:#28a745;color:#fff;padding:10px 14px;border-radius:8px;display:none;z-index:2000"></div>

<script type="module">
  // Firebase imports (modular)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getDatabase, ref, onValue, get, push, set } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  // jsPDF available via window.jspdf (loaded in head)
  const { jsPDF } = window.jspdf;

  // CONFIG: use your firebase config or existing one
  const firebaseConfig = {
    apiKey: "AIzaSyA_OCu7HQ5HCH2OYx5dQ2Z1r7YPwQJave4",
    authDomain: "visionary-youth-grou-2024.firebaseapp.com",
    databaseURL: "https://visionary-youth-grou-2024-default-rtdb.firebaseio.com",
    projectId: "visionary-youth-grou-2024",
    storageBucket: "visionary-youth-grou-2024.appspot.com",
    messagingSenderId: "372978592717",
    appId: "1:372978592717:web:1c15aec728ee5f854f3284"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // UI refs
  const hamburger = document.querySelector('.hamburgerAction');
  const menu = document.getElementById('menu');
  const toast = document.getElementById('toast');
  const topEmail = document.getElementById('topEmail');
  const welcomeName = document.getElementById('welcomeName');

  // helpers
  function showToast(msg, timeout=3000){
    toast.textContent = msg; toast.style.display='block';
    setTimeout(()=> toast.style.display='none', timeout);
  }

  function formatKsh(n){
    const num = Number(n||0);
    return 'Ksh ' + num.toLocaleString('en-KE');
  }

  // menu toggles
  if (hamburger) {
    hamburger.addEventListener('click', ()=> {
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    });
  }

  // menu links close and scroll
  menu.querySelectorAll('a[data-target]').forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      const target = a.dataset.target;
      const el = document.getElementById(target);
      if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
      menu.style.display = 'none';
    });
  });

  // global auth variables
  let currentUid = null;
  let profileSavedOnce = false;

  // Auto logout (3 minutes)
  let logoutTimer;
  function resetLogoutTimer(){ 
    clearTimeout(logoutTimer); 
    logoutTimer = setTimeout(()=>{ 
      try { signOut(auth); } catch(e){} 
      alert('Logged out due to inactivity'); 
      location.href='index.html'; 
    }, 3*60*1000); 
  }
  ['mousemove','keydown','click','touchstart'].forEach(ev=> window.addEventListener(ev, resetLogoutTimer));

  // Defensive element getters for elements that might not exist
  const loanBalanceEl = document.getElementById('loanBalance');
  const loanBalance2El = document.getElementById('loanBalance2');

  // AUTH state: load data
  onAuthStateChanged(auth, async user => {
    if(!user) { location.href='index.html'; return; }
    currentUid = user.uid;
    topEmail.textContent = user.email || '—';
    welcomeName.textContent = (user.email || 'Member').split('@')[0];
    resetLogoutTimer();

    // Realtime listeners:
    // Profile
    onValue(ref(db, `members/${currentUid}/profile`), snap=>{
      if(snap.exists()){
        const p = snap.val();
        if(p.name) document.getElementById('welcomeName').textContent = p.name;
        if(p.name) document.getElementById('profile_fullName').value = p.name;
        if(p.phone) document.getElementById('profile_phone').value = p.phone;
        if(p.id) document.getElementById('profile_id').value = p.id;
        if(p.yearJoined) document.getElementById('profile_yearJoined').value = p.yearJoined;
        if(p.dob) document.getElementById('profile_dob').value = p.dob;
        if(p.status) document.getElementById('topStatus').innerHTML = `Status: <strong style="color:#9ff2b8">${p.status}</strong>`;
      }
    });

    // Balances references
    const monthlyRef = ref(db, `members/${currentUid}/savings/monthly`);
    const weeklyRef = ref(db, `members/${currentUid}/savings/weekly`);
    const sharesRef = ref(db, `members/${currentUid}/shares/total`);
    const dividendsRef = ref(db, `members/${currentUid}/shares/dividends`);
    const unpaidRef = ref(db, `members/${currentUid}/unpaidBalances`);
    // avoid duplicate var names: use two refs
    const loansTotalsRef = ref(db, `members/${currentUid}/loans/totals loans`);
    const outstandingLoansRef = ref(db, `members/${currentUid}/outstandingLoans`);

    // helper to display either single number or sum of child amounts
    async function snapToAmount(snap){
      if(!snap.exists()) return 0;
      const val = snap.val();
      if(typeof val === 'number' || typeof val === 'string') return Number(val) || 0;
      let total = 0;
      Object.values(val).forEach(child=>{
        if(child && typeof child === 'object' && ('amount' in child)) total += Number(child.amount||0);
        else if(typeof child === 'number') total += child;
        else if(typeof child === 'object' && !('amount' in child)){
          Object.values(child).forEach(c2=>{
            if(c2 && typeof c2 === 'object' && ('amount' in c2)) total += Number(c2.amount||0);
          });
        }
      });
      return total;
    }

    // attach onValue listeners (with checks)
    onValue(monthlyRef, async s=>{ const v = await snapToAmount(s); const el = document.getElementById('monthlyVal'); if(el) el.textContent = formatKsh(v); });
    onValue(weeklyRef, async s=>{ const v = await snapToAmount(s); const el = document.getElementById('weeklyVal'); if(el) el.textContent = formatKsh(v); });
    onValue(sharesRef, s=>{ const v = s.exists()? Number(s.val()||0) : 0; const el = document.getElementById('sharesVal'); if(el) el.textContent = formatKsh(v); });
    onValue(dividendsRef, s=>{ const v = s.exists()? Number(s.val()||0) : 0; const el = document.getElementById('dividendsVal'); if(el) el.textContent = formatKsh(v); });
    onValue(unpaidRef, s=>{ const v = s.exists()? Number(s.val()||0) : 0; const el = document.getElementById('unpaidVal'); if(el) el.textContent = formatKsh(v); });

    onValue(loansTotalsRef, s=>{
      const obj = s.exists()? s.val() : {total:0,unpaid:0};
      const total = obj.total || 0;
      const unpaid = obj.unpaid || 0;
      const totalEl = document.getElementById('totalLoansVal');
      if(totalEl) totalEl.textContent = formatKsh(total);
      if(loanBalanceEl) loanBalanceEl.textContent = formatKsh(unpaid);
      if(loanBalance2El) loanBalance2El.textContent = formatKsh(unpaid);
    });

    onValue(outstandingLoansRef, s=>{
      const v = s.exists() ? (typeof s.val() === 'number' ? s.val() : 0) : 0;
      const outEl = document.getElementById('outstandingLoansVal');
      if(outEl) outEl.textContent = formatKsh(v);
    });

    // Loans list (applications)
    const appsRef = ref(db, `members/${currentUid}/loans/applications`);
    onValue(appsRef, snap=>{
      const area = document.getElementById('loansListArea');
      if(!area) return;
      area.innerHTML = '';
      if(!snap.exists()){ area.innerHTML = '<div class="muted">No applications yet</div>'; return; }
      const apps = snap.val();
      const list = document.createElement('div');
      Object.entries(apps).forEach(([id, app])=>{
        const d = document.createElement('div');
        d.style.padding='8px';
        d.style.borderBottom='1px solid #eef6ee';
        d.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>${app.memberName || app.name || app.memberNo || '(Applicant)'}</strong><div style="font-size:0.85rem;color:var(--muted)">Amount: ${formatKsh(app.amountFigures || app.amount || 0)} • Status: ${app.status||'Pending'}</div></div>
          <div style="text-align:right"><small>${new Date(app.appliedAt || app.timestamp || 0).toLocaleString()||''}</small></div>
        </div>`;
        list.appendChild(d);
      });
      area.appendChild(list);
    });

  }); // end auth state

  // ------------------ Loan Application logic ------------------
  const loanForm = document.getElementById('fullLoanForm');
  if (document.getElementById('previewLoanPdf')) {
    document.getElementById('previewLoanPdf').addEventListener('click', (e)=>{
      e.preventDefault();
      if(!loanForm) return;
      const formData = new FormData(loanForm);
      const data = Object.fromEntries(formData.entries());
      const doc = buildLoanPdfDoc(data, {preview:true});
      doc.save(`Loan_Application_PREVIEW.pdf`);
    });
  }

  if (loanForm) {
    loanForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!currentUid) return alert('Not authenticated');
      const agree = document.getElementById('agreeTerms');
      if(!agree || !agree.checked) return alert('Please agree to the terms');

      const formData = new FormData(loanForm);
      const data = Object.fromEntries(formData.entries());
      // add guarantors
      const guarantors = [];
      for(let i=1;i<=3;i++){
        guarantors.push({
          mno: data[`g_mno_${i}`] || '',
          name: data[`g_name_${i}`] || '',
          phone: data[`g_phone_${i}`] || '',
          id: data[`g_id_${i}`] || '',
          group: data[`g_group_${i}`] || '',
          amount: data[`g_amount_${i}`] || ''
        });
      }
      data.guarantors = guarantors;
      // metadata + write to DB if available
      try {
        const appRef = push(ref(db, `members/${currentUid}/loans/applications`));
        const appId = appRef.key;
        data.appliedAt = Date.now();
        data.status = 'Pending';
        await set(appRef, data);
        showToast('Application saved — downloading PDF');
        const doc = buildLoanPdfDoc(data, {id:appId});
        doc.save(`Loan_Application_${(data.memberName || data.name || currentUid).replace(/\s+/g,'_')}_${appId}.pdf`);
      } catch(err){
        console.error(err);
        alert('Failed to save application to the database. PDF will still be generated locally.');
        const doc = buildLoanPdfDoc(data, {});
        doc.save(`Loan_Application_${(data.memberName || data.name || currentUid).replace(/\s+/g,'_')}.pdf`);
      }
    });
  }

  // Build loan PDF function (returns jsPDF doc)
  function buildLoanPdfDoc(data, opts={}){
    const doc = new jsPDF({unit:'pt',format:'a4'});
    const left = 36; let y = 40;
    doc.setFontSize(16); doc.setFont('helvetica','bold');
    doc.text('VISIONARY YOUTH GROUP 2024', 300, y, {align:'center'}); y+=18;
    doc.setFontSize(14); doc.text('LOAN APPLICATION FORM', 300, y, {align:'center'}); y+=18;
    doc.setFontSize(10); doc.setDrawColor(200); doc.line(left, y, 555, y); y+=14;

    // Official header meta
    doc.setFont('helvetica','bold'); doc.setFontSize(10);
    doc.text('SOCIAL PROMOTION REGISTERED TRUSTEES', left, y); doc.setFont('helvetica','normal'); y+=16;
    doc.text(`Loan No: ${opts.id || ''}`, left, y); doc.text(`Applied: ${new Date(data.appliedAt||Date.now()).toLocaleString()}`, 360, y); y+=18;

    // Applicant details block
    doc.setFont('helvetica','bold'); doc.text('APPLICANT INFORMATION', left, y); y+=14;
    doc.setFont('helvetica','normal'); doc.setFontSize(10);
    const lines = [
      `Self-help group: ${data.selfHelpGroup || ''}`,
      `Name: ${data.memberName || data.name || ''}`,
      `Membership No: ${data.membershipNumber || ''}`,
      `National ID/Passport: ${data.nationalId || ''}`,
      `Marital Status: ${data.maritalStatus || ''} • Date of Birth: ${data.dob || ''}`,
      `County/Town: ${data.county || ''} / ${data.town || ''}`,
      `Address: ${data.currentAddress || ''}`,
      `Phone: ${data.phone || ''} • Email: ${data.email || ''}`
    ];
    lines.forEach(line=>{ const wrapped = doc.splitTextToSize(line, 520); doc.text(wrapped, left, y); y += wrapped.length * 12; });

    y+=6;
    // Employment
    doc.setFont('helvetica','bold'); doc.text('EMPLOYMENT INFORMATION (WHERE APPLICABLE)', left, y); y+=14;
    doc.setFont('helvetica','normal');
    const empLines = [
      `Employer: ${data.employer || ''}`,
      `Position: ${data.position || ''}`,
      `Period in current employment: ${data.periodEmployment || ''}`,
      `Employer address: ${data.employerAddress || ''}`,
      `Monthly income: ${data.monthlyIncome || ''}`
    ];
    empLines.forEach(line=>{ const wr = doc.splitTextToSize(line,520); doc.text(wr,left,y); y += wr.length*12; });
    y+=6;

    // Other incomes
    doc.setFont('helvetica','bold'); doc.text('OTHER SOURCES OF INCOME', left, y); y+=14;
    doc.setFont('helvetica','normal');
    const inc = [`1. ${data.income1 || ''}`, `2. ${data.income2 || ''}`, `3. ${data.income3 || ''}`];
    inc.forEach(line=>{ const wr = doc.splitTextToSize(line,520); doc.text(wr,left,y); y += wr.length*12; });
    y+=6;

    // Loan details
    doc.setFont('helvetica','bold'); doc.text('LOAN APPLICATION', left, y); y+=14;
    doc.setFont('helvetica','normal');
    const loanLines = [
      `Amount in figures: Ksh ${data.amountFigures || ''}`,
      `Amount in words: ${data.amountWords || ''}`,
      `Purpose: ${data.purpose || ''}`,
      `Repayable in (months): ${data.repayableMonths || ''}`
    ];
    loanLines.forEach(line=>{ const wr = doc.splitTextToSize(line,520); doc.text(wr,left,y); y+=wr.length*12; });
    y+=8;

    // Other loans / debts
    doc.setFont('helvetica','bold'); doc.text('OTHER LOANS / DEBTS / OBLIGATIONS', left, y); y+=12;
    doc.setFont('helvetica','normal');
    const otherLines = [data.otherLoan1 || '', data.otherLoan2 || ''];
    otherLines.forEach(line=>{ const wr = doc.splitTextToSize(line,520); doc.text(wr,left,y); y+=wr.length*12; });
    y+=8;

    // Guarantors table
    doc.setFont('helvetica','bold'); doc.text('GUARANTORS', left, y); y+=12;
    const colX = [left, 90, 260, 360, 440, 520];
    doc.setFont('helvetica','bold'); doc.setFontSize(9);
    doc.text('M No', colX[0], y); doc.text('Name', colX[1], y); doc.text('Phone', colX[2], y); doc.text('ID No', colX[3], y); doc.text('Group', colX[4], y); doc.text('Amount', colX[5], y); y+=8;
    doc.setFont('helvetica','normal'); doc.setFontSize(9);
    const guars = data.guarantors || [];
    guars.forEach(g=>{
      const row = [g.mno||'', g.name||'', g.phone||'', g.id||'', g.group||'', g.amount||''];
      if(y > 720){ doc.addPage(); y=40; }
      for(let i=0;i<row.length;i++) doc.text(String(row[i]), colX[i], y);
      y+=12;
    });

    y+=10;
    // Terms & signature
    doc.setFont('helvetica','bold'); doc.text('TERMS & CONDITIONS', left, y); y+=12;
    doc.setFont('helvetica','normal'); const terms = (data.terms || '').trim() || 'Applicant confirms they have read and agree to terms described in the system.';
    const wrappedTerms = doc.splitTextToSize(terms,520);
    doc.text(wrappedTerms, left, y); y += wrappedTerms.length*12 + 8;

    // signature placeholders
    if(y > 700){ doc.addPage(); y=40; }
    doc.text('Applicant Signature: ______________________   Date: ___________', left, y); y+=20;
    doc.text('Guarantor Signatures:', left, y); y+=14;
    for(let i=0;i<3;i++){ if(y>740){ doc.addPage(); y=40; } doc.text(`${i+1}. _________________________   ID: ___________   M/No: ______`, left, y); y+=14; }

    return doc;
  }

  // ------------------ Withdrawal form handlers (client-side PDF) ------------------
  const withdrawForm = document.getElementById('withdrawForm');
  if (document.getElementById('previewWithdrawPdf')) {
    document.getElementById('previewWithdrawPdf').addEventListener('click',(e)=>{
      e.preventDefault();
      if(!withdrawForm) return;
      const formData = new FormData(withdrawForm);
      const data = Object.fromEntries(formData.entries());
      const doc = buildWithdrawPdfDoc(data, {preview:true});
      doc.save(`Withdrawal_PREVIEW.pdf`);
    });
  }
  if (withdrawForm) {
    withdrawForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const formData = new FormData(withdrawForm);
      const data = Object.fromEntries(formData.entries());
      const doc = buildWithdrawPdfDoc(data, {submitted:true});
      doc.save(`Withdrawal_${(data.memberName||'Member').replace(/\s+/g,'_')}.pdf`);
    });
  }

  function buildWithdrawPdfDoc(data, opts={}){
    const doc = new jsPDF({unit:'pt',format:'a4'});
    let y = 50, left = 40;

    doc.setFontSize(16).setFont('helvetica','bold');
    doc.text('VISIONARY YOUTH GROUP 2024', 300, y, {align:'center'}); y+=18;
    doc.setFontSize(14).text('VOLUNTARY WITHDRAWABLE SAVINGS FORM', 300, y, {align:'center'}); y+=20;
    doc.setFontSize(10).line(left,y,555,y); y+=20;

    doc.setFont('helvetica','bold').text('Member Information', left, y); y+=14;
    doc.setFont('helvetica','normal');
    const lines = [
      `Name: ${data.memberName||''}`,
      `Membership Number: ${data.membershipNumber||''}`,
      `ID/Passport: ${data.idNumber||''}`,
      `Phone: ${data.phone||''}`,
      `Amount in figures: Ksh ${data.amountFigures||''}`,
      `Amount in words: ${data.amountWords||''}`,
      `Reason: ${data.reason||''}`,
    ];
    lines.forEach(line=>{
      const wrap = doc.splitTextToSize(line, 520);
      doc.text(wrap, left, y);
      y += wrap.length*14;
    });

    y+=20;
    doc.setFont('helvetica','bold').text('Member Signature: ________________________   Date: ____________', left, y); y+=30;
    doc.setFont('helvetica','bold').text('For Official Use Only', left, y); y+=16;
    doc.setFont('helvetica','normal').text('Checked & Approved by: ________________________', left, y);

    return doc;
  }

  // ------------------ Account Statement PDF ------------------
  async function buildAccountStatementPdf(){
    if(!currentUid) return alert('Not signed in');
    // read relevant nodes
    const snapMember = await get(ref(db, `members/${currentUid}`));
    const snapshotMonthly = await get(ref(db, `members/${currentUid}/savings/monthly`));
    const snapshotWeekly = await get(ref(db, `members/${currentUid}/savings/weekly`));
    const loansSnap = await get(ref(db, `members/${currentUid}/loans`));
    const sharesSnap = await get(ref(db, `members/${currentUid}/shares`));

    const doc = new jsPDF({unit:'pt', format:'a4'});
    let left = 36, y = 40;
    doc.setFontSize(16); doc.setFont('helvetica','bold');
    doc.text('VISIONARY YOUTH GROUP', 300, y, {align:'center'}); y += 18;
    doc.setFontSize(12); doc.setFont('helvetica','normal');
    doc.text('Account Statement', 300, y, {align:'center'}); y += 16;
    doc.setLineWidth(0.4); doc.line(left, y, 555, y); y += 14;

    const profile = snapMember.exists() && snapMember.val().profile ? snapMember.val().profile : {};
    doc.text(`Member: ${profile.name || profile.fullName || topEmail.textContent}`, left, y); y += 12;
    doc.text(`Email: ${topEmail.textContent}`, left, y); y += 12;
    doc.text(`Date: ${new Date().toLocaleDateString()}`, left, y); y += 18;

    // Totals
    const monthly = await snapToPrintableAmount(snapshotMonthly);
    const weekly = await snapToPrintableAmount(snapshotWeekly);
    const shares = sharesSnap.exists() ? (sharesSnap.val().total || sharesSnap.val() || 0) : 0;
    const dividends = sharesSnap.exists() ? (sharesSnap.val().dividends || 0) : 0;

    let totalLoans = 0; let unpaid = 0; let appsList = [];
    if(loansSnap.exists()){
      const loansObj = loansSnap.val();
      if(loansObj.summary){
        totalLoans = loansObj.summary.total || 0;
        unpaid = loansObj.summary.unpaid || 0;
      } else {
        Object.values(loansObj).forEach(v=>{
          if(v && typeof v === 'object' && v.amountFigures) { totalLoans += Number(v.amountFigures||0); if((v.status||'').toLowerCase() !== 'paid') unpaid += Number(v.amountFigures||0); appsList.push(v); }
          else if(v && typeof v === 'object' && v.app_amount) { totalLoans += Number(v.app_amount||0); if((v.status||'').toLowerCase() !== 'paid') unpaid += Number(v.app_amount||0); appsList.push(v); }
        });
      }
    }

    // present summary table
    doc.setFont('helvetica','bold'); doc.text('Financial Summary', left, y); y += 14;
    doc.setFont('helvetica','normal');
    doc.text(`Weekly Savings: ${formatKsh(weekly)}`, left, y); y+=12;
    doc.text(`Monthly Savings: ${formatKsh(monthly)}`, left, y); y+=12;
    doc.text(`Shares: ${formatKsh(shares)}`, left, y); y+=12;
    doc.text(`Dividends: ${formatKsh(dividends)}`, left, y); y+=12;
    doc.text(`Total Loans (applied/loan ledger): ${formatKsh(totalLoans)}`, left, y); y+=12;
    doc.text(`Unpaid Balances: ${formatKsh(unpaid)}`, left, y); y+=18;

    // Optional: list recent loan applications
    if(appsList.length){
      doc.setFont('helvetica','bold'); doc.text('Loan Applications (recent)', left, y); y += 14;
      doc.setFont('helvetica','normal');
      appsList.slice(-10).forEach(app=>{
        const line = `${app.memberName || app.name || ''} — ${formatKsh(app.amountFigures || app.app_amount || app.amount || 0)} — ${app.status || 'Pending'}`;
        const wr = doc.splitTextToSize(line, 500);
        doc.text(wr, left, y);
        y += wr.length * 12;
        if(y > 720){ doc.addPage(); y = 40; }
      });
      y+=8;
    }

    // Add signature line
    if(y > 700){ doc.addPage(); y=40; }
    doc.line(left, y+20, left+240, y+20);
    doc.text('Prepared by / Signature', left, y+34);

    return doc;
  }

  // helper to return numeric total for snapshot like monthly/weekly
  async function snapToPrintableAmount(snap){
    if(!snap.exists()) return 0;
    const val = snap.val();
    if(typeof val === 'number' || typeof val === 'string') return Number(val) || 0;
    let total = 0;
    Object.values(val).forEach(child => {
      if(child && typeof child === 'object' && ('amount' in child)) total += Number(child.amount||0);
      else if(typeof child === 'number') total += child;
    });
    return total;
  }

  // account statement download handlers (guarded)
  const downloadStatementTopBtn = document.getElementById('downloadStatementTop');
  if(downloadStatementTopBtn) downloadStatementTopBtn.addEventListener('click', async ()=>{
    const doc = await buildAccountStatementPdf();
    doc.save(`Account_Statement_${(topEmail.textContent||'member').replace(/[^\w@.-]/g,'')}.pdf`);
  });
  const downloadStatementBtn = document.getElementById('downloadStatement');
  if(downloadStatementBtn) downloadStatementBtn.addEventListener('click', async ()=>{
    const doc = await buildAccountStatementPdf();
    doc.save(`Account_Statement_${(topEmail.textContent||'member').replace(/[^\w@.-]/g,'')}.pdf`);
  });
  const profileStatementBtn = document.getElementById('profileStatement');
  if(profileStatementBtn) profileStatementBtn.addEventListener('click', async ()=>{
    const doc = await buildAccountStatementPdf();
    doc.save(`Account_Statement_${(topEmail.textContent||'member').replace(/[^\w@.-]/g,'')}.pdf`);
  });
  const quickStatementBtn = document.getElementById('quickStatement');
  if(quickStatementBtn) quickStatementBtn.addEventListener('click', async ()=>{
    const doc = await buildAccountStatementPdf();
    doc.save(`Account_Statement_${(topEmail.textContent||'member').replace(/[^\w@.-]/g,'')}.pdf`);
  });

  // downloadApplications: compile all user's loan applications to a single pdf
  const downloadAppsBtn = document.getElementById('downloadApplications');
  if(downloadAppsBtn) downloadAppsBtn.addEventListener('click', async ()=>{
    if(!currentUid) return alert('Not signed in');
    const snap = await get(ref(db, `members/${currentUid}/loans/applications`));
    if(!snap.exists()) return alert('No applications found');
    const apps = snap.val();
    const doc = new jsPDF({unit:'pt',format:'a4'}); let y=40; const left=36;
    doc.setFontSize(16); doc.text('Loan Applications',300,y,{align:'center'}); y+=20;
    doc.setFontSize(10);
    for(const [id,app] of Object.entries(apps)){
      const title = `${app.memberName || app.name || ''} — ${formatKsh(app.amountFigures || app.amount || app.app_amount || 0)} — ${app.status||''}`;
      const wrapped = doc.splitTextToSize(title, 520);
      doc.text(wrapped, left, y); y += wrapped.length * 12;
      const details = [
        `Applied: ${new Date(app.appliedAt || app.timestamp || 0).toLocaleString()}`,
        `Purpose: ${app.purpose || app.loanPurpose || ''}`,
        `Guarantors: ${ (app.guarantors || []).map(g=>g.name).filter(Boolean).join('; ') }`
      ];
      details.forEach(d => { const w = doc.splitTextToSize(d,520); doc.text(w, left+8, y); y += w.length * 12; });
      y += 8;
      if(y > 720){ doc.addPage(); y=40; }
    }
    doc.save(`Loan_Applications_${(topEmail.textContent||'member').replace(/[^\w@.-]/g,'')}.pdf`);
  });

  // preview / quick apply handlers
  const quickApplyBtn = document.getElementById('quickApply');
  if(quickApplyBtn) quickApplyBtn.addEventListener('click', ()=> document.getElementById('loan-section').scrollIntoView({behavior:'smooth'}));

  // Profile save
  const saveProfileBtn = document.getElementById('saveProfile');
  if(saveProfileBtn) saveProfileBtn.addEventListener('click', async ()=>{
    if(!currentUid) return alert('Not authenticated');
    if(profileSavedOnce) { showToast('Profile already updated in this session'); return; }
    const payload = {
      name: document.getElementById('profile_fullName').value,
      phone: document.getElementById('profile_phone').value,
      id: document.getElementById('profile_id').value,
      yearJoined: document.getElementById('profile_yearJoined').value,
      dob: document.getElementById('profile_dob').value,
      status: 'Active'
    };
    await set(ref(db, `members/${currentUid}/profile`), payload);
    profileSavedOnce = true;
    showToast('Profile updated');
  });

  // logout via menu
  const menuLogout = document.getElementById('menuLogout');
  if(menuLogout) menuLogout.addEventListener('click', ()=> { try{ signOut(auth); }catch(e){} window.location.href='index.html'; });

</script>

</body>
</html>
