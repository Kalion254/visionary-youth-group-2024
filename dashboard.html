<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Visionary Youth Group — Dashboard</title>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- jsPDF (single include only) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{
    --dark:#164e2a;
    --accent:#2e7d32;
    --gold:#ffcc00;
    --bg1:#e9ffec;
    --card:#ffffff;
    --muted:#6b7280;
  }
  *{box-sizing:border-box}
  body{
    margin:0;font-family:'Poppins',sans-serif;background:linear-gradient(120deg,var(--bg1),#f6fff6);color:#123;
  }

  /* Top bar */
  .topbar{
    position:fixed;left:0;right:0;top:0;height:64px;background:linear-gradient(90deg,var(--dark),#26734d);color:#fff;
    display:flex;align-items:center;justify-content:space-between;padding:0 18px;z-index:1200;
    box-shadow:0 6px 20px rgba(6,50,20,0.12);
  }
  .brand{display:flex;align-items:center;gap:12px}
  .brand h1{font-size:1.05rem;margin:0;font-weight:700}
  .hamburger{font-size:1.6rem;cursor:pointer}
  .user-info{text-align:right;font-size:0.95rem;display:flex;flex-direction:column;align-items:flex-end}
  .user-info small{display:block;color:rgba(255,255,255,0.85)}
  .top-controls{display:flex;gap:12px;align-items:center}
  .avatar {
    width:40px;height:40px;border-radius:8px;background:rgba(255,255,255,0.08);overflow:hidden;border:1px solid rgba(255,255,255,0.06);
    display:flex;align-items:center;justify-content:center;
  }
  .avatar img{width:100%;height:100%;object-fit:cover}

  .points-badge {
    background:rgba(255,255,255,0.12);
    padding:6px 10px;border-radius:999px;font-weight:700;color:#fff;font-size:0.9rem;border:1px solid rgba(255,255,255,0.06)
  }

  /* Menu overlay (compact) */
  .menu{
    position:fixed;top:64px;left:18px;background:rgba(255,255,255,0.98);width:260px;border-radius:8px;padding:8px;
    box-shadow:0 8px 30px rgba(0,0,0,0.12);display:none;z-index:1199;
  }
  .menu a{display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;color:#123;text-decoration:none}
  .menu a:hover{background:#f1fff1}
  .menu hr{border:0;border-top:1px solid #eef7ee;margin:8px 0}

  /* Layout */
  .page{
    max-width:1200px;margin:92px auto 48px;padding:0 18px;
    display:grid;grid-template-columns:repeat(12,1fr);gap:18px;
  }

  /* Hero / summary */
  .hero{grid-column:span 12;background:var(--card);border-radius:12px;padding:16px;display:flex;justify-content:space-between;align-items:center;gap:16px}
  .welcome{display:flex;flex-direction:column}
  .welcome h2{margin:0;color:var(--dark)}
  .quick-actions{display:flex;gap:10px}

  /* cards */
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 8px 20px rgba(6,50,20,0.05);overflow:hidden;}
  .balances-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px}
  .balance{background:linear-gradient(180deg,#f3fff3,#ffffff);padding:12px;border-radius:10px;text-align:center}
  .balance .label{color:var(--muted);font-size:0.95rem}
  .balance .value{font-weight:700;font-size:1.25rem;color:var(--accent);margin-top:8px}

  /* loan application large area */
  .big{grid-column:span 8}
  .side{grid-column:span 4}

  /* form */
  .form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .form-grid .full{grid-column:1/-1}
  input, select, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;font-size:0.95rem}
  textarea{min-height:100px;resize:vertical}
  .btn{background:var(--accent);color:white;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700}
  .btn.secondary{background:#fff;color:var(--accent);border:1px solid #e3f1e3}

  /* hidden sections by default — will be opened from menu */
  .hidden-section{display:none}

  /* Loan stages */
  .stages{display:flex;gap:10px;align-items:center;justify-content:space-between}
  .stage{flex:1;padding:10px;border-radius:8px;background:#f5faf5;text-align:center}
  .stage.active{background:var(--dark);color:white;font-weight:700}
  .stage.done{background:#27ae60;color:white}

  /* guarantors table */
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border:1px solid #e6f0ea;font-size:0.9rem;text-align:left}

  /* responsive */
  @media (max-width:1000px){
    .big{grid-column:span 12}
    .side{grid-column:span 12}
    .form-grid{grid-template-columns:1fr}
    .menu{left:10px;width:calc(100% - 20px)}
  }

  /* small helper styles */
  .muted{color:var(--muted)}
  .status-select{padding:6px;border-radius:6px;border:1px solid #d1d5db}
  .activity-log{max-height:260px;overflow:auto;padding:6px;background:#fbfff9;border-radius:8px}
  .hidden-file{display:none}
</style>
</head>
<body>

  <div class="topbar">
    <div class="brand">
      <i class="fas fa-seedling" style="font-size:1.25rem;color:var(--gold)"></i>
      <h1>Visionary Youth Group</h1>
    </div>

    <div style="display:flex;gap:12px;align-items:center">
      <div class="user-info" style="align-items:flex-end">
        <div id="topEmail">—</div>
        <small id="topStatus">Status: <strong style="color:#9ff2b8">Active</strong></small>
      </div>

      <div class="top-controls" style="margin-left:12px">
        <div class="points-badge" id="pointsDisplay">0 pts</div>
        <div class="avatar" id="topAvatarSmall" title="Your photo / profile">
          <i class="fas fa-user" style="color:#fff"></i>
        </div>
        <button id="downloadStatementTop" title="Download Account Statement" class="btn secondary"><i class="fas fa-file-pdf"></i>&nbsp;Statement</button>
        <i class="fas fa-bars hamburger hamburgerAction" role="button" aria-label="Menu" style="font-size:20px;color:#fff;margin-left:6px"></i>
      </div>
    </div>
  </div>

  <!-- menu (click to open) -->
  <div class="menu" id="menu" aria-hidden="true">
    <a href="#" data-target="overview"><i class="fas fa-home"></i> Overview</a>
    <a href="#" data-target="balancesCard"><i class="fas fa-wallet"></i> Balances</a>
    <a href="#" data-target="loan-section"><i class="fas fa-file-signature"></i> Loan Application</a>
    <a href="#" data-target="withdraw-section"><i class="fas fa-hand-holding-usd"></i> Withdrawable Form</a>
    <a href="#" data-target="loansListFull"><i class="fas fa-money-bill-wave"></i> Loans (Manage)</a>
    <a href="#" data-target="profile-area"><i class="fas fa-user-edit"></i> Update Profile</a>
    <hr />
    <a href="#" id="menuLogout"><i class="fas fa-sign-out-alt"></i> Logout</a>
  </div>

  <main class="page" id="pageRoot">
    <!-- hero -->
    <div class="hero card" id="overview">
      <div class="welcome">
        <h2 id="welcomeName">Welcome, Member</h2>
        <div style="color:var(--muted);margin-top:6px">Quick snapshot — all amounts shown in <strong>Ksh</strong></div>
      </div>
      <div class="quick-actions">
        <button id="quickApply" class="btn"><i class="fas fa-file-signature"></i>&nbsp;Apply Loan</button>
        <button id="quickStatement" class="btn secondary"><i class="fas fa-file-download"></i>&nbsp;Statement</button>
      </div>
    </div>

    <!-- balances summary -->
    <div class="card big" id="balancesCard">
      <h2>Balances</h2>
      <div class="balances-grid">
        <div class="balance"><div class="label">Monthly Savings</div><div class="value" id="monthlyVal">Ksh 0</div></div>
        <div class="balance"><div class="label">Weekly Savings</div><div class="value" id="weeklyVal">Ksh 0</div></div>
        <div class="balance"><div class="label">Shares</div><div class="value" id="sharesVal">Ksh 0</div></div>
        <div class="balance"><div class="label">Dividends</div><div class="value" id="dividendsVal">Ksh 0</div></div>
        <div class="balance"><div class="label">Total Loans</div><div class="value" id="totalLoansVal">Ksh 0</div></div>
        <div class="balance"><div class="label">Unpaid Balances</div><div class="value" id="unpaidVal">Ksh 0</div></div>
        <div class="balance"><div class="label">Outstanding Loans</div><div class="value" id="outstandingLoansVal">Ksh 0</div></div>
      </div>
    </div>

    <!-- loan application big form (hidden until menu click or quickApply) -->
    <section class="card big hidden-section" id="loan-section" aria-labelledby="loanHeading">
      <h2 id="loanHeading"><i class="fas fa-file-signature"></i> Loan Application (Official Form)</h2>

      <form id="fullLoanForm">
        <!-- header -->
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div>
            <div style="font-weight:800">VISIONARY YOUTH GROUP 2024</div>
            <div style="font-weight:700;color:var(--muted)">SOCIAL PROMOTION REGISTERED TRUSTEES</div>
          </div>
          <div style="text-align:right;font-size:0.9rem">
            <div>Loan Number: <span id="loanNoDisplay">—</span></div>
            <div>Serial No: <span id="serialNo">—</span></div>
            <div style="margin-top:8px;font-size:0.8rem"><small>FOR OFFICIAL USE ONLY</small></div>
          </div>
        </div>

        <!-- APPLICANT INFORMATION -->
        <h3>APPLICANT INFORMATION</h3>
        <div class="form-grid">
          <input class="full" name="selfHelpGroup" placeholder="Name of Self-Help Group" required>
          <input name="memberName" placeholder="Name of Applicant" required>
          <input name="membershipNumber" placeholder="Membership Number (M/No)" required>
          <input name="nationalId" placeholder="National ID / Passport No" required>
          <select name="maritalStatus" required>
            <option value="">Marital Status</option>
            <option>Single</option><option>Married</option><option>Widow</option><option>Others</option>
          </select>
          <input name="dob" type="date" placeholder="Date of Birth" required>
          <input name="county" placeholder="County" required>
          <input name="town" placeholder="City / Town" required>
          <input name="currentAddress" placeholder="Current Address" required>
          <input name="areaResidence" placeholder="Area of Residence" required>
          <input name="phone" placeholder="Phone" required>
          <input name="email" type="email" placeholder="E-mail" required>
          <select name="ownedRented">
            <option value="">Owned / Rented</option>
            <option>Owned</option><option>Rented</option>
          </select>
          <input name="monthlyRent" placeholder="Monthly payment or rent">
        </div>

        <!-- EMPLOYMENT -->
        <h3>EMPLOYMENT INFORMATION (WHERE APPLICABLE)</h3>
        <div class="form-grid">
          <input name="employer" placeholder="Current Employer">
          <input name="position" placeholder="Position">
          <input name="periodEmployment" placeholder="Period in Current Employment">
          <input name="employerAddress" placeholder="Employer Address">
          <input name="monthlyIncome" placeholder="Monthly Income (Ksh)" required>
        </div>

        <!-- OTHER SOURCES -->
        <h3>OTHER SOURCES OF INCOME</h3>
        <div class="form-grid">
          <input name="income1" placeholder="Income source 1 (Ksh)">
          <input name="income2" placeholder="Income source 2 (Ksh)">
          <input name="income3" placeholder="Income source 3 (Ksh)">
        </div>

        <!-- LOAN APPLICATION -->
        <h3>LOAN APPLICATION</h3>
        <div class="form-grid">
          <input name="amountFigures" placeholder="Amount Requested (Figures, Ksh)" required>
          <input name="amountWords" placeholder="Amount in words" required>
          <input name="purpose" placeholder="Purpose of the Loan" required>
          <input name="repayableMonths" placeholder="Repayable in monthly instalments (months)" required>
        </div>

        <!-- OTHER LOANS -->
        <h3>OTHER LOANS / DEBTS / OBLIGATIONS</h3>
        <div class="form-grid">
          <input name="otherLoan1" placeholder="Institution / Amount">
          <input name="otherLoan2" placeholder="Institution / Amount">
        </div>

        <!-- GUARANTORS -->
        <h3>GUARANTORS (Fill details, sign after applicant enters amount)</h3>
        <table>
          <thead>
            <tr><th>M No.</th><th>Name in Full</th><th>Cell Phone</th><th>ID No.</th><th>Group Name</th><th>Amount Offered (Ksh)</th></tr>
          </thead>
          <tbody id="guarantorRows">
            <!-- 3 default rows -->
            <tr>
              <td><input name="g_mno_1" placeholder="MNo"></td>
              <td><input name="g_name_1" placeholder="Full name"></td>
              <td><input name="g_phone_1" placeholder="Phone"></td>
              <td><input name="g_id_1" placeholder="ID No"></td>
              <td><input name="g_group_1" placeholder="SHG Name"></td>
              <td><input name="g_amount_1" placeholder="Ksh"></td>
            </tr>
            <tr>
              <td><input name="g_mno_2" placeholder="MNo"></td>
              <td><input name="g_name_2" placeholder="Full name"></td>
              <td><input name="g_phone_2" placeholder="Phone"></td>
              <td><input name="g_id_2" placeholder="ID No"></td>
              <td><input name="g_group_2" placeholder="SHG Name"></td>
              <td><input name="g_amount_2" placeholder="Ksh"></td>
            </tr>
            <tr>
              <td><input name="g_mno_3" placeholder="MNo"></td>
              <td><input name="g_name_3" placeholder="Full name"></td>
              <td><input name="g_phone_3" placeholder="Phone"></td>
              <td><input name="g_id_3" placeholder="ID No"></td>
              <td><input name="g_group_3" placeholder="SHG Name"></td>
              <td><input name="g_amount_3" placeholder="Ksh"></td>
            </tr>
          </tbody>
        </table>

        <!-- TERMS -->
        <h3>TERMS &amp; CONDITIONS — Applicant Commitment</h3>
        <textarea name="terms" readonly>
Please read the full terms on the system: you must have 6 consecutive months savings, savings cover a third of guarantorship, loans above Ksh 10,000 require bank statements, school fees loan evidence required, cancellations fee may apply, CRB checks permitted.
        </textarea>

        <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
          <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="agreeTerms" required> I have read and agree to the Terms & Conditions</label>
          <div style="margin-left:auto;display:flex;gap:8px">
            <button class="btn" type="button" id="previewLoanPdf">Preview PDF</button>
            <button class="btn" type="submit" id="submitLoanBtn">Submit Application & Download PDF</button>
          </div>
        </div>
      </form>
    </section>

    <!-- New Withdrawable Form (hidden) -->
    <section class="card big hidden-section" id="withdraw-section">
      <h2><i class="fas fa-hand-holding-usd"></i> Voluntary Withdrawable Savings Form</h2>

      <form id="withdrawForm">
        <div class="form-grid">
          <input class="full" name="memberName" placeholder="Member Name" required>
          <input name="membershipNumber" placeholder="Membership Number" required>
          <input name="idNumber" placeholder="ID / Passport Number" required>
          <input name="phone" placeholder="Phone Number" required>
          <input name="amountFigures" placeholder="Amount Requested (Figures, Ksh)" required>
          <input name="amountWords" placeholder="Amount in Words" required>
          <input class="full" name="reason" placeholder="Reason for Withdrawal" required>
        </div>

        <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
          <button class="btn" type="button" id="previewWithdrawPdf">Preview PDF</button>
          <button class="btn" type="submit" id="submitWithdrawBtn">Submit & Download PDF</button>
        </div>
      </form>
    </section>

    <!-- loans list full (manage) — hidden by menu -->
    <section class="card side hidden-section" id="loansListFull">
      <h2>Loans & Manage Applications</h2>
      <div id="loansListArea">Loading loans…</div>
      <div id="loansListFullContainer" style="margin-top:12px"></div>
      <hr style="margin:12px 0">
      <div style="display:flex;gap:8px">
        <button id="downloadApplications" class="btn"><i class="fas fa-download"></i>&nbsp;My Applications</button>
        <button id="downloadStatement" class="btn secondary"><i class="fas fa-file-pdf"></i>&nbsp;Download Statement</button>
      </div>
    </section>

    <!-- side quick panel (keeps original content) -->
    <aside class="card side" id="sidePanel">
      <h2>Overview — Quick Actions</h2>

      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <div class="avatar" id="topAvatar" style="width:72px;height:72px;border-radius:10px">
          <i class="fas fa-user" style="color:var(--dark)"></i>
        </div>
        <div style="flex:1">
          <div id="welcomeNameSidebar" style="font-weight:700">Member</div>
          <div id="topEmailSidebar" class="muted" style="font-size:0.9rem">—</div>
        </div>
      </div>

      <div style="margin-top:10px">
        <div style="font-weight:700;margin-bottom:6px">Points</div>
        <div class="activity-log" id="activityLogArea">
          <div id="pointsDetails" style="margin-bottom:8px">Total points: <strong id="pointsTotal">0</strong></div>
        </div>
      </div>

      <hr style="margin:12px 0">
      <div style="display:flex;gap:8px">
        <button id="openProfilePhotoUpload" class="btn secondary"><i class="fas fa-camera"></i>&nbsp;Upload Photo</button>
        <input id="photoUploadInput" type="file" accept="image/*" class="hidden-file">
        <button id="saveProfile" class="btn"><i class="fas fa-save"></i>&nbsp;Save Profile</button>
      </div>
    </aside>

    <!-- profile area (hidden until menu click) -->
    <section class="card hidden-section" id="profile-area">
      <h2><i class="fas fa-user-edit"></i> Update Profile</h2>
      <div class="form-grid" style="margin-top:10px">
        <input class="full" id="profile_fullName" placeholder="Full name">
        <input id="profile_phone" placeholder="Phone">
        <input id="profile_id" placeholder="ID Number">
        <input id="profile_yearJoined" placeholder="Year Joined (e.g. 2021)">
        <input id="profile_dob" type="date" placeholder="Date of Birth">
      </div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="saveProfileBtn" class="btn">Save Profile</button>
        <button id="profileStatement" class="btn secondary">Account Statement</button>
      </div>
    </section>

  </main>

  <div id="toast" style="position:fixed;right:18px;bottom:18px;background:#28a745;color:#fff;padding:10px 14px;border-radius:8px;display:none;z-index:2000"></div>

<script type="module">
  // Firebase imports (modular)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getDatabase, ref, onValue, get, push, set } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
  import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

  // jsPDF available via window.jspdf (loaded in head)
  const { jsPDF } = window.jspdf;

  // CONFIG: use your firebase config or existing one
  const firebaseConfig = {
    apiKey: "AIzaSyA_OCu7HQ5HCH2OYx5dQ2Z1r7YPwQJave4",
    authDomain: "visionary-youth-grou-2024.firebaseapp.com",
    databaseURL: "https://visionary-youth-grou-2024-default-rtdb.firebaseio.com",
    projectId: "visionary-youth-grou-2024",
    storageBucket: "visionary-youth-grou-2024.appspot.com",
    messagingSenderId: "372978592717",
    appId: "1:372978592717:web:1c15aec728ee5f854f3284"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const storage = getStorage(app);

  // UI refs
  const hamburger = document.querySelector('.hamburgerAction');
  const menu = document.getElementById('menu');
  const toast = document.getElementById('toast');
  const topEmail = document.getElementById('topEmail');
  const welcomeName = document.getElementById('welcomeName');
  const topAvatar = document.getElementById('topAvatar');
  const topAvatarSmall = document.getElementById('topAvatarSmall');
  const pointsDisplay = document.getElementById('pointsDisplay');
  const pointsTotalEl = document.getElementById('pointsTotal');
  const welcomeNameSidebar = document.getElementById('welcomeNameSidebar');
  const topEmailSidebar = document.getElementById('topEmailSidebar');
  const activityLogArea = document.getElementById('activityLogArea');

  // helpers
  function showToast(msg, timeout=3000){
    toast.textContent = msg; toast.style.display='block';
    setTimeout(()=> toast.style.display='none', timeout);
  }

  function formatKsh(n){
    const num = Number(n||0);
    return 'Ksh ' + num.toLocaleString('en-KE');
  }

  // menu toggles
  if (hamburger) {
    hamburger.addEventListener('click', ()=> {
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    });
  }

  // Hide all sections that should be hidden initially
  function hideAllManagedSections(){
    document.querySelectorAll('.hidden-section').forEach(el=> el.style.display = 'none');
  }
  hideAllManagedSections(); // keep the hidden sections hidden by default

  // menu links: reveal section and scroll into view
  menu.querySelectorAll('a[data-target]').forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      const target = a.dataset.target;
      const el = document.getElementById(target);
      if(el){
        // hide previous managed ones, show the chosen one
        hideAllManagedSections();
        el.style.display = (el.classList.contains('side') ? 'block' : 'block');
        // close menu on small screens too
        menu.style.display = 'none';
        // scroll to element
        setTimeout(()=> el.scrollIntoView({behavior:'smooth', block:'start'}), 80);
      }
    });
  });

  // Quick apply behavior: reveal loan section if hidden
  const quickApplyBtn = document.getElementById('quickApply');
  if(quickApplyBtn) quickApplyBtn.addEventListener('click', ()=>{
    const loanSection = document.getElementById('loan-section');
    if(loanSection){
      hideAllManagedSections();
      loanSection.style.display = 'block';
      loanSection.scrollIntoView({behavior:'smooth', block:'start'});
    }
  });

  // Auto logout (3 minutes)
  let logoutTimer;
  function resetLogoutTimer(){ 
    clearTimeout(logoutTimer); 
    logoutTimer = setTimeout(()=>{ 
      try { signOut(auth); } catch(e){} 
      alert('Logged out due to inactivity'); 
      location.href='index.html'; 
    }, 3*60*1000); 
  }
  ['mousemove','keydown','click','touchstart'].forEach(ev=> window.addEventListener(ev, resetLogoutTimer));

  // Points helpers (store per-member under members/{uid}/points)
  async function getPoints(){
    if(!currentUid) return 0;
    const snap = await get(ref(db, `members/${currentUid}/points`));
    return snap.exists()? Number(snap.val()||0) : 0;
  }
  async function setPoints(n){
    if(!currentUid) return;
    await set(ref(db, `members/${currentUid}/points`), Number(n) || 0);
    const p = Number(n) || 0;
    if(pointsDisplay) pointsDisplay.textContent = `${p} pts`;
    if(pointsTotalEl) pointsTotalEl.textContent = String(p);
  }
  async function awardPoints(n, reason=''){
    if(!currentUid || !n) return;
    const current = await getPoints();
    const updated = (Number(current)||0) + Number(n);
    await setPoints(updated);
    showToast(`+${n} points`);
    logActivity(`Points +${n} (${reason})`);
  }

  // log activity in RTDB and show in activity panel
  async function logActivity(msg){
    if(!currentUid) return;
    const t = Date.now();
    const item = { ts: t, text: msg };
    // push an activity entry (keeps short)
    try{
      const aRef = push(ref(db, `members/${currentUid}/activity`));
      await set(aRef, item);
    }catch(e){ console.warn('Activity push failed', e) }
    // also show locally in activity area
    appendActivityLocal(item);
  }
  function appendActivityLocal(item){
    try{
      if(!activityLogArea) return;
      const el = document.createElement('div');
      el.style.marginBottom = '6px';
      el.innerHTML = `<div style="font-size:0.85rem">${new Date(item.ts).toLocaleString()}</div><div style="font-size:0.95rem">${item.text}</div>`;
      activityLogArea.prepend(el);
    }catch(e){}
  }

  // Defensive element getters for elements that might not exist
  const loanBalanceEl = document.getElementById('loanBalance');
  const loanBalance2El = document.getElementById('loanBalance2');

  // Global auth variable
  let currentUid = null;
  let profileSavedOnce = false;

  // AUTH state: load data and wire listeners
  onAuthStateChanged(auth, async user => {
    if(!user) { location.href='index.html'; return; }
    currentUid = user.uid;
    topEmail.textContent = user.email || '—';
    welcomeName.textContent = (user.email || 'Member').split('@')[0];
    welcomeNameSidebar.textContent = welcomeName.textContent;
    topEmailSidebar.textContent = user.email || '—';
    resetLogoutTimer();
    awardPoints(10, 'Logged in'); // small login bonus

    // load profile
    onValue(ref(db, `members/${currentUid}/profile`), snap=>{
      if(snap.exists()){
        const p = snap.val();
        if(p.name){ document.getElementById('welcomeName').textContent = p.name; if(welcomeNameSidebar) welcomeNameSidebar.textContent = p.name; }
        if(p.name) document.getElementById('profile_fullName').value = p.name;
        if(p.phone) document.getElementById('profile_phone').value = p.phone;
        if(p.id) document.getElementById('profile_id').value = p.id;
        if(p.yearJoined) document.getElementById('profile_yearJoined').value = p.yearJoined;
        if(p.dob) document.getElementById('profile_dob').value = p.dob;
        if(p.status) document.getElementById('topStatus').innerHTML = `Status: <strong style="color:#9ff2b8">${p.status}</strong>`;
      }
    });

    // profile photo: get url if exists
    const photoSnap = await get(ref(db, `members/${currentUid}/photoURL`));
    if(photoSnap && photoSnap.exists()){
      const url = photoSnap.val();
      setAvatar(url);
    }

    // Balances references (preserve original reading semantics)
    const monthlyRef = ref(db, `members/${currentUid}/savings/monthly`);
    const weeklyRef = ref(db, `members/${currentUid}/savings/weekly`);
    const sharesRef = ref(db, `members/${currentUid}/shares/total`);
    const dividendsRef = ref(db, `members/${currentUid}/shares/dividends`);
    const unpaidRef = ref(db, `members/${currentUid}/unpaidBalances`);
    const loansTotalsRef = ref(db, `members/${currentUid}/loans/summary`);
    const outstandingLoansRef = ref(db, `members/${currentUid}/outstandingLoans`);

    async function snapToAmount(snap){
      if(!snap.exists()) return 0;
      const val = snap.val();
      if(typeof val === 'number' || typeof val === 'string') return Number(val) || 0;
      let total = 0;
      Object.values(val).forEach(child=>{
        if(child && typeof child === 'object' && ('amount' in child)) total += Number(child.amount||0);
        else if(typeof child === 'number') total += child;
        else if(typeof child === 'object' && !('amount' in child)){
          Object.values(child).forEach(c2=>{ if(c2 && typeof c2 === 'object' && ('amount' in c2)) total += Number(c2.amount||0); });
        }
      });
      return total;
    }

    onValue(monthlyRef, async s=>{ const v = await snapToAmount(s); const el = document.getElementById('monthlyVal'); if(el) el.textContent = formatKsh(v); });
    onValue(weeklyRef, async s=>{ const v = await snapToAmount(s); const el = document.getElementById('weeklyVal'); if(el) el.textContent = formatKsh(v); });
    onValue(sharesRef, s=>{ const v = s.exists()? Number(s.val()||0) : 0; const el = document.getElementById('sharesVal'); if(el) el.textContent = formatKsh(v); });
    onValue(dividendsRef, s=>{ const v = s.exists()? Number(s.val()||0) : 0; const el = document.getElementById('dividendsVal'); if(el) el.textContent = formatKsh(v); });
    onValue(unpaidRef, s=>{ const v = s.exists()? Number(s.val()||0) : 0; const el = document.getElementById('unpaidVal'); if(el) el.textContent = formatKsh(v); });

    onValue(loansTotalsRef, s=>{
      const obj = s.exists()? s.val() : {total:0,unpaid:0};
      const total = obj.total || 0; const unpaid = obj.unpaid || 0;
      const totalEl = document.getElementById('totalLoansVal'); if(totalEl) totalEl.textContent = formatKsh(total);
      if(loanBalanceEl) loanBalanceEl.textContent = formatKsh(unpaid);
      if(loanBalance2El) loanBalance2El.textContent = formatKsh(unpaid);
    });

    onValue(outstandingLoansRef, s=>{
      const v = s.exists() ? (typeof s.val() === 'number' ? s.val() : 0) : 0;
      const outEl = document.getElementById('outstandingLoansVal'); if(outEl) outEl.textContent = formatKsh(v);
    });

    // load applications and render with status update dropdown
    const appsRef = ref(db, `members/${currentUid}/loans/applications`);
    onValue(appsRef, snap=>{
      const area = document.getElementById('loansListArea');
      const areaFull = document.getElementById('loansListFullContainer');
      if(area) area.innerHTML = '';
      if(areaFull) areaFull.innerHTML = '';
      if(!snap.exists()){
        if(area) area.innerHTML = '<div class="muted">No applications yet</div>';
        if(areaFull) areaFull.innerHTML = '<div class="muted">No applications yet</div>';
        return;
      }
      const apps = snap.val();
      const list = document.createElement('div');
      const listFull = document.createElement('div');

      Object.entries(apps).forEach(([id, app])=>{
        const short = document.createElement('div');
        short.style.padding='8px';
        short.style.borderBottom='1px solid #eef6ee';
        short.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>${app.memberName || app.name || '(Applicant)'}</strong><div style="font-size:0.85rem;color:var(--muted)">Amount: ${formatKsh(app.amountFigures || app.amount || 0)} • Status: ${app.status||'Pending'}</div></div>
          <div style="text-align:right"><small>${new Date(app.appliedAt || 0).toLocaleString()||''}</small></div>
        </div>`;
        list.appendChild(short);

        // full list entry with status control
        const fullEntry = document.createElement('div');
        fullEntry.style.padding='8px';
        fullEntry.style.borderBottom='1px solid #eef6ee';
        const status = app.status || 'Pending';
        fullEntry.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:12px;align-items:center">
            <div style="flex:1">
              <div style="font-weight:700">${app.memberName || app.name || '(Applicant)'}</div>
              <div class="muted" style="font-size:0.9rem">Amount: ${formatKsh(app.amountFigures || app.amount || 0)} • Applied: ${new Date(app.appliedAt || 0).toLocaleString()}</div>
              <div style="margin-top:6px">${(app.purpose||'')}</div>
            </div>
            <div style="min-width:220px;display:flex;flex-direction:column;gap:6px;align-items:flex-end">
              <select class="status-select" data-app-id="${id}">
                <option ${status==='Pending'?'selected':''}>Pending</option>
                <option ${status==='Approved'?'selected':''}>Approved</option>
                <option ${status==='Disbursed'?'selected':''}>Disbursed</option>
                <option ${status==='Paid'?'selected':''}>Paid</option>
                <option ${status==='Rejected'?'selected':''}>Rejected</option>
              </select>
              <small class="muted">Change status (updates RTDB)</small>
            </div>
          </div>
        `;
        listFull.appendChild(fullEntry);
      });

      if(area) area.appendChild(list);
      if(areaFull) areaFull.appendChild(listFull);

      // attach change listeners for status selects
      document.querySelectorAll('.status-select').forEach(sel=>{
        sel.addEventListener('change', async (e)=>{
          const appId = sel.dataset.appId;
          const newStatus = sel.value;
          try{
            await set(ref(db, `members/${currentUid}/loans/applications/${appId}/status`), newStatus);
            showToast('Status updated');
            logActivity(`Application ${appId} status -> ${newStatus}`);
            awardPoints(3, 'Updated application status');
          }catch(err){ console.error(err); alert('Failed to update status'); }
        });
      });
    });

    // display points
    const ptsSnap = await get(ref(db, `members/${currentUid}/points`));
    const pts = ptsSnap.exists()? Number(ptsSnap.val()||0) : 0;
    if(pointsDisplay) pointsDisplay.textContent = `${pts} pts`;
    if(pointsTotalEl) pointsTotalEl.textContent = String(pts);

    // load recent activity entries (show top 10)
    const aSnap = await get(ref(db, `members/${currentUid}/activity`));
    if(aSnap && aSnap.exists()){
      const activities = aSnap.val();
      const entries = Object.values(activities).sort((a,b)=>b.ts - a.ts).slice(0,10);
      entries.forEach(e => appendActivityLocal(e));
    }

  }); // end onAuthStateChanged

  // ------------------ Loan Application logic & PDF ------------------
  const loanForm = document.getElementById('fullLoanForm');
  if (document.getElementById('previewLoanPdf')) {
    document.getElementById('previewLoanPdf').addEventListener('click', (e)=>{
      e.preventDefault();
      if(!loanForm) return;
      const formData = new FormData(loanForm);
      const data = Object.fromEntries(formData.entries());
      const doc = buildLoanPdfDoc(data, {preview:true});
      doc.save(`Loan_Application_PREVIEW.pdf`);
      awardPoints(2, 'Previewed loan PDF');
    });
  }

  if(loanForm){
    loanForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!currentUid) return alert('Not authenticated');
      const agree = document.getElementById('agreeTerms');
      if(!agree || !agree.checked) return alert('Please agree to the terms');

      const formData = new FormData(loanForm);
      const data = Object.fromEntries(formData.entries());
      const guarantors = [];
      for(let i=1;i<=3;i++){
        guarantors.push({
          mno: data[`g_mno_${i}`] || '',
          name: data[`g_name_${i}`] || '',
          phone: data[`g_phone_${i}`] || '',
          id: data[`g_id_${i}`] || '',
          group: data[`g_group_${i}`] || '',
          amount: data[`g_amount_${i}`] || ''
        });
      }
      data.guarantors = guarantors;
      data.appliedAt = Date.now();
      data.status = 'Pending';

      try{
        const appRef = push(ref(db, `members/${currentUid}/loans/applications`));
        const appId = appRef.key;
        await set(appRef, data);
        showToast('Application saved — downloading PDF');
        awardPoints(10, 'Submitted loan application');
        const doc = buildLoanPdfDoc(data, {id: appId});
        doc.save(`Loan_Application_${(data.memberName || data.name || currentUid).replace(/\s+/g,'_')}_${appId}.pdf`);
      }catch(err){
        console.error(err);
        alert('Failed to save application to DB. PDF will be generated locally.');
        const doc = buildLoanPdfDoc(data, {});
        doc.save(`Loan_Application_${(data.memberName || data.name || currentUid).replace(/\s+/g,'_')}.pdf`);
      }
    });
  }

  // Build loan PDF with a modern header
  function buildLoanPdfDoc(data, opts={}){
    const doc = new jsPDF({unit:'pt',format:'a4'});
    let y = 40; const left = 36;

    // header block with accent bar
    doc.setFillColor(46,125,50); // --accent
    doc.rect(0,0,595,60,'F');
    doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255); doc.setFontSize(16);
    doc.text('VISIONARY YOUTH GROUP', 300, 36, {align:'center'});
    doc.setTextColor(0,0,0);

    y = 80;
    doc.setFontSize(12); doc.setFont('helvetica','bold');
    doc.text('LOAN APPLICATION FORM', 300, y, {align:'center'}); y += 16;
    doc.setLineWidth(0.5); doc.line(left, y, 555, y); y += 14;

    // meta
    doc.setFontSize(10); doc.setFont('helvetica','bold');
    doc.text('APPLICANT INFORMATION', left, y); y+=12;
    doc.setFont('helvetica','normal'); const info = [
      `Self-help group: ${data.selfHelpGroup||''}`,
      `Name: ${data.memberName||''}`,
      `Membership No: ${data.membershipNumber||''}`,
      `National ID/Passport: ${data.nationalId||''}`,
      `Marital Status: ${data.maritalStatus||''} • DOB: ${data.dob||''}`,
      `County/Town: ${data.county||''} / ${data.town||''}`,
      `Address: ${data.currentAddress||''}`,
      `Phone: ${data.phone||''} • Email: ${data.email||''}`
    ];
    info.forEach(line=>{
      const wrap = doc.splitTextToSize(line, 520);
      doc.text(wrap, left, y); y += wrap.length * 12;
    });

    y += 6;
    doc.setFont('helvetica','bold'); doc.text('LOAN DETAILS', left, y); y+=12;
    doc.setFont('helvetica','normal');
    const loanLines = [
      `Amount: Ksh ${data.amountFigures||''} (${data.amountWords||''})`,
      `Purpose: ${data.purpose||''}`,
      `Repayable (months): ${data.repayableMonths||''}`
    ];
    loanLines.forEach(line=>{ const wr = doc.splitTextToSize(line,520); doc.text(wr,left,y); y += wr.length*12; });

    y+=8;
    doc.setFont('helvetica','bold'); doc.text('GUARANTORS', left, y); y+=10;
    doc.setFont('helvetica','normal'); doc.setFontSize(9);
    const guars = data.guarantors || [];
    guars.forEach(g=>{
      const row = `${g.mno||''} • ${g.name||''} • ${g.phone||''} • ID:${g.id||''} • ${g.group||''} • Ksh ${g.amount||''}`;
      const wr = doc.splitTextToSize(row,520);
      doc.text(wr,left,y); y += wr.length*12;
      if(y > 720){ doc.addPage(); y = 40; }
    });

    y += 8;
    doc.setFontSize(9); const terms = (data.terms||'').trim() || 'Applicant confirms they have read and agree to terms described in the system.';
    const tw = doc.splitTextToSize(terms, 520);
    doc.text(tw, left, y); y += tw.length*12;

    if(y > 700){ doc.addPage(); y=40; }
    doc.setFont('helvetica','bold'); doc.text('Applicant Signature: ______________________   Date: ___________', left, y);
    return doc;
  }

  // ------------------ Withdrawal handlers & PDF ------------------
  const withdrawForm = document.getElementById('withdrawForm');
  if (document.getElementById('previewWithdrawPdf')) {
    document.getElementById('previewWithdrawPdf').addEventListener('click',(e)=>{
      e.preventDefault();
      if(!withdrawForm) return;
      const formData = new FormData(withdrawForm);
      const data = Object.fromEntries(formData.entries());
      const doc = buildWithdrawPdfDoc(data, {preview:true});
      doc.save(`Withdrawal_PREVIEW.pdf`);
      awardPoints(2, 'Previewed withdrawal PDF');
    });
  }
  if(withdrawForm){
    withdrawForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const formData = new FormData(withdrawForm);
      const data = Object.fromEntries(formData.entries());
      const doc = buildWithdrawPdfDoc(data, {submitted:true});
      doc.save(`Withdrawal_${(data.memberName||'Member').replace(/\s+/g,'_')}.pdf`);
      awardPoints(6, 'Submitted withdrawal');
    });
  }
  function buildWithdrawPdfDoc(data, opts={}){
    const doc = new jsPDF({unit:'pt',format:'a4'});
    let y = 50, left = 40;
    doc.setFillColor(46,125,50); doc.rect(0,0,595,56,'F');
    doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255); doc.setFontSize(14);
    doc.text('VOLUNTARY WITHDRAWABLE SAVINGS FORM', 300, 36, {align:'center'});
    doc.setTextColor(0,0,0);
    y = 80;
    doc.setFont('helvetica','bold'); doc.text('Member Information', left, y); y+=14;
    doc.setFont('helvetica','normal'); const lines = [
      `Name: ${data.memberName||''}`,
      `Membership Number: ${data.membershipNumber||''}`,
      `ID/Passport: ${data.idNumber||''}`,
      `Phone: ${data.phone||''}`,
      `Amount in figures: Ksh ${data.amountFigures||''}`,
      `Amount in words: ${data.amountWords||''}`,
      `Reason: ${data.reason||''}`,
    ];
    lines.forEach(line=>{ const wrap = doc.splitTextToSize(line,520); doc.text(wrap,left,y); y += wrap.length*14; });
    y+=18;
    doc.setFont('helvetica','bold'); doc.text('Member Signature: ________________________   Date: ____________', left, y);
    return doc;
  }

  // ------------------ Account Statement PDF ------------------
  async function buildAccountStatementPdf(){
    if(!currentUid) return alert('Not signed in');
    const snapMember = await get(ref(db, `members/${currentUid}`));
    const snapshotMonthly = await get(ref(db, `members/${currentUid}/savings/monthly`));
    const snapshotWeekly = await get(ref(db, `members/${currentUid}/savings/weekly`));
    const loansSnap = await get(ref(db, `members/${currentUid}/loans`));
    const sharesSnap = await get(ref(db, `members/${currentUid}/shares`));

    const doc = new jsPDF({unit:'pt', format:'a4'});
    let left = 36, y = 40;
    doc.setFillColor(46,125,50); doc.rect(0,0,595,56,'F');
    doc.setTextColor(255,255,255); doc.setFont('helvetica','bold'); doc.setFontSize(16);
    doc.text('ACCOUNT STATEMENT', 300, 36, {align:'center'});
    doc.setTextColor(0,0,0);
    y = 80;
    const profile = snapMember.exists() && snapMember.val().profile ? snapMember.val().profile : {};
    doc.setFontSize(10); doc.setFont('helvetica','normal');
    doc.text(`Member: ${profile.name || profile.fullName || topEmail.textContent}`, left, y); y+=12;
    doc.text(`Email: ${topEmail.textContent}`, left, y); y+=12;
    doc.text(`Date: ${new Date().toLocaleDateString()}`, left, y); y+=18;

    // Totals:
    function calcSnap(snap){
      if(!snap.exists()) return 0;
      const val = snap.val();
      if(typeof val === 'number' || typeof val === 'string') return Number(val)||0;
      let total = 0; Object.values(val).forEach(child=>{ if(child && typeof child === 'object' && ('amount' in child)) total += Number(child.amount||0); else if(typeof child === 'number') total += child; });
      return total;
    }
    const monthly = calcSnap(snapshotMonthly);
    const weekly = calcSnap(snapshotWeekly);
    const shares = sharesSnap.exists()? (sharesSnap.val().total || sharesSnap.val() || 0) : 0;
    const dividends = sharesSnap.exists()? (sharesSnap.val().dividends || 0) : 0;

    let totalLoans = 0, unpaid = 0, appsList = [];
    if(loansSnap.exists()){
      const loansObj = loansSnap.val();
      if(loansObj.summary){
        totalLoans = loansObj.summary.total || 0; unpaid = loansObj.summary.unpaid || 0;
      } else {
        Object.values(loansObj).forEach(v=>{
          if(v && typeof v === 'object' && v.amountFigures) { totalLoans += Number(v.amountFigures||0); if((v.status||'').toLowerCase() !== 'paid') unpaid += Number(v.amountFigures||0); appsList.push(v); }
        });
      }
    }

    doc.setFont('helvetica','bold'); doc.text('Financial Summary', left, y); y+=14;
    doc.setFont('helvetica','normal');
    doc.text(`Weekly Savings: ${formatKsh(weekly)}`, left, y); y+=12;
    doc.text(`Monthly Savings: ${formatKsh(monthly)}`, left, y); y+=12;
    doc.text(`Shares: ${formatKsh(shares)}`, left, y); y+=12;
    doc.text(`Dividends: ${formatKsh(dividends)}`, left, y); y+=12;
    doc.text(`Total Loans: ${formatKsh(totalLoans)}`, left, y); y+=12;
    doc.text(`Unpaid Balances: ${formatKsh(unpaid)}`, left, y); y+=18;

    if(appsList.length){
      doc.setFont('helvetica','bold'); doc.text('Loan Applications (recent)', left, y); y += 14;
      doc.setFont('helvetica','normal');
      appsList.slice(-10).forEach(app=>{
        const line = `${app.memberName || app.name || ''} — ${formatKsh(app.amountFigures || 0)} — ${app.status || 'Pending'}`;
        const wr = doc.splitTextToSize(line, 500); doc.text(wr,left,y); y += wr.length*12;
        if(y > 720){ doc.addPage(); y=40; }
      });
      y+=8;
    }
    if(y > 700){ doc.addPage(); y=40; }
    doc.line(left, y+20, left+240, y+20); doc.text('Prepared by / Signature', left, y+34);
    return doc;
  }

  // account statement button handlers
  const downloadStatementTopBtn = document.getElementById('downloadStatementTop');
  if(downloadStatementTopBtn) downloadStatementTopBtn.addEventListener('click', async ()=>{
    const doc = await buildAccountStatementPdf();
    doc.save(`Account_Statement_${(topEmail.textContent||'member').replace(/[^\w@.-]/g,'')}.pdf`);
    awardPoints(4, 'Downloaded account statement');
  });
  const downloadStatementBtn = document.getElementById('downloadStatement');
  if(downloadStatementBtn) downloadStatementBtn.addEventListener('click', async ()=>{
    const doc = await buildAccountStatementPdf();
    doc.save(`Account_Statement_${(topEmail.textContent||'member').replace(/[^\w@.-]/g,'')}.pdf`);
    awardPoints(4, 'Downloaded account statement');
  });
  const profileStatementBtn = document.getElementById('profileStatement');
  if(profileStatementBtn) profileStatementBtn.addEventListener('click', async ()=>{
    const doc = await buildAccountStatementPdf();
    doc.save(`Account_Statement_${(topEmail.textContent||'member').replace(/[^\w@.-]/g,'')}.pdf`);
    awardPoints(4, 'Downloaded account statement');
  });
  const quickStatementBtn = document.getElementById('quickStatement');
  if(quickStatementBtn) quickStatementBtn.addEventListener('click', async ()=>{
    const doc = await buildAccountStatementPdf();
    doc.save(`Account_Statement_${(topEmail.textContent||'member').replace(/[^\w@.-]/g,'')}.pdf`);
    awardPoints(4, 'Downloaded account statement');
  });

  // downloadApplications (compile user's apps)
  const downloadAppsBtn = document.getElementById('downloadApplications');
  if(downloadAppsBtn) downloadAppsBtn.addEventListener('click', async ()=>{
    if(!currentUid) return alert('Not signed in');
    const snap = await get(ref(db, `members/${currentUid}/loans/applications`));
    if(!snap.exists()) return alert('No applications found');
    const apps = snap.val();
    const doc = new jsPDF({unit:'pt',format:'a4'}); let y=40; const left=36;
    doc.setFontSize(16); doc.text('Loan Applications',300,y,{align:'center'}); y+=20;
    doc.setFontSize(10);
    for(const [id,app] of Object.entries(apps)){
      const title = `${app.memberName || app.name || ''} — ${formatKsh(app.amountFigures || 0)} — ${app.status||''}`;
      const wrapped = doc.splitTextToSize(title, 520);
      doc.text(wrapped, left, y); y += wrapped.length * 12;
      const details = [
        `Applied: ${new Date(app.appliedAt || 0).toLocaleString()}`,
        `Purpose: ${app.purpose || ''}`,
        `Guarantors: ${ (app.guarantors || []).map(g=>g.name).filter(Boolean).join('; ') }`
      ];
      details.forEach(d => { const w = doc.splitTextToSize(d,520); doc.text(w, left+8, y); y += w.length * 12; });
      y += 8;
      if(y > 720){ doc.addPage(); y=40; }
    }
    doc.save(`Loan_Applications_${(topEmail.textContent||'member').replace(/[^\w@.-]/g,'')}.pdf`);
    awardPoints(6, 'Downloaded applications PDF');
  });

  // Save profile (and optionally upload photo) — from side panel
  const saveProfileBtn = document.getElementById('saveProfileBtn');
  if(saveProfileBtn) saveProfileBtn.addEventListener('click', async ()=>{
    if(!currentUid) return alert('Not authenticated');
    if(profileSavedOnce) { showToast('Profile already updated in this session'); return; }
    const payload = {
      name: document.getElementById('profile_fullName').value,
      phone: document.getElementById('profile_phone').value,
      id: document.getElementById('profile_id').value,
      yearJoined: document.getElementById('profile_yearJoined').value,
      dob: document.getElementById('profile_dob').value,
      status: 'Active'
    };
    await set(ref(db, `members/${currentUid}/profile`), payload);
    profileSavedOnce = true;
    showToast('Profile updated');
    awardPoints(5, 'Updated profile');
  });

  // The saveProfile button in side panel (keeps older id)
  const saveProfileBtnLegacy = document.getElementById('saveProfile');
  if(saveProfileBtnLegacy) saveProfileBtnLegacy.addEventListener('click', async ()=>{
    if(!currentUid) return alert('Not authenticated');
    if(profileSavedOnce) { showToast('Profile already updated in this session'); return; }
    const payload = {
      name: document.getElementById('profile_fullName').value,
      phone: document.getElementById('profile_phone').value,
      id: document.getElementById('profile_id').value,
      yearJoined: document.getElementById('profile_yearJoined').value,
      dob: document.getElementById('profile_dob').value,
      status: 'Active'
    };
    await set(ref(db, `members/${currentUid}/profile`), payload);
    profileSavedOnce = true;
    showToast('Profile updated');
    awardPoints(5, 'Updated profile');
  });

  // Photo upload handling (storage)
  const photoInput = document.getElementById('photoUploadInput');
  const openPhotoUploadBtn = document.getElementById('openProfilePhotoUpload');
  if(openPhotoUploadBtn && photoInput){
    openPhotoUploadBtn.addEventListener('click', ()=> photoInput.click());
  }
  if(photoInput){
    photoInput.addEventListener('change', async (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      if(!currentUid) return alert('Not signed in');
      const path = `members/${currentUid}/photo_${Date.now()}`;
      const sRef = storageRef(storage, path);
      try{
        await uploadBytes(sRef, file);
        const url = await getDownloadURL(sRef);
        // store URL in RTDB for easy retrieval
        await set(ref(db, `members/${currentUid}/photoURL`), url);
        setAvatar(url);
        showToast('Photo uploaded');
        awardPoints(4, 'Uploaded profile photo');
      }catch(err){
        console.error(err); alert('Photo upload failed');
      }
    });
  }

  function setAvatar(url){
    const html = `<img src="${url}" alt="avatar">`;
    if(topAvatar) topAvatar.innerHTML = html;
    if(topAvatarSmall) topAvatarSmall.innerHTML = html;
  }

  // small utility: set initial avatar (blank)
  if(topAvatar) topAvatar.innerHTML = '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:var(--dark)"> <i class="fas fa-user"></i> </div>';
  if(topAvatarSmall) topAvatarSmall.innerHTML = '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#fff"> <i class="fas fa-user"></i> </div>';

  // award some points on page actions (e.g., opening loan or withdrawal)
  document.querySelectorAll('[data-target]').forEach(a=>{
    a.addEventListener('click', ()=> awardPoints(1, `Visited ${a.dataset.target}`));
  });

  // Logout via menu
  const menuLogout = document.getElementById('menuLogout');
  if(menuLogout) menuLogout.addEventListener('click', ()=> { try{ signOut(auth); }catch(e){} window.location.href='index.html'; });

  // initial small activity
  logActivity('Dashboard loaded');

</script>

</body>
</html>
