<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Visionary Youth Group — Final Dashboard</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons (Heroicons / FontAwesome minimal used) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

  <style>
    /* small extra styles */
    .card { background: white; border-radius: 12px; box-shadow: 0 8px 30px rgba(2,6,23,0.06); }
    .badge { padding: .25rem .5rem; border-radius: 9999px; font-weight:600; font-size:.75rem; display:inline-block; }
    .status-pending{ background:#fff7ed; color:#92400e; }
    .status-approved{ background:#ecfdf5; color:#065f46; }
    .status-rejected{ background:#fff1f2; color:#9f1239; }
    .sidebar-collapsed { width:72px !important; }
    .wiz-step { display:none; }
    .wiz-step.active { display:block; }
    /* toast */
    #toast { position: fixed; right: 20px; bottom: 20px; z-index: 60; }
  </style>
</head>
<body class="bg-gradient-to-br from-emerald-50 to-emerald-100 min-h-screen">

  <!-- Topbar -->
  <header class="fixed left-0 right-0 top-0 h-16 bg-emerald-800 text-white flex items-center justify-between px-4 z-40">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded bg-white/20 flex items-center justify-center font-bold">VY</div>
      <div>
        <div class="text-lg font-semibold">Visionary Youth Group</div>
        <div class="text-xs opacity-80">Member Portal</div>
      </div>
    </div>

    <div class="flex items-center gap-4">
      <div class="text-right">
        <div id="memberName" class="font-semibold">Guest</div>
        <div id="memberStatus" class="text-xs opacity-80">Not signed in</div>
      </div>

      <button id="toggleSidebar" class="p-2 rounded bg-white/10 hover:bg-white/20">
        <i class="fa fa-bars"></i>
      </button>

      <button id="signOutBtn" class="px-3 py-2 bg-white/10 rounded hover:bg-white/20">Sign out</button>
    </div>
  </header>

  <!-- Layout -->
  <div class="pt-20 flex gap-6 max-w-7xl mx-auto px-4">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-72 p-4 card sticky top-20 h-[calc(100vh-5rem)] overflow-auto">
      <nav class="space-y-2">
        <button data-tab="overview" class="tab-btn w-full text-left px-3 py-2 rounded hover:bg-emerald-50 flex items-center gap-3"><i class="fa fa-home w-4"></i> Overview</button>
        <button data-tab="balances" class="tab-btn w-full text-left px-3 py-2 rounded hover:bg-emerald-50 flex items-center gap-3"><i class="fa fa-wallet w-4"></i> Balances</button>
        <button data-tab="loanWizard" class="tab-btn w-full text-left px-3 py-2 rounded hover:bg-emerald-50 flex items-center gap-3"><i class="fa fa-file-signature w-4"></i> Apply Loan (Wizard)</button>
        <button data-tab="loanActions" class="tab-btn w-full text-left px-3 py-2 rounded hover:bg-emerald-50 flex items-center gap-3"><i class="fa fa-list"></i> Loan Actions</button>
        <button data-tab="withdraw" class="tab-btn w-full text-left px-3 py-2 rounded hover:bg-emerald-50 flex items-center gap-3"><i class="fa fa-hand-holding-dollar"></i> Withdraw</button>
        <button data-tab="goals" class="tab-btn w-full text-left px-3 py-2 rounded hover:bg-emerald-50 flex items-center gap-3"><i class="fa fa-bullseye"></i> Goals</button>
        <button data-tab="profile" class="tab-btn w-full text-left px-3 py-2 rounded hover:bg-emerald-50 flex items-center gap-3"><i class="fa fa-user"></i> Profile</button>
        <button data-tab="statements" class="tab-btn w-full text-left px-3 py-2 rounded hover:bg-emerald-50 flex items-center gap-3"><i class="fa fa-file-pdf"></i> Statements</button>
      </nav>

      <div class="mt-6 text-sm text-gray-600">
        <div>Points: <strong id="pointsTop">0</strong></div>
        <div class="mt-2">Auto logout: <strong>3 minutes</strong> inactivity</div>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 space-y-6 pb-24">

      <!-- Overview -->
      <section id="tab-overview" class="card p-6">
        <div class="flex items-start justify-between gap-6">
          <div>
            <h2 class="text-2xl font-bold" id="welcome">Welcome, <span id="welcomeName">Member</span></h2>
            <p class="text-sm text-gray-600">Realtime snapshot of balances and loans</p>
          </div>

          <div class="flex items-center gap-3">
            <button id="downloadStatement" class="btn px-4 py-2 bg-emerald-700 text-white rounded">Download Statement</button>
            <button id="openLoanWizardQuick" class="btn px-4 py-2 bg-white text-emerald-700 rounded border border-emerald-100">Apply Loan</button>
          </div>
        </div>

        <!-- balances -->
        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="card p-4">
            <div class="text-sm text-gray-500">Monthly Saving</div>
            <div class="text-2xl font-bold text-emerald-700" id="monthlyVal">Ksh 0</div>
            <div class="text-xs text-gray-500 mt-1">Target: <span id="monthlyTarget">Ksh 0</span></div>
          </div>
          <div class="card p-4">
            <div class="text-sm text-gray-500">Weekly Saving</div>
            <div class="text-2xl font-bold text-emerald-700" id="weeklyVal">Ksh 0</div>
            <div class="text-xs text-gray-500 mt-1">Progress: <span id="weeklyProgress">0%</span></div>
          </div>
          <div class="card p-4">
            <div class="text-sm text-gray-500">Outstanding Loans</div>
            <div class="text-2xl font-bold text-emerald-700" id="outstandingVal">Ksh 0</div>
            <div class="text-xs text-gray-500 mt-1">Unpaid: <span id="unpaidVal">Ksh 0</span></div>
          </div>
        </div>

        <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div class="card p-4 lg:col-span-2">
            <h3 class="font-semibold mb-2">Active Loans</h3>
            <div id="loansBrief">Loading...</div>
          </div>

          <div class="card p-4">
            <h3 class="font-semibold mb-2">Savings Goal</h3>
            <canvas id="goalChart" height="180"></canvas>
            <div class="mt-3 text-sm text-gray-600">Goal: <span id="goalTargetVal">Ksh 0</span> • Progress: <span id="goalProgressPct">0%</span></div>
          </div>
        </div>
      </section>

      <!-- Balances tab (detailed) -->
      <section id="tab-balances" class="card p-6 hidden">
        <h3 class="font-semibold">Balances</h3>
        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="card p-4">
            <div class="text-sm text-gray-500">Monthly</div>
            <div id="monthlyVal2" class="text-2xl font-bold text-emerald-700">Ksh 0</div>
            <div class="mt-2">
              <label class="text-sm">Set monthly target (Ksh)</label>
              <input id="setGoalAmount" type="number" class="mt-1 p-2 border rounded w-full" placeholder="e.g., 5000">
              <button id="saveGoal" class="mt-2 px-3 py-2 bg-emerald-700 text-white rounded">Save Goal</button>
            </div>
          </div>

          <div class="card p-4">
            <div class="text-sm text-gray-500">Weekly</div>
            <div id="weeklyVal2" class="text-2xl font-bold text-emerald-700">Ksh 0</div>
            <div class="mt-2 text-sm text-gray-500">Transactions & history on statements</div>
          </div>
        </div>
      </section>

      <!-- Loan Wizard -->
      <section id="tab-loanWizard" class="card p-6 hidden">
        <h3 class="font-semibold">Loan Application (Wizard)</h3>
        <div class="mt-3 text-sm text-gray-600 mb-4">
          <div id="wizStepLabel">Step 1 / 6</div>
          <div class="w-full bg-slate-100 rounded overflow-hidden h-2 mt-2">
            <div id="wizBar" class="h-2 bg-emerald-600" style="width:0%"></div>
          </div>
        </div>

        <form id="loanWizardForm" class="space-y-4">
          <!-- Step 1 -->
          <div id="wiz-1" class="wiz-step active grid grid-cols-1 md:grid-cols-2 gap-3">
            <input name="fullName" placeholder="Full name" class="p-2 border rounded" required />
            <input name="idNumber" placeholder="ID / Passport" class="p-2 border rounded" required />
            <input name="dob" type="date" class="p-2 border rounded" required />
            <input name="phone" placeholder="Phone" class="p-2 border rounded" required />
            <input name="email" type="email" placeholder="Email" class="p-2 border rounded" />
            <input name="memberNo" placeholder="Member No" class="p-2 border rounded" />
          </div>

          <!-- Step 2 (Residence) -->
          <div id="wiz-2" class="wiz-step grid grid-cols-1 md:grid-cols-2 gap-3">
            <select name="county" class="p-2 border rounded" id="countySelect"></select>
            <input name="constituency" placeholder="Constituency" class="p-2 border rounded" />
            <input name="ward" placeholder="Ward" class="p-2 border rounded" />
            <input name="village" placeholder="Village/estate" class="p-2 border rounded" />
            <input name="residence" placeholder="Residence / House" class="p-2 border rounded full" />
          </div>

          <!-- Step 3 (Education) -->
          <div id="wiz-3" class="wiz-step grid grid-cols-1 md:grid-cols-2 gap-3">
            <select name="educationLevel" class="p-2 border rounded">
              <option value="">Education level</option>
              <option>Primary</option><option>Secondary</option><option>Diploma</option><option>Undergraduate</option><option>Postgraduate</option>
            </select>
            <input name="institution" placeholder="Institution" class="p-2 border rounded" />
            <input name="educationYear" placeholder="Year / Index" class="p-2 border rounded" />
            <input name="course" placeholder="Course" class="p-2 border rounded" />
          </div>

          <!-- Step 4 (Guarantors) -->
          <div id="wiz-4" class="wiz-step">
            <div class="text-sm text-gray-600 mb-2">Provide 3 guarantors (required)</div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
              <div><input name="g1_name" placeholder="Guarantor 1 name" class="p-2 border rounded" required /></div>
              <div><input name="g1_phone" placeholder="Guarantor 1 phone" class="p-2 border rounded" required /></div>
              <div><input name="g1_amount" placeholder="Ksh" type="number" class="p-2 border rounded" required /></div>

              <div><input name="g2_name" placeholder="Guarantor 2 name" class="p-2 border rounded" required /></div>
              <div><input name="g2_phone" placeholder="Guarantor 2 phone" class="p-2 border rounded" required /></div>
              <div><input name="g2_amount" placeholder="Ksh" type="number" class="p-2 border rounded" required /></div>

              <div><input name="g3_name" placeholder="Guarantor 3 name" class="p-2 border rounded" required /></div>
              <div><input name="g3_phone" placeholder="Guarantor 3 phone" class="p-2 border rounded" required /></div>
              <div><input name="g3_amount" placeholder="Ksh" type="number" class="p-2 border rounded" required /></div>
            </div>
          </div>

          <!-- Step 5 (Loan details) -->
          <div id="wiz-5" class="wiz-step grid grid-cols-1 md:grid-cols-2 gap-3">
            <input name="amount" placeholder="Amount requested (Ksh)" type="number" class="p-2 border rounded" required />
            <input name="amountWords" placeholder="Amount in words" class="p-2 border rounded" required />
            <input name="purpose" placeholder="Purpose" class="p-2 border rounded" required />
            <input name="repayableMonths" placeholder="Repayable in months" class="p-2 border rounded" required />
            <select name="disbursementMode" class="p-2 border rounded">
              <option value="mpesa">M-Pesa</option><option value="bank">Bank Transfer</option><option value="cash">Cash (Office)</option>
            </select>
            <input name="accountNumber" placeholder="Account / Till no" class="p-2 border rounded" />
          </div>

          <!-- Step 6 (Review & submit) -->
          <div id="wiz-6" class="wiz-step">
            <div class="text-sm text-gray-600">Review details and submit. You will download a styled PDF to present to the office.</div>
            <div class="mt-3">
              <label class="inline-flex items-center gap-2"><input type="checkbox" id="wizardAgree" /> I confirm the details above are true.</label>
            </div>
          </div>

          <div class="flex justify-between">
            <button type="button" id="wizPrev" class="px-4 py-2 bg-gray-200 rounded">Back</button>
            <div class="flex gap-2">
              <button type="button" id="wizNext" class="px-4 py-2 bg-emerald-600 text-white rounded">Next</button>
              <button type="submit" id="wizSubmit" class="px-4 py-2 bg-emerald-700 text-white rounded hidden">Submit & Download PDF</button>
            </div>
          </div>
        </form>
      </section>

      <!-- Loan Actions -->
      <section id="tab-loanActions" class="card p-6 hidden">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">Loan Actions</h3>
          <button id="toggleLoanActions" class="text-sm text-emerald-600 underline">Show full table</button>
        </div>

        <div class="mt-4 loan-summary p-3 flex items-center justify-between">
          <div><strong id="loanCount">0</strong> active loan(s) • Outstanding: <span id="loanOutstanding">Ksh 0</span></div>
          <div id="loanSummaryBadges"></div>
        </div>

        <div id="loanActionsPanel" class="mt-4 hidden">
          <table class="min-w-full text-sm">
            <thead><tr class="text-left"><th class="px-3 py-2">Loan Date</th><th class="px-3 py-2">Purpose</th><th class="px-3 py-2">Amount</th><th class="px-3 py-2">Due Date</th><th class="px-3 py-2">Status</th><th class="px-3 py-2">Progress</th></tr></thead>
            <tbody id="loanActionsBody"></tbody>
          </table>
        </div>
      </section>

      <!-- Withdraw -->
      <section id="tab-withdraw" class="card p-6 hidden">
        <h3 class="font-semibold">Withdrawal</h3>
        <form id="withdrawForm" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
          <input name="w_memberName" placeholder="Member name" class="p-2 border rounded" required />
          <input name="w_membershipNumber" placeholder="Membership No" class="p-2 border rounded" required />
          <input name="w_idNumber" placeholder="ID number" class="p-2 border rounded" required />
          <input name="w_phone" placeholder="Phone" class="p-2 border rounded" required />
          <input name="w_amountFigures" placeholder="Amount (Ksh)" type="number" class="p-2 border rounded" required />
          <textarea name="w_reason" placeholder="Reason (min 200 characters)" class="p-2 border rounded md:col-span-2" required></textarea>

          <div class="md:col-span-2 flex justify-end gap-2">
            <button id="previewWithdraw" type="button" class="px-4 py-2 bg-gray-200 rounded">Preview PDF</button>
            <button id="submitWithdraw" type="submit" class="px-4 py-2 bg-emerald-700 text-white rounded">Submit & Download</button>
          </div>
        </form>
      </section>

      <!-- Goals -->
      <section id="tab-goals" class="card p-6 hidden">
        <h3 class="font-semibold">Savings Goal</h3>
        <div class="mt-4">
          <label>Target amount (Ksh)</label>
          <input id="goalAmountInput" type="number" class="p-2 border rounded mt-1" placeholder="e.g., 10000" />
          <label class="block mt-2">Target date</label>
          <input id="goalDateInput" type="date" class="p-2 border rounded mt-1" />
          <div class="mt-3 flex gap-2">
            <button id="saveGoalBtn" class="px-3 py-2 bg-emerald-700 text-white rounded">Save Goal</button>
            <button id="clearGoalBtn" class="px-3 py-2 bg-gray-200 rounded">Clear Goal</button>
          </div>
        </div>
        <div class="mt-6">
          <div>Progress: <strong id="goalProgressLabel">0%</strong></div>
          <div class="w-full bg-slate-100 rounded h-3 mt-2"><div id="goalProgressBar" class="h-3 bg-emerald-600" style="width:0%"></div></div>
        </div>
      </section>

      <!-- Profile -->
      <section id="tab-profile" class="card p-6 hidden">
        <h3 class="font-semibold">Profile</h3>
        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
          <input id="profile_fullName" placeholder="Full name" class="p-2 border rounded" />
          <input id="profile_phone" placeholder="Phone" class="p-2 border rounded" />
          <input id="profile_id" placeholder="ID number" class="p-2 border rounded" />
          <input id="profile_yearJoined" placeholder="Year joined" class="p-2 border rounded" />
          <input id="profile_dob" type="date" placeholder="DOB" class="p-2 border rounded" />
          <input id="profile_status" placeholder="Status (Active/Dormant)" class="p-2 border rounded" />
        </div>
        <div class="mt-3 flex gap-2">
          <input id="photoInput" type="file" accept="image/*" class="hidden" />
          <button id="choosePhotoBtn" class="px-3 py-2 bg-gray-200 rounded">Upload Photo</button>
          <button id="saveProfileBtn" class="px-3 py-2 bg-emerald-700 text-white rounded">Save</button>
        </div>
      </section>

      <!-- Statements -->
      <section id="tab-statements" class="card p-6 hidden">
        <h3 class="font-semibold">Statements</h3>
        <div class="mt-3 flex gap-2">
          <button id="downloadStatementBtn" class="px-3 py-2 bg-emerald-700 text-white rounded">Download Account Statement (PDF)</button>
          <button id="downloadAppsBtn" class="px-3 py-2 bg-gray-200 rounded">Download My Applications</button>
        </div>
      </section>

    </main>
  </div>

  <!-- toast area -->
  <div id="toast" class="hidden"></div>

  <!-- Firebase + App Logic -->
  <script type="module">
    /* ===============================
       Imports
       =============================== */
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getDatabase, ref, onValue, push, set, update, get, onChildChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js';
    const { jsPDF } = window.jspdf;
    const Chart = window.Chart;

    /* ===============================
       Firebase config (from you)
       =============================== */
    const firebaseConfig = {
      apiKey: "AIzaSyA_OCu7HQ5HCH2OYx5dQ2Z1r7YPwQJave4",
      authDomain: "visionary-youth-grou-2024.firebaseapp.com",
      databaseURL: "https://visionary-youth-grou-2024-default-rtdb.firebaseio.com",
      projectId: "visionary-youth-grou-2024",
      storageBucket: "visionary-youth-grou-2024.appspot.com",
      messagingSenderId: "372978592717",
      appId: "1:372978592717:web:1c15aec728ee5f854f3284"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    /* ===============================
       Small helpers & DOM refs
       =============================== */
    const qs = sel => document.querySelector(sel);
    function toast(msg, ms=3000){
      const el = qs('#toast');
      el.textContent = msg; el.classList.remove('hidden'); el.classList.add('fixed','right-6','bottom-6','bg-emerald-600','text-white','px-4','py-2','rounded','shadow');
      setTimeout(()=> { el.classList.add('hidden'); el.className=''; el.id='toast'; }, ms);
    }
    function fmtK(n){ return 'Ksh ' + (Number(n||0)).toLocaleString('en-KE'); }

    /* ===============================
       UI: tabs
       =============================== */
    const tabButtons = document.querySelectorAll('.tab-btn');
    function openTab(tabId){
      // hide all tab sections (sections have id="tab-<id>" OR elements like tab-loanWizard)
      const sections = document.querySelectorAll('main [id^="tab-"], main #loan-wizard-tab, main #tab-loanWizard, main #tab-overview');
      sections.forEach(s => { if(s.id) s.classList.add('hidden'); });
      // map button data-tab to section ids used in markup
      const mapping = {
        'overview': 'tab-overview',
        'balances': 'tab-balances',
        'loanWizard': 'tab-loanWizard',
        'loanActions': 'tab-loanActions',
        'withdraw': 'tab-withdraw',
        'goals': 'tab-goals',
        'profile': 'tab-profile',
        'statements': 'tab-statements'
      };
      const target = mapping[tabId] || tabId;
      const el = document.getElementById(target);
      if(el) el.classList.remove('hidden');
      window.scrollTo({top:0, behavior:'smooth'});
    }
    tabButtons.forEach(b => b.addEventListener('click', ()=> openTab(b.dataset.tab)));
    // default
    openTab('overview');

    // menu toggle
    qs('#toggleSidebar').addEventListener('click', ()=> qs('#sidebar').classList.toggle('hidden'));

    /* ===============================
       Inactivity auto-logout (3 min)
       =============================== */
    let inactivityTimer = null;
    const INACTIVITY_LIMIT = 3*60*1000;
    function resetInactivity(){
      clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(async ()=> {
        try{ await signOut(auth); } catch(e){}
        alert('Signed out due to inactivity');
        location.reload();
      }, INACTIVITY_LIMIT);
    }
    ['mousemove','keydown','click','touchstart'].forEach(ev => window.addEventListener(ev, resetInactivity));

    /* ===============================
       County list (for wizard)
       =============================== */
    const counties = ["Mombasa","Kwale","Kilifi","Tana River","Lamu","Taita-Taveta","Garissa","Wajir","Mandera","Marsabit","Isiolo","Meru","Tharaka-Nithi","Embu","Kitui","Machakos","Makueni","Nyandarua","Nyeri","Kirinyaga","Murang'a","Kiambu","Turkana","West Pokot","Samburu","Trans-Nzoia","Uasin Gishu","Elgeyo-Marakwet","Nandi","Baringo","Laikipia","Nakuru","Narok","Kajiado","Kericho","Bomet","Kakamega","Vihiga","Bungoma","Busia","Siaya","Kisumu","Homa Bay","Migori","Kisii","Nyamira","Nairobi"];
    const countySelect = qs('#countySelect');
    if(countySelect){
      counties.forEach(c => { const o = document.createElement('option'); o.value=c; o.textContent=c; countySelect.appendChild(o); });
    }

    /* ===============================
       Authentication state & initial subscriptions
       =============================== */
    let currentUid = null;
    onAuthStateChanged(auth, async user => {
      if(!user) {
        // no user: redirect or show guest
        // For now, alert & stop
        alert('No authenticated user. Redirecting to login.');
        window.location.href = 'index.html';
        return;
      }
      currentUid = user.uid;
      qs('#memberName').textContent = user.displayName || user.email || 'Member';
      qs('#memberStatus').textContent = 'Status: Active';
      qs('#welcomeName').textContent = user.displayName || (user.email? user.email.split('@')[0] : 'Member');

      // reset inactivity timer
      resetInactivity();

      // start listeners
      subscribeBalances();
      subscribeLoanApplications();
      subscribeGoal();
      subscribePoints();
      subscribeProfile();

      // award small points for login
      try{ await awardPoints(5, 'Login'); } catch(e){}
    });

    // sign out button
    qs('#signOutBtn').addEventListener('click', async ()=> {
      try{ await signOut(auth); } catch(e){}
      location.href = 'index.html';
    });

    /* ===============================
       Points & activity
       =============================== */
    async function awardPoints(n, reason){
      if(!currentUid) return;
      const pRef = ref(db, `members/${currentUid}/points`);
      const snap = await get(pRef);
      const curr = snap.exists() ? Number(snap.val()||0) : 0;
      await set(pRef, curr + n);
      // log activity
      await push(ref(db, `members/${currentUid}/activityLog`), { text: reason || 'action', ts: Date.now() });
      qs('#pointsTop').textContent = String(curr + n);
    }
    async function subscribePoints(){
      onValue(ref(db, `members/${currentUid}/points`), snap => {
        const v = snap.exists() ? snap.val() : 0;
        qs('#pointsTop').textContent = String(v||0);
      });
    }

    /* ===============================
       Profile
       =============================== */
    async function subscribeProfile(){
      onValue(ref(db, `members/${currentUid}/profile`), snap => {
        if(!snap.exists()) return;
        const p = snap.val();
        if(p.name) qs('#profile_fullName').value = p.name, qs('#welcomeName').textContent = p.name;
        if(p.phone) qs('#profile_phone').value = p.phone;
        if(p.id) qs('#profile_id').value = p.id;
        if(p.yearJoined) qs('#profile_yearJoined').value = p.yearJoined;
        if(p.dob) qs('#profile_dob').value = p.dob;
        if(p.status) qs('#profile_status').value = p.status, qs('#memberStatus').textContent = p.status;
        if(p.photoURL) qs('#topAvatar').innerHTML = `<img src="${p.photoURL}" class="w-10 h-10 rounded object-cover">`;
      });
    }

    qs('#saveProfileBtn')?.addEventListener('click', async ()=>{
      if(!currentUid) return alert('Sign in');
      const payload = {
        name: qs('#profile_fullName').value,
        phone: qs('#profile_phone').value,
        id: qs('#profile_id').value,
        yearJoined: qs('#profile_yearJoined').value,
        dob: qs('#profile_dob').value,
        status: qs('#profile_status').value || 'Active'
      };
      await set(ref(db, `members/${currentUid}/profile`), payload);
      toast('Profile saved');
      await awardPoints(5, 'Updated profile');
    });

    // photo upload
    qs('#choosePhotoBtn')?.addEventListener('click', ()=> qs('#photoInput').click());
    qs('#photoInput')?.addEventListener('change', async (e)=>{
      const f = e.target.files && e.target.files[0]; if(!f) return;
      const path = `members/${currentUid}/photo_${Date.now()}`;
      const st = sRef(storage, path);
      try{
        await uploadBytes(st, f);
        const url = await getDownloadURL(st);
        await set(ref(db, `members/${currentUid}/profile/photoURL`), url);
        toast('Photo uploaded');
      }catch(err){
        console.error(err); alert('Upload failed');
      }
    });

    /* ===============================
       Balances subscriptions
       =============================== */
    function subscribeBalances(){
      onValue(ref(db, `members/${currentUid}/savings/monthly`), snap => qs('#monthlyVal').textContent = fmtK(snap.exists()? snap.val() : 0));
      onValue(ref(db, `members/${currentUid}/savings/weekly`), snap => qs('#weeklyVal').textContent = fmtK(snap.exists()? snap.val() : 0));
      onValue(ref(db, `members/${currentUid}/unpaidBalances`), snap => qs('#unpaidVal').textContent = fmtK(snap.exists()? snap.val() : 0));
      onValue(ref(db, `members/${currentUid}/loans/summary/outstanding`), snap => qs('#outstandingVal').textContent = fmtK(snap.exists()? snap.val() : 0));
      // mirror other UI nodes if needed
    }

    /* ===============================
       Goal (target + progress)
       =============================== */
    // subscribe & chart
    let goalChart = null;
    function subscribeGoal(){
      onValue(ref(db, `members/${currentUid}/goal/target`), snap => {
        const v = snap.exists()? Number(snap.val()||0) : 0;
        qs('#goalTargetVal').textContent = fmtK(v);
        qs('#goalAmountInput') && (qs('#goalAmountInput').value = v || '');
        qs('#monthlyTarget') && (qs('#monthlyTarget').textContent = fmtK(v));
      });
      onValue(ref(db, `members/${currentUid}/goal/progress`), snap => {
        const v = snap.exists()? Number(snap.val()||0) : 0;
        const pct = snap.exists() && getPercent(v, (document.getElementById('goalAmountInput')?.value || Number(qs('#goalTargetVal').textContent.replace(/[^0-9]/g,'')) || 0));
        qs('#goalProgressPct').textContent = (pct || 0) + '%';
        qs('#goalProgressLabel').textContent = (pct || 0) + '%';
        qs('#goalProgressBar').style.width = (pct || 0) + '%';
        // update chart
        renderGoalChart(pct || 0);
      });
      onValue(ref(db, `members/${currentUid}/goal/targetDate`), snap => {
        if(snap.exists()) qs('#goalDateInput').value = new Date(snap.val()).toISOString().split('T')[0];
      });
    }

    function getPercent(current, target){ target = Number(target||0); if(!target) return 0; return Math.min(100, Math.round( (Number(current||0)/target) * 100 )); }

    function renderGoalChart(pct){
      const ctx = qs('#goalChart');
      if(!ctx) return;
      if(goalChart) { goalChart.destroy(); goalChart = null; }
      goalChart = new Chart(ctx, {
        type:'doughnut',
        data: { labels:['Saved','Remaining'], datasets:[{ data: [pct, 100-pct], backgroundColor:['#16a34a','#d1fae5'] }] },
        options: { cutout: '70%', plugins:{legend:{display:false}} }
      });
    }

    // Save goal
    qs('#saveGoalBtn')?.addEventListener('click', async ()=>{
      if(!currentUid) return alert('Sign in');
      const val = Number(qs('#goalAmountInput').value || 0);
      const dateVal = qs('#goalDateInput').value ? new Date(qs('#goalDateInput').value).getTime() : null;
      if(!val || val <= 0) return alert('Enter valid target');
      await set(ref(db, `members/${currentUid}/goal/target`), val);
      if(dateVal) await set(ref(db, `members/${currentUid}/goal/targetDate`), dateVal);
      toast('Goal saved');
      await awardPoints(3, 'Set goal');
    });

    qs('#clearGoalBtn')?.addEventListener('click', async ()=> {
      if(!confirm('Clear your goal?')) return;
      await set(ref(db, `members/${currentUid}/goal`), { target:0, progress:0 });
      toast('Goal cleared');
    });

    /* ===============================
       Loan Applications (wizard) -> RTDB
       + PDF generation, reminders, listeners to update UI.
       =============================== */
    const wizardForm = qs('#loanWizardForm');
    let currentStep = 1;
    const totalSteps = 6;
    function showWizardStep(){
      for(let i=1;i<=totalSteps;i++){
        const el = qs('#wiz-' + i);
        if(!el) continue;
        el.classList.toggle('active', i === currentStep);
      }
      qs('#wizStepLabel').textContent = `Step ${currentStep} / ${totalSteps}`;
      const pct = Math.round(((currentStep-1)/(totalSteps-1))*100);
      qs('#wizBar').style.width = pct + '%';
      qs('#wizPrev').disabled = currentStep === 1;
      if(currentStep === totalSteps){
        qs('#wizNext').classList.add('hidden'); qs('#wizSubmit').classList.remove('hidden');
      } else {
        qs('#wizNext').classList.remove('hidden'); qs('#wizSubmit').classList.add('hidden');
      }
    }
    qs('#wizNext').addEventListener('click', ()=> { if(currentStep < totalSteps) currentStep++; showWizardStep(); });
    qs('#wizPrev').addEventListener('click', ()=> { if(currentStep > 1) currentStep--; showWizardStep(); });
    showWizardStep();

    // Submit wizard
    wizardForm.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      if(!currentUid) return alert('Not signed in');
      // ensure agree
      if(!qs('#wizardAgree')?.checked) return alert('Please confirm the details.');
      const fd = new FormData(wizardForm);
      const data = Object.fromEntries(fd.entries());
      // Add guarantors aggregated
      const guarantors = [
        { name: data.g1_name, phone: data.g1_phone, amount: Number(data.g1_amount||0) },
        { name: data.g2_name, phone: data.g2_phone, amount: Number(data.g2_amount||0) },
        { name: data.g3_name, phone: data.g3_phone, amount: Number(data.g3_amount||0) }
      ];
      data.guarantors = guarantors;
      data.appliedAt = Date.now();
      data.status = 'Pending';
      data.progress = 0;
      // Optionally compute dueDate from repayableMonths - here we leave dueDate empty until admin approves
      try{
        const appRef = push(ref(db, `members/${currentUid}/loans/applications`));
        await set(appRef, data);
        // also copy summary perhaps to loans/summary or loans list
        // For simplicity, add a copy under members/{uid}/loans/list (if desired)
        toast('Application submitted — generating PDF');
        await awardPoints(12, 'Submitted loan application');
        // generate PDF
        const doc = buildLoanPdf(data);
        doc.save(`Loan_Application_${(data.fullName||'member').replace(/\s+/g,'_')}_${appRef.key}.pdf`);
        // push reminder for dueDate if user set one (if data.dueDate)
        if(data.dueDate){
          await push(ref(db, 'reminders'), { uid: currentUid, title: 'Loan due', message: `Loan "${data.purpose}" due on ${new Date(data.dueDate).toLocaleDateString()}`, ts: Date.now() });
        }
      }catch(err){
        console.error(err); alert('Failed to submit application');
      }
    });

    // Loan PDF builder (basic layout, watermark)
    function buildLoanPdf(data){
      const doc = new jsPDF({ unit:'pt', format:'a4' });
      const left = 36;
      // header
      doc.setFillColor(16, 185, 129); doc.rect(0,0,595,60,'F');
      doc.setFontSize(16); doc.setTextColor(255,255,255); doc.text('VISIONARY YOUTH GROUP', 300, 34, { align: 'center' });
      doc.setTextColor(0,0,0); doc.setFontSize(11);
      let y = 84;
      doc.text('LOAN APPLICATION', left, y); y += 14;
      doc.setFontSize(10);
      const lines = [
        `Name: ${data.fullName || ''}`,
        `ID: ${data.idNumber || ''}`,
        `Phone: ${data.phone || ''} • Email: ${data.email || ''}`,
        `Amount: Ksh ${data.amount || data.amountFigures || ''} (${data.amountWords||''})`,
        `Purpose: ${data.purpose || ''}`,
        `Guarantors: ${ (data.guarantors||[]).map(g=>g.name+'('+ (g.amount||0) +')').join('; ') }`
      ];
      lines.forEach(l => { const wrap = doc.splitTextToSize(l, 520); doc.text(wrap, left, y); y += wrap.length * 12; });
      y += 8;
      doc.text('Applicant signature: ____________________  Date: __________', left, y);
      // footer
      const pageCount = doc.getNumberOfPages();
      for(let i=1;i<=pageCount;i++){
        doc.setPage(i);
        doc.setFontSize(8); doc.text('Visionary Youth Group — Official Application', 300, 820, { align: 'center' });
      }
      return doc;
    }

    /* ===============================
       Loan Actions: listen & render live
       =============================== */
    function subscribeLoanApplications(){
      const appsRef = ref(db, `members/${currentUid}/loans/applications`);
      onValue(appsRef, snap => {
        const obj = snap.exists()? snap.val() : {};
        // Build brief active loans (show up to 5)
        const loansList = Object.values(obj || {});
        const brief = qs('#loansBrief');
        brief.innerHTML = '';
        if(!loansList.length){
          brief.innerHTML = '<div class="text-sm text-gray-500">No active loans</div>';
          qs('#loanCount').textContent = '0';
          qs('#loanOutstanding').textContent = fmtK(0);
          return;
        }
        // summary numbers
        let outstanding = 0;
        loansList.slice(0,6).forEach(l => {
          const div = document.createElement('div');
          div.className = 'p-2 border-b border-slate-100';
          div.innerHTML = `<div class="flex justify-between"><div><strong>${l.purpose || 'Loan'}</strong><div class="text-xs text-gray-500">${l.fullName || ''}</div></div><div class="text-right">${fmtK(l.amount || l.amountFigures || 0)}<div class="text-xs ${ (l.status||'').toLowerCase() === 'approved' ? 'text-green-600' : 'text-yellow-600' }">${l.status || 'Pending'}</div></div></div>`;
          brief.appendChild(div);
          outstanding += Number(l.amount || l.amountFigures || 0);
        });
        qs('#loanCount').textContent = String(loansList.length);
        qs('#loanOutstanding').textContent = fmtK(outstanding);
        // Full table
        const body = qs('#loanActionsBody');
        body.innerHTML = '';
        Object.entries(obj || {}).forEach(([id, loan]) => {
          const tr = document.createElement('tr');
          const applied = loan.appliedAt ? new Date(loan.appliedAt).toLocaleDateString() : '-';
          const due = loan.dueDate ? new Date(loan.dueDate).toLocaleDateString() : '-';
          const amt = fmtK(loan.amount || loan.amountFigures || 0);
          const status = loan.status || 'Pending';
          const progress = loan.progress || 0;
          let statusClass = 'status-pending';
          if(['approved','disbursed','paid'].includes((status||'').toLowerCase())) statusClass = 'status-approved';
          if((status||'').toLowerCase() === 'rejected') statusClass = 'status-rejected';
          tr.innerHTML = `<td class="px-3 py-2">${applied}</td><td class="px-3 py-2">${escapeHtml(loan.purpose || '')}</td><td class="px-3 py-2">${amt}</td><td class="px-3 py-2">${due}</td><td class="px-3 py-2"><span class="${statusClass}">${status}</span></td><td class="px-3 py-2">${progress}%</td>`;
          body.appendChild(tr);
        });
      });

      // also listen for child changed to highlight updates
      onChildChanged(ref(db, `members/${currentUid}/loans/applications`), (snap) => {
        const updated = snap.val();
        // Optionally highlight or notify
        toast(`Loan ${updated.purpose || ''} updated: ${updated.status || ''}`);
      });
    }

    /* ===============================
       Goals progress: simple client-side demo
       (you can integrate server-calculated progress)
       =============================== */
    // update `members/{uid}/goal/progress` when savings change (example)
    // NOTE: here we only show how to update progress if you want to auto-update based on monthly savings
    onValue(ref(db), ()=>{}); // keep connection alive

    /* ===============================
       Withdraw handlers & PDF
       =============================== */
    qs('#previewWithdraw')?.addEventListener('click', ()=>{
      const fd = new FormData(qs('#withdrawForm'));
      const data = Object.fromEntries(fd.entries());
      const doc = buildWithdrawPdf(data);
      doc.save('Withdrawal_PREVIEW.pdf');
    });

    qs('#withdrawForm')?.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      if(!currentUid) return alert('Sign in');
      const fd = new FormData(qs('#withdrawForm'));
      const data = Object.fromEntries(fd.entries());
      if((data.w_reason || '').length < 200) return alert('Reason must be at least 200 characters');
      // save withdrawal request
      const wRef = push(ref(db, `members/${currentUid}/withdrawals`));
      await set(wRef, { ...data, submittedAt: Date.now(), status: 'submitted' });
      toast('Withdrawal submitted');
      await awardPoints(6, 'Submitted withdrawal');
      const doc = buildWithdrawPdf(data);
      doc.save(`Withdrawal_${(data.w_memberName||'member').replace(/\s+/g,'_')}.pdf`);
    });

    function buildWithdrawPdf(data){
      const doc = new jsPDF({ unit:'pt', format:'a4' });
      const left = 36; let y = 48;
      doc.setFillColor(16,185,129); doc.rect(0,0,595,60,'F');
      doc.setFontSize(14); doc.setTextColor(255,255,255); doc.text('VOLUNTARY WITHDRAWAL FORM', 300, 36, { align:'center' });
      doc.setTextColor(0,0,0); doc.setFontSize(10);
      y = 90;
      doc.text(`Member: ${data.w_memberName || ''}`, left, y); y += 14;
      doc.text(`Membership No: ${data.w_membershipNumber || ''}`, left, y); y += 14;
      doc.text(`ID: ${data.w_idNumber || ''}`, left, y); y += 14;
      doc.text(`Phone: ${data.w_phone || ''}`, left, y); y += 14;
      doc.text(`Amount: ${fmtK(data.w_amountFigures || 0)}`, left, y); y += 18;
      const wrap = doc.splitTextToSize(`Reason: ${data.w_reason || ''}`, 520);
      doc.text(wrap, left, y); y += wrap.length * 12;
      return doc;
    }

    /* ===============================
       Statements PDF
       =============================== */
    async function buildAccountStatement(){
      if(!currentUid) return alert('Sign in');
      const memberSnap = await get(ref(db, `members/${currentUid}`));
      const doc = new jsPDF({ unit:'pt', format:'a4' });
      const left = 36; let y = 40;
      doc.setFillColor(16,185,129); doc.rect(0,0,595,56,'F');
      doc.setFontSize(14); doc.setTextColor(255,255,255); doc.text('ACCOUNT STATEMENT', 300, 34, { align:'center' });
      doc.setTextColor(0,0,0);
      y = 80;
      const profile = memberSnap.exists() && memberSnap.val().profile ? memberSnap.val().profile : {};
      doc.setFontSize(10);
      doc.text(`Member: ${profile.name || ''}`, left, y); y += 12;
      doc.text(`Email: ${auth.currentUser?.email || ''}`, left, y); y += 14;
      // fetch some nodes
      const monthlySnap = await get(ref(db, `members/${currentUid}/savings/monthly`));
      const weeklySnap = await get(ref(db, `members/${currentUid}/savings/weekly`));
      const loansSnap = await get(ref(db, `members/${currentUid}/loans/applications`));
      doc.text(`Monthly: ${fmtK(monthlySnap.exists()? monthlySnap.val() : 0)}`, left, y); y += 12;
      doc.text(`Weekly: ${fmtK(weeklySnap.exists()? weeklySnap.val() : 0)}`, left, y); y += 12;
      doc.text('Loans:', left, y); y += 12;
      if(loansSnap.exists()){
        Object.values(loansSnap.val()).slice(-10).forEach(l => {
          const line = `${l.purpose || ''} — ${fmtK(l.amount || l.amountFigures || 0)} — ${l.status || 'Pending'}`;
          const w = doc.splitTextToSize(line, 520);
          doc.text(w, left, y); y += w.length * 12;
          if(y > 720){ doc.addPage(); y = 40; }
        });
      } else {
        doc.text('No loans found', left, y); y += 12;
      }
      return doc;
    }

    qs('#downloadStatement')?.addEventListener('click', async () => {
      const doc = await buildAccountStatement();
      doc.save(`Account_Statement_${(auth.currentUser?.email||'member').replace(/[^\w@.-]/g,'')}.pdf`);
      await awardPoints(4, 'Downloaded statement');
    });
    qs('#downloadStatementBtn')?.addEventListener('click', async () => {
      const doc = await buildAccountStatement();
      doc.save(`Account_Statement_${(auth.currentUser?.email||'member').replace(/[^\w@.-]/g,'')}.pdf`);
      await awardPoints(4, 'Downloaded statement');
    });

    qs('#downloadAppsBtn')?.addEventListener('click', async () => {
      if(!currentUid) return alert('Sign in');
      const appsSnap = await get(ref(db, `members/${currentUid}/loans/applications`));
      if(!appsSnap.exists()) return alert('No applications found');
      const doc = new jsPDF({ unit:'pt', format:'a4' }); let y = 40;
      doc.setFontSize(12); doc.text('Loan Applications', 40, y); y += 20;
      Object.entries(appsSnap.val()).forEach(([id, app]) => {
        const title = `${app.fullName || app.memberName || ''} — ${fmtK(app.amount || app.amountFigures || 0)} — ${app.status || ''}`;
        const w = doc.splitTextToSize(title, 520);
        doc.text(w, 40, y); y += w.length * 12;
        if(y > 720){ doc.addPage(); y = 40; }
      });
      doc.save(`Loan_Applications_${(auth.currentUser?.email||'member').replace(/[^\w@.-]/g,'')}.pdf`);
      await awardPoints(5, 'Downloaded applications');
    });

    /* ===============================
       Misc UI bindings
       =============================== */
    // quick open loan wizard
    qs('#openLoanWizardQuick')?.addEventListener('click', () => {
      openTab('loanWizard');
      currentStep = 1; showWizardStep();
    });

    // loan actions toggle
    qs('#toggleLoanActions')?.addEventListener('click', () => {
      const panel = qs('#loanActionsPanel');
      if(panel.classList.contains('hidden')) { panel.classList.remove('hidden'); qs('#toggleLoanActions').textContent = 'Hide full table'; }
      else { panel.classList.add('hidden'); qs('#toggleLoanActions').textContent = 'Show full table'; }
    });

    // helper escape
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

    // small helper: subscribe points (already awarded on login)
    async function subscribePoints(){ onValue(ref(db, `members/${currentUid}/points`), snap => { if(snap.exists()) qs('#pointsTop').textContent = String(snap.val()); }); }

    /* ===============================
       Final note:
       - This file writes/reads to RTDB paths under `members/{uid}/...`
       - For production: secure DB rules and implement cloud functions to send emails/notifications and copy admin decisions into user nodes
       - The reminders node `reminders` is created for backend processing
       =============================== */

  </script>
</body>
</html>
