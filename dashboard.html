<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visionary Youth Group - Dashboard</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: #e6f7e6; /* Light green */
      color: #333;
    }

    nav {
      background: #004d00;
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    nav h1 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 700;
    }

    #menuToggle {
      cursor: pointer;
      font-size: 24px;
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: -250px;
      width: 220px;
      height: 100%;
      background: #fff;
      box-shadow: 2px 0 8px rgba(0,0,0,0.2);
      padding: 20px;
      transition: 0.3s;
      z-index: 1000;
    }

    .sidebar.active {
      left: 0;
    }

    .sidebar a {
      display: block;
      margin: 12px 0;
      padding: 10px;
      color: #333;
      border-radius: 6px;
      text-decoration: none;
      transition: 0.3s;
    }

    .sidebar a:hover {
      background: #004d00;
      color: white;
    }

    .main {
      padding: 25px;
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
    }

    .card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
      transition: 0.3s;
    }

    .card:hover {
      transform: scale(1.05);
    }

    .card i {
      font-size: 36px;
      color: #009933;
      margin-bottom: 10px;
    }

    .hidden { display: none; }

    .form-section {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    button {
      background: #009933;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.3s;
    }

    button:hover {
      background: #004d00;
    }

    footer {
      text-align: center;
      padding: 12px;
      margin-top: 20px;
      background: #004d00;
      color: white;
    }
  </style>
</head>
<body>
  <nav>
    <span id="menuToggle"><i class="fas fa-bars"></i></span>
    <h1>Dashboard</h1>
    <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
  </nav>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <a href="#" onclick="showSection('overview')"><i class="fas fa-home"></i> Overview</a>
    <a href="#" onclick="showSection('loans')"><i class="fas fa-hand-holding-usd"></i> Loan Application</a>
    <a href="#" onclick="showSection('statement')"><i class="fas fa-file-pdf"></i> Account Statement</a>
    <a href="#" onclick="showSection('profile')"><i class="fas fa-user"></i> Update Profile</a>
  </aside>

  <main class="main">
    <!-- Overview -->
    <section id="overview">
      <h2>Welcome, <span id="userEmail"></span> (<span id="userStatus">Active</span>)</h2>
      <div class="card-grid">
        <div class="card"><i class="fas fa-piggy-bank"></i><h3>Weekly Savings</h3><p id="weeklyBalance">Ksh 0</p></div>
        <div class="card"><i class="fas fa-calendar"></i><h3>Monthly Savings</h3><p id="monthlyBalance">Ksh 0</p></div>
        <div class="card"><i class="fas fa-hand-holding-usd"></i><h3>Loans</h3><p id="loanBalance">Ksh 0</p></div>
        <div class="card"><i class="fas fa-chart-line"></i><h3>Loan Progress</h3><p id="loanProgress">0%</p></div>
        <div class="card"><i class="fas fa-share-alt"></i><h3>Shares</h3><p id="sharesBalance">Ksh 0</p></div>
        <div class="card"><i class="fas fa-coins"></i><h3>Dividends</h3><p id="dividendsBalance">Ksh 0</p></div>
        <div class="card"><i class="fas fa-exclamation-circle"></i><h3>Unpaid Balances</h3><p id="unpaidBalance">Ksh 0</p></div>
      </div>
    </section>

    <!-- Loan Application -->
    <section id="loans" class="hidden">
      <h2>Loan Application</h2>
      <form id="loanForm" class="form-section">
        <h3>Personal Details</h3>
        <input type="text" id="fullName" placeholder="Full Name" required>
        <input type="text" id="idNumber" placeholder="National ID Number" required>
        <input type="text" id="phone" placeholder="Phone Number" required>

        <h3>Residence</h3>
        <input type="text" id="residence" placeholder="Residence" required>
        <input type="text" id="employment" placeholder="Employment/Business" required>

        <h3>Guarantor</h3>
        <input type="text" id="guarantorName" placeholder="Guarantor Name" required>
        <input type="text" id="guarantorPhone" placeholder="Guarantor Phone" required>

        <h3>Loan Details</h3>
        <input type="number" id="loanAmount" placeholder="Loan Amount (Ksh)" required>
        <input type="number" id="repaymentPeriod" placeholder="Repayment Period (months)" required>

        <button type="submit">Submit Loan Application</button>
      </form>
    </section>

    <!-- Account Statement -->
    <section id="statement" class="hidden">
      <h2>Account Statement</h2>
      <button onclick="downloadStatement()">Download PDF Statement</button>
    </section>

    <!-- Update Profile -->
    <section id="profile" class="hidden">
      <h2>Update Profile</h2>
      <form id="profileForm" class="form-section">
        <input type="text" id="profileName" placeholder="Full Name" required>
        <input type="text" id="profilePhone" placeholder="Phone Number" required>
        <button type="submit">Update</button>
      </form>
    </section>
  </main>

  <footer>
    <p>Â© 2024 Visionary Youth Group</p>
  </footer>

  <!-- Firebase & jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getDatabase, ref, get, set, push } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA_OCu7HQ5HCH2OYx5dQ2Z1r7YPwQJave4",
      authDomain: "visionary-youth-grou-2024.firebaseapp.com",
      databaseURL: "https://visionary-youth-grou-2024-default-rtdb.firebaseio.com/",
      projectId: "visionary-youth-grou-2024",
      storageBucket: "visionary-youth-grou-2024.appspot.com",
      messagingSenderId: "372978592717",
      appId: "1:372978592717:web:1c15aec728ee5f854f3284"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let logoutTimer;

    // Section toggle
    window.showSection = (id) => {
      document.querySelectorAll("main section").forEach(s => s.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
    };

    // Sidebar toggle
    document.getElementById("menuToggle").addEventListener("click", () => {
      document.getElementById("sidebar").classList.toggle("active");
    });

    // Auto logout after 3 mins
    function resetLogoutTimer() {
      clearTimeout(logoutTimer);
      logoutTimer = setTimeout(() => {
        signOut(auth);
      }, 3 * 60 * 1000);
    }
    document.addEventListener("mousemove", resetLogoutTimer);
    document.addEventListener("keypress", resetLogoutTimer);

    // Auth state
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        document.getElementById("userEmail").textContent = user.email;

        const snapshot = await get(ref(db, "balances/" + user.uid));
        if (snapshot.exists()) {
          const data = snapshot.val();
          document.getElementById("weeklyBalance").textContent = "Ksh " + (data.weekly || 0);
          document.getElementById("monthlyBalance").textContent = "Ksh " + (data.monthly || 0);
          document.getElementById("loanBalance").textContent = "Ksh " + (data.loans || 0);
          document.getElementById("loanProgress").textContent = (data.loanProgress || 0) + "%";
          document.getElementById("sharesBalance").textContent = "Ksh " + (data.shares || 0);
          document.getElementById("dividendsBalance").textContent = "Ksh " + (data.dividends || 0);
          document.getElementById("unpaidBalance").textContent = "Ksh " + (data.unpaid || 0);
        }
      }
    });

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
    });

    // Loan Application
    document.getElementById("loanForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) return;

      const loanData = {
        fullName: document.getElementById("fullName").value,
        idNumber: document.getElementById("idNumber").value,
        phone: document.getElementById("phone").value,
        residence: document.getElementById("residence").value,
        employment: document.getElementById("employment").value,
        guarantorName: document.getElementById("guarantorName").value,
        guarantorPhone: document.getElementById("guarantorPhone").value,
        loanAmount: document.getElementById("loanAmount").value,
        repaymentPeriod: document.getElementById("repaymentPeriod").value,
        status: "Pending",
        date: new Date().toISOString()
      };

      await push(ref(db, "loans/" + user.uid), loanData);

      // PDF Download
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Loan Application", 20, 20);
      Object.keys(loanData).forEach((k, i) => {
        doc.text(`${k}: ${loanData[k]}`, 20, 30 + i * 10);
      });
      doc.save("loan_application.pdf");

      alert("Loan Application Submitted!");
      e.target.reset();
    });

    // Account Statement PDF
    window.downloadStatement = async () => {
      const user = auth.currentUser;
      if (!user) return;
      const snapshot = await get(ref(db, "balances/" + user.uid));
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Account Statement", 20, 20);
      if (snapshot.exists()) {
        const data = snapshot.val();
        let y = 30;
        for (const [k, v] of Object.entries(data)) {
          doc.text(`${k}: Ksh ${v}`, 20, y);
          y += 10;
        }
      }
      doc.save("account_statement.pdf");
    };

    // Profile update
    document.getElementById("profileForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) return;
      await set(ref(db, "profiles/" + user.uid), {
        name: document.getElementById("profileName").value,
        phone: document.getElementById("profilePhone").value
      });
      alert("Profile Updated Successfully!");
    });
  </script>
</body>
</html>
