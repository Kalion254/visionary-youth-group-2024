<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Visionary Youth Dashboard</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<!-- FontAwesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
body{margin:0;font-family:'Segoe UI',sans-serif;background:#f0f4f8;}
header{background:#1976d2;color:white;padding:15px 30px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 5px 15px rgba(0,0,0,0.2);}
header h1{margin:0;font-size:22px;}
header .user-email{font-size:14px;opacity:0.85;}
header button{background:#ff5252;color:white;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;transition:0.3s;}
header button:hover{background:#ff1744;}
.container{padding:20px;}
.tabs{display:flex;gap:10px;margin-bottom:20px;}
.tab-btn{flex:1;padding:10px;border:none;border-radius:8px;background:#e0e0e0;color:#333;font-weight:bold;cursor:pointer;transition:0.3s;}
.tab-btn.active{background:#1976d2;color:white;}
.card-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:20px;}
.card{background:white;padding:20px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,0.1);transition:0.3s;}
.card:hover{transform:translateY(-5px);box-shadow:0 12px 25px rgba(0,0,0,0.2);}
.card h3{display:flex;align-items:center;margin-top:0;font-size:18px;}
.card h3 i{margin-right:8px;color:#1976d2;}
.progress-bar{height:20px;background:#eee;border-radius:10px;overflow:hidden;margin-top:5px;}
.progress{height:100%;border-radius:10px;text-align:right;color:white;padding-right:5px;transition:width 0.7s;}
.section{display:none;background:white;padding:20px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,0.1);}
.section.active{display:block;}
input,select,button{width:100%;padding:10px;margin:8px 0;border-radius:6px;border:1px solid #ccc;}
button{background:#1976d2;color:white;border:none;cursor:pointer;transition:0.3s;}
button:hover{background:#115293;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
table th,table td{border:1px solid #ddd;padding:8px;text-align:center;}
table th{background:#1976d2;color:white;}
.badge{padding:3px 6px;border-radius:5px;color:white;font-weight:bold;}
.badge.Applied{background:#2196f3;}
.badge.Registered{background:#64b5f6;}
.badge.Verified{background:#ff9800;}
.badge.Allocation{background:#9c27b0;}
.badge['Disbursement in Progress']{background:#009688;}
.badge.Disbursed{background:#4caf50;}
</style>
</head>
<body>

<header>
<div>
<h1 id="userName">User</h1>
<div class="user-email" id="emailDisplay">email@example.com</div>
</div>
<button id="logoutBtn">Logout</button>
</header>

<div class="container">

<!-- Tabs -->
<div class="tabs">
<button class="tab-btn active">Financial Overview</button>
<button class="tab-btn">Profile</button>
<button class="tab-btn">Loan Application</button>
<button class="tab-btn">Loan Progress</button>
<button class="tab-btn">Account Statement</button>
</div>

<!-- Sections -->
<div id="financial" class="section active">
<div class="card-grid">
<div class="card"><h3><i class="fa-solid fa-money-bill-wave"></i> Weekly Savings</h3><p id="weeklySavings">0</p><div class="progress-bar"><div class="progress" id="weeklyProgress">0%</div></div></div>
<div class="card"><h3><i class="fa-solid fa-calendar-days"></i> Monthly Savings</h3><p id="monthlySavings">0</p><div class="progress-bar"><div class="progress" id="monthlyProgress">0%</div></div></div>
<div class="card"><h3><i class="fa-solid fa-chart-simple"></i> Shares</h3><p id="shares">0</p><div class="progress-bar"><div class="progress" id="sharesProgress">0%</div></div></div>
<div class="card"><h3><i class="fa-solid fa-hand-holding-dollar"></i> Loan</h3><p id="loan">0</p><div class="progress-bar"><div class="progress" id="loanProgress">0%</div></div></div>
<div class="card"><h3><i class="fa-solid fa-circle-exclamation"></i> Unpaid Balances</h3><p id="unpaidBalances">0</p></div>
<div class="card"><h3><i class="fa-solid fa-gem"></i> Dividends</h3><p id="dividends">0</p></div>
</div>
</div>

<div id="profile" class="section">
<h3>Update Profile</h3>
<form id="profileForm">
<label>Name</label><input id="profileName" required>
<label>ID</label><input id="profileID" required>
<label>Email</label><input type="email" id="profileEmail" required>
<label>Phone Number</label><input id="profilePhone" required>
<label>Origin</label><input id="profileOrigin" required>
<label>Member Number</label><input id="profileMember" required>
<label>Passport Upload</label><input type="file" id="passport" accept="image/*" required>
<button type="submit" id="profileUpdateBtn">Update Profile</button>
</form>
</div>

<div id="loan" class="section">
<h3>Loan Application</h3>
<div id="loanProgressBar" class="progress-bar"><div id="loanProgressFill" class="progress" style="width:0%"></div></div>
<form id="loanMultiForm">
<div class="loanStep" style="display:block;">
<label>Name</label><input id="loanName" required>
<label>ID</label><input id="loanID" required>
<label>Email</label><input type="email" id="loanEmail" required>
<label>Phone</label><input id="loanPhone" required>
<label>Origin</label><input id="loanOrigin" required>
<button type="button" class="nextBtn">Next</button>
</div>
<div class="loanStep">
<label>Amount</label><input type="number" id="loanAmount" required>
<label>Category</label><select id="loanCategory" required><option value="">Select</option><option value="Business">Business</option><option value="Education">Education</option><option value="Emergency">Emergency</option></select>
<label>Purpose</label><input id="loanPurpose" required>
<label>Duration (Months)</label><input type="number" id="loanDuration" required>
<button type="button" class="prevBtn">Back</button>
<button type="button" class="nextBtn">Next</button>
</div>
<div class="loanStep">
<label>Guarantor Name</label><input id="guarantorName" required>
<label>Guarantor ID</label><input id="guarantorID" required>
<label>Guarantor Phone</label><input id="guarantorPhone" required>
<label>Guarantor Email</label><input type="email" id="guarantorEmail" required>
<button type="button" class="prevBtn">Back</button>
<button type="button" class="nextBtn">Next</button>
</div>
<div class="loanStep">
<label>Repayment Plan</label><select id="repaymentPlan" required><option value="">Select</option><option value="Weekly">Weekly</option><option value="Monthly">Monthly</option></select>
<label>Installment Amount</label><input type="number" id="installmentAmount" required>
<label>Due Date</label><input type="date" id="dueDate" required>
<button type="button" class="prevBtn">Back</button>
<button type="button" id="submitLoanBtn">Submit</button>
</div>
</form>
<button id="downloadLoanBtn" style="display:none;">Download Your Loan Application</button>
</div>

<div id="loanProgress" class="section">
<h3>Loan Progress History</h3>
<table id="loanProgressTable"><thead><tr><th>Date</th><th>Stage</th><th>Amount</th><th>Status</th></tr></thead><tbody></tbody></table>
</div>

<div id="statement" class="section">
<h3>Download Account Statement</h3>
<button id="downloadStatementBtn">Download CSV</button>
</div>

<script>
window.onload = () => {
    let currentUserUid, currentStep = 1, inactivityTimer;
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();

    const sections = document.querySelectorAll('.section');
    const tabButtons = document.querySelectorAll('.tab-btn');

    function showSection(id, btn){
        sections.forEach(s=>s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        tabButtons.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
    }

    // Tabs
    tabButtons.forEach(btn=>{
        btn.addEventListener('click', ()=> {
            const text = btn.textContent.trim();
            switch(text){
                case 'Financial Overview': showSection('financial', btn); break;
                case 'Profile': showSection('profile', btn); break;
                case 'Loan Application': showSection('loan', btn); break;
                case 'Loan Progress': showSection('loanProgress', btn); break;
                case 'Account Statement': showSection('statement', btn); break;
            }
        });
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', ()=> auth.signOut().then(()=>window.location.href="index.html"));

    // Auto logout
    function resetInactivityTimer(){ clearTimeout(inactivityTimer); inactivityTimer=setTimeout(()=>{ alert("Logged out due to inactivity"); auth.signOut().then(()=>window.location.href="index.html");},15*60*1000);}
    document.onmousemove=resetInactivityTimer; document.onkeypress=resetInactivityTimer;

    // Login check
    auth.onAuthStateChanged(user=>{
        if(user){
            currentUserUid=user.uid;
            loadProfile();
            loadFinancials();
            loadLoanProgress();
        } else { window.location.href="index.html"; }
    });

    // Profile update
    document.getElementById('profileForm').addEventListener('submit', async e=>{
        e.preventDefault();
        try{
            const name = document.getElementById("profileName").value.trim();
            const id = document.getElementById("profileID").value.trim();
            const email = document.getElementById("profileEmail").value.trim();
            const phone = document.getElementById("profilePhone").value.trim();
            const origin = document.getElementById("profileOrigin").value.trim();
            const member = document.getElementById("profileMember").value.trim();
            const passportFile = document.getElementById("passport").files[0];
            if(!name||!id||!email||!phone||!origin||!member||!passportFile) return alert("All fields required!");

            const ref = storage.ref(`passports/${currentUserUid}_${passportFile.name}`);
            await ref.put(passportFile);
            const url = await ref.getDownloadURL();
            await db.ref(`users/${currentUserUid}/profile`).set({name,id,email,phone,origin,member_number:member,passport:url});
            alert("Profile updated successfully!");
            document.getElementById("profileUpdateBtn").disabled=true;
        } catch(err){ alert(err.message); }
    });

    // Load financials
    function loadFinancials(){
        db.ref(`users/${currentUserUid}/financials`).on('value', snap=>{
            const d = snap.val()||{};
            document.getElementById("userName").innerText = d.name||"User";
            document.getElementById("emailDisplay").innerText = d.email||"";
            document.getElementById("weeklySavings").innerText = d.weekly_savings||0;
            document.getElementById("monthlySavings").innerText = d.monthly_savings||0;
            document.getElementById("shares").innerText = d.shares||0;
            document.getElementById("loan").innerText = d.loan||0;
            document.getElementById("unpaidBalances").innerText = d.unpaid_balances||0;
            document.getElementById("dividends").innerText = d.dividends||0;
            document.getElementById("weeklyProgress").style.width=Math.min((d.weekly_savings||0)/10000*100,100)+'%';
            document.getElementById("monthlyProgress").style.width=Math.min((d.monthly_savings||0)/50000*100,100)+'%';
            document.getElementById("sharesProgress").style.width=Math.min((d.shares||0)/5000*100,100)+'%';
            document.getElementById("loanProgress").style.width=Math.min((d.loan||0)/20000*100,100)+'%';
        });
    }

    // Loan multi-step
    const loanSteps = document.querySelectorAll('.loanStep');
    const nextBtns = document.querySelectorAll('.nextBtn');
    const prevBtns = document.querySelectorAll('.prevBtn');
    function updateLoanProgress(){ document.getElementById('loanProgressFill').style.width = ((currentStep-1)/(loanSteps.length-1)*100)+'%'; }

    nextBtns.forEach((btn,i)=> btn.addEventListener('click', ()=>{
        for(let inp of loanSteps[currentStep-1].querySelectorAll('input,select')) if(!inp.value) return alert("All fields required!");
        loanSteps[currentStep-1].style.display='none';
        loanSteps[currentStep].style.display='block';
        currentStep++;
        updateLoanProgress();
    }));

    prevBtns.forEach((btn,i)=> btn.addEventListener('click', ()=>{
        loanSteps[currentStep-1].style.display='none';
        loanSteps[currentStep-2].style.display='block';
        currentStep--;
        updateLoanProgress();
    }));

    // Submit loan
    document.getElementById('submitLoanBtn').addEventListener('click', ()=>{
        const loanData={
            personal:{
                name:document.getElementById("loanName").value,
                id:document.getElementById("loanID").value,
                email:document.getElementById("loanEmail").value,
                phone:document.getElementById("loanPhone").value,
                origin:document.getElementById("loanOrigin").value
            },
            loanDetails:{
                amount:parseFloat(document.getElementById("loanAmount").value),
                category:document.getElementById("loanCategory").value,
                purpose:document.getElementById("loanPurpose").value,
                duration:parseInt(document.getElementById("loanDuration").value)
            },
            guarantor:{
                name:document.getElementById("guarantorName").value,
                id:document.getElementById("guarantorID").value,
                phone:document.getElementById("guarantorPhone").value,
                email:document.getElementById("guarantorEmail").value
            },
            repayment:{
                plan:document.getElementById("repaymentPlan").value,
                installmentAmount:parseFloat(document.getElementById("installmentAmount").value),
                dueDate:document.getElementById("dueDate").value
            },
            status:"Applied",
            timestamp:Date.now()
        };
        db.ref(`users/${currentUserUid}/loan_applications`).push(loanData).then(ref=>{
            alert("Loan application submitted!");
            document.getElementById("loanMultiForm").reset();
            loanSteps.forEach((s,i)=> i===0?s.style.display='block':s.style.display='none');
            currentStep=1; updateLoanProgress();
            const dlBtn = document.getElementById("downloadLoanBtn");
            dlBtn.style.display="block";
            dlBtn.onclick = ()=>downloadLoanApplication(ref.key);
            loadLoanProgress();
        });
    });

    // Download loan CSV
    function downloadLoanApplication(loanKey){
        db.ref(`users/${currentUserUid}/loan_applications/${loanKey}`).once('value').then(snap=>{
            const d = snap.val(); let csv="Section,Field,Value\n";
            for(let section in d) for(let key in d[section]) csv+=`${section},${key},${d[section][key]}\n`;
            const blob = new Blob([csv],{type:'text/csv'});
            const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download='loan_application.csv'; link.click();
        });
    }

    document.getElementById("downloadStatementBtn").addEventListener('click', ()=>{
        db.ref(`users/${currentUserUid}/financials`).once('value').then(snap=>{
            const d = snap.val()||{};
            const csv=`Type,Amount
Weekly Savings,${d.weekly_savings||0}
Monthly Savings,${d.monthly_savings||0}
Shares,${d.shares||0}
Loan,${d.loan||0}
Unpaid Balances,${d.unpaid_balances||0}
Dividends,${d.dividends||0}`;
            const blob = new Blob([csv],{type:'text/csv'});
            const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download='account_statement.csv'; link.click();
        });
    });

    function loadLoanProgress(){
        const tbody = document.querySelector("#loanProgressTable tbody"); tbody.innerHTML="";
        db.ref(`users/${currentUserUid}/loan_applications`).on('value', snap=>{
            snap.forEach(child=>{
                const loan = child.val();
                const date = new Date(loan.timestamp).toLocaleString();
                const amount = loan.loanDetails.amount||0;
                const status = loan.status||"Applied";
                const tr = document.createElement("tr");
                tr.innerHTML=`<td>${date}</td><td>${status}</td><td>${amount}</td><td><span class="badge ${status.replace(/\s/g,'')}">${status}</span></td>`;
                tbody.appendChild(tr);
            });
        });
    }

};
</script>

</body>
</html>
