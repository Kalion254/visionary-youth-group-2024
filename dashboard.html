<script>
// Firebase config
const firebaseConfig = { 
    apiKey:"AIzaSyA_OCu7HQ5HCH2OYx5dQ2Z1r7YPwQJave4",
    authDomain:"visionary-youth-grou-2024.firebaseapp.com",
    databaseURL:"https://visionary-youth-grou-2024-default-rtdb.firebaseio.com/",
    projectId:"visionary-youth-grou-2024",
    storageBucket:"visionary-youth-grou-2024.firebasestorage.app",
    messagingSenderId:"372978592717",
    appId:"1:372978592717:web:624596619d41aab84f3284",
    measurementId:"G-FEHC1GM3B7"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

let currentUserUid, currentStep = 1, inactivityTimer;

// Tabs
function showSection(id, btn) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

// Fix tab buttons
document.querySelectorAll('.tab-btn').forEach(btn => {
    const target = btn.textContent.trim();
    btn.addEventListener('click', () => {
        switch(target){
            case 'Financial Overview': showSection('financial', btn); break;
            case 'Profile': showSection('profile', btn); break;
            case 'Loan Application': showSection('loan', btn); break;
            case 'Loan Progress': showSection('loanProgress', btn); break;
            case 'Account Statement': showSection('statement', btn); break;
        }
    });
});

// Auto logout
function resetInactivityTimer() {
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(()=>{ alert("Logged out due to inactivity"); logout(); }, 5*60*1000);
}
document.onmousemove = resetInactivityTimer;
document.onkeypress = resetInactivityTimer;

// Login check
auth.onAuthStateChanged(user => {
    if(user){
        currentUserUid = user.uid;
        loadProfile();
        loadFinancials();
        loadLoanProgress();
    } else {
        window.location.href = "index.html";
    }
});

// Logout
function logout(){
    auth.signOut().then(()=>window.location.href="index.html");
}

// Profile update
async function updateProfile(){
    try {
        const name = document.getElementById("profileName").value.trim();
        const id = document.getElementById("profileID").value.trim();
        const email = document.getElementById("profileEmail").value.trim();
        const phone = document.getElementById("profilePhone").value.trim();
        const origin = document.getElementById("profileOrigin").value.trim();
        const member = document.getElementById("profileMember").value.trim();
        const passportFile = document.getElementById("passport").files[0];
        if(!name||!id||!email||!phone||!origin||!member||!passportFile) return alert("All fields required!");

        const ref = storage.ref(`passports/${currentUserUid}_${passportFile.name}`);
        await ref.put(passportFile);
        const url = await ref.getDownloadURL();
        await db.ref(`users/${currentUserUid}/profile`).set({name,id,email,phone,origin,member_number:member,passport:url});
        alert("Profile updated successfully!");
        document.getElementById("profileUpdateBtn").disabled = true;
    } catch(e){ alert(e.message); }
}

// Load financials
function loadFinancials(){
    db.ref(`users/${currentUserUid}/financials`).on('value', snap => {
        const d = snap.val() || {};
        document.getElementById("userName").innerText = d.name || "User";
        document.getElementById("emailDisplay").innerText = d.email || "";
        document.getElementById("weeklySavings").innerText = d.weekly_savings||0;
        document.getElementById("monthlySavings").innerText = d.monthly_savings||0;
        document.getElementById("shares").innerText = d.shares||0;
        document.getElementById("loan").innerText = d.loan||0;
        document.getElementById("unpaidBalances").innerText = d.unpaid_balances||0;
        document.getElementById("dividends").innerText = d.dividends||0;
        document.getElementById("weeklyProgress").style.width = Math.min((d.weekly_savings||0)/10000*100,100)+'%';
        document.getElementById("monthlyProgress").style.width = Math.min((d.monthly_savings||0)/50000*100,100)+'%';
        document.getElementById("sharesProgress").style.width = Math.min((d.shares||0)/5000*100,100)+'%';
        document.getElementById("loanProgress").style.width = Math.min((d.loan||0)/20000*100,100)+'%';
    });
}

// Loan multi-step
function updateLoanProgress(){ document.getElementById('loanProgressFill').style.width = ((currentStep-1)/3*100)+'%'; }
function nextStep(step){
    const divs = document.querySelectorAll('.loanStep');
    for(let inp of divs[step-1].querySelectorAll('input,select')) if(!inp.value) return alert("All fields required");
    divs[step-1].style.display='none';
    divs[step].style.display='block';
    currentStep++;
    updateLoanProgress();
}
function prevStep(step){
    const divs = document.querySelectorAll('.loanStep');
    divs[step-1].style.display='block';
    divs[step].style.display='none';
    currentStep--;
    updateLoanProgress();
}

// Submit loan
function submitLoanApplication(){
    const loanData={
        personal:{
            name:document.getElementById("loanName").value,
            id:document.getElementById("loanID").value,
            email:document.getElementById("loanEmail").value,
            phone:document.getElementById("loanPhone").value,
            origin:document.getElementById("loanOrigin").value
        },
        loanDetails:{
            amount:parseFloat(document.getElementById("loanAmount").value),
            category:document.getElementById("loanCategory").value,
            purpose:document.getElementById("loanPurpose").value,
            duration:parseInt(document.getElementById("loanDuration").value)
        },
        guarantor:{
            name:document.getElementById("guarantorName").value,
            id:document.getElementById("guarantorID").value,
            phone:document.getElementById("guarantorPhone").value,
            email:document.getElementById("guarantorEmail").value
        },
        repayment:{
            plan:document.getElementById("repaymentPlan").value,
            installmentAmount:parseFloat(document.getElementById("installmentAmount").value),
            dueDate:document.getElementById("dueDate").value
        },
        status:"Applied",
        timestamp:Date.now()
    };
    db.ref(`users/${currentUserUid}/loan_applications`).push(loanData).then(ref=>{
        alert("Loan application submitted!");
        document.getElementById("loanMultiForm").reset();
        document.querySelectorAll('.loanStep').forEach((d,i)=>i===0?d.style.display='block':d.style.display='none');
        currentStep=1;updateLoanProgress();
        document.getElementById("downloadLoanBtn").style.display="block";
        document.getElementById("downloadLoanBtn").onclick = ()=>downloadLoanApplication(ref.key);
        loadLoanProgress();
    });
}

// Download CSV
function downloadLoanApplication(loanKey){
    db.ref(`users/${currentUserUid}/loan_applications/${loanKey}`).once('value').then(snap=>{
        const d = snap.val();
        let csv="Section,Field,Value\n";
        for(let section in d){ for(let key in d[section]) csv+=`${section},${key},${d[section][key]}\n`; }
        const blob = new Blob([csv], {type:'text/csv'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'loan_application.csv';
        link.click();
    });
}
function downloadStatement(){
    db.ref(`users/${currentUserUid}/financials`).once('value').then(snap=>{
        const d = snap.val()||{};
        const csv=`Type,Amount
Weekly Savings,${d.weekly_savings||0}
Monthly Savings,${d.monthly_savings||0}
Shares,${d.shares||0}
Loan,${d.loan||0}
Unpaid Balances,${d.unpaid_balances||0}
Dividends,${d.dividends||0}`;
        const blob = new Blob([csv],{type:'text/csv'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download='account_statement.csv';
        link.click();
    });
}

// Load loan progress
function loadLoanProgress(){
    const tbody = document.querySelector("#loanProgressTable tbody");
    tbody.innerHTML="";
    db.ref(`users/${currentUserUid}/loan_applications`).on('value', snap=>{
        snap.forEach(child=>{
            const loan = child.val();
            const date = new Date(loan.timestamp).toLocaleString();
            const amount = loan.loanDetails.amount||0;
            const status = loan.status||"Applied";
            const stage = loan.status;
            const tr = document.createElement("tr");
            tr.innerHTML=`<td>${date}</td><td>${stage}</td><td>${amount}</td><td><span class="badge ${stage}">${status}</span></td>`;
            tbody.appendChild(tr);
        });
    });
}
</script>
