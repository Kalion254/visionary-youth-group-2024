<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Visionary Youth Group — Dashboard (Integrated)</title>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{
    --dark:#164e2a;
    --accent:#2e7d32;
    --gold:#ffcc00;
    --bg1:#e9ffec;
    --card:#ffffff;
    --muted:#6b7280;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family:'Poppins',sans-serif;background:linear-gradient(120deg,var(--bg1),#f6fff6);color:#123;
    -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
  }

  /* Top bar */
  .topbar{
    position:fixed;left:0;right:0;top:0;height:64px;background:linear-gradient(90deg,var(--dark),#26734d);color:#fff;
    display:flex;align-items:center;justify-content:space-between;padding:0 18px;z-index:1200;
    box-shadow:0 6px 20px rgba(6,50,20,0.12);
  }
  .brand{display:flex;align-items:center;gap:12px}
  .brand h1{font-size:1.05rem;margin:0;font-weight:700}
  .hamburger{font-size:1.6rem;cursor:pointer}
  .user-area{display:flex;align-items:center;gap:12px}
  .avatar-wrap{width:44px;height:44px;border-radius:8px;overflow:hidden;background:#fff;display:flex;align-items:center;justify-content:center}
  .avatar-wrap img{width:100%;height:100%;object-fit:cover;display:block}
  .user-info{text-align:right;font-size:0.95rem}
  .user-info small{display:block;color:rgba(255,255,255,0.85)}

  /* Menu overlay (slightly offset from left for mobile) */
  .menu{
    position:fixed;top:64px;left:12px;background:rgba(255,255,255,0.98);max-width:320px;border-radius:8px;padding:8px;
    box-shadow:0 8px 30px rgba(0,0,0,0.12);display:none;z-index:1199;
    transform-origin:top left;
  }
  .menu a{display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;color:#123;text-decoration:none}
  .menu a:hover{background:#f1fff1}

  /* Layout */
  .page{
    max-width:1200px;margin:92px auto 48px;padding:0 18px;
    display:grid;grid-template-columns:repeat(12,1fr);gap:18px;
  }

  /* Hero / summary */
  .hero{grid-column:span 12;background:var(--card);border-radius:12px;padding:16px;display:flex;justify-content:space-between;align-items:center;gap:16px;box-shadow:0 8px 20px rgba(6,50,20,0.03)}
  .welcome{display:flex;flex-direction:column}
  .welcome h2{margin:0;color:var(--dark)}
  .quick-actions{display:flex;gap:10px}

  /* cards */
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 8px 20px rgba(6,50,20,0.05);}
  .balances-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px}
  .balance{background:linear-gradient(180deg,#f3fff3,#ffffff);padding:12px;border-radius:10px;text-align:center}
  .balance .label{color:var(--muted);font-size:0.95rem}
  .balance .value{font-weight:700;font-size:1.25rem;color:var(--accent);margin-top:8px}

  /* loan application large area */
  .big{grid-column:span 8}
  .side{grid-column:span 4}

  /* form */
  .form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .form-grid .full{grid-column:1/-1}
  input, select, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;font-size:0.95rem}
  textarea{min-height:100px;resize:vertical}
  .btn{background:var(--accent);color:white;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700}
  .btn.secondary{background:#fff;color:var(--accent);border:1px solid #e3f1e3}

  /* Voluntary Withdrawal Application specifics - kept styles */
  /* loan stages */
  .stages{display:flex;gap:10px;align-items:center;justify-content:space-between}
  .stage{flex:1;padding:10px;border-radius:8px;background:#f5faf5;text-align:center}
  .stage.active{background:var(--dark);color:white;font-weight:700}
  .stage.done{background:#27ae60;color:white}

  /* guarantors table */
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border:1px solid #e6f0ea;font-size:0.9rem;text-align:left}

  /* sidebar small tweaks */
  .side h2{margin-top:0}
  .muted{color:var(--muted)}

  /* profile area fix: ensure it can grow and isn't cut on small screens */
  #profile-area{overflow:visible}
  .profile-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}

  /* small screens adjustments */
  @media (max-width:1000px){
    .big{grid-column:span 12}
    .side{grid-column:span 12}
    .form-grid{grid-template-columns:1fr}
    .menu{left:8px;right:8px;max-width:unset}
  }

  /* PDF watermark (visual only in page if needed) */
  .watermark{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);opacity:0.06;font-size:72px;color:#2e7d32;pointer-events:none;white-space:nowrap}

  /* wizard & added visuals */
  .wiz-step{display:none}
  .wiz-step.active{display:block}
  .wiz-nav{display:flex;gap:8px;align-items:center;margin-top:8px}
  .status-badge{padding:6px 10px;border-radius:8px;font-weight:700}
  .status-pending{background:#fff7ed;color:#92400e}
  .status-approved{background:#ecfdf5;color:#065f46}
  .status-rejected{background:#fff1f2;color:#9f1239}
  .small-muted{font-size:0.9rem;color:var(--muted)}
  #goalProgressBar{height:10px;background:linear-gradient(90deg,#16a34a,#86efac);border-radius:8px;width:0%}

</style>
</head>
<body>

  <div class="topbar">
    <div class="brand">
      <i class="fas fa-seedling" style="font-size:1.25rem;color:var(--gold)"></i>
      <h1>Visionary Youth Group</h1>
    </div>

    <div class="user-area">
      <div class="avatar-wrap" id="topAvatar" title="Profile photo">
        <!-- avatar inserted by JS -->
      </div>
      <div class="user-info">
        <div id="topEmail">—</div>
        <small id="topStatus">Status: <strong style="color:#9ff2b8">Active</strong></small>
      </div>

      <div style="display:flex;align-items:center;gap:10px">
        <button id="downloadStatementTop" title="Download Account Statement" class="btn secondary"><i class="fas fa-file-pdf"></i>&nbsp;Statement</button>
        <i class="fas fa-bars hamburger hamburgerAction" role="button" aria-label="Menu" style="font-size:20px;color:#fff;margin-left:6px"></i>
      </div>
    </div>
  </div>

  <!-- Menu: hidden by default and offset a bit for mobile finger tap -->
  <div class="menu" id="menu" aria-hidden="true">
    <a href="#" data-target="overview"><i class="fas fa-home"></i> Overview</a>
    <a href="#" data-target="balancesCard"><i class="fas fa-wallet"></i> Balances</a>
    <a href="#" data-target="loan-section"><i class="fas fa-file-signature"></i> Loan Application</a>
    <a href="#" data-target="loansListFull"><i class="fas fa-money-bill-wave"></i> Loans (Manage)</a>
    <a href="#" data-target="withdraw-section"><i class="fas fa-hand-holding-usd"></i> Withdrawals</a>
    <a href="#" data-target="profile-area"><i class="fas fa-user-edit"></i> Update Profile</a>
    <a href="#" id="menuLogout"><i class="fas fa-sign-out-alt"></i> Logout</a>
  </div>

  <main class="page" id="pageRoot">
    <!-- hero -->
    <div class="hero card" id="overview">
      <div class="welcome">
        <h2 id="welcomeName">Welcome, Member</h2>
        <div style="color:var(--muted);margin-top:6px">Quick snapshot — all amounts shown in <strong>Ksh</strong></div>
        <div style="margin-top:6px;font-size:0.9rem">Points: <strong id="pointsDisplay">0</strong></div>
      </div>
      <div class="quick-actions">
        <button id="quickApply" class="btn"><i class="fas fa-file-signature"></i>&nbsp;Apply Loan</button>
        <button id="quickStatement" class="btn secondary"><i class="fas fa-file-download"></i>&nbsp;Statement</button>
      </div>
    </div>

    <!-- balances summary -->
    <div class="card big" id="balancesCard">
      <h2>Balances</h2>

      <div class="balances-grid">
        <div class="balance"><div class="label">Monthly Savings</div><div class="value" id="monthlyVal">Ksh 0</div></div>
        <div class="balance"><div class="label">Weekly Savings</div><div class="value" id="weeklyVal">Ksh 0</div></div>
        <div class="balance"><div class="label">Shares</div><div class="value" id="sharesVal">Ksh 0</div></div>
        <div class="balance"><div class="label">Dividends</div><div class="value" id="dividendsVal">Ksh 0</div></div>
        <div class="balance"><div class="label">Total Loans</div><div class="value" id="totalLoansVal">Ksh 0</div></div>
        <div class="balance"><div class="label">Unpaid Balances</div><div class="value" id="unpaidVal">Ksh 0</div></div>
        <div class="balance"><div class="label">Outstanding Loans</div><div class="value" id="outstandingLoansVal">Ksh 0</div></div>
      </div>

      <!-- Goals / Shares area (ADDED) -->
      <div style="margin-top:12px;display:flex;gap:12px;align-items:flex-start">
        <!-- Goal small form -->
        <div style="flex:1" class="card" id="goalCard">
          <h4 style="margin:0 0 8px 0">Set a Goal</h4>
          <div class="small-muted">Tell us your goal so we can track progress and remind you.</div>
          <div style="margin-top:8px" class="form-grid">
            <input id="goal_name" placeholder="Your full name" class="full">
            <input id="goal_id" placeholder="ID Number" >
            <input id="goal_title" placeholder="Goal title (e.g., 'Buy a motorbike')">
            <input id="goal_target" placeholder="Target amount (Ksh)" type="number">
            <input id="goal_start" type="date" placeholder="Start date">
            <input id="goal_end" type="date" placeholder="End date">
          </div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button id="saveGoalBtn" class="btn">Save Goal</button>
            <button id="goalPdfBtn" class="btn secondary">Download Goal PDF</button>
          </div>
          <div style="margin-top:10px">
            <div class="small-muted">Progress</div>
            <div style="height:10px;background:#eefaf0;border-radius:6px;overflow:hidden;margin-top:6px">
              <div id="goalProgressBar" style="height:100%;width:0;background:linear-gradient(90deg,#16a34a,#86efac)"></div>
            </div>
            <div class="small-muted" style="margin-top:6px">Progress: <span id="goalProgressPct">0%</span></div>
          </div>
        </div>

        <!-- Shares purchase form -->
        <div style="width:360px" class="card" id="sharesCard">
          <h4 style="margin:0 0 8px 0">Purchase Shares</h4>
          <div class="small-muted">Set a shares target and pay installments to reach it.</div>
          <div style="margin-top:8px">
            <label class="small-muted">Target amount (Ksh)</label>
            <input id="shares_target" type="number" placeholder="e.g., 5000" style="width:100%;padding:8px;border-radius:8px;border:1px solid #d1d5db;margin-top:6px">
            <label class="small-muted" style="margin-top:8px;display:block">Start date</label>
            <input id="shares_start" type="date" style="width:100%;padding:8px;border-radius:8px;border:1px solid #d1d5db;margin-top:6px">
            <label class="small-muted" style="margin-top:8px;display:block">Installments (count)</label>
            <input id="shares_installments" type="number" placeholder="e.g., 5" style="width:100%;padding:8px;border-radius:8px;border:1px solid #d1d5db;margin-top:6px">
            <div style="margin-top:8px;display:flex;gap:8px">
              <button id="saveSharesGoal" class="btn">Save Shares Goal</button>
              <button id="payShareInstallment" class="btn secondary">Record Installment</button>
            </div>

            <div style="margin-top:12px">
              <div class="small-muted">Shares goal progress: <span id="sharesProgressPct">0%</span></div>
              <div style="height:8px;background:#eefaf0;border-radius:6px;overflow:hidden;margin-top:6px">
                <div id="sharesProgressBar" style="height:100%;width:0;background:linear-gradient(90deg,#0ea5a3,#7dd3fc)"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Loan Application: TRANSFORMED INTO WIZARD — THIS REPLACES single-page submittal but preserves all original fields & PDF builders -->
    <section class="card big" id="loan-section" aria-labelledby="loanHeading">
      <h2 id="loanHeading"><i class="fas fa-file-signature"></i> Loan Application (Wizard) — Official Form</h2>

      <!-- Wizard navigation -->
      <div class="wiz-nav small-muted" style="margin-top:8px">
        <div id="wizStepLabel">Step <strong id="wizStep">1</strong> / 6</div>
        <div style="flex:1;height:8px;background:#eef6ee;border-radius:6px;margin-left:12px;overflow:hidden">
          <div id="wizBar" style="height:100%;width:0;background:linear-gradient(90deg,var(--accent),#86efac)"></div>
        </div>
      </div>

      <!-- The form now is a wizard. All original fields are preserved — field names kept where possible -->
      <form id="loanWizardForm" style="margin-top:10px">
        <!-- Step 1: Membership form (ADDED) -->
        <div class="wiz-step active" id="wiz-1">
          <h3>Membership — Personal Information</h3>
          <div class="form-grid">
            <input name="selfHelpGroup" class="full" placeholder="Name of Self-Help Group">
            <input name="memberName" placeholder="Full name" required>
            <input name="membershipNumber" placeholder="Membership Number (M/No)" required>
            <input name="nationalId" placeholder="National ID / Passport No" required>
            <input name="phone" placeholder="Phone" required>
            <input name="email" type="email" placeholder="E-mail" required>
            <select name="educationLevel"><option value="">Education Level</option><option>Primary</option><option>Secondary</option><option>Diploma</option><option>Undergraduate</option><option>Postgraduate</option></select>
            <input name="incomeSource" placeholder="Main source of income">
            <input name="nextOfKin" placeholder="Next of Kin name">
            <input name="nextOfKinPhone" placeholder="Next of Kin phone">
            <input name="residenceCounty" placeholder="County">
            <input name="residenceTown" placeholder="Town / City">
          </div>
          <div style="margin-top:8px" class="small-muted">This membership info will be saved under `members/{uid}/profile` when you submit the wizard.</div>
        </div>

        <!-- Step 2: Residence -->
        <div class="wiz-step" id="wiz-2">
          <h3>Residence & Contact</h3>
          <div class="form-grid">
            <input name="county" placeholder="County" required>
            <input name="town" placeholder="City / Town">
            <input name="ward" placeholder="Ward">
            <input name="village" placeholder="Village / Estate">
            <input name="currentAddress" placeholder="Current Address" class="full">
          </div>
        </div>

        <!-- Step 3: Education/Employment -->
        <div class="wiz-step" id="wiz-3">
          <h3>Education & Employment</h3>
          <div class="form-grid">
            <input name="education" placeholder="Education (e.g., Diploma)">
            <input name="institution" placeholder="Institution / School">
            <input name="periodEmployment" placeholder="Period in Current Employment">
            <input name="employer" placeholder="Current Employer">
            <input name="position" placeholder="Position">
            <input name="monthlyIncome" placeholder="Monthly Income (Ksh)">
          </div>
        </div>

        <!-- Step 4: Guarantors -->
        <div class="wiz-step" id="wiz-4">
          <h3>Guarantors (3 required)</h3>
          <table>
            <thead><tr><th>M No.</th><th>Name in Full</th><th>Cell Phone</th><th>ID No.</th><th>Group Name</th><th>Amount (Ksh)</th></tr></thead>
            <tbody>
              <tr>
                <td><input name="g_mno_1" placeholder="MNo" required></td>
                <td><input name="g_name_1" placeholder="Full name" required></td>
                <td><input name="g_phone_1" placeholder="Phone" required></td>
                <td><input name="g_id_1" placeholder="ID No." required></td>
                <td><input name="g_group_1" placeholder="SHG Name"></td>
                <td><input name="g_amount_1" placeholder="Ksh" required></td>
              </tr>
              <tr>
                <td><input name="g_mno_2" placeholder="MNo" required></td>
                <td><input name="g_name_2" placeholder="Full name" required></td>
                <td><input name="g_phone_2" placeholder="Phone" required></td>
                <td><input name="g_id_2" placeholder="ID No." required></td>
                <td><input name="g_group_2" placeholder="SHG Name"></td>
                <td><input name="g_amount_2" placeholder="Ksh" required></td>
              </tr>
              <tr>
                <td><input name="g_mno_3" placeholder="MNo" required></td>
                <td><input name="g_name_3" placeholder="Full name" required></td>
                <td><input name="g_phone_3" placeholder="Phone" required></td>
                <td><input name="g_id_3" placeholder="ID No." required></td>
                <td><input name="g_group_3" placeholder="SHG Name"></td>
                <td><input name="g_amount_3" placeholder="Ksh" required></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Step 5: Loan Details -->
        <div class="wiz-step" id="wiz-5">
          <h3>Loan Details</h3>
          <div class="form-grid">
            <input name="amountFigures" placeholder="Amount Requested (Figures, Ksh)" required>
            <input name="amountWords" placeholder="Amount in words" required>
            <input name="purpose" placeholder="Purpose of the Loan" required>
            <input name="repayableMonths" placeholder="Repayable in monthly instalments (months)" required>
            <select name="disbursementMode"><option value="mpesa">M-Pesa</option><option value="bank">Bank Transfer</option><option value="cash">Cash</option></select>
            <input name="accountNumber" placeholder="Account / Till No">
            <input name="expectedStartDate" type="date" placeholder="Start date">
            <input name="expectedDueDate" type="date" placeholder="Due date (optional)">
          </div>
        </div>

        <!-- Step 6: Review & Submit -->
        <div class="wiz-step" id="wiz-6">
          <h3>Review & Submit</h3>
          <div class="small-muted">Please confirm all fields. When you submit: (1) membership profile will be saved, (2) application will be stored under `members/{uid}/loans/applications`, (3) PDF will be generated for you to download and present to the office, and (4) reminders pushed to `/reminders` if due date exists.</div>
          <div style="margin-top:10px">
            <label><input type="checkbox" id="wizAgree" required> I confirm the data and agree to the terms.</label>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;justify-content:space-between">
          <button type="button" id="wizPrev" class="btn secondary">Back</button>
          <div style="display:flex;gap:8px">
            <button type="button" id="wizNext" class="btn">Next</button>
            <button type="submit" id="wizSubmit" class="btn" style="display:none">Submit & Download PDF</button>
          </div>
        </div>
      </form>
    </section>

    <!-- withdrawals and other sections untouched -->
    <section class="card big" id="withdraw-section">
      <h2><i class="fas fa-hand-holding-usd"></i> Voluntary Withdrawable Savings Form</h2>

      <form id="withdrawForm">
        <div class="form-grid">
          <input class="full" name="memberName" placeholder="Member Name" required>
          <input name="membershipNumber" placeholder="Membership Number" required>
          <input name="idNumber" placeholder="ID / Passport Number" required>
          <input name="phone" placeholder="Phone Number" required>
          <input name="amountFigures" placeholder="Amount Requested (Figures, Ksh)" required>
          <input name="amountWords" placeholder="Amount in Words" required>
          <input class="full" name="reason" placeholder="Reason for Withdrawal" required>
        </div>

        <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
          <button class="btn" type="button" id="previewWithdrawPdf">Preview PDF</button>
          <button class="btn" type="submit" id="submitWithdrawBtn">Submit & Download PDF</button>
        </div>
      </form>
    </section>

    <!-- loans management full list (with status update selects) -->
    <section class="card side" id="loansListFull">
      <h2>Loans — Manage Applications</h2>
      <div id="loansListArea">Loading loans…</div>
      <div id="loansListFull" style="margin-top:12px"></div>

      <hr style="margin:12px 0">
      <div style="display:flex;gap:8px">
        <button id="downloadStatement" class="btn secondary"><i class="fas fa-file-pdf"></i>&nbsp;Download Statement</button>
        <button id="downloadApplications" class="btn" title="Download all my applications"><i class="fas fa-download"></i>&nbsp;My Applications</button>
      </div>
    </section>

    <!-- profile area -->
    <section class="card" id="profile-area">
      <h2><i class="fas fa-user-edit"></i> Update Profile</h2>
      <div class="profile-grid" style="margin-top:10px">
        <input class="full" id="profile_fullName" placeholder="Full name">
        <input id="profile_phone" placeholder="Phone">
        <input id="profile_id" placeholder="ID Number">
        <input id="profile_yearJoined" placeholder="Year Joined (e.g. 2021)">
        <input id="profile_dob" type="date" placeholder="Date of Birth">
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
        <input type="file" id="photoUploadInput" accept="image/*" style="display:none">
        <button id="choosePhotoBtn" class="btn secondary"><i class="fas fa-camera"></i>&nbsp;Upload Photo</button>
        <button id="saveProfile" class="btn">Save Profile</button>
        <button id="profileStatement" class="btn secondary">Account Statement</button>
      </div>

      <div style="margin-top:12px;font-size:0.9rem;color:var(--muted)">
        <strong>Note:</strong> Your photo will be visible at the top when uploaded. Profile changes are saved to the server.
      </div>
    </section>
  </main>

  <div id="toast" style="position:fixed;right:18px;bottom:18px;background:#28a745;color:#fff;padding:10px 14px;border-radius:8px;display:none;z-index:2000"></div>

<!-- Firebase & App logic -->
<script type="module">
  // Imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getDatabase, ref, onValue, get, push, set, update, onChildChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
  import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

  // jsPDF
  const { jsPDF } = window.jspdf;

  // Firebase config (kept as provided)
  const firebaseConfig = {
    apiKey: "AIzaSyA_OCu7HQ5HCH2OYx5dQ2Z1r7YPwQJave4",
    authDomain: "visionary-youth-grou-2024.firebaseapp.com",
    databaseURL: "https://visionary-youth-grou-2024-default-rtdb.firebaseio.com",
    projectId: "visionary-youth-grou-2024",
    storageBucket: "visionary-youth-grou-2024.appspot.com",
    messagingSenderId: "372978592717",
    appId: "1:372978592717:web:1c15aec728ee5f854f3284"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const storage = getStorage(app);

  // UI refs
  const hamburger = document.querySelector('.hamburgerAction');
  const menu = document.getElementById('menu');
  const toast = document.getElementById('toast');
  const topEmail = document.getElementById('topEmail');
  const welcomeName = document.getElementById('welcomeName');
  const pointsDisplay = document.getElementById('pointsDisplay');
  const topAvatar = document.getElementById('topAvatar');

  // helpers
  function showToast(msg, timeout=3000){
    toast.textContent = msg; toast.style.display='block';
    setTimeout(()=> toast.style.display='none', timeout);
  }

  function formatKsh(n){
    const num = Number(n||0);
    return 'Ksh ' + num.toLocaleString('en-KE');
  }

  // menu toggles
  if (hamburger) {
    hamburger.addEventListener('click', ()=> {
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    });
  }

  // menu links: scroll & show/hide
  menu.querySelectorAll('a[data-target]').forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      const target = a.dataset.target;
      // hide major sections then show
      const all = ['overview','balancesCard','loan-section','withdraw-section','loansListFull','profile-area'];
      all.forEach(id => { const n = document.getElementById(id); if(n) n.style.display = 'none'; });
      const el = document.getElementById(target);
      if(el) el.style.display = 'block';
      menu.style.display = 'none';
      el && el.scrollIntoView({behavior:'smooth', block:'start'});
    });
  });

  // global auth variables
  let currentUid = null;
  let profileSavedOnce = false;

  // Auto logout (3 minutes)
  let logoutTimer;
  function resetLogoutTimer(){
    clearTimeout(logoutTimer);
    logoutTimer = setTimeout(()=>{
      try { signOut(auth); } catch(e) {}
      alert('Logged out due to inactivity');
      location.href='index.html';
    }, 3*60*1000);
  }
  ['mousemove','keydown','click','touchstart'].forEach(ev=> window.addEventListener(ev, resetLogoutTimer));

  // ----- Points functions -----
  async function getPoints(){
    if(!currentUid) return 0;
    try{
      const snap = await get(ref(db, `members/${currentUid}/points`));
      return snap.exists()? Number(snap.val()||0) : 0;
    }catch(e){ console.error(e); return 0; }
  }
  async function setPoints(n){
    if(!currentUid) return;
    await set(ref(db, `members/${currentUid}/points`), Number(n||0));
    if(pointsDisplay) pointsDisplay.textContent = String(Number(n||0));
  }
  async function logActivity(msg){
    if(!currentUid) return;
    const entryRef = push(ref(db, `members/${currentUid}/activityLog`));
    await set(entryRef, {text: msg, ts: Date.now()});
  }
  async function awardPoints(n, reason){
    if(!currentUid || !n) return;
    const current = await getPoints();
    const updated = (Number(current)||0) + Number(n);
    await setPoints(updated);
    showToast(`+${n} points`);
    logActivity(`Points +${n} (${reason})`);
  }

  // ----- AUTH STATE -----
  onAuthStateChanged(auth, async user => {
    if(!user){ location.href='index.html'; return; }
    currentUid = user.uid;
    topEmail.textContent = user.email || '—';
    welcomeName.textContent = (user.email || 'Member').split('@')[0];
    resetLogoutTimer();
    awardPoints(10, 'Logged in');

    // load profile (existing)
    onValue(ref(db, `members/${currentUid}/profile`), snap=>{
      if(snap.exists()){
        const p = snap.val();
        if(p.name){ document.getElementById('welcomeName').textContent = p.name; }
        if(p.name) document.getElementById('profile_fullName').value = p.name;
        if(p.phone) document.getElementById('profile_phone').value = p.phone;
        if(p.id) document.getElementById('profile_id').value = p.id;
        if(p.yearJoined) document.getElementById('profile_yearJoined').value = p.yearJoined;
        if(p.dob) document.getElementById('profile_dob').value = p.dob;
        if(p.status) document.getElementById('topStatus').innerHTML = `Status: <strong style="color:#9ff2b8">${p.status}</strong>`;
      }
    });

    // photo
    try{
      const photoSnap = await get(ref(db, `members/${currentUid}/photoURL`));
      if(photoSnap && photoSnap.exists()){
        const url = photoSnap.val();
        setAvatar(url);
      } else {
        if(topAvatar) topAvatar.innerHTML = '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:var(--dark)"><i class="fas fa-user"></i></div>';
      }
    }catch(e){ console.error(e); }

    // balances listeners (original)
    const monthlyRef = ref(db, `members/${currentUid}/savings/monthly`);
    const weeklyRef = ref(db, `members/${currentUid}/savings/weekly`);
    const sharesRef = ref(db, `members/${currentUid}/shares/total`);
    const dividendsRef = ref(db, `members/${currentUid}/shares/dividends`);
    const unpaidRef = ref(db, `members/${currentUid}/unpaidBalances`);
    const loansTotalsRef = ref(db, `members/${currentUid}/loans/summary`);
    const outstandingLoansRef = ref(db, `members/${currentUid}/outstandingLoans`);

    async function snapToAmount(snap){
      if(!snap.exists()) return 0;
      const val = snap.val();
      if(typeof val === 'number' || typeof val === 'string') return Number(val) || 0;
      let total = 0;
      Object.values(val).forEach(child=>{
        if(child && typeof child === 'object' && ('amount' in child)) total += Number(child.amount||0);
        else if(typeof child === 'number') total += child;
        else if(typeof child === 'object' && !('amount' in child)){
          Object.values(child).forEach(c2=>{ if(c2 && typeof c2 === 'object' && ('amount' in c2)) total += Number(c2.amount||0); });
        }
      });
      return total;
    }

    onValue(monthlyRef, async s=>{ const v = await snapToAmount(s); const el = document.getElementById('monthlyVal'); if(el) el.textContent = formatKsh(v); });
    onValue(weeklyRef, async s=>{ const v = await snapToAmount(s); const el = document.getElementById('weeklyVal'); if(el) el.textContent = formatKsh(v); });
    onValue(sharesRef, s=>{ const v = s.exists()? Number(s.val()||0) : 0; const el = document.getElementById('sharesVal'); if(el) el.textContent = formatKsh(v); });
    onValue(dividendsRef, s=>{ const v = s.exists()? Number(s.val()||0) : 0; const el = document.getElementById('dividendsVal'); if(el) el.textContent = formatKsh(v); });
    onValue(unpaidRef, s=>{ const v = s.exists()? Number(s.val()||0) : 0; const el = document.getElementById('unpaidVal'); if(el) el.textContent = formatKsh(v); });

    onValue(loansTotalsRef, s=>{
      const obj = s.exists()? s.val() : {total:0,unpaid:0};
      const total = obj.total || 0; const unpaid = obj.unpaid || 0;
      const totalEl = document.getElementById('totalLoansVal'); if(totalEl) totalEl.textContent = formatKsh(total);
      const unpaidEl = document.getElementById('unpaidVal'); if(unpaidEl) unpaidEl.textContent = formatKsh(unpaid);
    });

    onValue(outstandingLoansRef, s=>{
      const v = s.exists() ? (typeof s.val() === 'number' ? s.val() : 0) : 0;
      const outEl = document.getElementById('outstandingLoansVal'); if(outEl) outEl.textContent = formatKsh(v);
    });

    // load applications and render with status update dropdown
    const appsRef = ref(db, `members/${currentUid}/loans/applications`);
    onValue(appsRef, snap=>{
      const area = document.getElementById('loansListArea');
      const areaFull = document.getElementById('loansListFull');
      if(area) area.innerHTML = '';
      if(areaFull) areaFull.innerHTML = '';
      if(!snap.exists()){
        if(area) area.innerHTML = '<div class="muted">No applications yet</div>';
        if(areaFull) areaFull.innerHTML = '<div class="muted">No applications yet</div>';
        return;
      }
      const apps = snap.val();
      const list = document.createElement('div');
      const listFull = document.createElement('div');

      Object.entries(apps).forEach(([id, app])=>{
        const short = document.createElement('div');
        short.style.padding='8px';
        short.style.borderBottom='1px solid #eef6ee';
        short.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>${app.memberName || app.name || '(Applicant)'}</strong><div style="font-size:0.85rem;color:var(--muted)">Amount: ${formatKsh(app.amountFigures || app.amount || 0)} • Status: ${app.status||'Pending'}</div></div>
          <div style="text-align:right"><small>${new Date(app.appliedAt || 0).toLocaleString()||''}</small></div>
        </div>`;
        list.appendChild(short);

        // full list entry with status control
        const fullEntry = document.createElement('div');
        fullEntry.style.padding='8px';
        fullEntry.style.borderBottom='1px solid #eef6ee';
        const status = app.status || 'Pending';
        fullEntry.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:12px;align-items:center">
            <div style="flex:1">
              <div style="font-weight:700">${app.memberName || app.name || '(Applicant)'}</div>
              <div class="muted" style="font-size:0.9rem">Amount: ${formatKsh(app.amountFigures || app.amount || 0)} • Applied: ${new Date(app.appliedAt || 0).toLocaleString()}</div>
              <div style="margin-top:6px">${(app.purpose||'')}</div>
            </div>
            <div style="min-width:220px;display:flex;flex-direction:column;gap:6px;align-items:flex-end">
              <select class="status-select" data-app-id="${id}">
                <option ${status==='Pending'?'selected':''}>Pending</option>
                <option ${status==='Approved'?'selected':''}>Approved</option>
                <option ${status==='Disbursed'?'selected':''}>Disbursed</option>
                <option ${status==='Paid'?'selected':''}>Paid</option>
                <option ${status==='Rejected'?'selected':''}>Rejected</option>
              </select>
              <small class="muted">Change status (updates RTDB)</small>
            </div>
          </div>
        `;
        listFull.appendChild(fullEntry);
      });

      if(area) area.appendChild(list);
      if(areaFull) areaFull.appendChild(listFull);

      // attach change listeners for status selects
      document.querySelectorAll('.status-select').forEach(sel=>{
        sel.addEventListener('change', async (e)=>{
          const appId = sel.dataset.appId;
          const newStatus = sel.value;
          try{
            await set(ref(db, `members/${currentUid}/loans/applications/${appId}/status`), newStatus);
            showToast('Status updated');
            logActivity(`Application ${appId} status -> ${newStatus}`);
            awardPoints(3, 'Updated application status');
          }catch(err){ console.error(err); alert('Failed to update status'); }
        });
      });
    });

    // display points
    const ptsSnap = await get(ref(db, `members/${currentUid}/points`));
    pointsDisplay.textContent = ptsSnap.exists()? String(ptsSnap.val()||0) : '0';
  }); // end onAuthStateChanged

  // ------------------ WIZARD LOGIC (replaces single fullLoanForm) ------------------
  (function wizardController(){
    const steps = [1,2,3,4,5,6];
    let current = 1;
    const total = steps.length;
    const wizBar = document.getElementById('wizBar');
    const wizStepLabel = document.getElementById('wizStep');

    function showStep(){
      steps.forEach(n=>{
        const el = document.getElementById('wiz-' + n);
        if(!el) return;
        if(n === current) el.classList.add('active'); else el.classList.remove('active');
      });
      const pct = Math.round(((current-1)/(total-1))*100);
      wizBar.style.width = pct + '%';
      wizStepLabel.textContent = String(current);
      document.getElementById('wizPrev').disabled = current === 1;
      if(current === total){
        document.getElementById('wizNext').style.display = 'none';
        document.getElementById('wizSubmit').style.display = 'inline-block';
      } else {
        document.getElementById('wizNext').style.display = 'inline-block';
        document.getElementById('wizSubmit').style.display = 'none';
      }
    }
    showStep();

    document.getElementById('wizNext').addEventListener('click', ()=> { if(current < total) current++; showStep(); });
    document.getElementById('wizPrev').addEventListener('click', ()=> { if(current > 1) current--; showStep(); });

    // On submit: save profile (membership) and application to RTDB, generate PDF, push reminders, award points
    document.getElementById('loanWizardForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!currentUid) return alert('Not signed in');
      if(!document.getElementById('wizAgree')?.checked) return alert('Please accept terms');

      const form = document.getElementById('loanWizardForm');
      const fd = new FormData(form);
      const data = Object.fromEntries(fd.entries());

      // Build guarantors array
      const guarantors = [
        { mno: data.g_mno_1 || data.g_mno_1, name: data.g_name_1, phone: data.g_phone_1, id: data.g_id_1, group: data.g_group_1, amount: data.g_amount_1 },
        { mno: data.g_mno_2, name: data.g_name_2, phone: data.g_phone_2, id: data.g_id_2, group: data.g_group_2, amount: data.g_amount_2 },
        { mno: data.g_mno_3, name: data.g_name_3, phone: data.g_phone_3, id: data.g_id_3, group: data.g_group_3, amount: data.g_amount_3 },
      ];
      data.guarantors = guarantors;
      data.appliedAt = Date.now();
      data.status = 'Pending';
      data.progress = 0;

      try{
        // Save membership profile (from step 1)
        const profilePayload = {
          name: data.memberName,
          phone: data.phone,
          id: data.nationalId,
          yearJoined: new Date().getFullYear(),
          dob: data.dob || null,
          education: data.education || data.educationLevel || null,
          incomeSource: data.incomeSource || null,
          nextOfKin: data.nextOfKin || null,
          nextOfKinPhone: data.nextOfKinPhone || null,
          address: data.currentAddress || null,
          status: 'Active'
        };
        await set(ref(db, `members/${currentUid}/profile`), profilePayload);

        // Save loan application (same path)
        const appRef = push(ref(db, `members/${currentUid}/loans/applications`));
        const appId = appRef.key;
        await set(appRef, data);

        // If due date provided, push reminder node for backend processing
        if(data.expectedDueDate){
          await push(ref(db, `reminders`), {
            uid: currentUid,
            applicationId: appId,
            dueDate: data.expectedDueDate,
            title: 'Loan due reminder',
            message: `Loan for ${data.purpose} is due on ${new Date(data.expectedDueDate).toLocaleDateString()}`,
            ts: Date.now()
          });
        }

        await awardPoints(12, 'Submitted loan via wizard');
        showToast('Application submitted; downloading PDF');

        // Build and save PDF using existing builder
        const doc = buildLoanPdfDoc(data, {id: appId});
        doc.save(`Loan_Application_${(data.memberName || 'member').replace(/\s+/g,'_')}_${appId}.pdf`);

      }catch(err){
        console.error('Wizard submit failed', err);
        alert('Failed to submit application, check console');
      }
    });
  })();

  // ------------------ Loan PDF builder (kept original) ------------------
  function buildLoanPdfDoc(data, opts={}){
    const doc = new jsPDF({unit:'pt',format:'a4'});
    let y = 40; const left = 36;

    // header block with accent bar
    doc.setFillColor(46,125,50); // --accent
    doc.rect(0,0,595,60,'F');
    doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255); doc.setFontSize(16);
    doc.text('VISIONARY YOUTH GROUP', 300, 36, {align:'center'});
    doc.setTextColor(0,0,0);

    // watermark
    doc.setTextColor(200,230,200);
    doc.setFontSize(48);
    doc.text('VISIONARY YOUTH GROUP', 300, 320, {align:'center'});
    doc.setTextColor(0,0,0);

    y = 80;
    doc.setFontSize(12); doc.setFont('helvetica','bold');
    doc.text('LOAN APPLICATION FORM', 300, y, {align:'center'}); y += 16;
    doc.setLineWidth(0.5); doc.line(left, y, 555, y); y += 14;

    // meta
    doc.setFontSize(10); doc.setFont('helvetica','bold');
    doc.text('APPLICANT INFORMATION', left, y); y+=12;
    doc.setFont('helvetica','normal'); const info = [
      `Self-help group: ${data.selfHelpGroup||''}`,
      `Name: ${data.memberName||''}`,
      `Membership No: ${data.membershipNumber||''}`,
      `National ID/Passport: ${data.nationalId||''}`,
      `DOB: ${data.dob||''}`,
      `County/Town: ${data.county||''} / ${data.town||''}`,
      `Address: ${data.currentAddress||''}`,
      `Phone: ${data.phone||''} • Email: ${data.email||''}`
    ];
    info.forEach(line=>{
      const wrap = doc.splitTextToSize(line, 520);
      doc.text(wrap, left, y); y += wrap.length * 12;
    });

    y += 6;
    doc.setFont('helvetica','bold'); doc.text('LOAN DETAILS', left, y); y+=12;
    doc.setFont('helvetica','normal');
    const loanLines = [
      `Amount: Ksh ${data.amountFigures||data.amount||''} (${data.amountWords||''})`,
      `Purpose: ${data.purpose||''}`,
      `Repayable (months): ${data.repayableMonths||''}`,
      `Disbursement: ${data.disbursementMode||''} • Account/Till: ${data.accountNumber||''}`,
      `Start / Due: ${data.expectedStartDate || '-'} / ${data.expectedDueDate || '-'}`
    ];
    loanLines.forEach(line=>{ const wr = doc.splitTextToSize(line,520); doc.text(wr,left,y); y += wr.length*12; });

    y+=8;
    doc.setFont('helvetica','bold'); doc.text('GUARANTORS', left, y); y+=10;
    doc.setFont('helvetica','normal'); doc.setFontSize(9);
    const guars = data.guarantors || [];
    guars.forEach(g=>{
      const row = `${g.mno||''} • ${g.name||''} • ${g.phone||''} • ID:${g.id||''} • ${g.group||''} • Ksh ${g.amount||''}`;
      const wr = doc.splitTextToSize(row,520);
      doc.text(wr,left,y); y += wr.length*12;
      if(y > 720){ doc.addPage(); y = 40; }
    });

    y += 8;
    doc.setFontSize(9); const terms = (data.terms||'').trim() || 'Applicant confirms they have read and agree to terms described in the system.';
    const tw = doc.splitTextToSize(terms, 520);
    doc.text(tw, left, y); y += tw.length*12;

    if(y > 700){ doc.addPage(); y=40; }
    doc.setFont('helvetica','bold'); doc.text('Applicant Signature: ______________________   Date: ___________', left, y);
    // footer
    const pageCount = doc.getNumberOfPages();
    for (let i=1;i<=pageCount;i++){
      doc.setPage(i);
      doc.setFontSize(8); doc.setTextColor(120);
      doc.text(`Visionary Youth Group • Official Loan Application • Page ${i} of ${pageCount}`, 300, 820, {align:'center'});
    }
    return doc;
  }

  // ------------------ Shares goal logic ------------------
  (function sharesController(){
    const saveBtn = document.getElementById('saveSharesGoal');
    const payBtn = document.getElementById('payShareInstallment');
    const targetInput = document.getElementById('shares_target');
    const startInput = document.getElementById('shares_start');
    const installmentsInput = document.getElementById('shares_installments');
    const progressBar = document.getElementById('sharesProgressBar');
    const progressPct = document.getElementById('sharesProgressPct');

    saveBtn?.addEventListener('click', async ()=>{
      if(!currentUid) return alert('Sign in');
      const target = Number(targetInput.value || 0);
      const start = startInput.value ? new Date(startInput.value).getTime() : null;
      const installments = Number(installmentsInput.value || 0);
      if(!target || !installments) return alert('Enter valid target and installments');
      const goalRef = push(ref(db, `members/${currentUid}/shares/goals`));
      const goalData = {
        id: goalRef.key,
        targetAmount: target,
        startDate: start,
        installments: installments,
        paid: 0,
        progressPct: 0,
        createdAt: Date.now()
      };
      await set(goalRef, goalData);
      showToast('Shares goal saved');
      await awardPoints(4, 'Set shares goal');
    });

    payBtn?.addEventListener('click', async ()=>{
      if(!currentUid) return alert('Sign in');
      // For simplicity: record payment under /members/{uid}/shares/payments
      const amount = prompt('Enter installment amount (Ksh)');
      if(!amount) return;
      const pRef = push(ref(db, `members/${currentUid}/shares/payments`));
      await set(pRef, { amount: Number(amount), ts: Date.now() });
      showToast('Installment recorded');
      await awardPoints(2, 'Paid share installment');
      // update progress: compute totals & update the active goal if exists
      const goalsSnap = await get(ref(db, `members/${currentUid}/shares/goals`));
      if(goalsSnap.exists()){
        const goals = goalsSnap.val();
        // pick latest goal
        const keys = Object.keys(goals);
        const last = goals[keys[keys.length-1]];
        const paymentsSnap = await get(ref(db, `members/${currentUid}/shares/payments`));
        let totalPaid = 0;
        if(paymentsSnap.exists()){
          Object.values(paymentsSnap.val()).forEach(p => totalPaid += Number(p.amount || 0));
        }
        const pct = Math.min(100, Math.round((totalPaid / (last.targetAmount || 1))*100));
        // update goal record
        await update(ref(db, `members/${currentUid}/shares/goals/${last.id}`), { paid: totalPaid, progressPct: pct });
        progressBar.style.width = pct + '%';
        progressPct.textContent = pct + '%';
      }
    });

    // listen for goal updates
    onAuthStateChanged(auth, user => {
      if(!user) return;
      onValue(ref(db, `members/${user.uid}/shares/goals`), snap => {
        if(!snap.exists()) return;
        const vals = snap.val();
        const lastKey = Object.keys(vals).pop();
        const g = vals[lastKey];
        const pct = g.progressPct || 0;
        progressBar.style.width = pct + '%';
        progressPct.textContent = pct + '%';
      });
    });
  })();

  // ------------------ Goal setting logic ------------------
  (function goalsController(){
    const nameInput = document.getElementById('goal_name');
    const idInput = document.getElementById('goal_id');
    const titleInput = document.getElementById('goal_title');
    const targetInput = document.getElementById('goal_target');
    const startInput = document.getElementById('goal_start');
    const endInput = document.getElementById('goal_end');
    const saveBtn = document.getElementById('saveGoalBtn');
    const pdfBtn = document.getElementById('goalPdfBtn');
    const progressBar = document.getElementById('goalProgressBar');
    const pctSpan = document.getElementById('goalProgressPct');

    saveBtn?.addEventListener('click', async ()=>{
      if(!currentUid) return alert('Sign in');
      const payload = {
        name: nameInput.value || '',
        idNumber: idInput.value || '',
        title: titleInput.value || '',
        targetAmount: Number(targetInput.value || 0),
        startDate: startInput.value ? new Date(startInput.value).getTime() : Date.now(),
        endDate: endInput.value ? new Date(endInput.value).getTime() : null,
        currentAmount: 0,
        progress: 0,
        reminderEnabled: true,
        createdAt: Date.now()
      };
      const gRef = push(ref(db, `members/${currentUid}/goals`));
      await set(gRef, payload);
      showToast('Goal saved');
      await awardPoints(4, 'Saved goal');
    });

    // Simple PDF for goal
    pdfBtn?.addEventListener('click', async ()=>{
      const doc = new jsPDF({unit:'pt',format:'a4'});
      doc.setFontSize(16); doc.text('Goal Summary', 40, 40);
      doc.setFontSize(10);
      doc.text(`Name: ${nameInput.value || ''}`, 40, 70);
      doc.text(`ID: ${idInput.value || ''}`, 40, 88);
      doc.text(`Goal: ${titleInput.value || ''}`, 40, 106);
      doc.text(`Target: ${formatKsh(targetInput.value || 0)}`, 40, 124);
      if(endInput.value) doc.text(`End date: ${new Date(endInput.value).toLocaleDateString()}`, 40, 142);
      doc.save(`Goal_${(titleInput.value||'goal').replace(/\s+/g,'_')}.pdf`);
    });

    // live update: compute progress for latest goal based on members/{uid}/savings/monthly or shares payments
    onAuthStateChanged(auth, user=>{
      if(!user) return;
      onValue(ref(db, `members/${user.uid}/goals`), async snap => {
        if(!snap.exists()) { progressBar.style.width = '0%'; pctSpan.textContent = '0%'; return; }
        const goals = snap.val();
        const lastKey = Object.keys(goals).pop();
        const g = goals[lastKey];
        // compute progress: check savings monthly + weekly totals (you can customize)
        const monthlySnap = await get(ref(db, `members/${user.uid}/savings/monthly`));
        const monthly = monthlySnap.exists()? Number(monthlySnap.val()) : 0;
        // currentAmount = monthly for demo; in real life sum transactions
        const currentAmount = g.currentAmount || monthly;
        const pct = g.targetAmount ? Math.min(100, Math.round((currentAmount / g.targetAmount)*100)) : 0;
        progressBar.style.width = pct + '%';
        pctSpan.textContent = pct + '%';
        // update RTDB progress value
        await update(ref(db, `members/${user.uid}/goals/${lastKey}`), { currentAmount: currentAmount, progress: pct });
      });
    });
  })();

  // ------------------ Withdraw handlers & PDF ------------------
  const withdrawForm = document.getElementById('withdrawForm');
  if (document.getElementById('previewWithdrawPdf')) {
    document.getElementById('previewWithdrawPdf').addEventListener('click',(e)=>{
      e.preventDefault();
      if(!withdrawForm) return;
      const formData = new FormData(withdrawForm);
      const data = Object.fromEntries(formData.entries());
      const doc = buildWithdrawPdfDoc(data, {preview:true});
      doc.save(`Withdrawal_PREVIEW.pdf`);
      awardPoints(2, 'Previewed withdrawal PDF');
    });
  }
  if(withdrawForm){
    withdrawForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const formData = new FormData(withdrawForm);
      const data = Object.fromEntries(formData.entries());
      const doc = buildWithdrawPdfDoc(data, {submitted:true});
      doc.save(`Withdrawal_${(data.memberName||'Member').replace(/\s+/g,'_')}.pdf`);
      awardPoints(6, 'Submitted withdrawal');

      if(currentUid){
        const wRef = push(ref(db, `members/${currentUid}/withdrawals`));
        await set(wRef, {...data, submittedAt: Date.now(), status: 'submitted'});
      }
    });
  }
  function buildWithdrawPdfDoc(data, opts={}){
    const doc = new jsPDF({unit:'pt',format:'a4'});
    let y = 50, left = 40;
    doc.setFillColor(46,125,50); doc.rect(0,0,595,56,'F');
    doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255); doc.setFontSize(14);
    doc.text('VOLUNTARY WITHDRAWABLE SAVINGS FORM', 300, 36, {align:'center'});
    doc.setTextColor(0,0,0);
    y = 80;
    doc.setFont('helvetica','bold'); doc.text('Member Information', left, y); y+=14;
    doc.setFont('helvetica','normal'); const lines = [
      `Name: ${data.memberName||''}`,
      `Membership Number: ${data.membershipNumber||''}`,
      `ID/Passport: ${data.idNumber||''}`,
      `Phone: ${data.phone||''}`,
      `Amount in figures: Ksh ${data.amountFigures||''}`,
      `Amount in words: ${data.amountWords||''}`,
      `Reason: ${data.reason||''}`,
    ];
    lines.forEach(line=>{ const wrap = doc.splitTextToSize(line,520); doc.text(wrap,left,y); y += wrap.length*14; });
    y+=18;
    doc.setFont('helvetica','bold'); doc.text('Member Signature: ________________________   Date: ____________', left, y);
    // footer
    doc.setFontSize(8); doc.setTextColor(120);
    doc.text(`Visionary Youth Group • Voluntary Withdrawal Form`, 300, 820, {align:'center'});
    return doc;
  }

  // ------------------ Account Statement PDF ------------------
  async function buildAccountStatementPdf(){
    if(!currentUid) return alert('Not signed in');
    const snapMember = await get(ref(db, `members/${currentUid}`));
    const snapshotMonthly = await get(ref(db, `members/${currentUid}/savings/monthly`));
    const snapshotWeekly = await get(ref(db, `members/${currentUid}/savings/weekly`));
    const loansSnap = await get(ref(db, `members/${currentUid}/loans`));
    const sharesSnap = await get(ref(db, `members/${currentUid}/shares`));

    const doc = new jsPDF({unit:'pt', format:'a4'});
    let left = 36, y = 40;
    doc.setFillColor(46,125,50); doc.rect(0,0,595,56,'F');
    doc.setTextColor(255,255,255); doc.setFont('helvetica','bold'); doc.setFontSize(16);
    doc.text('ACCOUNT STATEMENT', 300, 36, {align:'center'});
    doc.setTextColor(0,0,0);
    y = 80;
    const profile = snapMember.exists() && snapMember.val().profile ? snapMember.val().profile : {};
    doc.setFontSize(10); doc.setFont('helvetica','normal');
    doc.text(`Member: ${profile.name || profile.fullName || topEmail.textContent}`, left, y); y+=12;
    doc.text(`Email: ${topEmail.textContent}`, left, y); y+=12;
    doc.text(`Date: ${new Date().toLocaleDateString()}`, left, y); y+=18;

    // Totals:
    function calcSnap(snap){
      if(!snap.exists()) return 0;
      const val = snap.val();
      if(typeof val === 'number' || typeof val === 'string') return Number(val)||0;
      let total = 0; Object.values(val).forEach(child=>{ if(child && typeof child === 'object' && ('amount' in child)) total += Number(child.amount||0); else if(typeof child === 'number') total += child; });
      return total;
    }
    const monthly = calcSnap(snapshotMonthly);
    const weekly = calcSnap(snapshotWeekly);
    const shares = sharesSnap.exists()? (sharesSnap.val().total || sharesSnap.val() || 0) : 0;
    const dividends = sharesSnap.exists()? (sharesSnap.val().dividends || 0) : 0;

    let totalLoans = 0, unpaid = 0, appsList = [];
    if(loansSnap.exists()){
      const loansObj = loansSnap.val();
      if(loansObj.summary){
        totalLoans = loansObj.summary.total || 0; unpaid = loansObj.summary.unpaid || 0;
      } else {
        Object.values(loansObj).forEach(v=>{
          if(v && typeof v === 'object' && v.amountFigures) { totalLoans += Number(v.amountFigures||0); if((v.status||'').toLowerCase() !== 'paid') unpaid += Number(v.amountFigures||0); appsList.push(v); }
        });
      }
    }

    doc.setFont('helvetica','bold'); doc.text('Financial Summary', left, y); y+=14;
    doc.setFont('helvetica','normal');
    doc.text(`Weekly Savings: ${formatKsh(weekly)}`, left, y); y+=12;
    doc.text(`Monthly Savings: ${formatKsh(monthly)}`, left, y); y+=12;
    doc.text(`Shares: ${formatKsh(shares)}`, left, y); y+=12;
    doc.text(`Dividends: ${formatKsh(dividends)}`, left, y); y+=12;
    doc.text(`Total Loans: ${formatKsh(totalLoans)}`, left, y); y+=12;
    doc.text(`Unpaid Balances: ${formatKsh(unpaid)}`, left, y); y+=18;

    if(appsList.length){
      doc.setFont('helvetica','bold'); doc.text('Loan Applications (recent)', left, y); y += 14;
      doc.setFont('helvetica','normal');
      appsList.slice(-10).forEach(app=>{
        const line = `${app.memberName || app.name || ''} — ${formatKsh(app.amountFigures || 0)} — ${app.status || 'Pending'}`;
        const wr = doc.splitTextToSize(line, 500); doc.text(wr,left,y); y += wr.length*12;
        if(y > 720){ doc.addPage(); y=40; }
      });
      y+=8;
    }
    if(y > 700){ doc.addPage(); y=40; }
    doc.line(left, y+20, left+240, y+20); doc.text('Prepared by / Signature', left, y+34);
    return doc;
  }

  // account statement button handlers (kept original)
  const downloadStatementTopBtn = document.getElementById('downloadStatementTop');
  if(downloadStatementTopBtn) downloadStatementTopBtn.addEventListener('click', async ()=>{
    const doc = await buildAccountStatementPdf();
    doc.save(`Account_Statement_${(topEmail.textContent||'member').replace(/[^\w@.-]/g,'')}.pdf`);
    awardPoints(4, 'Downloaded account statement');
  });
  const downloadStatementBtn = document.getElementById('downloadStatement');
  if(downloadStatementBtn) downloadStatementBtn.addEventListener('click', async ()=>{
    const doc = await buildAccountStatementPdf();
    doc.save(`Account_Statement_${(topEmail.textContent||'member').replace(/[^\w@.-]/g,'')}.pdf`);
    awardPoints(4, 'Downloaded account statement');
  });
  const profileStatementBtn = document.getElementById('profileStatement');
  if(profileStatementBtn) profileStatementBtn.addEventListener('click', async ()=>{
    const doc = await buildAccountStatementPdf();
    doc.save(`Account_Statement_${(topEmail.textContent||'member').replace(/[^\w@.-]/g,'')}.pdf`);
    awardPoints(4, 'Downloaded account statement');
  });
  const quickStatementBtn = document.getElementById('quickStatement');
  if(quickStatementBtn) quickStatementBtn.addEventListener('click', async ()=>{
    const doc = await buildAccountStatementPdf();
    doc.save(`Account_Statement_${(topEmail.textContent||'member').replace(/[^\w@.-]/g,'')}.pdf`);
    awardPoints(4, 'Downloaded account statement');
  });

  // downloadApplications (kept original)
  const downloadAppsBtn = document.getElementById('downloadApplications');
  if(downloadAppsBtn) downloadAppsBtn.addEventListener('click', async ()=>{
    if(!currentUid) return alert('Not signed in');
    const snap = await get(ref(db, `members/${currentUid}/loans/applications`));
    if(!snap.exists()) return alert('No applications found');
    const apps = snap.val();
    const doc = new jsPDF({unit:'pt',format:'a4'}); let y=40; const left=36;
    doc.setFontSize(16); doc.text('Loan Applications',300,y,{align:'center'}); y+=20;
    doc.setFontSize(10);
    for(const [id,app] of Object.entries(apps)){
      const title = `${app.memberName || app.name || ''} — ${formatKsh(app.amountFigures || 0)} — ${app.status||''}`;
      const wrapped = doc.splitTextToSize(title, 520);
      doc.text(wrapped, left, y); y += wrapped.length * 12;
      const details = [
        `Applied: ${new Date(app.appliedAt || 0).toLocaleString()}`,
        `Purpose: ${app.purpose || ''}`,
        `Guarantors: ${ (app.guarantors || []).map(g=>g.name).filter(Boolean).join('; ') }`
      ];
      details.forEach(d => { const w = doc.splitTextToSize(d,520); doc.text(w, left+8, y); y += w.length * 12; });
      y += 8;
      if(y > 720){ doc.addPage(); y=40; }
    }
    doc.save(`Loan_Applications_${(topEmail.textContent||'member').replace(/[^\w@.-]/g,'')}.pdf`);
    awardPoints(6, 'Downloaded applications PDF');
  });

  // quick apply: scroll to wizard
  const quickApplyBtn = document.getElementById('quickApply');
  if(quickApplyBtn) quickApplyBtn.addEventListener('click', ()=> document.getElementById('loan-section').scrollIntoView({behavior:'smooth'}));

  // Save profile (kept original)
  const saveProfileBtn = document.getElementById('saveProfile');
  if(saveProfileBtn) saveProfileBtn.addEventListener('click', async ()=>{
    if(!currentUid) return alert('Not authenticated');
    if(profileSavedOnce) { showToast('Profile already updated in this session'); return; }
    const payload = {
      name: document.getElementById('profile_fullName').value,
      phone: document.getElementById('profile_phone').value,
      id: document.getElementById('profile_id').value,
      yearJoined: document.getElementById('profile_yearJoined').value,
      dob: document.getElementById('profile_dob').value,
      status: 'Active'
    };
    await set(ref(db, `members/${currentUid}/profile`), payload);
    profileSavedOnce = true;
    showToast('Profile updated');
    awardPoints(5, 'Updated profile');
  });

  // photo upload (kept original)
  const choosePhotoBtn = document.getElementById('choosePhotoBtn');
  const photoInput = document.getElementById('photoUploadInput');
  if(choosePhotoBtn && photoInput){
    choosePhotoBtn.addEventListener('click', ()=> photoInput.click());
  }
  if(photoInput){
    photoInput.addEventListener('change', async (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      if(!currentUid) return alert('Not signed in');
      const path = `members/${currentUid}/photo_${Date.now()}`;
      const sRef = storageRef(storage, path);
      try{
        await uploadBytes(sRef, file);
        const url = await getDownloadURL(sRef);
        // store URL in RTDB for easy retrieval
        await set(ref(db, `members/${currentUid}/photoURL`), url);
        setAvatar(url);
        showToast('Photo uploaded');
        awardPoints(4, 'Uploaded profile photo');
      }catch(err){
        console.error(err); alert('Photo upload failed');
      }
    });
  }

  function setAvatar(url){
    const html = `<img src="${url}" alt="avatar">`;
    if(topAvatar) topAvatar.innerHTML = html;
  }

  if(!topAvatar || !topAvatar.innerHTML) {
    if(topAvatar) topAvatar.innerHTML = '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:var(--dark)"><i class="fas fa-user"></i></div>';
  }

  // logout via menu
  const menuLogout = document.getElementById('menuLogout');
  if(menuLogout) menuLogout.addEventListener('click', ()=> { try{ signOut(auth); }catch(e){} window.location.href='index.html'; });

  // award points on navigation
  document.querySelectorAll('[data-target]').forEach(a=>{
    a.addEventListener('click', ()=> awardPoints(1, `Visited ${a.dataset.target}`));
  });

  // init tiny activity
  (async()=>{ try{ await logActivity('Dashboard loaded'); }catch(e){} })();

  // util escape
  function escapeHtml(unsafe) {
    return String(unsafe||'').replace(/[&<>"'`=\/]/g, function (s) {
      return ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[s];
    });
  }
</script>

</body>
</html>
