<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Visionary Youth Group — Full Modern Dashboard</title>
  <meta name="description" content="Visionary Youth Group member portal — balances, loans, withdrawals, statements, realtime Firebase" />

  <!-- Tailwind CSS for fast styling (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Feather icons for small inline icons -->
  <script src="https://unpkg.com/feather-icons"></script>

  <!-- jsPDF (for PDF generation) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Chart.js (for progress charts) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --accent: #2563eb;
      --muted: #6b7280;
    }
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; }
    .card { background: white; border-radius: 12px; box-shadow: 0 8px 30px rgba(2,6,23,0.06); }
    .badge { padding: .25rem .5rem; border-radius: 9999px; font-weight:600; font-size:.75rem; display:inline-block; }
    .status-pending{ background:#fff7ed; color:#92400e; }
    .status-approved{ background:#ecfdf5; color:#065f46; }
    .status-rejected{ background:#fff1f2; color:#9f1239; }
    .sidebar-collapsed { width: 72px !important; }
    .wiz-step { display: none; }
    .wiz-step.active { display:block; }
    #toast { position: fixed; right: 20px; bottom: 20px; z-index: 9999; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen">

  <div class="min-h-screen flex">
    <!-- SIDEBAR -->
    <aside id="sidebar" class="w-72 bg-gradient-to-b from-slate-900 to-slate-800 text-white p-5 flex-shrink-0 transition-all">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-11 h-11 rounded bg-white/10 flex items-center justify-center text-xl font-bold">VY</div>
        <div>
          <div class="text-lg font-bold">Visionary</div>
          <div class="text-xs text-slate-300">Youth Group Portal</div>
        </div>
      </div>

      <nav class="space-y-1 text-sm">
        <button class="w-full text-left px-3 py-2 rounded flex items-center gap-3 hover:bg-white/5 active:bg-white/10" data-tab="dashboard">
          <i data-feather="home" class="w-4 h-4"></i><span class="ml-1">Dashboard</span>
        </button>
        <button class="w-full text-left px-3 py-2 rounded flex items-center gap-3 hover:bg-white/5" data-tab="loan">
          <i data-feather="file-text" class="w-4 h-4"></i><span class="ml-1">Loan Application</span>
        </button>
        <button class="w-full text-left px-3 py-2 rounded flex items-center gap-3 hover:bg-white/5" data-tab="withdraw">
          <i data-feather="credit-card" class="w-4 h-4"></i><span class="ml-1">Withdrawal</span>
        </button>
        <button class="w-full text-left px-3 py-2 rounded flex items-center gap-3 hover:bg-white/5" data-tab="profile">
          <i data-feather="user" class="w-4 h-4"></i><span class="ml-1">Profile</span>
        </button>
        <button class="w-full text-left px-3 py-2 rounded flex items-center gap-3 hover:bg-white/5" data-tab="statements">
          <i data-feather="download" class="w-4 h-4"></i><span class="ml-1">Statements</span>
        </button>
      </nav>

      <div class="mt-6 text-xs text-slate-300">Quick actions</div>
      <div class="mt-2 flex flex-col gap-2">
        <button id="claimPts" class="px-3 py-2 bg-white/10 rounded text-sm">Claim +5 pts</button>
        <button id="downloadStmt" class="px-3 py-2 bg-white/10 rounded text-sm">Download Statement</button>
      </div>

      <div class="mt-auto pt-6 text-xs text-slate-400">Powered by Visionary • Prototype</div>
    </aside>

    <!-- MAIN -->
    <main class="flex-1 p-6">
      <header class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-2xl font-semibold">Member Dashboard</h2>
          <p class="text-sm text-slate-500">Realtime balances, loan progress & quick actions</p>
        </div>

        <div class="flex items-center gap-6">
          <div class="text-right">
            <div id="memberName" class="font-medium">Guest</div>
            <div id="memberStatus" class="text-xs text-slate-500">Not signed in</div>
          </div>
          <div id="authArea"></div>
          <button id="menuToggle" class="px-3 py-2 border rounded text-sm">Toggle</button>
          <button id="signOutBtn" class="px-3 py-2 border rounded text-sm">Sign out</button>
        </div>
      </header>

      <!-- TABS CONTENT -->
      <section id="tab-dashboard" class="tab-content">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
          <div class="card p-5 flex items-center gap-4">
            <div class="rounded-full p-3 bg-blue-50 text-blue-600"><i data-feather="save" class="w-5 h-5"></i></div>
            <div>
              <div class="text-sm text-slate-500">Monthly saving</div>
              <div id="monthlyVal" class="text-2xl font-semibold">Ksh 0</div>
              <div class="text-xs text-slate-400">Target: <span id="monthlyTarget">Ksh 0</span></div>
            </div>
          </div>

          <div class="card p-5 flex items-center gap-4">
            <div class="rounded-full p-3 bg-green-50 text-green-600"><i data-feather="clock" class="w-5 h-5"></i></div>
            <div>
              <div class="text-sm text-slate-500">Weekly saving</div>
              <div id="weeklyVal" class="text-2xl font-semibold">Ksh 0</div>
            </div>
          </div>

          <div class="card p-5 flex items-center gap-4">
            <div class="rounded-full p-3 bg-yellow-50 text-yellow-600"><i data-feather="trending-up" class="w-5 h-5"></i></div>
            <div>
              <div class="text-sm text-slate-500">Total loans</div>
              <div id="totalLoansVal" class="text-2xl font-semibold">Ksh 0</div>
            </div>
          </div>

          <div class="card p-5 flex items-center gap-4">
            <div class="rounded-full p-3 bg-red-50 text-red-600"><i data-feather="alert-circle" class="w-5 h-5"></i></div>
            <div>
              <div class="text-sm text-slate-500">Outstanding</div>
              <div id="outstandingVal" class="text-2xl font-semibold">Ksh 0</div>
            </div>
          </div>

          <div class="card p-5 flex items-center gap-4">
            <div class="rounded-full p-3 bg-indigo-50 text-indigo-600"><i data-feather="dollar-sign" class="w-5 h-5"></i></div>
            <div>
              <div class="text-sm text-slate-500">Paid balances</div>
              <div id="paidVal" class="text-2xl font-semibold">Ksh 0</div>
            </div>
          </div>

          <div class="card p-5 col-span-full lg:col-span-3">
            <div class="flex items-center justify-between mb-3">
              <div>
                <div class="text-sm text-slate-500">Loan status</div>
                <div id="loanStatus" class="mt-1"><span class="badge status-pending">No Loans</span></div>
              </div>
              <div><button id="viewLoansBtn" class="px-3 py-2 bg-white/10 rounded text-sm">View loans</button></div>
            </div>

            <div class="w-full bg-slate-100 rounded p-3">
              <div class="flex items-center gap-3">
                <div class="w-full">
                  <div class="flex items-center justify-between mb-2 text-xs text-slate-500">
                    <div>Repayment progress</div><div id="progressPercent">0%</div>
                  </div>
                  <div class="h-3 bg-white rounded overflow-hidden"><div id="progressBar" class="h-full bg-gradient-to-r from-blue-500 to-indigo-500" style="width:0%"></div></div>
                </div>
                <div class="w-40 text-right text-sm text-slate-600">Progress</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Active Loans Table & Savings Chart -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="card p-4 lg:col-span-2">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-semibold">Active Loans</h3>
              <div class="text-sm text-slate-500">Realtime updates</div>
            </div>
            <div class="overflow-auto">
              <table class="w-full text-sm">
                <thead class="text-slate-500 text-left"><tr><th class="pb-2">Loan</th><th class="pb-2">Amount</th><th class="pb-2">Status</th><th class="pb-2">Due</th><th class="pb-2">Progress</th></tr></thead>
                <tbody id="loansBody"></tbody>
              </table>
            </div>
          </div>

          <div class="card p-4">
            <h3 class="font-semibold mb-3">Monthly Savings Progress</h3>
            <canvas id="savingsChart" height="220"></canvas>
            <div class="mt-3 text-xs text-slate-500">Set a monthly target to see progress.</div>
          </div>
        </div>
      </section>

      <!-- LOAN WIZARD TAB -->
      <section id="tab-loan" class="tab-content hidden">
        <div class="card p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold">Loan Application Wizard</h3>
            <div class="text-sm text-slate-500">Complete steps, submit & download</div>
          </div>

          <!-- progress indicator -->
          <div class="mb-4">
            <div class="flex items-center gap-3 text-xs text-slate-500 mb-2">
              <div id="wizardStepLabel">Step 1 of 6</div>
              <div class="flex-1"><div class="h-2 bg-slate-100 rounded overflow-hidden"><div id="wizardBar" class="h-full bg-gradient-to-r from-blue-500 to-indigo-500" style="width:10%"></div></div></div>
            </div>
          </div>

          <form id="loanWizardForm" class="space-y-6">

            <!-- STEP 1: Personal -->
            <div id="wiz-1" class="wiz-step active">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="text-sm">Full name *</label>
                  <input name="fullName" required class="w-full p-2 border rounded" />
                </div>
                <div>
                  <label class="text-sm">National ID / Passport *</label>
                  <input name="idNumber" required class="w-full p-2 border rounded" />
                </div>
                <div>
                  <label class="text-sm">Date of birth *</label>
                  <input name="dob" type="date" required class="w-full p-2 border rounded" />
                </div>
                <div>
                  <label class="text-sm">Phone *</label>
                  <input name="phone" required class="w-full p-2 border rounded" />
                </div>
                <div>
                  <label class="text-sm">Email *</label>
                  <input name="email" type="email" required class="w-full p-2 border rounded" />
                </div>
                <div class="sm:col-span-2">
                  <label class="text-sm">Upload ID (optional)</label>
                  <input name="idFile" type="file" class="w-full" />
                </div>
              </div>
            </div>

            <!-- STEP 2: Residence -->
            <div id="wiz-2" class="wiz-step">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="text-sm">County *</label>
                  <select name="county" id="countySelect" class="w-full p-2 border rounded"></select>
                </div>
                <div>
                  <label class="text-sm">Constituency</label>
                  <input name="constituency" class="w-full p-2 border rounded" />
                </div>
                <div>
                  <label class="text-sm">Ward / Village</label>
                  <input name="ward" class="w-full p-2 border rounded" />
                </div>
                <div>
                  <label class="text-sm">Residence / House</label>
                  <input name="residence" class="w-full p-2 border rounded" />
                </div>
              </div>
            </div>

            <!-- STEP 3: Education -->
            <div id="wiz-3" class="wiz-step">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="text-sm">Education level</label>
                  <select name="educationLevel" class="w-full p-2 border rounded">
                    <option value="">Select</option>
                    <option>Primary</option><option>Secondary</option><option>Certificate</option>
                    <option>Diploma</option><option>Undergraduate</option><option>Postgraduate</option>
                  </select>
                </div>
                <div>
                  <label class="text-sm">Institution</label>
                  <input name="institution" class="w-full p-2 border rounded" />
                </div>
                <div>
                  <label class="text-sm">Year / Index</label>
                  <input name="educationYear" class="w-full p-2 border rounded" />
                </div>
              </div>
            </div>

            <!-- STEP 4: Guarantors -->
            <div id="wiz-4" class="wiz-step">
              <div class="text-sm text-slate-600 mb-2">Provide 3 guarantors (all required)</div>

              <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <input name="g1name" placeholder="Guarantor1 name *" class="w-full p-2 border rounded" required />
                <input name="g1phone" placeholder="Phone *" class="w-full p-2 border rounded" required />
                <input name="g1amount" placeholder="Amount *" type="number" class="w-full p-2 border rounded" required />
              </div>

              <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-3">
                <input name="g2name" placeholder="Guarantor2 name *" class="w-full p-2 border rounded" required />
                <input name="g2phone" placeholder="Phone *" class="w-full p-2 border rounded" required />
                <input name="g2amount" placeholder="Amount *" type="number" class="w-full p-2 border rounded" required />
              </div>

              <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-3">
                <input name="g3name" placeholder="Guarantor3 name *" class="w-full p-2 border rounded" required />
                <input name="g3phone" placeholder="Phone *" class="w-full p-2 border rounded" required />
                <input name="g3amount" placeholder="Amount *" type="number" class="w-full p-2 border rounded" required />
              </div>
            </div>

            <!-- STEP 5: Parents/Guardians -->
            <div id="wiz-5" class="wiz-step">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="text-sm">Parent / Guardian Relation</label>
                  <select name="parentRelation" class="w-full p-2 border rounded">
                    <option>Father</option><option>Mother</option><option>Brother</option><option>Sister</option><option>Other</option>
                  </select>
                </div>
                <div>
                  <label class="text-sm">Parent Name</label>
                  <input name="parentName" class="w-full p-2 border rounded" />
                </div>
                <div>
                  <label class="text-sm">Parent Phone</label>
                  <input name="parentPhone" class="w-full p-2 border rounded" />
                </div>
                <div>
                  <label class="text-sm">Parent ID</label>
                  <input name="parentId" class="w-full p-2 border rounded" />
                </div>
              </div>
            </div>

            <!-- STEP 6: Amount & Disbursement -->
            <div id="wiz-6" class="wiz-step">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="text-sm">Amount applying (Ksh) *</label>
                  <input name="amount" type="number" class="w-full p-2 border rounded" required />
                </div>
                <div>
                  <label class="text-sm">Disbursement *</label>
                  <select name="disbursementMode" class="w-full p-2 border rounded">
                    <option value="mpesa">M-Pesa</option>
                    <option value="bank">Bank Transfer</option>
                    <option value="cash">Cash (Office)</option>
                  </select>
                </div>
                <div>
                  <label class="text-sm">Account / Till Number</label>
                  <input name="accountNumber" class="w-full p-2 border rounded" />
                </div>
                <div class="sm:col-span-2">
                  <label class="text-sm">Purpose / Reason</label>
                  <textarea name="purpose" rows="4" class="w-full p-2 border rounded"></textarea>
                </div>
              </div>
            </div>

            <div class="flex justify-between">
              <div><button type="button" id="wizPrev" class="px-4 py-2 border rounded">Back</button></div>
              <div class="flex gap-2">
                <button type="button" id="wizNext" class="px-4 py-2 bg-indigo-600 text-white rounded">Next</button>
                <button type="button" id="wizSubmit" class="px-4 py-2 bg-green-600 text-white rounded hidden">Submit & Download PDF</button>
              </div>
            </div>
          </form>
        </div>
      </section>

      <!-- WITHDRAWAL TAB -->
      <section id="tab-withdraw" class="tab-content hidden">
        <div class="card p-6">
          <h3 class="text-lg font-semibold mb-3">Withdrawal Form</h3>
          <form id="withdrawForm" class="space-y-3">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="text-sm">Member No</label>
                <input name="memberNo" class="w-full p-2 border rounded" />
              </div>
              <div>
                <label class="text-sm">Amount (Ksh)</label>
                <input name="amount" type="number" class="w-full p-2 border rounded" />
              </div>
            </div>
            <div>
              <label class="text-sm">Reason (min 200 characters)</label>
              <textarea name="reason" rows="6" class="w-full p-2 border rounded"></textarea>
            </div>
            <div class="flex justify-end">
              <button type="button" id="withdrawSubmit" class="px-4 py-2 bg-blue-600 text-white rounded">Submit & Download PDF</button>
            </div>
          </form>
        </div>
      </section>

      <!-- PROFILE TAB -->
      <section id="tab-profile" class="tab-content hidden">
        <div class="card p-6">
          <h3 class="text-lg font-semibold mb-4">Profile</h3>
          <form id="profileForm" class="space-y-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="text-sm">Full name *</label>
                <input name="fullName" class="w-full p-2 border rounded" required />
              </div>
              <div>
                <label class="text-sm">Phone *</label>
                <input name="phone" class="w-full p-2 border rounded" required />
              </div>
              <div>
                <label class="text-sm">Member No *</label>
                <input name="memberNo" class="w-full p-2 border rounded" required />
              </div>
              <div>
                <label class="text-sm">Residence</label>
                <input name="residence" class="w-full p-2 border rounded" />
              </div>
              <div>
                <label class="text-sm">Date of birth *</label>
                <input name="dob" type="date" class="w-full p-2 border rounded" required />
              </div>
              <div>
                <label class="text-sm">ID number *</label>
                <input name="idNumber" class="w-full p-2 border rounded" required />
              </div>
            </div>
            <div class="flex justify-end">
              <button type="button" id="saveProfileBtn" class="px-4 py-2 bg-green-600 text-white rounded">Save Profile</button>
            </div>
          </form>
        </div>
      </section>

      <!-- STATEMENTS TAB -->
      <section id="tab-statements" class="tab-content hidden">
        <div class="card p-6">
          <h3 class="text-lg font-semibold mb-3">Statements</h3>
          <p class="text-sm text-slate-500 mb-4">Download account statements including balances, transactions and loan history.</p>
          <div class="flex gap-3">
            <button id="dlStmtBtn" class="px-4 py-2 bg-indigo-600 text-white rounded">Download PDF Statement</button>
            <button id="dlLoanAppBtn" class="px-4 py-2 border rounded">Download Latest Loan Application</button>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- Toast container -->
  <div id="toast"></div>

  <!-- Firebase modular SDK + App logic: module script -->
  <script type="module">
    // ---------- Imports (modular) ----------
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getDatabase, ref, onValue, push, set, update, get, child } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js';
    const { jsPDF } = window.jspdf;
    const Chart = window.Chart; // Chart.js global

    // ---------- Firebase config (REPLACE if needed) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyA_OCu7HQ5HCH2OYx5dQ2Z1r7YPwQJave4",
      authDomain: "visionary-youth-grou-2024.firebaseapp.com",
      databaseURL: "https://visionary-youth-grou-2024-default-rtdb.firebaseio.com",
      projectId: "visionary-youth-grou-2024",
      storageBucket: "visionary-youth-grou-2024.appspot.com",
      messagingSenderId: "372978592717",
      appId: "1:372978592717:web:1c15aec728ee5f854f328"
    };

    // ---------- Init Firebase ----------
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // ---------- Helpers ----------
    const qs = (s) => document.querySelector(s);
    const qsa = (s) => Array.from(document.querySelectorAll(s));
    function toast(msg, ms = 3000) {
      const t = document.createElement('div');
      t.className = 'px-4 py-3 mb-2 bg-white rounded shadow';
      t.textContent = msg;
      qs('#toast').appendChild(t);
      setTimeout(() => t.remove(), ms);
    }
    function fmt(v) { return 'Ksh ' + Number(v||0).toLocaleString(); }

    // ---------- Populate counties ----------
    const counties = ["Mombasa","Kwale","Kilifi","Tana River","Lamu","Taita-Taveta","Garissa","Wajir","Mandera","Marsabit","Isiolo","Meru","Tharaka-Nithi","Embu","Kitui","Machakos","Makueni","Nyandarua","Nyeri","Kirinyaga","Murang'a","Kiambu","Turkana","West Pokot","Samburu","Trans-Nzoia","Uasin Gishu","Elgeyo-Marakwet","Nandi","Baringo","Laikipia","Nakuru","Narok","Kajiado","Kericho","Bomet","Kakamega","Vihiga","Bungoma","Busia","Siaya","Kisumu","Homa Bay","Migori","Kisii","Nyamira","Nairobi"];
    const cSel = qs('#countySelect');
    counties.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; cSel.appendChild(o); });

    // ---------- Tab switching ----------
    qsa('[data-tab]').forEach(btn => btn.addEventListener('click', () => {
      qsa('[data-tab]').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      qsa('.tab-content').forEach(s => s.classList.add('hidden'));
      qs('#tab-' + tab).classList.remove('hidden');
      window.scrollTo({top:0, behavior:'smooth'});
    }));
    // default open dashboard
    qsa('[data-tab]')[0]?.click();

    // ---------- Auth UI ----------
    const authArea = qs('#authArea');
    function renderAuth(user) {
      authArea.innerHTML = '';
      if (user) {
        const n = document.createElement('div'); n.className='text-sm'; n.textContent = user.email || user.uid;
        authArea.appendChild(n);
      } else {
        const form = document.createElement('form'); form.className = 'flex items-center gap-2';
        const e = document.createElement('input'); e.placeholder='email'; e.type='email'; e.required=true; e.className='p-2 border rounded text-sm';
        const p = document.createElement('input'); p.placeholder='password'; p.type='password'; p.required=true; p.className='p-2 border rounded text-sm';
        const btn = document.createElement('button'); btn.className='px-3 py-2 bg-indigo-600 text-white rounded text-sm'; btn.textContent='Sign in';
        form.appendChild(e); form.appendChild(p); form.appendChild(btn);
        form.addEventListener('submit', async (ev) => {
          ev.preventDefault();
          try {
            await signInWithEmailAndPassword(auth, e.value, p.value);
            toast('Signed in');
          } catch (err) { alert('Auth error: ' + err.message); }
        });
        authArea.appendChild(form);
      }
    }

    // ---------- Inactivity timeout (3 minutes) & sign out ----------
    let inactivityTimer = null;
    const inactivityLimit = 3 * 60 * 1000; // 3 minutes

    function resetInactivityTimer() {
      clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(async () => {
        if (auth.currentUser) {
          await signOut(auth);
          toast('Signed out due to inactivity');
        }
      }, inactivityLimit);
    }
    ['mousemove','keydown','click','touchstart'].forEach(evt => document.addEventListener(evt, resetInactivityTimer));

    // Sign out button
    qs('#signOutBtn').addEventListener('click', async () => {
      try { await signOut(auth); toast('Signed out'); } catch(e){ console.error(e); }
    });

    // ---------- Real-time listeners & UI binding ----------
    let currentUser = null;
    onAuthStateChanged(auth, async user => {
      currentUser = user;
      renderAuth(user);
      if (user) {
        resetInactivityTimer();
        qs('#memberName').textContent = user.displayName || user.email || user.uid;
        qs('#memberStatus').textContent = 'Status: Active';
        subscribeUser(user.uid);
        subscribeAdmin(); // populates admin view if needed
        awardPoints(user.uid, 1);
      } else {
        clearTimeout(inactivityTimer);
        qs('#memberName').textContent = 'Guest';
        qs('#memberStatus').textContent = 'Not signed in';
        clearDashboard();
      }
    });

    function clearDashboard() {
      qs('#monthlyVal').textContent = 'Ksh 0';
      qs('#weeklyVal').textContent = 'Ksh 0';
      qs('#totalLoansVal').textContent = 'Ksh 0';
      qs('#outstandingVal').textContent = 'Ksh 0';
      qs('#paidVal').textContent = 'Ksh 0';
      qs('#loanStatus').innerHTML = '<span class="badge status-pending">No Loans</span>';
      updateProgress(0);
      qs('#loansBody').innerHTML = '';
      if (window.savingsChart) { window.savingsChart.destroy(); }
    }

    // Subscribe user data: balances, loans, transactions, profile, points
    function subscribeUser(uid) {
      onValue(ref(db, 'balances/'+uid), snap => {
        const v = snap.exists() ? snap.val() : {};
        qs('#monthlyVal').textContent = fmt(v.monthly);
        qs('#weeklyVal').textContent = fmt(v.weekly);
        qs('#totalLoansVal').textContent = fmt(v.totalLoans);
        qs('#outstandingVal').textContent = fmt(v.outstanding);
        qs('#paidVal').textContent = fmt(v.paid);
        qs('#monthlyTarget').textContent = fmt(v.monthlyTarget || 0);

        // update savings chart (progress percent)
        const target = Number(v.monthlyTarget || 0);
        const current = Number(v.monthly || 0);
        const progress = target > 0 ? Math.round((current / target) * 100) : 0;
        updateSavingsChart(Math.min(100, progress));
      });

      onValue(ref(db, 'transactions/'+uid), snap => {
        const txns = snap.exists() ? Object.values(snap.val()) : [];
        renderTransactions(txns);
      });

      onValue(ref(db, 'loans/'+uid), snap => {
        const loansObj = snap.exists() ? snap.val() : {};
        renderLoans(loansObj);
        // Check for due loans and create reminders if needed
        checkLoanStatus(uid);
      });

      onValue(ref(db, 'profiles/'+uid), snap => {
        if (snap.exists()) {
          const p = snap.val();
          qs('#memberName').textContent = p.fullName || (currentUser && (currentUser.email || currentUser.uid));
        }
      });

      onValue(ref(db, 'points/'+uid), snap => {
        const pts = snap.exists() ? (snap.val().score || 0) : 0;
        // show points in the UI (prepend small badge)
        if (!qs('#pointsBadge')) {
          const b = document.createElement('div'); b.id='pointsBadge'; b.className='text-sm text-slate-500'; b.textContent = 'Points: ' + pts;
          authArea.prepend(b);
        } else qs('#pointsBadge').textContent = 'Points: ' + pts;
      });
    }

    // ---------- Render helpers ----------
    function renderTransactions(txns) {
      // Simple console log + can be rendered into table
      // For now, we'll show limited: latest 10 in the console
      console.log('transactions', txns.slice().reverse().slice(0,10));
    }

    function renderLoans(loansObj) {
      const body = qs('#loansBody'); body.innerHTML = '';
      const loans = Object.values(loansObj || {});
      if (loans.length === 0) {
        body.innerHTML = '<tr><td colspan="5" class="text-slate-500 text-sm py-2">No active loans</td></tr>';
        qs('#loanStatus').innerHTML = '<span class="badge status-pending">No Loans</span>';
        updateProgress(0);
        return;
      }
      let totalProgress = 0, count = 0;
      loans.forEach(l => {
        const tr = document.createElement('tr');
        const progress = Number(l.progress || 0);
        totalProgress += progress; count++;
        const statusClass = l.status === 'approved' ? 'status-approved' : l.status === 'rejected' ? 'status-rejected' : 'status-pending';
        tr.innerHTML = `<td class="py-2">${l.product || 'Loan'}</td><td>${fmt(l.amount)}</td><td><span class="badge ${statusClass}">${l.status || 'pending'}</span></td><td>${l.dueDate ? new Date(l.dueDate).toLocaleDateString() : '-'}</td><td>${progress}%</td>`;
        body.appendChild(tr);
      });
      const avg = count ? Math.round(totalProgress / count) : 0;
      updateProgress(avg);
      const anyPending = loans.some(L => L.status === 'pending');
      qs('#loanStatus').innerHTML = loans.length && anyPending ? '<span class="badge status-pending">Pending</span>' : '<span class="badge status-approved">All good</span>';
    }

    function updateProgress(pct) {
      qs('#progressPercent').textContent = pct + '%';
      qs('#progressBar').style.width = pct + '%';
      qs('#wizardBar').style.width = Math.max(5, pct/2) + '%';
    }

    // ---------- Savings Chart ----------
    function updateSavingsChart(progress) {
      const ctx = qs('#savingsChart').getContext('2d');
      if (window.savingsChart) window.savingsChart.destroy();
      window.savingsChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Saved', 'Remaining'],
          datasets: [{ data: [progress, Math.max(0, 100-progress)], backgroundColor: ['#2563eb', '#e6eefc'] }]
        },
        options: {
          responsive: true,
          cutout: '70%',
          plugins: { legend: { display: false } }
        }
      });
    }

    // ---------- Points ----------
    async function awardPoints(uid, n = 1) {
      if (!uid) return;
      const pRef = ref(db, 'points/' + uid);
      const snap = await get(pRef);
      const curr = snap.exists() ? (snap.val().score || 0) : 0;
      await set(pRef, { score: curr + n });
      toast('Points awarded: ' + n);
    }
    qs('#claimPts').addEventListener('click', () => {
      if (!currentUser) return alert('Sign in to claim');
      awardPoints(currentUser.uid, 5);
    });

    // ---------- Loan Wizard logic ----------
    let wizStep = 1, wizTotal = 6;
    function showWiz() {
      for (let i=1;i<=wizTotal;i++) {
        const el = qs('#wiz-' + i); if (!el) continue;
        el.classList.toggle('active', i === wizStep);
      }
      qs('#wizardStepLabel').textContent = `Step ${wizStep} of ${wizTotal}`;
      qs('#wizNext').classList.toggle('hidden', wizStep === wizTotal);
      qs('#wizSubmit').classList.toggle('hidden', wizStep !== wizTotal);
      qs('#wizPrev').disabled = wizStep === 1;
      qs('#wizardBar').style.width = Math.round((wizStep-1)/(wizTotal-1)*100) + '%';
      window.scrollTo({top:0, behavior:'smooth'});
    }
    qs('#wizNext').addEventListener('click', () => { if (wizStep < wizTotal) { wizStep++; showWiz(); } });
    qs('#wizPrev').addEventListener('click', () => { if (wizStep > 1) { wizStep--; showWiz(); } });
    showWiz();

    // Submit loan application
    qs('#wizSubmit').addEventListener('click', async () => {
      if (!currentUser) return alert('Sign in to apply');
      const form = qs('#loanWizardForm'); const fd = new FormData(form);
      // minimal validation
      const required = ['fullName','idNumber','dob','phone','email','amount'];
      for (const r of required) if (!fd.get(r)) return alert('Please complete required: ' + r);

      const appObj = {
        applicantUid: currentUser.uid,
        applicantEmail: fd.get('email'),
        applicantProfile: {
          fullName: fd.get('fullName'), idNumber: fd.get('idNumber'), phone: fd.get('phone'), dob: fd.get('dob')
        },
        residence: { county: fd.get('county'), constituency: fd.get('constituency'), ward: fd.get('ward'), residence: fd.get('residence') },
        education: { level: fd.get('educationLevel'), institution: fd.get('institution'), year: fd.get('educationYear') },
        guarantors: [
          { name: fd.get('g1name'), phone: fd.get('g1phone'), amount: Number(fd.get('g1amount') || 0) },
          { name: fd.get('g2name'), phone: fd.get('g2phone'), amount: Number(fd.get('g2amount') || 0) },
          { name: fd.get('g3name'), phone: fd.get('g3phone'), amount: Number(fd.get('g3amount') || 0) }
        ],
        parents: { relation: fd.get('parentRelation'), name: fd.get('parentName'), phone: fd.get('parentPhone'), id: fd.get('parentId') },
        amount: Number(fd.get('amount') || 0),
        purpose: fd.get('purpose'),
        disbursementMode: fd.get('disbursementMode'),
        accountNumber: fd.get('accountNumber'),
        status: 'pending',
        progress: 0,
        createdAt: Date.now()
      };

      // push to loanApplications (admin view)
      const newRef = push(ref(db, 'loanApplications'));
      await set(newRef, appObj);

      // also register under loans/{uid}/{loanId} for quick display
      const loanRef = push(ref(db, 'loans/' + currentUser.uid));
      await set(loanRef, { ...appObj, id: newRef.key });

      toast('Application submitted. Generating PDF...');
      generateLoanPDF(appObj);
    });

    // ---------- Withdraw submit ----------
    qs('#withdrawSubmit').addEventListener('click', async () => {
      if (!currentUser) return alert('Sign in');
      const f = qs('#withdrawForm'); const fd = new FormData(f); const reason = fd.get('reason') || '';
      if (reason.length < 200) return alert('Reason must be at least 200 characters');
      const w = { uid: currentUser.uid, memberNo: fd.get('memberNo'), amount: Number(fd.get('amount')||0), reason, status: 'submitted', createdAt: Date.now() };
      const newW = push(ref(db, 'withdrawals')); await set(newW, w);
      toast('Withdrawal submitted');
      generateWithdrawPDF(w);
    });

    // ---------- Save profile ----------
    qs('#saveProfileBtn').addEventListener('click', async () => {
      if (!currentUser) return alert('Sign in to update profile');
      const f = qs('#profileForm'); const fd = new FormData(f);
      const requiredFields = ['fullName','phone','memberNo','dob','idNumber'];
      for (const field of requiredFields) if (!fd.get(field)) return alert('Please fill out: ' + field);
      const profile = {
        fullName: fd.get('fullName'), phone: fd.get('phone'), memberNo: fd.get('memberNo'),
        dob: fd.get('dob'), idNumber: fd.get('idNumber'), residence: fd.get('residence')
      };
      await set(ref(db, 'profiles/' + currentUser.uid), profile);
      toast('Profile updated');
    });

    // ---------- Generate PDFs ----------
    function generateLoanPDF(app) {
      const doc = new jsPDF({ unit: 'pt' });
      doc.setFontSize(20); doc.text('Visionary Youth Group', 40, 48); doc.setFontSize(12); doc.text('Loan Application', 40, 68);
      doc.setFontSize(10);
      doc.text(`Name: ${app.applicantProfile.fullName}`, 40, 96);
      doc.text(`ID: ${app.applicantProfile.idNumber}`, 40, 110);
      doc.text(`DOB: ${app.applicantProfile.dob || '-'}`, 40, 124);
      doc.text(`Phone: ${app.applicantProfile.phone || '-'}`, 40, 138);
      doc.text(`Email: ${app.applicantEmail || '-'}`, 40, 152);
      doc.text(`Amount: ${fmt(app.amount)}`, 40, 166);
      doc.text(`Disbursement: ${app.disbursementMode} • Account: ${app.accountNumber || '-'}`, 40, 180);
      doc.text('Residence:', 40, 200);
      doc.text(`${app.residence.county || ''} • ${app.residence.constituency || ''} • ${app.residence.ward || ''}`, 40, 214);
      doc.text('Guarantors:', 40, 238);
      app.guarantors.forEach((g, i) => doc.text(`${i+1}. ${g.name} • ${g.phone} • Ksh ${Number(g.amount||0).toLocaleString()}`, 40, 252 + i*14));
      doc.text('Parents / Guardians:', 40, 292);
      doc.text(`${app.parents.relation}: ${app.parents.name} • ${app.parents.phone}`, 40, 306);
      doc.setFontSize(9); doc.text(`Generated: ${new Date().toLocaleString()}`, 40, 760);
      doc.save('loan_application_' + (app.applicantProfile.idNumber || Date.now()) + '.pdf');
    }

    function generateWithdrawPDF(w) {
      const doc = new jsPDF({ unit: 'pt' });
      doc.setFontSize(16); doc.text('Visionary Youth Group — Withdrawal', 40, 48);
      doc.setFontSize(10); doc.text(`Member: ${w.memberNo||''}`, 40, 80); doc.text(`Amount: ${fmt(w.amount)}`, 40, 96);
      doc.text('Reason:', 40, 118); doc.text(doc.splitTextToSize(w.reason, 520), 40, 136);
      doc.text('Office Use Only:\nApproved: _______\nStamp: ________', 40, 520);
      doc.setFontSize(9); doc.text(`Generated: ${new Date().toLocaleString()}`, 40, 760);
      doc.save('withdrawal_' + (w.memberNo || Date.now()) + '.pdf');
    }

    async function generateStatementPDFForCurrentUser() {
      if (!currentUser) return alert('Sign in to download');
      const txSnap = await get(child(ref(db), 'transactions/' + currentUser.uid));
      const txns = txSnap.exists() ? Object.values(txSnap.val()) : [];
      const balSnap = await get(child(ref(db), 'balances/' + currentUser.uid));
      const balances = balSnap.exists() ? balSnap.val() : {};
      const profileSnap = await get(child(ref(db), 'profiles/' + currentUser.uid));
      const profile = profileSnap.exists() ? profileSnap.val() : {};
      const doc = new jsPDF({ unit: 'pt' });
      doc.setFontSize(16); doc.text('Visionary Youth Group — Account Statement', 40, 48);
      doc.setFontSize(10); doc.text(`Member: ${profile.fullName || ''}`, 40, 72); doc.text(`Member No: ${profile.memberNo || ''}`, 40, 86);
      doc.text(`DOB: ${profile.dob || ''}`, 40, 100); doc.text(`Generated: ${new Date().toLocaleString()}`, 40, 114);
      doc.text('Balances:', 40, 138); doc.text(`Monthly: ${fmt(balances.monthly)}`, 40, 152); doc.text(`Weekly: ${fmt(balances.weekly)}`, 200, 152);
      doc.text(`Total Loans: ${fmt(balances.totalLoans)}`, 40, 166); doc.text(`Outstanding: ${fmt(balances.outstanding)}`, 200, 166);
      doc.text('Transactions:', 40, 190);
      let y = 204;
      (txns || []).forEach(t => {
        if (y > 720) { doc.addPage(); y = 40; }
        doc.text(new Date(t.date || t.createdAt || Date.now()).toLocaleDateString(), 40, y);
        doc.text((t.type || '') + '', 140, y);
        doc.text(fmt(t.amount), 240, y);
        doc.text((t.note || '').toString().slice(0,30), 340, y);
        y += 14;
      });
      doc.save('statement_' + (profile.memberNo || Date.now()) + '.pdf');
    }

    qs('#downloadStmt').addEventListener('click', generateStatementPDFForCurrentUser);
    qs('#dlStmtBtn').addEventListener('click', generateStatementPDFForCurrentUser);

    // ---------- Reminders (create node for cloud functions) ----------
    function createReminder(uid, subject, message) {
      push(ref(db, 'reminders'), { uid, subject, message, createdAt: Date.now() });
    }

    function checkLoanStatus(uid) {
      onValue(ref(db, 'loans/' + uid), snap => {
        const loans = snap.exists() ? snap.val() : {};
        if (!loans) return;
        Object.values(loans).forEach(loan => {
          if (loan.dueDate && new Date(loan.dueDate) <= new Date() && (!loan.reminderSent)) {
            // Push reminder into DB for cloud function to pick up (and mark reminderSent)
            createReminder(uid, 'Loan Repayment Reminder', `Your loan ${loan.product || ''} is due. Please make a payment.`);
            // mark reminderSent flag for that loan entry
            // this requires updating loans/{uid}/{loanId}/reminderSent = true
            // but we need loan id; for simplicity, leave it to admin/cloud fn to track duplicates
          }
        });
      });
    }

    // ---------- Admin subscription placeholder ----------
    function subscribeAdmin() {
      // This sample just attaches a listener to loanApplications so admin UI can be built
      onValue(ref(db, 'loanApplications'), snap => {
        // Admin UI not fully implemented here; saved for future iteration
        // Example: populate admin list in a modal, or toggle 'approve' buttons
      });
    }

    // ---------- Collapsible sidebar ----------
    qs('#menuToggle').addEventListener('click', () => {
      const side = qs('#sidebar');
      side.classList.toggle('sidebar-collapsed');
    });

    // ---------- Transaction rendering (small view) ----------
    function renderTransactions(txns) {
      // Placeholder: logs and could be injected into a UI table
      console.log('Transactions (latest):', txns.slice().reverse().slice(0,10));
    }

    // ---------- Utility: check firebase writes for specific activities to award points, etc. ----------
    // Example: when user creates a loan application we already push to DB; we may award points
    // This can be extended to other actions (download statement, update profile)
    // For example award point when applying:
    // (award is already done on sign-in; you can add additional awardPoints(currentUser.uid, n) on events as needed)

    // ---------- Expose for debugging ----------
    window._visionary = { db, auth, awardPoints, createReminder };

  </script>

  <script>
    // Replace feather icons
    feather.replace();
  </script>

</body>
</html>
