<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Visionary Youth Group ‚Äî Final Dashboard</title>
<meta name="description" content="Final Visionary Youth Group dashboard ‚Äî balances, loans, transactions, PDFs, all buttons fixed." />
<!-- libraries -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
  :root{--seku-green:#006400;--seku-gold:#FFD700;--muted:#274733;--panel:#fff;--glass:rgba(0,100,0,0.04);--shadow:0 12px 30px rgba(2,10,6,0.08);--radius:12px;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
  *{box-sizing:border-box}body{margin:0;background:linear-gradient(180deg,#f3fbf3 0%, #eaf7ea 100%);padding:18px;color:#07210f}
  .app{max-width:1400px;margin:0 auto;display:grid;gap:18px}
  .topbar{height:72px;background:var(--panel);border-radius:12px;display:flex;align-items:center;justify-content:space-between;padding:10px 16px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,0.04);position:sticky;top:18px;z-index:30}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--seku-green),#0b6720);display:flex;align-items:center;justify-content:center;color:var(--seku-gold);font-weight:900}
  .subtitle{font-size:12px;color:var(--muted)}
  .container{display:grid;grid-template-columns:320px 1fr;gap:18px;margin-top:12px}
  .sidebar{background:var(--panel);border-radius:12px;padding:18px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,0.04);height:calc(100vh - 140px);overflow:auto;position:sticky;top:110px}
  .side-item{padding:10px;border-radius:10px;cursor:pointer;color:var(--muted);display:flex;align-items:center;gap:10px}
  .side-item.active{background:linear-gradient(90deg, rgba(0,100,0,0.06), rgba(255,215,0,0.02));border:1px solid rgba(0,100,0,0.06)}
  .content{background:var(--panel);border-radius:12px;padding:18px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,0.04);min-height:600px;overflow:auto}
  .grid-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
  .card{background:#fff;border-radius:12px;padding:14px;border:1px solid rgba(0,0,0,0.04);display:flex;align-items:center;gap:12px}
  .card .label{font-size:13px;color:var(--muted)}
  .card .value{font-weight:800;font-size:18px;color:var(--seku-green)}
  .panel{margin-top:14px;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfff8);border:1px solid rgba(0,0,0,0.03)}
  .table-wrap{overflow:auto;max-height:360px}
  table{width:100%;border-collapse:collapse;font-size:14px}
  thead th{padding:10px;text-align:left;border-bottom:1px solid rgba(0,0,0,0.06);color:var(--muted);font-weight:700}
  td{padding:8px;border-bottom:1px solid rgba(0,0,0,0.04)}
  .btn{background:var(--seku-green);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
  .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--muted);font-weight:600}
  .status-pill{padding:6px 10px;border-radius:999px;font-weight:800}
  @media(max-width:1100px){ .container{grid-template-columns:1fr} .grid-cards{grid-template-columns:repeat(2,1fr)} .sidebar{display:none} }
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="brand"><div class="logo">VY</div><div><div style="font-weight:800">Visionary Youth Group</div><div class="subtitle">Member dashboard</div></div></div>
    <div style="display:flex;align-items:center;gap:12px">
      <div style="display:flex;align-items:center;gap:8px;background:linear-gradient(90deg,rgba(255,215,0,0.08),rgba(0,100,0,0.03));padding:8px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.04)">
        <div style="font-size:12px;color:var(--muted)">Points</div>
        <div id="pointsValue" style="font-weight:800;color:var(--seku-green)">0</div>
      </div>
      <div style="text-align:right"><div id="topUserName" style="font-weight:800">Member</div><div id="topUserEmail" class="subtitle">member@example.com</div></div>
      <div id="signOutWrap"></div>
    </div>
  </div>

  <div class="container">
    <aside class="sidebar">
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:8px"><div style="width:54px;height:54;border-radius:10px;background:linear-gradient(135deg,var(--seku-green),#0b6720);display:flex;align-items:center;justify-content:center;color:var(--seku-gold);font-weight:900">VY</div><div><div id="sideName" style="font-weight:800">Member</div><div id="sideEmail" class="subtitle">member@example.com</div></div></div>

      <div style="display:flex;flex-direction:column;gap:8px">
        <div class="side-item active" data-view="dashboard">üè† Dashboard</div>
        <div class="side-item" data-view="transactions">üìú Transactions</div>
        <div class="side-item" data-view="loans">üí≥ Loans</div>
        <div class="side-item" data-view="withdrawals">üèß Withdrawals</div>
        <div class="side-item" data-view="profile">üë§ Profile</div>
        <div class="side-item" data-view="settings">‚öôÔ∏è Settings</div>
      </div>

      <div style="height:14px"></div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button class="btn" id="applyLoanBtn">Apply for Loan</button>
        <button class="btn ghost" id="requestWithdrawBtn" style="background:#fff;color:var(--seku-green);border:1px solid rgba(0,0,0,0.06)">Request Withdrawal</button>
      </div>
      <div class="subtitle" style="margin-top:18px">Support: visionary@example.com</div>
    </aside>

    <main class="content">
      <section id="view-dashboard">
        <div class="grid-cards">
          <div class="card"><div style="flex:1"><div class="label">Monthly Savings</div><div class="value" id="monthlyBalance">KES 0</div></div></div>
          <div class="card"><div style="flex:1"><div class="label">Weekly Savings</div><div class="value" id="weeklyBalance">KES 0</div></div></div>
          <div class="card"><div style="flex:1"><div class="label">Shares</div><div class="value" id="sharesCount">0 units</div></div></div>
        </div>

        <div class="grid-cards" style="margin-top:12px">
          <div class="card"><div style="flex:1"><div class="label">Dividends</div><div class="value" id="dividendsBalance">KES 0</div></div></div>
          <div class="card"><div style="flex:1"><div class="label">Outstanding</div><div class="value" id="outstandingBalance">KES 0</div></div></div>
          <div class="card"><div style="flex:1"><div class="label">Unpaid / Fees</div><div class="value" id="unpaidBalance">KES 0</div></div></div>
        </div>

        <!-- loan action bar -->
        <div class="panel" id="loanActionPanel" style="display:none;margin-top:18px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Loan Action</strong><div class="subtitle">Live loan status & quick actions</div></div>
            <div id="loanBadge" class="subtitle">Status ‚Äî</div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:center">
            <div style="min-width:140px"><div class="subtitle">Amount</div><div id="actAmt" style="font-weight:800">KES 0</div></div>
            <div style="min-width:120px"><div class="subtitle">Interest</div><div id="actInt" style="font-weight:800">0%</div></div>
            <div style="min-width:100px"><div class="subtitle">Stage</div><div id="actStage">‚Äî</div></div>
            <div style="min-width:120px"><div class="subtitle">Installments</div><div id="actInst">0</div></div>
            <div style="min-width:160px"><div class="subtitle">Next Repayment</div><div id="actNext">‚Äî</div></div>
            <div style="margin-left:auto;display:flex;gap:8px">
              <button class="btn" id="viewLoanDetailsBtn">View Details</button>
              <button class="btn" id="downloadLoanAppBtn">Download Loan PDF</button>
              <button class="btn" id="repayBtn">Make Repayment</button>
            </div>
          </div>
        </div>

        <!-- loans list -->
        <div class="panel" style="margin-top:18px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Your Loan Applications</strong><div class="subtitle">All applications and statuses</div></div>
            <div><button class="btn" id="refreshLoansBtn">Refresh</button></div>
          </div>
          <div id="loanList" style="margin-top:12px" class="table-wrap"><table id="loanTable"><thead><tr><th>Applied</th><th>Amount</th><th>Interest</th><th>Tenure</th><th>Status</th><th>Actions</th></tr></thead><tbody id="loanBody"><tr><td colspan="6" class="subtitle">No applications yet.</td></tr></tbody></table></div>
        </div>

        <!-- transactions -->
        <div class="panel" style="margin-top:18px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Transaction History</strong><div class="subtitle">Debits, credits and running balances</div></div>
            <div style="display:flex;gap:8px;align-items:center"><button class="btn" id="exportCsvBtn">Export CSV</button><button class="btn" id="exportPdfBtn">Export PDF</button></div>
          </div>
          <div style="margin-top:12px" class="table-wrap"><table id="txTable"><thead><tr><th>Date</th><th>Particulars</th><th>Debit (KES)</th><th>Credit (KES)</th><th>Balance (KES)</th></tr></thead><tbody id="txBody"><tr><td colspan="5" class="subtitle">No transactions yet.</td></tr></tbody></table></div>
        </div>
      </section>

      <!-- other sections (kept minimal) -->
      <section id="view-transactions" style="display:none"><div class="panel"><h4>Transactions</h4></div></section>
      <section id="view-loans" style="display:none"><div class="panel"><h4>Loans</h4></div></section>
      <section id="view-withdrawals" style="display:none"><div class="panel"><h4>Withdrawals</h4></div></section>
      <section id="view-profile" style="display:none"><div class="panel"><h4>Profile</h4></div></section>
      <section id="view-settings" style="display:none"><div class="panel"><h4>Settings</h4></div></section>
    </main>

  </div>
</div>

<!-- logout modal -->
<div id="logoutWarning" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:60">
  <div style="background:#fff;padding:18px;border-radius:10px;max-width:420px;width:90%">
    <h3 style="margin-top:0">You're inactive</h3>
    <p class="subtitle">You will be signed out soon due to inactivity.</p>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button class="btn ghost" id="logoutCancel">Stay signed in</button>
      <button class="btn" id="logoutNow">Sign out now</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getDatabase, ref, onValue, set, push, get, child } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { jsPDF } from "https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js";

  // === YOUR REAL FIREBASE CONFIG (kept as requested) ===
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyA_OCu7HQ5HCH2OYx5dQ2Z1r7YPwQJave4",
    authDomain: "visionary-youth-grou-2024.firebaseapp.com",
    databaseURL: "https://visionary-youth-grou-2024-default-rtdb.firebaseio.com",
    projectId: "visionary-youth-grou-2024",
    storageBucket: "visionary-youth-grou-2024.appspot.com",
    messagingSenderId: "372978592717",
    appId: "1:372978592717:web:1c15aec728ee5f854f3284"
  };
  // =====================================================

  const app = initializeApp(FIREBASE_CONFIG);
  const db = getDatabase(app);
  const auth = getAuth(app);

  // quick helpers
  const $ = id => document.getElementById(id);
  const fmt = v => 'KES ' + (Number(v||0)).toLocaleString();
  const esc = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

  let currentUser = null;
  let unsubscribers = [];
  let selectedLoanId = null;

  // NAV handlers (simple)
  document.querySelectorAll('.side-item').forEach(el => el.addEventListener('click', () => {
    document.querySelectorAll('.side-item').forEach(s=> s.classList.remove('active'));
    el.classList.add('active');
    const view = el.getAttribute('data-view') || 'dashboard';
    document.querySelectorAll('main .panel, main section').forEach(n => n.style.display = 'none');
    // show dashboard by default
    if(view === 'dashboard'){ document.getElementById('view-dashboard').style.display = 'block'; }
    else { const s = document.getElementById('view-' + view); if(s) s.style.display = 'block'; }
  }));

  // append sign out button
  const signOutWrap = $('signOutWrap');
  const signOutBtn = document.createElement('button'); signOutBtn.className='btn ghost'; signOutBtn.textContent='Sign out';
  signOutBtn.addEventListener('click', ()=> { if(!currentUser) window.location.href='index.html'; else signOut(auth).then(()=> window.location.href='index.html').catch(()=> window.location.href='index.html'); });
  signOutWrap.appendChild(signOutBtn);

  // Attach top buttons
  function attachButtons(){
    // Apply loan (quick prompt flow)
    $('applyLoanBtn').addEventListener('click', async ()=>{
      if(!currentUser){ alert('Sign in to apply'); return; }
      try{
        const fullName = prompt('Full name', currentUser.displayName || '');
        if(fullName === null) return;
        const email = prompt('Email', currentUser.email || '');
        if(email === null) return;
        const amount = Number(prompt('Loan amount (KES)','10000'));
        if(isNaN(amount) || amount <= 0){ alert('Invalid amount'); return; }
        const interestRate = Number(prompt('Interest rate (%)','12'));
        if(isNaN(interestRate)) { alert('Invalid interest rate'); return; }
        const tenure = Number(prompt('Tenure (months)','6'));
        if(isNaN(tenure) || tenure <= 0){ alert('Invalid tenure'); return; }
        const purpose = prompt('Purpose','Business capital');
        if(purpose === null) return;

        const loansRef = ref(db, `members/${currentUser.uid}/loans`);
        const p = push(loansRef);
        const createdAt = Date.now();
        const payload = { id: p.key, fullName, email, amount, interestRate, tenureMonths: tenure, purpose, status:'pending', stage:'applied', createdAt };
        await set(p, payload);
        await set(ref(db, `members/${currentUser.uid}/loan`), { id: p.key, amount, interestRate, status:'pending', tenureMonths: tenure, appliedAt: createdAt });
        alert('Loan application saved.');
      }catch(e){ console.error('applyLoan err', e); alert('Failed to apply loan: ' + e.message); }
    });

    // request withdrawal
    $('requestWithdrawBtn').addEventListener('click', async ()=>{
      if(!currentUser){ alert('Sign in to request withdrawal'); return; }
      try{
        const amount = Number(prompt('Withdrawal amount (KES)','0'));
        if(!amount || isNaN(amount) || amount <=0){ alert('Invalid amount'); return; }
        const reason = prompt('Reason for withdrawal','Personal use');
        if(reason === null) return;
        const wRef = ref(db, `members/${currentUser.uid}/withdrawals`);
        const p = push(wRef);
        const payload = { id: p.key, amount, reason, status: 'pending', requestedAt: Date.now() };
        await set(p, payload);
        alert('Withdrawal request submitted.');
      }catch(e){ console.error('withdraw err', e); alert('Failed to request withdrawal: ' + e.message); }
    });

    // transaction export
    $('exportCsvBtn').addEventListener('click', ()=>{
      const rows = Array.from($('txBody').children).map(tr => Array.from(tr.children).map(td => td.textContent.trim()));
      if(!rows.length){ alert('No transactions to export'); return; }
      const csv = rows.map(r => r.map(c => `"${c.replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type:'text/csv' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `transactions_${currentUser? currentUser.uid : 'guest'}_${Date.now()}.csv`; a.click();
    });

    $('exportPdfBtn').addEventListener('click', ()=>{
      const el = $('txTable');
      html2canvas(el, { scale:2 }).then(canvas => {
        const img = canvas.toDataURL('image/png');
        const doc = new jsPDF('p','mm','a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const imgProps = doc.getImageProperties(img);
        const imgWidth = pageWidth - 20;
        const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
        doc.addImage(img,'PNG',10,10,imgWidth,imgHeight);
        doc.save(`transactions_${currentUser? currentUser.uid : 'guest'}_${Date.now()}.pdf`);
      }).catch(e => { console.error('exportPdf err', e); alert('Failed to export PDF'); });
    });

    // refresh loans (listener auto-updates but keep button for manual)
    $('refreshLoansBtn').addEventListener('click', ()=> { if(currentUser) alert('Loans refreshed (listeners are live)'); else alert('Sign in to refresh'); });

    // repay from action bar
    $('repayBtn').addEventListener('click', async ()=>{
      if(!currentUser){ alert('Sign in to repay'); return; }
      if(!selectedLoanId){ alert('No active loan selected'); return; }
      const amount = Number(prompt('Enter repayment amount (KES)','0'));
      if(!amount || isNaN(amount) || amount <=0){ alert('Invalid'); return; }
      try{
        const txRef = ref(db, `members/${currentUser.uid}/transactions`); const p = push(txRef); await set(p, { date: new Date().toISOString(), description: 'Loan repayment', debit:0, credit: amount, timestamp: Date.now(), status: 'posted' });
        const instRef = ref(db, `members/${currentUser.uid}/loans/${selectedLoanId}/installments`); const pi = push(instRef); await set(pi, { amount, paidAt: Date.now() });
        alert('Repayment recorded.');
      }catch(e){ console.error('repay err', e); alert('Repayment failed: ' + e.message); }
    });

    // view loan details
    $('viewLoanDetailsBtn').addEventListener('click', async ()=>{
      if(!currentUser){ alert('Sign in to view'); return; }
      if(!selectedLoanId){ alert('No active loan selected'); return; }
      try{
        const snap = await get(child(ref(db), `members/${currentUser.uid}/loans/${selectedLoanId}`));
        if(!snap.exists()){ alert('Loan not found'); return; }
        const loan = snap.val();
        alert(`Loan ID: ${loan.id || selectedLoanId}\nAmount: ${loan.amount? fmt(loan.amount) : '‚Äî'}\nInterest: ${loan.interestRate? loan.interestRate + '%' : '‚Äî'}\nTenure: ${loan.tenureMonths || '‚Äî'} months\nStatus: ${loan.status || 'pending'}`);
      }catch(e){ console.error('viewLoan err', e); alert('Failed to load loan details'); }
    });

    // download loan PDF from action bar
    $('downloadLoanAppBtn').addEventListener('click', async ()=>{ if(!selectedLoanId){ alert('No active loan to download'); return; } await downloadLoanPdfById(selectedLoanId); });
  }

  // populate loan action panel
  function populateLoanAction(loan){
    if(!loan) return hideLoanAction();
    $('loanActionPanel').style.display = 'block';
    $('actAmt').textContent = loan.amount ? fmt(loan.amount) : 'KES 0';
    $('actInt').textContent = loan.interestRate ? loan.interestRate + '%' : '‚Äî';
    $('actStage').textContent = loan.stage || loan.status || 'pending';
    let instCount = 0;
    if(loan.installments){ instCount = Array.isArray(loan.installments) ? loan.installments.length : Object.keys(loan.installments||{}).length; } else instCount = loan.tenureMonths || 0;
    $('actInst').textContent = instCount;
    $('actNext').textContent = loan.nextRepayment ? new Date(Number(loan.nextRepayment)).toLocaleString() : '‚Äî';
    $('loanBadge').innerHTML = loan.status ? `<span class="status-pill ${loan.status==='pending'?'status-pending': loan.status==='approved'?'status-approved':'status-rejected'}">${esc(loan.status)}</span>` : '‚Äî';
    selectedLoanId = loan.id || selectedLoanId;
  }
  function hideLoanAction(){ $('loanActionPanel').style.display = 'none'; selectedLoanId = null; }

  // download loan PDF helper
  async function downloadLoanPdfById(loanId){
    if(!currentUser) { alert('Sign in to download'); return; }
    try{
      const snap = await get(child(ref(db), `members/${currentUser.uid}/loans/${loanId}`));
      if(!snap.exists()){ alert('Loan not found'); return; }
      const loan = snap.val();
      const doc = new jsPDF('p','mm','a4');
      const pageWidth = doc.internal.pageSize.getWidth();
      doc.setTextColor(200,200,200); doc.setFontSize(60); doc.text('Visionary Youth', pageWidth/2, 120, { align:'center' });
      doc.setTextColor(0,80,0); doc.setFontSize(18); doc.text('Visionary Youth Group', 14, 20);
      doc.setFontSize(11); doc.setTextColor(80,80,80); doc.text(`Loan Application ‚Äî ${loanId}`, 14, 28);
      doc.setFontSize(10); doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 34);
      doc.setDrawColor(0,100,0); doc.setFillColor(240,255,240); doc.rect(14,38,pageWidth-28,30,'F');
      doc.setTextColor(0,70,0); doc.setFontSize(11); doc.text(`Member: ${loan.fullName || currentUser.displayName || currentUser.email}`, 16,46);
      doc.text(`Email: ${loan.email || currentUser.email || ''}`, 16,52);
      doc.text(`Member ID: ${loan.memberId || currentUser.uid}`, 16,58);
      doc.setFontSize(12); doc.setTextColor(0,0,0); doc.text('Loan details', 14, 80);
      const lines = [
        `Amount: ${loan.amount ? 'KES ' + Number(loan.amount).toLocaleString() : '‚Äî'}`,
        `Interest rate: ${loan.interestRate ? loan.interestRate + '%' : '‚Äî'}`,
        `Tenure (months): ${loan.tenureMonths || '‚Äî'}`,
        `Status: ${loan.status || 'pending'}`,
        `Purpose: ${loan.purpose || '‚Äî'}`,
      ];
      let y = 88; lines.forEach(l => { doc.setFontSize(10); doc.text(l, 16, y); y += 7; });
      doc.setFontSize(9); doc.setTextColor(100,100,100); doc.text('Visionary Youth Group ‚Äî Loan Application (Generated PDF)', 14, 280);
      doc.save(`loan_${loanId}_${currentUser.uid}_${Date.now()}.pdf`);
    }catch(e){ console.error('downloadLoanPdfById err', e); alert('Failed to generate PDF: ' + (e.message || e)); }
  }

  // delegated loan table actions
  document.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-action]');
    if(!btn) return;
    const id = btn.getAttribute('data-id');
    const action = btn.getAttribute('data-action');
    if(action === 'view'){
      if(!currentUser){ alert('Sign in to view'); return; }
      try{
        const snap = await get(child(ref(db), `members/${currentUser.uid}/loans/${id}`));
        if(!snap.exists()){ alert('Loan not found'); return; }
        const loan = snap.val();
        alert(`Loan ID: ${loan.id || id}\nAmount: ${loan.amount? fmt(loan.amount): '‚Äî'}\nInterest: ${loan.interestRate? loan.interestRate + '%' : '‚Äî'}\nTenure: ${loan.tenureMonths || '‚Äî'} months\nStatus: ${loan.status || 'pending'}`);
      }catch(err){ console.error('loan view err', err); alert('Failed to fetch loan'); }
    } else if(action === 'download'){
      if(!id){ alert('Loan id missing'); return; }
      await downloadLoanPdfById(id);
    }
  });

  // onAuthStateChanged: attach listeners for balances, points, tx, loans
  onAuthStateChanged(auth, async user => {
    // cleanup
    unsubscribers.forEach(u => { try{ if(typeof u === 'function') u(); } catch(e){} });
    unsubscribers = [];
    currentUser = user;
    if(user){
      $('topUserName').textContent = user.displayName || user.email || 'Member';
      $('topUserEmail').textContent = user.email || '';
      $('sideName').textContent = user.displayName || user.email || 'Member';
      $('sideEmail').textContent = user.email || '';

      // Balances: try members/{uid}/balances then fallback to balances/{uid}
      const memberBalancesRef = ref(db, `members/${user.uid}/balances`);
      const topBalancesRef = ref(db, `balances/${user.uid}`);
      const balUnsub = onValue(memberBalancesRef, snap => {
        if(snap.exists()){
          const b = snap.val();
          $('monthlyBalance').textContent = fmt(b.monthly || b.monthlySavings || 0);
          $('weeklyBalance').textContent = fmt(b.weekly || b.weeklySavings || 0);
          $('sharesCount').textContent = (b.shares || b.sharesCount || 0) + ' units';
          $('dividendsBalance').textContent = fmt(b.dividends || 0);
          $('outstandingBalance').textContent = fmt(b.outstanding || 0);
          $('unpaidBalance').textContent = fmt(b.pending || b.unpaid || 0);
        } else {
          // fallback get
          get(topBalancesRef).then(snap2 => {
            if(snap2.exists()){
              const b2 = snap2.val();
              $('monthlyBalance').textContent = fmt(b2.monthly || 0);
              $('weeklyBalance').textContent = fmt(b2.weekly || 0);
              $('sharesCount').textContent = (b2.shares || 0) + ' units';
              $('dividendsBalance').textContent = fmt(b2.dividends || 0);
              $('outstandingBalance').textContent = fmt(b2.outstanding || 0);
              $('unpaidBalance').textContent = fmt(b2.pending || 0);
            } else {
              // nothing
              $('monthlyBalance').textContent = $('weeklyBalance').textContent = 'KES 0';
              $('sharesCount').textContent = '0 units';
              $('dividendsBalance').textContent = $('outstandingBalance').textContent = $('unpaidBalance').textContent = 'KES 0';
            }
          }).catch(e => { console.error('fallback balances get err', e); });
        }
      }, err => { console.error('balances onValue err', err); });
      unsubscribers.push(balUnsub);

      // Points
      const memberPointsRef = ref(db, `members/${user.uid}/points`);
      const topPointsRef = ref(db, `points/${user.uid}`);
      const ptsUnsub = onValue(memberPointsRef, snap => {
        if(snap.exists()) $('pointsValue').textContent = Number(snap.val()) || 0;
        else {
          get(topPointsRef).then(snap2 => { $('pointsValue').textContent = snap2.exists() ? Number(snap2.val()) : 0; }).catch(e=> { console.error('fallback points err', e); $('pointsValue').textContent = 0; });
        }
      }, err => { console.error('points onValue err', err); $('pointsValue').textContent = 0; });
      unsubscribers.push(ptsUnsub);

      // Transactions
      const txRef = ref(db, `members/${user.uid}/transactions`);
      const txUnsub = onValue(txRef, snap => {
        const arr = [];
        if(snap.exists()){
          const val = snap.val();
          Object.entries(val).forEach(([k,v]) => arr.push({ id:k, ...v }));
          arr.sort((a,b) => (a.timestamp||a.date||0) - (b.timestamp||b.date||0));
        }
        renderTransactions(arr);
      }, err => { console.error('transactions onValue err', err); renderTransactions([]); });
      unsubscribers.push(txUnsub);

      // Loans
      const loansRef = ref(db, `members/${user.uid}/loans`);
      const loansUnsub = onValue(loansRef, snap => {
        const body = $('loanBody'); body.innerHTML = '';
        const rows = [];
        if(snap.exists()){
          const data = snap.val();
          Object.entries(data).forEach(([k,v]) => rows.push({ id:k, ...v }));
          rows.sort((a,b) => (b.createdAt||0) - (a.createdAt||0));
          rows.forEach(r => {
            const tr = document.createElement('tr');
            const applied = r.createdAt ? new Date(Number(r.createdAt)).toLocaleString() : '‚Äî';
            const amt = r.amount ? fmt(r.amount) : '‚Äî';
            const int = (r.interestRate? r.interestRate + '%' : '‚Äî');
            const tenure = r.tenureMonths ? r.tenureMonths + ' mo' : '‚Äî';
            const status = r.status || 'pending';
            const statusHtml = `<span class="status-pill ${status==='pending'?'status-pending': status==='approved'?'status-approved':'status-rejected'}">${esc(status)}</span>`;
            tr.innerHTML = `<td>${esc(applied)}</td><td>${esc(amt)}</td><td>${esc(int)}</td><td>${esc(tenure)}</td><td>${statusHtml}</td><td><button class="btn" data-id="${esc(r.id)}" data-action="view">View</button> <button class="btn ghost" data-id="${esc(r.id)}" data-action="download">PDF</button></td>`;
            body.appendChild(tr);
          });
          const active = rows.find(rr => rr.status === 'approved') || rows.find(rr => rr.status === 'pending') || rows[0];
          if(active){ populateLoanAction(active); selectedLoanId = active.id; } else { hideLoanAction(); selectedLoanId = null; }
        } else {
          body.innerHTML = '<tr><td colspan="6" class="subtitle">No applications yet.</td></tr>'; hideLoanAction(); selectedLoanId = null;
        }
      }, err => { console.error('loans onValue err', err); });
      unsubscribers.push(loansUnsub);

      // Attach buttons now that user exists
      attachButtons();

      // award login points (non-blocking)
      try{ const pRef = ref(db, `members/${user.uid}/points`); get(pRef).then(snap => { const cur = snap.exists()? Number(snap.val()):0; set(pRef, cur + 5).catch(()=>{}); }); }catch(e){}

      // reset inactivity
      resetInactivityTimer();
    } else {
      // guest -> redirect to index
      // (you can choose to redirect or show guest UI)
      console.log('no user; redirecting to index.html'); // comment out if not desired
      // window.location.href = 'index.html';
      // clear UI
      $('monthlyBalance').textContent = 'KES 0'; $('weeklyBalance').textContent = 'KES 0'; $('sharesCount').textContent = '0 units'; $('dividendsBalance').textContent = 'KES 0'; $('outstandingBalance').textContent = 'KES 0'; $('unpaidBalance').textContent = 'KES 0'; $('pointsValue').textContent = 0;
      hideLoanAction();
      unsubscribers.forEach(u => { try{ if(typeof u === 'function') u(); }catch(e){} }); unsubscribers = [];
      clearTimeout(inactivityTimer); clearTimeout(warningTimer);
    }
  });

  // render transactions
  function renderTransactions(arr){
    const tbody = $('txBody'); tbody.innerHTML = '';
    if(!arr || !arr.length){ tbody.innerHTML = '<tr><td colspan="5" class="subtitle">No transactions yet.</td></tr>'; return; }
    let running = 0;
    arr.forEach(t => {
      if('balance' in t && t.balance !== null && t.balance !== undefined) running = Number(t.balance);
      else running = running + (Number(t.credit||0) - Number(t.debit||0));
      const dateStr = t.date ? new Date(t.date).toLocaleString() : new Date(t.timestamp||0).toLocaleString();
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${esc(dateStr)}</td><td>${esc(t.description||'')}</td><td>${t.debit? (Number(t.debit).toLocaleString()): ''}</td><td>${t.credit? (Number(t.credit).toLocaleString()): ''}</td><td>${running.toLocaleString()}</td>`;
      tbody.appendChild(tr);
    });
  }

  // inactivity auto-logout
  let AUTO_LOGOUT_MIN = 10; let inactivityTimer = null; let warningTimer = null;
  function resetInactivityTimer(){ if(inactivityTimer) clearTimeout(inactivityTimer); if(warningTimer) clearTimeout(warningTimer); if(!currentUser) return; warningTimer = setTimeout(()=>{ $('logoutWarning').style.display = 'flex'; }, Math.max((AUTO_LOGOUT_MIN * 60 - 60) * 1000, 0)); inactivityTimer = setTimeout(()=>{ signOut(auth).then(()=> window.location.href='index.html').catch(()=> window.location.href='index.html'); $('logoutWarning').style.display = 'none'; }, AUTO_LOGOUT_MIN * 60 * 1000); }
  ['click','mousemove','keydown','scroll','touchstart'].forEach(evt => window.addEventListener(evt, ()=> { if(currentUser) resetInactivityTimer(); }, { passive:true }));

  // cleanup on unload
  window.addEventListener('beforeunload', ()=> { unsubscribers.forEach(u => { try{ if(typeof u === 'function') u(); }catch(e){} }); });

  // small helpers
  function fmt(v){ return 'KES ' + (Number(v||0)).toLocaleString(); }
  function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

</script>
</body>
</html>
