<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Visionary Youth Group — SEKU Dashboard (Final)</title>
<meta name="description" content="Final SEKU-styled dashboard with full Firebase RTDB integration, auto-logout after 3 minutes inactivity, points system, loan wizard, withdrawals, transactions, exports, and collapsible menu." />
<!-- External libs -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
  :root{
    --seku-green:#006400; --seku-gold:#FFD700; --bg:#f6faf6; --panel:#ffffff; --muted:#274733;
    --glass:rgba(0,100,0,0.04); --radius:12px; --shadow:0 10px 30px rgba(2,10,6,0.08);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#edf7ef 0%, #e9f6e9 100%);color:#07210f;padding:18px;-webkit-font-smoothing:antialiased}
  .app{max-width:1500px;margin:0 auto;display:grid;grid-template-columns:320px 1fr;gap:18px;min-height:92vh;align-items:start}
  aside.sidebar{background:var(--panel);border-radius:12px;padding:18px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,0.04);height:calc(100vh - 36px);overflow:auto;position:sticky;top:18px}
  .brand{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--seku-green),#004b20);display:flex;align-items:center;justify-content:center;color:var(--seku-gold);font-weight:900;font-size:20px}
  .brand h2{margin:0;font-size:18px}
  nav.side-menu{display:flex;flex-direction:column;gap:6px;margin-top:12px}
  .side-link{display:flex;align-items:center;gap:10px;padding:12px;border-radius:10px;color:var(--muted);text-decoration:none;cursor:pointer;border:1px solid transparent}
  .side-link:hover{background:var(--glass);color:var(--seku-green);font-weight:700}
  .side-link.active{background:linear-gradient(90deg, rgba(0,100,0,0.06), rgba(255,215,0,0.02));border:1px solid rgba(0,100,0,0.06)}
  .collapsible{cursor:pointer;user-select:none;display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;background:rgba(0,0,0,0.02);border:1px solid rgba(0,0,0,0.03)}
  .collapsible + .content{display:none;padding-left:6px;margin-top:6px}
  .collapsible.open + .content{display:block}
  .sub-link{display:block;padding:8px 12px;border-radius:8px;color:var(--muted);cursor:pointer;margin:4px 0}
  .sub-link:hover{background:var(--glass);color:var(--seku-green);font-weight:700}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .top-actions{display:flex;gap:8px;align-items:center}
  .btn{background:var(--seku-green);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
  .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--muted);font-weight:600}
  .btn.small{padding:6px 8px;font-size:13px;border-radius:6px}
  .content{padding:18px;background:var(--panel);border-radius:12px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,0.04);overflow:auto;min-height:80vh}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .card{background:linear-gradient(180deg,#fff,#fbfff8);border-radius:10px;padding:14px;border:1px solid rgba(0,0,0,0.03);box-shadow:0 6px 18px rgba(2,10,6,0.04)}
  .card .label{font-size:13px;color:var(--muted)}
  .card .value{font-size:20px;font-weight:800;margin-top:6px;color:var(--seku-green)}
  .card .icon{width:48px;height:48px;border-radius:8px;background:linear-gradient(135deg,#edf9ef,#e5f7e5);display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--seku-green)}
  .panel{margin-top:12px;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfffb);border:1px solid rgba(0,0,0,0.03)}
  table{width:100%;border-collapse:collapse;font-size:14px}
  thead th{background:transparent;color:var(--muted);text-align:left;padding:12px;border-bottom:1px solid rgba(0,0,0,0.04);font-weight:700}
  td{padding:10px;border-bottom:1px solid rgba(0,0,0,0.03)}
  .muted{color:var(--muted)}
  .action-bar{display:flex;flex-direction:column;gap:10px;padding:12px;border-radius:8px;background:linear-gradient(90deg, rgba(0,100,0,0.06), rgba(255,215,0,0.03));border:1px solid rgba(0,0,0,0.03)}
  .action-row{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;align-items:center}
  .action-item{padding:10px;border-radius:8px;background:#fff;border:1px solid rgba(0,0,0,0.02);text-align:center}
  .form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  label{display:block;margin-top:8px;font-size:13px;color:var(--muted);font-weight:700}
  input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:#fff;margin-top:6px}
  textarea{min-height:120px;resize:vertical}
  .footer-note{margin-top:12px;font-size:13px;color:var(--muted)}
  @media (max-width:1200px){.app{grid-template-columns:1fr}.grid-3{grid-template-columns:repeat(2,1fr)}.action-row{grid-template-columns:repeat(2,1fr)}.form-grid{grid-template-columns:1fr}aside.sidebar{position:relative;height:auto}}
  .spacer{height:10px}
  .tooltip{position:relative;display:inline-block}
  .tooltip .tooltiptext{visibility:hidden;width:220px;background:var(--panel);color:#111;text-align:left;padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.06);position:absolute;z-index:1;bottom:125%;left:50%;transform:translateX(-50%);box-shadow:var(--shadow)}
  .tooltip:hover .tooltiptext{visibility:visible}
  .hidden{display:none}
  .chev{transition:transform .2s ease}
  .collapsible.open .chev{transform:rotate(90deg)}
  .notice{padding:10px;border-radius:8px;background:#f3fff3;border:1px solid rgba(0,100,0,0.06);color:var(--seku-green);margin-top:10px}
</style>
</head>
<body>
<div class="app" id="appRoot">
  <aside class="sidebar" aria-label="sidebar">
    <div class="brand">
      <div class="logo">VY</div>
      <div><h2>Visionary Youth</h2><div class="muted">Member portal — SEKU</div></div>
    </div>

    <div style="display:flex;gap:8px;flex-direction:column">
      <div class="collapsible" id="menuAccount">
        <div style="display:flex;gap:10px;align-items:center">
          <div id="sideAvatar" style="width:46px;height:46px;border-radius:8px;background:linear-gradient(135deg,var(--seku-green),#004b20);display:flex;align-items:center;justify-content:center;color:var(--seku-gold);font-weight:800">GK</div>
          <div><div id="sideName" style="font-weight:800">Guest</div><div id="sideEmail" class="muted">Not signed in</div></div>
        </div>
        <div><span class="chev">▶</span></div>
      </div>
      <div class="content" id="menuAccountContent">
        <div class="sub-link" id="quickViewProfile">View profile</div>
        <div class="sub-link" id="quickSettings">Settings</div>
        <div class="sub-link hidden" id="signoutSmall">Sign out</div>
      </div>
    </div>

    <nav class="side-menu" id="mainMenu">
      <div class="side-link active" data-view="dashboard" onclick="navigate('dashboard', this)">Dashboard</div>
      <div class="side-link" data-view="transactions" onclick="navigate('transactions', this)">Transactions</div>
      <div class="side-link" data-view="loans" onclick="navigate('loans', this)">Loans</div>

      <div class="collapsible" id="collLoans">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Loan tools</strong></div><div class="chev">▶</div>
        </div>
      </div>
      <div class="content" id="collLoansContent">
        <div class="sub-link" onclick="navigate('loans')">Apply for loan</div>
        <div class="sub-link" onclick="navigate('loans')">My applications</div>
        <div class="sub-link" onclick="navigate('loans')">Repayment schedule</div>
      </div>

      <div class="side-link" data-view="withdrawals" onclick="navigate('withdrawals', this)">Withdrawals</div>
      <div class="side-link" data-view="profile" onclick="navigate('profile', this)">Profile</div>
      <div class="side-link" data-view="settings" onclick="navigate('settings', this)">Settings</div>
    </nav>

    <div class="spacer"></div>
    <div style="display:flex;flex-direction:column;gap:8px">
      <button class="btn small" id="quickApply">Apply for Loan</button>
      <button class="btn small ghost" id="quickWithdraw">Request Withdrawal</button>
    </div>

    <div class="spacer"></div>
    <div class="muted">Support<br/>Email: <a href="mailto:visionary@example.com">visionary@example.com</a></div>
    <div style="height:30px"></div>
    <small class="muted"> © Visionary Youth Group 2024 — SEKU final</small>
  </aside>

  <div style="display:flex;flex-direction:column;gap:12px">
    <header class="topbar">
      <div><h3 style="margin:0">Member Dashboard</h3><div class="muted">Secure • Real-time • SEKU</div></div>
      <div class="top-actions">
        <div id="authControls">
          <button class="btn ghost small" id="btnSignIn">Sign in</button>
          <button class="btn small" id="btnSignUp">Sign up</button>
        </div>
        <div id="userControls" style="display:none;align-items:center;gap:8px">
          <div style="text-align:right"><div id="topUserName" style="font-weight:800">Guest</div><div id="topUserEmail" class="muted">—</div></div>
          <button class="btn ghost small" id="btnSignOut">Sign out</button>
        </div>
      </div>
    </header>

    <main class="content" id="mainContent">
      <!-- Dashboard -->
      <section id="view-dashboard">
        <div class="grid-3">
          <div class="card"><div style="display:flex;gap:10px;align-items:center"><div class="icon">M</div><div><div class="label">Monthly Savings</div><div class="value" id="monthlyBalance">KES 0</div><div class="muted">Monthly contributions</div></div></div></div>
          <div class="card"><div style="display:flex;gap:10px;align-items:center"><div class="icon">W</div><div><div class="label">Weekly Savings</div><div class="value" id="weeklyBalance">KES 0</div><div class="muted">Weekly deposits</div></div></div></div>
          <div class="card"><div style="display:flex;gap:10px;align-items:center"><div class="icon">S</div><div><div class="label">Shares</div><div class="value" id="sharesCount">0 units</div><div class="muted">Shareholding</div></div></div></div>
        </div>

        <div class="grid-3" style="margin-top:12px">
          <div class="card"><div style="display:flex;gap:10px;align-items:center"><div class="icon">D</div><div><div class="label">Dividends</div><div class="value" id="dividendsBalance">KES 0</div><div class="muted">Dividends</div></div></div></div>
          <div class="card"><div style="display:flex;gap:10px;align-items:center"><div class="icon">O</div><div><div class="label">Outstanding</div><div class="value" id="outstandingBalance">KES 0</div><div class="muted">Loans outstanding</div></div></div></div>
          <div class="card"><div style="display:flex;gap:10px;align-items:center"><div class="icon">U</div><div><div class="label">Unpaid</div><div class="value" id="unpaidBalance">KES 0</div><div class="muted">Fees & arrears</div></div></div></div>
        </div>

        <div class="panel" id="loanActionPanel" aria-hidden="true" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center"><div><strong>Loan Action Bar</strong><div class="muted">Visible when an active loan exists</div></div><div id="loanBadge" class="muted">Status: —</div></div>
          <div class="action-bar" style="margin-top:10px">
            <div class="action-row"><div class="action-item"><div class="muted">Amount</div><div id="actAmt" style="font-weight:800">KES 0</div></div><div class="action-item"><div class="muted">Interest</div><div id="actInt" style="font-weight:800">0%</div></div><div class="action-item"><div class="muted">Stage</div><div id="actStage">—</div></div><div class="action-item"><div class="muted">Installments</div><div id="actInst">0</div></div><div class="action-item"><div class="muted">Next Repayment</div><div id="actNext">—</div></div></div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px"><button class="btn ghost small" id="downloadLoanAppBtn">Download Application</button><button class="btn small" id="repayBtn">Make Repayment</button></div>
          </div>
        </div>

        <div class="panel" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Transaction History</strong><div class="muted">Ledger of debits, credits & running balances</div></div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="btn ghost small" id="filterToggleBtn">Filter</button>
              <button class="btn ghost small" id="exportCsvBtn">CSV</button>
              <button class="btn small" id="exportPdfBtn">PDF</button>
            </div>
          </div>

          <div id="filterArea" style="display:none;margin-top:8px" class="panel">
            <div class="form-grid">
              <div><label>From</label><input type="date" id="filterFrom" /></div>
              <div><label>To</label><input type="date" id="filterTo" /></div>
              <div><label>Type</label><select id="filterType"><option value="">All</option><option value="credit">Credit</option><option value="debit">Debit</option><option value="fee">Fee</option></select></div>
              <div><label>Search</label><input id="filterSearch" placeholder="Search description or ref" /></div>
            </div>
            <div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="btn ghost small" id="applyFilterBtn">Apply</button></div>
          </div>

          <div style="margin-top:8px;overflow:auto;max-height:420px">
            <table id="txTable">
              <thead><tr><th>Date</th><th>Particulars</th><th>Debit (KES)</th><th>Credit (KES)</th><th>Balance (KES)</th></tr></thead>
              <tbody id="txBody"><tr><td colspan="5" class="muted">No transactions available.</td></tr></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Transactions view -->
      <section id="view-transactions" style="display:none">
        <div class="panel"><h4>Transactions</h4><div class="muted">Detailed transaction list</div><div style="height:12px"></div><div style="overflow:auto;max-height:600px"><table id="txTable2"><thead><tr><th>Date</th><th>Description</th><th>Debit</th><th>Credit</th><th>Balance</th></tr></thead><tbody id="txBody2"><tr><td colspan="5" class="muted">No transactions.</td></tr></tbody></table></div></div>
      </section>

      <!-- Loans view -->
      <section id="view-loans" style="display:none">
        <div class="panel"><h4>Loan Applications</h4><div class="muted">Apply or view status</div><div id="loanList" style="margin-top:8px"><div class="muted">No applications yet.</div></div></div>

      <div class="panel" style="margin-top:12px">
        <h4>Loan Application Wizard — Final</h4>
        <div class="muted">Comprehensive multi-step loanee information</div>
        <div style="height:10px"></div>
        <div id="wizardStepsBar" style="display:flex;gap:6px;flex-wrap:wrap"></div>
        <form id="loanFormFull" onsubmit="return false" style="margin-top:12px">
          <div id="wizardFullContent"></div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
            <button class="btn ghost small" id="wizardPrevBtn" type="button">Back</button>
            <button class="btn small" id="wizardNextBtnFull" type="button">Next</button>
            <button class="btn small" id="wizardSubmitFull" type="button" style="display:none">Submit Application</button>
          </div>
        </form>
      </div>
      </section>

      <!-- Withdrawals view -->
      <section id="view-withdrawals" style="display:none">
        <div class="panel">
          <h4>Withdrawal Request</h4>
          <div class="muted">Members requesting withdrawal must provide a detailed justification (>=200 chars)</div>
          <div style="height:10px"></div>
          <form id="withdrawalFormFull" onsubmit="return false">
            <div class="form-grid">
              <div><label>Amount (KES)</label><input id="wd_amount_full" type="number" required/></div>
              <div><label>Bank</label><input id="wd_bank_full"/></div>
              <div><label>Account number</label><input id="wd_acct_full"/></div>
              <div><label>Fees (KES)</label><input id="wd_fees_full" type="number" value="0"/></div>
            </div>
            <label>Reason for withdrawal (minimum 200 characters)</label>
            <textarea id="wd_reason_full" minlength="200" placeholder="Explain why you wish to withdraw (200+ characters)" required></textarea>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
              <button class="btn ghost small" id="clearWithdrawFull" type="button">Clear</button>
              <button class="btn small" id="submitWithdrawalFull" type="button">Submit Request</button>
            </div>
          </form>
        </div>
      </section>

      <!-- Profile view -->
      <section id="view-profile" style="display:none">
        <div class="panel">
          <h4>Update Profile</h4>
          <div class="muted">Complete particulars below</div>
          <div style="height:8px"></div>
          <form id="profileFullForm" onsubmit="return false">
            <div class="form-grid">
              <div><label>Full name</label><input id="pf_fullname"/></div>
              <div><label>Member ID</label><input id="pf_memberid"/></div>
              <div><label>Email</label><input id="pf_email" type="email"/></div>
              <div><label>Member Type</label><select id="pf_type"><option value="ordinary">Ordinary</option><option value="premium">Premium</option><option value="staff">Staff</option></select></div>
              <div><label>Phone</label><input id="pf_phone"/></div>
              <div><label>Gender</label><select id="pf_gender"><option value="">Select</option><option>Male</option><option>Female</option><option>Other</option></select></div>
              <div><label>Date of birth</label><input id="pf_dob" type="date"/></div>
              <div><label>Residence</label><input id="pf_residence"/></div>
              <div><label>Education level</label><input id="pf_education" placeholder="e.g., BSc Computer Science"/></div>
              <div><label>Occupation / Employer</label><input id="pf_employer"/></div>
              <div><label>Next of kin (Name)</label><input id="pf_nok_name"/></div>
              <div><label>Next of kin (Contact)</label><input id="pf_nok_contact"/></div>
              <div><label>Source of income</label><input id="pf_income_source"/></div>
              <div><label>Referral source</label><input id="pf_referral"/></div>
              <div><label>Membership date (auto)</label><input id="pf_joined" readonly/></div>
              <div><label>Notes (admin)</label><textarea id="pf_admin_notes" placeholder="Internal notes (admin only)"></textarea></div>
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
              <button class="btn ghost small" id="resetProfileFull" type="button">Reset</button>
              <button class="btn small" id="saveProfileFull" type="button">Save Profile</button>
            </div>
          </form>
        </div>
      </section>

      <!-- Settings view -->
      <section id="view-settings" style="display:none">
        <div class="panel">
          <h4>Settings</h4>
          <div class="muted">Preferences and utilities</div>
          <div style="height:8px"></div>
          <div class="form-grid">
            <div><label>Auto-logout (minutes)</label><input id="set_autologout" type="number" value="3" min="1" /></div>
            <div><label>Date format</label><select id="set_datefmt"><option value="local">Local</option><option value="iso">ISO</option></select></div>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px"><button class="btn small" id="applySettingsBtn">Apply</button></div>
        </div>
      </section>

    </main>

    <div class="footer-note">This file is final: full Firebase integration, auto-logout after inactivity, points system, and all major features per your spec.</div>
  </div>
</div>

<script type="module">
  // Firebase modular imports v9
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getDatabase, ref, onValue, set, push, update, serverTimestamp, get, child } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

  // Provided Firebase config (as you gave earlier)
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyA_OCu7HQ5HCH2OYx5dQ2Z1r7YPwQJave4",
    authDomain: "visionary-youth-grou-2024.firebaseapp.com",
    databaseURL: "https://visionary-youth-grou-2024-default-rtdb.firebaseio.com",
    projectId: "visionary-youth-grou-2024",
    storageBucket: "visionary-youth-grou-2024.appspot.com",
    messagingSenderId: "372978592717",
    appId: "1:372978592717:web:1c15aec728ee5f854f3284"
  };

  // Initialize Firebase app and services
  const app = initializeApp(FIREBASE_CONFIG);
  const db = getDatabase(app);
  const auth = getAuth(app);

  // Helpers
  const $ = id => document.getElementById(id);
  function fmt(v){ return 'KES ' + (Number(v||0)).toLocaleString(); }
  function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function show(el){ if(el) el.style.display = 'block'; }
  function hide(el){ if(el) el.style.display = 'none'; }

  // Navigation
  function navigate(view, el){
    const views = ['dashboard','transactions','loans','withdrawals','profile','settings'];
    views.forEach(v => { const n = $( 'view-' + v); if(n) n.style.display = 'none'; });
    const target = $( 'view-' + view );
    if(target) target.style.display = 'block';
    document.querySelectorAll('.side-link').forEach(s => s.classList.remove('active'));
    if(el) el.classList.add('active'); else { const m = document.querySelector(`[data-view="${view}"]`); if(m) m.classList.add('active'); }
  }
  navigate('dashboard');

  // Collapsible handlers
  document.querySelectorAll('.collapsible').forEach(c => {
    c.addEventListener('click', ()=>{
      c.classList.toggle('open');
      const next = c.nextElementSibling;
      if(next && next.classList.contains('content')) next.style.display = next.style.display === 'block' ? 'none' : 'block';
    });
  });

  // UI wiring
  $('btnSignIn').addEventListener('click', ()=> openAuthModal('signin'));
  $('btnSignUp').addEventListener('click', ()=> openAuthModal('signup'));
  $('btnSignOut').addEventListener('click', ()=> { signOut(auth).then(()=> alert('Signed out')).catch(e=>alert('Sign out failed')); });
  $('quickApply').addEventListener('click', ()=> navigate('loans'));
  $('quickWithdraw').addEventListener('click', ()=> navigate('withdrawals'));

  // Auth modal (uses Firebase)
  function openAuthModal(mode){
    const overlay = document.createElement('div'); overlay.style.position='fixed'; overlay.style.inset=0; overlay.style.background='rgba(0,0,0,0.6)'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center'; overlay.style.zIndex=9999;
    const box = document.createElement('div'); box.style.width='520px'; box.style.padding='18px'; box.style.borderRadius='10px'; box.style.background='white';
    box.innerHTML = `<h3 style="margin-top:0">${mode==='signin'?'Sign in':'Create account'}</h3>
      <div style="margin-top:8px"><label class="muted">Email</label><input id="auth_email" type="email" style="width:100%;padding:10px;margin-top:6px"/></div>
      <div style="margin-top:8px"><label class="muted">Password</label><input id="auth_pass" type="password" style="width:100%;padding:10px;margin-top:6px"/></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px"><button id="auth_cancel" class="btn ghost small">Cancel</button><button id="auth_submit" class="btn small">${mode==='signin'?'Sign in':'Create'}</button></div>
      <div id="auth_msg" style="margin-top:8px;color:var(--seku-green)"></div>`;
    overlay.appendChild(box); document.body.appendChild(overlay);
    $('auth_cancel').addEventListener('click', ()=> document.body.removeChild(overlay));
    $('auth_submit').addEventListener('click', async ()=>{
      const email = $('auth_email').value.trim(); const pass = $('auth_pass').value;
      if(!email || !pass){ $('auth_msg').textContent = 'Provide email & password'; return; }
      try{
        if(mode==='signin'){ await signInWithEmailAndPassword(auth, email, pass); $('auth_msg').textContent = 'Signed in'; }
        else { await createUserWithEmailAndPassword(auth, email, pass); $('auth_msg').textContent = 'Account created'; }
        setTimeout(()=> { if(document.body.contains(overlay)) document.body.removeChild(overlay); }, 500);
      }catch(err){ $('auth_msg').textContent = err.message || String(err); }
    });
  }

  // Auto-logout after inactivity: 3 minutes default, configurable in settings
  let AUTO_LOGOUT_MIN = 3;
  let inactivityTimer = null;

  function resetInactivityTimer(){
    if(inactivityTimer) clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(()=>{
      // perform sign out
      if(auth.currentUser){ signOut(auth).then(()=> { alert('Signed out due to inactivity (auto-logout)'); }).catch(e=> console.error(e)); }
    }, AUTO_LOGOUT_MIN * 60 * 1000);
  }

  // reset on user interactions
  ['click','mousemove','keydown','scroll','touchstart'].forEach(evt => {
    window.addEventListener(evt, ()=> {
      if(auth && auth.currentUser) resetInactivityTimer();
    }, { passive:true });
  });

  // Points system: store under /members/{uid}/points (number)
  async function addPoints(uid, amount, reason='action'){
    try{
      const pointsRef = ref(db, `members/${uid}/points`);
      const snap = await get(pointsRef);
      const current = snap.exists() ? Number(snap.val()) : 0;
      await set(pointsRef, current + Number(amount));
      // also record a small log
      const logRef = ref(db, `members/${uid}/pointsLog`);
      const p = push(logRef);
      await set(p, { change: Number(amount), reason, at: serverTimestamp() });
      return current + Number(amount);
    }catch(e){
      console.error('addPoints error', e);
      return null;
    }
  }

  // onAuth change: attach listeners to RTDB nodes for the user
  let userListeners = [];

  onAuthStateChanged(auth, async user => {
    // clear previous listeners
    userListeners.forEach(fn=> fn());
    userListeners = [];
    if(user){
      // show UI
      $('authControls').style.display = 'none'; $('userControls').style.display = 'flex';
      $('topUserName').textContent = user.email || 'Member'; $('topUserEmail').textContent = user.email || '';
      $('sideEmail').textContent = user.email || '';
      $('sideName').textContent = user.email || '';
      $('signoutSmall').classList.remove('hidden');
      // create default profile if missing
      const profileRef = ref(db, `members/${user.uid}/profile`);
      const profileSnap = await get(profileRef);
      if(!profileSnap.exists()){
        await set(profileRef, { fullName: user.email, memberId: user.uid, email: user.email, joined: new Date().toISOString(), type:'ordinary' });
      }
      // attach balances listener
      const balancesRef = ref(db, `members/${user.uid}/balances`);
      const unBalances = onValue(balancesRef, snap => {
        const b = snap.exists()? snap.val() : {};
        $('monthlyBalance').textContent = fmt(b.monthly); $('weeklyBalance').textContent = fmt(b.weekly); $('sharesCount').textContent = (b.shares||0) + ' units';
        $('dividendsBalance').textContent = fmt(b.dividends); $('outstandingBalance').textContent = fmt(b.outstanding); $('unpaidBalance').textContent = fmt(b.unpaid);
      });
      userListeners.push(()=> unBalances());

      // attach transactions listener
      const txRef = ref(db, `members/${user.uid}/transactions`);
      const unTx = onValue(txRef, snap => {
        const arr = [];
        if(snap.exists()){
          const val = snap.val(); Object.entries(val).forEach(([k,v]) => arr.push({ id:k, ...v }));
          arr.sort((a,b) => (a.timestamp||0) - (b.timestamp||0));
        }
        renderTransactions(arr);
      });
      userListeners.push(()=> unTx());

      // attach profile listener
      const profRef = ref(db, `members/${user.uid}/profile`);
      const unProf = onValue(profRef, snap => {
        const p = snap.exists()? snap.val() : null;
        if(p){
          $('pf_fullname').value = p.fullName || '';
          $('pf_memberid').value = p.memberId || user.uid;
          $('pf_email').value = p.email || '';
          $('pf_type').value = p.type || 'ordinary';
          $('pf_phone').value = p.phone || '';
          $('pf_gender').value = p.gender || '';
          $('pf_dob').value = p.dob || '';
          $('pf_residence').value = p.residence || '';
          $('pf_education').value = p.education || '';
          $('pf_employer').value = p.employer || '';
          $('pf_nok_name').value = p.nokName || '';
          $('pf_nok_contact').value = p.nokContact || '';
          $('pf_income_source').value = p.incomeSource || '';
          $('pf_referral').value = p.referral || '';
          $('pf_joined').value = p.joined || new Date().toISOString();
          $('pf_admin_notes').value = p.adminNotes || '';
          $('sideAvatar').textContent = (p.fullName||'Member').split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase();
          $('sideName').textContent = p.fullName || p.email || 'Member';
          $('topUserName').textContent = p.fullName || p.email || 'Member';
        }
      });
      userListeners.push(()=> unProf());
      // award login points once per session
      try{ await addPoints(user.uid, 5, 'login'); }catch(e){console.warn(e);}
      // start inactivity timer
      resetInactivityTimer();
    } else {
      // guest UI
      $('authControls').style.display = 'flex'; $('userControls').style.display = 'none';
      $('sideName').textContent = 'Guest'; $('sideEmail').textContent = 'Not signed in'; $('topUserName').textContent = 'Guest'; $('topUserEmail').textContent = '—';
      $('signoutSmall').classList.add('hidden');
      // clear transaction tables and balances
      $('txBody').innerHTML = '<tr><td colspan="5" class="muted">Sign in to view transactions.</td></tr>';
      $('txBody2').innerHTML = '<tr><td colspan="5" class="muted">Sign in to view transactions.</td></tr>';
      $('monthlyBalance').textContent = 'KES 0'; $('weeklyBalance').textContent = 'KES 0'; $('sharesCount').textContent = '0 units';
      $('dividendsBalance').textContent = 'KES 0'; $('outstandingBalance').textContent = 'KES 0'; $('unpaidBalance').textContent = 'KES 0';
      // stop inactivity timer
      if(inactivityTimer) clearTimeout(inactivityTimer);
    }
  });

  // Render transactions
  function renderTransactions(arr){
    const tbody = $('txBody'); tbody.innerHTML = ''; const tbody2 = $('txBody2'); tbody2.innerHTML = '';
    if(!arr.length){ tbody.innerHTML = '<tr><td colspan="5" class="muted">No transactions yet.</td></tr>'; tbody2.innerHTML = '<tr><td colspan="5" class="muted">No transactions yet.</td></tr>'; return; }
    let running = 0;
    arr.forEach(t => {
      if('balance' in t && t.balance !== null && t.balance !== undefined) running = Number(t.balance);
      else running = running + (Number(t.credit||0) - Number(t.debit||0));
      const dateStr = t.date ? new Date(t.date).toLocaleString() : new Date(t.timestamp||0).toLocaleString();
      const tr = document.createElement('tr'); tr.innerHTML = `<td>${esc(dateStr)}</td><td>${esc(t.description||'')}</td><td>${t.debit? (Number(t.debit).toLocaleString()): ''}</td><td>${t.credit? (Number(t.credit).toLocaleString()): ''}</td><td>${running.toLocaleString()}</td>`; tbody.appendChild(tr);
      const tr2 = document.createElement('tr'); tr2.innerHTML = `<td>${esc(dateStr)}</td><td>${esc(t.description||'')}</td><td>${t.debit? fmt(t.debit) : ''}</td><td>${t.credit? fmt(t.credit) : ''}</td><td>${fmt(running)}</td>`; tbody2.appendChild(tr2);
    });
  }

  // Export CSV and PDF
  $('exportCsvBtn').addEventListener('click', ()=>{
    const rows = Array.from($('txBody').children).map(tr => Array.from(tr.children).map(td=> td.textContent.trim()));
    if(!rows.length){ alert('No transactions to export'); return; }
    const csv = rows.map(r => r.map(c=> `"${c.replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type:'text/csv' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `transactions_${auth.currentUser? auth.currentUser.uid : 'guest'}_${Date.now()}.csv`; a.click();
  });
  $('exportPdfBtn').addEventListener('click', async ()=>{
    const el = $('txTable');
    const canvas = await html2canvas(el, { scale:2 });
    const img = canvas.toDataURL('image/png'); const { jsPDF } = window.jspdf; const pdf = new jsPDF('p','mm','a4'); const pageWidth = pdf.internal.pageSize.getWidth(); const imgProps = pdf.getImageProperties(img); const imgWidth = pageWidth - 20; const imgHeight = (imgProps.height * imgWidth) / imgProps.width; pdf.addImage(img,'PNG',10,10,imgWidth,imgHeight); pdf.setFontSize(10); pdf.text('Visionary Youth — Transactions', pageWidth/2, 8, { align:'center' }); pdf.save(`transactions_${auth.currentUser? auth.currentUser.uid : 'guest'}_${Date.now()}.pdf`);
  });

  // Filter toggle
  $('filterToggleBtn').addEventListener('click', ()=> { const fa = $('filterArea'); fa.style.display = fa.style.display === 'none' ? 'block' : 'none'; });
  $('applyFilterBtn').addEventListener('click', ()=> alert('Filter applied (demo)'));

  // Loan wizard implementation (comprehensive)
  const wizardSteps = ['personal','identity','employment','loan','guarantor','collateral','declarations','review']; let wizardPos = 0;
  let wizardData = { fullName:'', email:'', phone:'', address:'', idNumber:'', dob:'', employer:'', jobTitle:'', monthlyIncome:0, otherIncome:0, amount:0, interestRate:12, tenureMonths:6, repaymentSource:'', purpose:'', guarantorName:'', guarantorPhone:'', guarantorId:'', collateralDesc:'', collateralValue:0, declarations:false, signature:'' };

  function initLoanWizard(){
    const bar = $('wizardStepsBar'); bar.innerHTML = '';
    wizardSteps.forEach((s,i)=>{ const el = document.createElement('div'); el.textContent = `${i+1}. ${s}`; el.style.padding='6px 8px'; el.style.borderRadius='6px'; el.style.background = i===wizardPos? 'linear-gradient(90deg,var(--seku-green),var(--seku-gold))' : 'transparent'; el.style.color = i===wizardPos? '#fff' : 'var(--muted)'; bar.appendChild(el); });
    renderWizardStep();
    $('wizardPrevBtn').addEventListener('click', ()=>{ if(wizardPos>0){ saveWizardFields(); wizardPos--; renderWizardStep(); } });
    $('wizardNextBtnFull').addEventListener('click', ()=>{ saveWizardFields(); if(wizardPos < wizardSteps.length-1){ wizardPos++; renderWizardStep(); } });
    $('wizardSubmitFull').addEventListener('click', submitLoanApplication);
  }

  function renderWizardStep(){
    const bar = $('wizardStepsBar'); Array.from(bar.children).forEach((c,i)=>{ c.style.background = i===wizardPos? 'linear-gradient(90deg,var(--seku-green),var(--seku-gold))' : 'transparent'; c.style.color = i===wizardPos? '#fff' : 'var(--muted)'; });
    const container = $('wizardFullContent'); container.innerHTML = ''; const step = wizardSteps[wizardPos];
    if(step === 'personal'){ container.innerHTML = `<div class="form-grid"><div><label>Full name</label><input id="wiz_fullName" value="${esc(wizardData.fullName)}"/></div><div><label>Email</label><input id="wiz_email" type="email" value="${esc(wizardData.email)}"/></div><div><label>Phone</label><input id="wiz_phone" value="${esc(wizardData.phone)}"/></div><div><label>Address</label><input id="wiz_address" value="${esc(wizardData.address)}"/></div></div>`; }
    else if(step === 'identity'){ container.innerHTML = `<div class="form-grid"><div><label>ID Number</label><input id="wiz_idNumber" value="${esc(wizardData.idNumber)}"/></div><div><label>Date of birth</label><input id="wiz_dob" type="date" value="${esc(wizardData.dob)}"/></div></div>`; }
    else if(step === 'employment'){ container.innerHTML = `<div class="form-grid"><div><label>Employer</label><input id="wiz_employer" value="${esc(wizardData.employer)}"/></div><div><label>Job title</label><input id="wiz_jobTitle" value="${esc(wizardData.jobTitle)}"/></div><div><label>Monthly income (KES)</label><input id="wiz_monthlyIncome" type="number" value="${esc(wizardData.monthlyIncome)}"/></div><div><label>Other income (KES)</label><input id="wiz_otherIncome" type="number" value="${esc(wizardData.otherIncome)}"/></div></div>`; }
    else if(step === 'loan'){ container.innerHTML = `<div class="form-grid"><div><label>Amount (KES)</label><input id="wiz_amount" type="number" value="${esc(wizardData.amount)}"/></div><div><label>Interest rate (%)</label><input id="wiz_interestRate" type="number" value="${esc(wizardData.interestRate)}"/></div><div><label>Tenure (months)</label><input id="wiz_tenureMonths" type="number" value="${esc(wizardData.tenureMonths)}"/></div><div><label>Repayment source</label><input id="wiz_repaymentSource" value="${esc(wizardData.repaymentSource)}"/></div></div><label>Purpose</label><textarea id="wiz_purpose">${esc(wizardData.purpose)}</textarea>`; }
    else if(step === 'guarantor'){ container.innerHTML = `<div class="form-grid"><div><label>Guarantor name</label><input id="wiz_guarantorName" value="${esc(wizardData.guarantorName)}"/></div><div><label>Guarantor phone</label><input id="wiz_guarantorPhone" value="${esc(wizardData.guarantorPhone)}"/></div><div><label>Guarantor ID</label><input id="wiz_guarantorId" value="${esc(wizardData.guarantorId)}"/></div><div><label>Collateral value (KES)</label><input id="wiz_collateralValue" type="number" value="${esc(wizardData.collateralValue)}"/></div></div><label>Collateral description</label><textarea id="wiz_collateralDesc">${esc(wizardData.collateralDesc)}</textarea>`; }
    else if(step === 'collateral'){ container.innerHTML = `<label>Collateral details</label><textarea id="wiz_collateralFull">${esc(wizardData.collateralDesc)}</textarea>`; }
    else if(step === 'declarations'){ container.innerHTML = `<label><input type="checkbox" id="wiz_declarations" ${wizardData.declarations? 'checked':''}/> I declare information is true.</label><label>Digital signature (type full name)</label><input id="wiz_signature" value="${esc(wizardData.signature)}"/>`; }
    else if(step === 'review'){ saveWizardFields(); container.innerHTML = `<h4>Review</h4><pre style="white-space:pre-wrap;background:#f2f7f2;padding:10px;border-radius:8px">${esc(JSON.stringify(wizardData,null,2))}</pre>`; }
    $('wizardPrevBtn').style.display = wizardPos===0? 'none' : 'inline-block';
    $('wizardNextBtnFull').style.display = wizardPos===wizardSteps.length-1? 'none' : 'inline-block';
    $('wizardSubmitFull').style.display = wizardPos===wizardSteps.length-1? 'inline-block' : 'none';
  }

  function saveWizardFields(){
    const map = { fullName:'wiz_fullName', email:'wiz_email', phone:'wiz_phone', address:'wiz_address', idNumber:'wiz_idNumber', dob:'wiz_dob', employer:'wiz_employer', jobTitle:'wiz_jobTitle', monthlyIncome:'wiz_monthlyIncome', otherIncome:'wiz_otherIncome', amount:'wiz_amount', interestRate:'wiz_interestRate', tenureMonths:'wiz_tenureMonths', repaymentSource:'wiz_repaymentSource', purpose:'wiz_purpose', guarantorName:'wiz_guarantorName', guarantorPhone:'wiz_guarantorPhone', guarantorId:'wiz_guarantorId', collateralDesc:'wiz_collateralDesc', collateralValue:'wiz_collateralValue', declarations:'wiz_declarations', signature:'wiz_signature', collateralFull:'wiz_collateralFull' };
    for(const k in map){ const el = document.getElementById(map[k]); if(!el) continue; if(el.type === 'checkbox') wizardData[k] = el.checked; else wizardData[k] = el.value; }
  }

  async function submitLoanApplication(){
    saveWizardFields();
    const user = auth.currentUser;
    if(!user){ alert('Sign in first'); return; }
    if(!wizardData.fullName || !wizardData.email || !wizardData.amount){ alert('Please enter full name, email and loan amount'); return; }
    try{
      const appsRef = ref(db, `members/${user.uid}/loanApplications`);
      const newApp = push(appsRef);
      await set(newApp, { ...wizardData, status:'pending', createdAt: serverTimestamp() });
      // set top-level loan object for quick access
      await set(ref(db, `members/${user.uid}/loan`), { amount: Number(wizardData.amount), interestRate: Number(wizardData.interestRate), status:'pending', installments: [], tenureMonths: Number(wizardData.tenureMonths), appliedAt: serverTimestamp() });
      // award points
      await addPoints(user.uid, 20, 'loan_application');
      alert('Loan application submitted');
      wizardPos = 0; wizardData = {}; renderWizardStep();
    }catch(e){ console.error(e); alert('Failed to submit loan: ' + e.message); }
  }

  // Withdrawals handling
  $('submitWithdrawalFull').addEventListener('click', async ()=>{
    const user = auth.currentUser;
    if(!user){ alert('Sign in first'); return; }
    const amt = Number($('wd_amount_full').value || 0); const reason = $('wd_reason_full').value || '';
    if(!amt || amt <= 0){ alert('Enter valid amount'); return; }
    if(reason.trim().length < 200){ alert('Reason must be at least 200 characters'); return; }
    try{
      const wRef = ref(db, `members/${user.uid}/withdrawals`);
      const p = push(wRef);
      const payload = { amount: amt, bank: $('wd_bank_full').value||'', account: $('wd_acct_full').value||'', fees: Number($('wd_fees_full').value||0), reason, status:'pending', createdAt: serverTimestamp() };
      await set(p, payload);
      // record transaction
      const txRef = ref(db, `members/${user.uid}/transactions`);
      const txp = push(txRef);
      await set(txp, { date: new Date().toISOString(), description: 'Withdrawal request', debit: amt, credit:0, balance: null, timestamp: Date.now(), status:'pending' });
      // award points for responsible action
      await addPoints(user.uid, 5, 'withdrawal_request');
      alert('Withdrawal request submitted');
      clearWithdrawalForm();
    }catch(e){ console.error(e); alert('Failed to submit withdrawal: ' + e.message); }
  });

  function clearWithdrawalForm(){ $('wd_amount_full').value=''; $('wd_bank_full').value=''; $('wd_acct_full').value=''; $('wd_fees_full').value='0'; $('wd_reason_full').value=''; }

  // Profile save
  $('saveProfileFull').addEventListener('click', async ()=>{
    const user = auth.currentUser; if(!user){ alert('Sign in first'); return; }
    const payload = {
      fullName: $('pf_fullname').value || '', memberId: $('pf_memberid').value || user.uid, email: $('pf_email').value || '', type: $('pf_type').value || 'ordinary', phone: $('pf_phone').value || '',
      gender: $('pf_gender').value || '', dob: $('pf_dob').value || '', residence: $('pf_residence').value || '', education: $('pf_education').value || '', employer: $('pf_employer').value || '',
      nokName: $('pf_nok_name').value || '', nokContact: $('pf_nok_contact').value || '', incomeSource: $('pf_income_source').value || '', referral: $('pf_referral').value || '', joined: $('pf_joined').value || new Date().toISOString(), adminNotes: $('pf_admin_notes').value || ''
    };
    try{
      await set(ref(db, `members/${user.uid}/profile`), payload);
      alert('Profile updated');
      // award points for completing profile
      await addPoints(user.uid, 10, 'profile_update');
    }catch(e){ console.error(e); alert('Failed to save profile: ' + e.message); }
  });
  $('resetProfileFull').addEventListener('click', ()=>{
    ['pf_fullname','pf_memberid','pf_email','pf_type','pf_phone','pf_gender','pf_dob','pf_residence','pf_education','pf_employer','pf_nok_name','pf_nok_contact','pf_income_source','pf_referral','pf_admin_notes'].forEach(id=> { if($(id)) $(id).value = ''; });
  });

  // Download loan application as PDF
  $('downloadLoanAppBtn').addEventListener('click', async ()=>{
    const user = auth.currentUser; if(!user){ alert('Sign in first'); return; }
    try{
      const loanSnap = await get(child(ref(db), `members/${user.uid}/loan`));
      if(!loanSnap.exists()){ alert('No active loan found'); return; }
      const ln = loanSnap.val();
      const wrapper = document.createElement('div'); wrapper.style.padding='20px'; wrapper.style.background='#fff'; wrapper.style.width='900px'; wrapper.innerHTML = `<h2>Visionary Youth — Loan Application</h2><p>Generated: ${new Date().toLocaleString()}</p><hr/><pre style="white-space:pre-wrap">${esc(JSON.stringify(ln,null,2))}</pre>`;
      document.body.appendChild(wrapper);
      const canvas = await html2canvas(wrapper, { scale:2 }); const img = canvas.toDataURL('image/png'); const { jsPDF } = window.jspdf; const pdf = new jsPDF('p','mm','a4'); const pageWidth = pdf.internal.pageSize.getWidth(); const imgProps = pdf.getImageProperties(img); const imgWidth = pageWidth - 20; const imgHeight = (imgProps.height * imgWidth) / imgProps.width; pdf.addImage(img,'PNG',10,10,imgWidth,imgHeight); pdf.save(`loan_app_${user.uid}_${Date.now()}.pdf`); document.body.removeChild(wrapper);
    }catch(e){ console.error(e); alert('Failed to download loan PDF: ' + e.message); }
  });

  // Repayment (simple prompt) — records transaction and awards points
  $('repayBtn').addEventListener('click', async ()=>{
    const user = auth.currentUser; if(!user){ alert('Sign in first'); return; }
    const amount = prompt('Enter repayment amount (KES)', '0'); if(!amount) return; const a = Number(amount); if(isNaN(a) || a <= 0){ alert('Invalid amount'); return; }
    try{
      const txRef = ref(db, `members/${user.uid}/transactions`); const t = push(txRef);
      await set(t, { date: new Date().toISOString(), description: 'Loan repayment', debit:0, credit: a, timestamp: Date.now(), status: 'posted' });
      await addPoints(user.uid, 2, 'repayment');
      alert('Repayment recorded');
    }catch(e){ console.error(e); alert('Failed to record repayment: ' + e.message); }
  });

  // Utility: add demo transactions (for testing) — but still writes to Firebase if available
  window.seedDemo = async ()=>{
    const user = auth.currentUser; if(!user){ alert('Sign in first'); return; }
    const txRef = ref(db, `members/${user.uid}/transactions`);
    const now = Date.now();
    const sample = [ { date:new Date(now-86400000*30).toISOString(), description:'Monthly deposit', debit:0, credit:7000, balance:7000, timestamp: now-86400000*30 }, { date:new Date(now-86400000*20).toISOString(), description:'Shares purchase', debit:2000, credit:0, balance:5000, timestamp: now-86400000*20 }, { date:new Date(now-86400000*8).toISOString(), description:'Dividend payout', debit:0, credit:250, balance:5250, timestamp: now-86400000*8 } ];
    try{
      for(const s of sample){ const p = push(txRef); await set(p, s); }
      await set(ref(db, `members/${user.uid}/balances`), { monthly:5250, weekly:1200, shares:20, dividends:250, outstanding:0, unpaid:0, pinned:1000, available:5250, blocked:0 });
      alert('Demo data seeded to Firebase');
    }catch(e){ console.error(e); alert('Failed to seed demo: ' + e.message); }
  };

  // CSV / PDF helpers already wired above for exports

  // Initialize loan wizard on DOMContentLoaded
  document.addEventListener('DOMContentLoaded', ()=>{ initLoanWizard(); $('filterToggleBtn').addEventListener('click', ()=>{ const fa = $('filterArea'); fa.style.display = fa.style.display === 'none' ? 'block' : 'none'; }); $('applySettingsBtn').addEventListener('click', ()=>{ const v = Number($('set_autologout').value || 3); AUTO_LOGOUT_MIN = v || 3; alert('Settings applied — auto-logout set to ' + AUTO_LOGOUT_MIN + ' minute(s)'); }); });

  // Helper: ensure proper signout on manual window close/unload? we let Firebase handle token expiry, but also sign out on unload for security
  window.addEventListener('beforeunload', (e)=>{ /* do not force signout — keep user session */ });

  // Simple guard: ensure auth persistence — default is local
  // Note: Firebase client will maintain session across reloads; inactivity auto-logout uses our timer
</script>
</body>
</html>


