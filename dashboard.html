<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Member Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand fw-bold" href="#">My Sacco Dashboard</a>
      <button class="btn btn-danger" id="logoutBtn">Logout</button>
    </div>
  </nav>

  <!-- Dashboard Content -->
  <div class="container my-4">
    <h2 class="text-center mb-4">Welcome, <span id="userName">Member</span></h2>

    <!-- Profile Section -->
    <div class="card mb-3">
      <div class="card-header bg-info text-white">Profile</div>
      <div class="card-body">
        <form id="profileForm">
          <div class="mb-2">
            <label>Full Name</label>
            <input type="text" id="fullName" class="form-control">
          </div>
          <div class="mb-2">
            <label>Email</label>
            <input type="email" id="email" class="form-control" disabled>
          </div>
          <div class="mb-2">
            <label>Phone</label>
            <input type="text" id="phone" class="form-control">
          </div>
          <button type="submit" class="btn btn-success">Update Profile</button>
        </form>
      </div>
    </div>

    <!-- Loan Application -->
    <div class="card mb-3">
      <div class="card-header bg-warning">Loan Application</div>
      <div class="card-body">
        <form id="loanForm">
          <div class="mb-2">
            <label>Loan Amount</label>
            <input type="number" id="loanAmount" class="form-control" required>
          </div>
          <div class="mb-2">
            <label>Reason</label>
            <textarea id="loanReason" class="form-control" required></textarea>
          </div>
          <button type="submit" class="btn btn-primary">Apply</button>
        </form>
      </div>
    </div>

    <!-- Savings -->
    <div class="card mb-3">
      <div class="card-header bg-success text-white">Savings</div>
      <div class="card-body">
        <p>Total Savings: <span id="savingsTotal">0</span> KES</p>
        <button class="btn btn-outline-success" id="addSavingsBtn">Add Savings</button>
      </div>
    </div>

    <!-- Statement Download -->
    <div class="card mb-3">
      <div class="card-header bg-secondary text-white">Account Statement</div>
      <div class="card-body">
        <button class="btn btn-dark" id="downloadStatement">Download PDF</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyA_OCu7HQ5HCH2OYx5dQ2Z1r7YPwQJave4",
      authDomain: "your-project-id.firebaseapp.com",
      projectId: "your-project-id",
      storageBucket: "your-project-id.appspot.com",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:yourappid"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.firestore();

    // Protect Dashboard
    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = "index.html"; // redirect if not logged in
      } else {
        document.getElementById("userName").innerText = user.email;
        loadProfile(user.uid);
      }
    });

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", () => {
      auth.signOut().then(() => window.location.href = "index.html");
    });

    // Load Profile
    function loadProfile(uid) {
      db.collection("users").doc(uid).get().then(doc => {
        if (doc.exists) {
          let data = doc.data();
          document.getElementById("fullName").value = data.fullName || "";
          document.getElementById("email").value = data.email || "";
          document.getElementById("phone").value = data.phone || "";
          document.getElementById("savingsTotal").innerText = data.savings || 0;
        }
      });
    }

    // Update Profile
    document.getElementById("profileForm").addEventListener("submit", e => {
      e.preventDefault();
      const user = auth.currentUser;
      db.collection("users").doc(user.uid).set({
        fullName: document.getElementById("fullName").value,
        email: user.email,
        phone: document.getElementById("phone").value,
      }, { merge: true });
      alert("Profile updated!");
    });

    // Loan Application
    document.getElementById("loanForm").addEventListener("submit", e => {
      e.preventDefault();
      const user = auth.currentUser;
      db.collection("loans").add({
        uid: user.uid,
        amount: document.getElementById("loanAmount").value,
        reason: document.getElementById("loanReason").value,
        status: "Pending",
        createdAt: new Date()
      });
      alert("Loan application submitted!");
    });

    // Add Savings
    document.getElementById("addSavingsBtn").addEventListener("click", () => {
      const user = auth.currentUser;
      let newSavings = parseInt(prompt("Enter savings amount:"));
      if (!isNaN(newSavings)) {
        const userRef = db.collection("users").doc(user.uid);
        userRef.get().then(doc => {
          let current = doc.exists && doc.data().savings ? doc.data().savings : 0;
          userRef.update({ savings: current + newSavings });
          document.getElementById("savingsTotal").innerText = current + newSavings;
        });
      }
    });

    // Download Statement (Mock)
    document.getElementById("downloadStatement").addEventListener("click", () => {
      alert("Statement download coming soon (PDF export).");
    });
  </script>
</body>
</html>
