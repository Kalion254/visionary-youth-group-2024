<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Visionary Youth Group â€” NeoPortal Dashboard</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- AOS (animations) -->
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Canvas Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    :root{
      --primary:#006b3c; /* deep green */
      --accent:#00a86b;
      --bg1:#f2fff6;
      --card:#ffffff;
      --muted:#6b7280;
      --glass: rgba(255,255,255,0.6);
      --radius: 14px;
      --shadow: 0 10px 30px rgba(2,48,22,0.08);
      --glass-border: rgba(6,50,20,0.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:'Poppins',sans-serif;background:linear-gradient(135deg,var(--bg1),#e9fff0);
      color:#122; -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }

    /* Layout */
    .app {
      display:flex;min-height:100vh;gap:18px;
    }

    /* Sidebar */
    .sidebar {
      position:fixed;left:18px;top:84px;width:68px;bottom:24px;border-radius:12px;background:linear-gradient(180deg,#ffffff,#f8fff9);
      box-shadow:var(--shadow);padding:8px;display:flex;flex-direction:column;align-items:center;gap:8px;z-index:1400;
      transition:width .28s ease, padding .28s ease;
      overflow:hidden;
    }
    .sidebar.expanded{width:220px;padding:14px}
    .sidebar .brandMini{display:flex;align-items:center;gap:8px}
    .sidebar .navBtn{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid var(--glass-border);background:linear-gradient(180deg,#fff,#f6fff6)}
    .sidebar .navBtn.active{background:var(--primary);color:white;box-shadow:0 6px 18px rgba(0,106,60,0.15)}
    .sidebar .navLabel{margin-left:12px;font-weight:600;color:var(--primary);display:none}
    .sidebar.expanded .navLabel{display:inline-block}
    .toggleSide {margin-top:8px;font-size:0.9rem;cursor:pointer;color:var(--muted)}

    /* Topbar */
    .topbar{
      position:fixed;left:0;right:0;top:0;height:72px;background:linear-gradient(90deg,var(--primary),var(--accent));
      color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 20px;z-index:1200;box-shadow:0 12px 40px rgba(2,48,22,0.12);
    }
    .brand {display:flex;align-items:center;gap:12px}
    .brand h1{font-size:1.05rem;margin:0;font-weight:700}
    .user-area{display:flex;align-items:center;gap:12px}
    .avatar{width:44px;height:44px;border-radius:10px;background:#fff;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .avatar img{width:100%;height:100%;object-fit:cover}

    /* Main page grid */
    .page {
      margin:92px auto 48px;padding:18px;
      width:calc(100% - 140px);
      transition: width .28s ease;
    }
    .page-inner {max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr 380px;gap:18px;align-items:start}
    .full-width {grid-column:1/-1}

    /* Cards & look */
    .card {
      background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow);
      transition:transform .18s ease, box-shadow .18s ease;
    }
    .card:hover{transform:translateY(-6px)}
    h2{margin:0 0 10px 0;font-size:1.05rem;color:var(--primary)}
    .muted{color:var(--muted)}

    /* Hero */
    .hero{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:18px}
    .hero .left {display:flex;flex-direction:column}
    .hero .actions{display:flex;gap:8px;align-items:center}
    .btn{background:var(--primary);color:white;padding:10px 14px;border:none;border-radius:10px;cursor:pointer;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--primary);font-weight:600}
    .btn.small{padding:6px 10px;font-size:0.95rem}

    /* Balances grid */
    .balances {display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .balance {
      padding:12px;border-radius:12px;background:linear-gradient(180deg,#f7fff8,#ffffff);text-align:left;border:1px solid var(--glass-border)
    }
    .balance .label{color:var(--muted);font-size:0.95rem}
    .balance .value{font-weight:800;font-size:1.2rem;color:var(--primary);margin-top:8px}

    /* Action bar */
    .action-bar {display:flex;gap:12px;align-items:center;flex-wrap:wrap;padding:12px;border-radius:10px;background:linear-gradient(90deg,#fff,#f6fff6);border:1px solid var(--glass-border)}
    .action-stat{flex:1;min-width:140px}
    .action-stat h4{margin:0;font-size:0.92rem;color:var(--muted)}
    .action-stat p{margin:6px 0 0 0;font-weight:800;color:var(--primary)}

    /* Wizard form */
    .wizard {position:relative}
    .steps {display:flex;gap:8px;margin-bottom:12px}
    .step {flex:1;padding:8px;border-radius:8px;background:#f5fff8;text-align:center;font-weight:700;color:var(--muted);font-size:0.9rem}
    .step.active{background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff}
    .wizard-step {display:none;animation:fadeIn .36s ease}
    .wizard-step.active{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

    /* Table */
    .table {width:100%;border-collapse:collapse;margin-top:8px}
    .table th, .table td {padding:10px;border-bottom:1px solid #eef7f0;text-align:left;font-size:0.95rem}
    .table th {color:var(--muted);font-weight:700}

    /* Downloads list */
    .downloads {display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
    .download-card {padding:12px;border-radius:10px;border:1px solid var(--glass-border);display:flex;flex-direction:column;gap:8px;align-items:flex-start}

    /* Notifications */
    .notif-list {max-height:260px;overflow:auto;padding-right:6px}
    .notif-item{padding:10px;border-radius:8px;border:1px solid #ecf8ef;margin-bottom:8px;background:linear-gradient(180deg,#fff,#fbfff8)}

    /* small screens */
    @media (max-width:1100px){
      .sidebar{display:none}
      .page {width:100%}
      .page-inner{grid-template-columns:1fr}
    }
    @media (max-width:520px){
      .balances{grid-template-columns:repeat(1,1fr)}
      .hero{flex-direction:column;align-items:flex-start}
      h2{font-size:1rem}
    }

    /* utility */
    .right{margin-left:auto}
    .muted-small{color:var(--muted);font-size:0.9rem}
    .progress {height:8px;background:#f1fff5;border-radius:8px;overflow:hidden}
    .progress > div{height:100%;background:linear-gradient(90deg,var(--primary),var(--accent));width:0;transition:width .6s ease}
    .toast {position:fixed;right:18px;bottom:18px;background:var(--primary);color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:2200;box-shadow:0 6px 18px rgba(0,0,0,0.18)}
    .small-muted{font-size:0.85rem;color:var(--muted)}
    .countdown{font-weight:800;color:var(--primary)}
    .chip{background:#f0fff4;padding:6px 8px;border-radius:8px;font-weight:700;color:var(--primary)}
    .dark-toggle{cursor:pointer;border-radius:8px;padding:6px 8px;border:1px solid rgba(255,255,255,0.12)}
  </style>
</head>
<body>

  <!-- TOPBAR -->
  <div class="topbar" data-aos="fade-down">
    <div class="brand" style="gap:10px">
      <i class="fas fa-seedling" style="font-size:1.25rem;color:#ffcc00"></i>
      <div>
        <h1>Visionary Youth Group</h1>
        <div class="small-muted">Member portal â€” SEKU NeoPortal</div>
      </div>
    </div>

    <div class="user-area">
      <div style="display:flex;gap:8px;align-items:center">
        <div id="agmtimer" class="small-muted" style="margin-right:12px">AGM: <span class="countdown" id="agmCountdown">â€”</span></div>
        <div class="dark-toggle" id="darkToggle" title="Toggle dark mode"><i class="fas fa-moon"></i></div>
      </div>

      <div style="display:flex;align-items:center;gap:12px;margin-left:12px">
        <button class="btn ghost small" id="notifOpenBtn"><i class="fas fa-bell"></i> <span id="notifCount" style="margin-left:8px">0</span></button>
        <button class="btn ghost small" id="downloadCenterBtn"><i class="fas fa-download"></i> Downloads</button>
        <div class="avatar" id="topAvatar"><i class="fas fa-user" style="color:var(--primary)"></i></div>
      </div>
    </div>
  </div>

  <div style="height:72px"></div>

  <div class="app">
    <!-- SIDEBAR (collapsible) -->
    <aside class="sidebar expanded" id="sidebar" data-aos="fade-right">
      <div class="brandMini">
        <i class="fas fa-seedling" style="color:#ffcc00;font-size:1.15rem"></i>
        <div style="display:flex;flex-direction:column">
          <span style="font-weight:800;color:var(--primary);font-size:0.95rem">VYG</span>
          <small class="muted">Member</small>
        </div>
      </div>

      <div style="margin-top:8px;width:100%;display:flex;flex-direction:column;gap:6px">
        <div class="navBtn active" data-target="overview" title="Overview"><i class="fas fa-home"></i><span class="navLabel"> Overview</span></div>
        <div class="navBtn" data-target="balancesCard" title="Balances"><i class="fas fa-wallet"></i><span class="navLabel"> Balances</span></div>
        <div class="navBtn" data-target="loan-section" title="Loan"><i class="fas fa-file-signature"></i><span class="navLabel"> Loans</span></div>
        <div class="navBtn" data-target="withdraw-section" title="Withdraw"><i class="fas fa-hand-holding-usd"></i><span class="navLabel"> Withdraw</span></div>
        <div class="navBtn" data-target="downloadsSection" title="Downloads"><i class="fas fa-download"></i><span class="navLabel"> Downloads</span></div>
        <div class="navBtn" data-target="profile-area" title="Profile"><i class="fas fa-user-edit"></i><span class="navLabel"> Profile</span></div>
      </div>

      <div style="margin-top:auto;text-align:center">
        <div class="toggleSide" id="toggleSidebarBtn"><i class="fas fa-chevron-left"></i> Collapse</div>
      </div>
    </aside>

    <!-- MAIN PAGE -->
    <main class="page" id="pageRoot">
      <div class="page-inner">

        <!-- LEFT Column -->
        <div>

          <!-- HERO + summary -->
          <div class="card hero" data-aos="fade-up" id="overview">
            <div class="left">
              <div style="display:flex;gap:12px;align-items:center">
                <div style="font-size:1.1rem;font-weight:800" id="welcomeName">Welcome, Member</div>
                <div class="chip" id="memberStatus">Active</div>
              </div>
              <div class="muted-small" style="margin-top:6px">Snapshot â€¢ All amounts in <strong>Ksh</strong></div>
              <div style="margin-top:8px;font-size:0.95rem">Points: <strong id="pointsDisplay">0</strong> â€¢ <span class="muted-small" id="memberSince">Joined: â€”</span></div>
            </div>

            <div class="actions right">
              <button class="btn" id="quickApply"><i class="fas fa-file-signature"></i>&nbsp;Apply Loan</button>
              <button class="btn ghost" id="quickStatement"><i class="fas fa-file-pdf"></i>&nbsp;Statement</button>
            </div>
          </div>

          <!-- Balances -->
          <div class="card" id="balancesCard" data-aos="fade-up">
            <h2>Balances & Accounts</h2>
            <div class="balances" style="margin-top:12px">
              <div class="balance">
                <div class="label">Monthly Savings</div>
                <div class="value" id="monthlyVal">Ksh 0</div>
              </div>
              <div class="balance">
                <div class="label">Weekly Savings</div>
                <div class="value" id="weeklyVal">Ksh 0</div>
              </div>
              <div class="balance">
                <div class="label">Shares</div>
                <div class="value" id="sharesVal">Ksh 0</div>
              </div>
              <div class="balance">
                <div class="label">Dividends</div>
                <div class="value" id="dividendsVal">Ksh 0</div>
              </div>
              <div class="balance">
                <div class="label">Total Loans</div>
                <div class="value" id="totalLoansVal">Ksh 0</div>
              </div>
              <div class="balance">
                <div class="label">Outstanding</div>
                <div class="value" id="outstandingLoansVal">Ksh 0</div>
              </div>
            </div>

            <!-- mini charts -->
            <div style="display:flex;gap:12px;margin-top:14px;align-items:center;flex-wrap:wrap">
              <div style="flex:1;min-width:220px" class="card" data-aos="fade-left">
                <div style="display:flex;align-items:center;gap:8px">
                  <div style="font-weight:700">Share growth</div>
                  <div class="muted-small right">Last 6 months</div>
                </div>
                <canvas id="sharesChart" style="height:110px;margin-top:8px"></canvas>
              </div>

              <div style="min-width:220px;flex:0 0 260px" class="card" data-aos="fade-left">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div><strong>Points & Activity</strong><div class="muted-small">Earned for actions</div></div>
                  <div class="chip" id="pointsChip">0 pts</div>
                </div>
                <div style="margin-top:10px">
                  <div class="progress"><div id="pointsProgress" style="width:0%"></div></div>
                  <div class="muted-small" style="margin-top:6px">Next reward at 100 pts</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Action bar -->
          <div class="card action-bar" data-aos="fade-up">
            <div class="action-stat">
              <h4>Next Installment</h4>
              <p id="nextInstallment">Ksh 0 â€¢ <span class="muted-small" id="nextInstallmentDate">â€”</span></p>
            </div>
            <div class="action-stat">
              <h4>Loan Stage</h4>
              <p id="loanStage">â€”</p>
            </div>
            <div class="action-stat">
              <h4>Interest Rate</h4>
              <p id="loanInterest">â€”</p>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="btn small" id="makePaymentBtn"><i class="fas fa-money-bill-wave"></i>&nbsp;Pay (M-Pesa)</button>
              <button class="btn ghost small" id="openLoanWizard">Manage Loan</button>
            </div>
          </div>

          <!-- Recent activities -->
          <div class="card" data-aos="fade-up">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <h2>Recent Activities</h2>
              <select id="activityFilter" class="muted-small">
                <option value="all">All</option>
                <option value="loan">Loans</option>
                <option value="share">Shares</option>
                <option value="deposit">Deposits</option>
                <option value="withdrawal">Withdrawals</option>
              </select>
            </div>
            <ul id="activity-timeline" style="margin-top:12px" class="muted-small"></ul>
          </div>

          <!-- Transaction history -->
          <div class="card" data-aos="fade-up">
            <h2>Transaction History</h2>
            <div style="overflow:auto;margin-top:8px">
              <table class="table" id="transactionsTable">
                <thead>
                  <tr><th>Date</th><th>Description</th><th>Debit</th><th>Credit</th><th>Balance</th></tr>
                </thead>
                <tbody id="transactionsBody">
                  <tr><td colspan="5" class="muted">Loading transactionsâ€¦</td></tr>
                </tbody>
              </table>
            </div>
            <div style="margin-top:10px;display:flex;gap:8px">
              <button class="btn ghost small" id="exportTransactionsPdf">Download PDF</button>
              <button class="btn small" id="refreshTx">Refresh</button>
            </div>
          </div>

          <!-- LOAN WIZARD (hidden default) -->
          <div class="card wizard" id="loanWizardCard" style="display:none" data-aos="fade-up">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <h2>Loan Application â€” Wizard</h2>
              <button class="btn ghost small" id="closeWizard">Close</button>
            </div>

            <div class="steps" id="loanWizardSteps">
              <div class="step active" data-step="1">1. Applicant</div>
              <div class="step" data-step="2">2. Employment</div>
              <div class="step" data-step="3">3. Loan</div>
              <div class="step" data-step="4">4. Guarantors</div>
              <div class="step" data-step="5">5. Confirm</div>
            </div>

            <form id="loanWizardForm">
              <div class="wizard-step active" data-step="1">
                <h3>Applicant Information</h3>
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
                  <input name="selfHelpGroup" placeholder="Self-help group" required>
                  <input name="memberName" placeholder="Full name" required>
                  <input name="membershipNumber" placeholder="Membership No" required>
                  <input name="nationalId" placeholder="National ID / Passport" required>
                  <input name="dob" type="date" placeholder="Date of birth">
                  <input name="phone" placeholder="Phone" required>
                  <input name="email" type="email" placeholder="Email">
                </div>
                <div style="margin-top:10px;display:flex;gap:8px">
                  <button type="button" class="btn ghost" data-action="next">Next</button>
                </div>
              </div>

              <div class="wizard-step" data-step="2">
                <h3>Employment & Income</h3>
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
                  <input name="employer" placeholder="Employer / Business">
                  <input name="position" placeholder="Position">
                  <input name="periodEmployment" placeholder="Period in current employment">
                  <input name="monthlyIncome" placeholder="Monthly income (Ksh)" required>
                  <input name="income1" placeholder="Other income 1 (Ksh)">
                  <input name="income2" placeholder="Other income 2 (Ksh)">
                </div>
                <div style="margin-top:10px;display:flex;gap:8px">
                  <button type="button" class="btn ghost" data-action="prev">Prev</button>
                  <button type="button" class="btn" data-action="next">Next</button>
                </div>
              </div>

              <div class="wizard-step" data-step="3">
                <h3>Loan Details</h3>
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
                  <input name="amountFigures" placeholder="Amount (Ksh)" required>
                  <input name="amountWords" placeholder="Amount in words" required>
                  <input name="purpose" placeholder="Purpose" required>
                  <input name="repayableMonths" placeholder="Repayable (months)" required>
                </div>
                <div style="margin-top:10px;display:flex;gap:8px">
                  <button type="button" class="btn ghost" data-action="prev">Prev</button>
                  <button type="button" class="btn" data-action="next">Next</button>
                </div>
              </div>

              <div class="wizard-step" data-step="4">
                <h3>Guarantors (up to 3)</h3>
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
                  <input name="g_mno_1" placeholder="G1 MNo">
                  <input name="g_name_1" placeholder="G1 Name">
                  <input name="g_phone_1" placeholder="G1 Phone">
                  <input name="g_amount_1" placeholder="G1 Amount Ksh">
                  <input name="g_mno_2" placeholder="G2 MNo">
                  <input name="g_name_2" placeholder="G2 Name">
                  <input name="g_phone_2" placeholder="G2 Phone">
                  <input name="g_amount_2" placeholder="G2 Amount Ksh">
                  <input name="g_mno_3" placeholder="G3 MNo">
                  <input name="g_name_3" placeholder="G3 Name">
                  <input name="g_phone_3" placeholder="G3 Phone">
                  <input name="g_amount_3" placeholder="G3 Amount Ksh">
                </div>
                <div style="margin-top:10px;display:flex;gap:8px">
                  <button type="button" class="btn ghost" data-action="prev">Prev</button>
                  <button type="button" class="btn" data-action="next">Next</button>
                </div>
              </div>

              <div class="wizard-step" data-step="5">
                <h3>Confirm & Submit</h3>
                <div class="muted-small">Review the data then submit. A PDF will be generated and the application saved to RTDB.</div>

                <div style="margin-top:12px;display:flex;gap:8px">
                  <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="wizardAgree" required> I agree to the terms</label>
                  <div style="margin-left:auto;display:flex;gap:8px">
                    <button type="button" class="btn ghost" data-action="prev">Prev</button>
                    <button type="submit" class="btn" id="wizardSubmit">Submit Application</button>
                  </div>
                </div>
              </div>
            </form>
          </div>

        </div> <!-- left column -->

        <!-- RIGHT Column -->
        <aside>

          <!-- Notifications -->
          <div class="card" data-aos="fade-left">
            <h2>ðŸ”” Notifications</h2>
            <div class="notif-list" id="notificationsList">
              <div class="notif-item">Loading notificationsâ€¦</div>
            </div>
          </div>

          <!-- Downloads -->
          <div class="card" id="downloadsSection" data-aos="fade-left">
            <h2>Downloads</h2>
            <div style="display:flex;gap:8px;margin-bottom:10px">
              <button class="btn ghost small" id="uploadPdfBtn"><i class="fas fa-upload"></i> Upload</button>
              <button class="btn small" id="refreshDownloads">Refresh</button>
            </div>
            <div class="downloads" id="downloadsList">
              <div class="muted">Loading filesâ€¦</div>
            </div>
          </div>

          <!-- Withdraw & Quick pay -->
          <div class="card" data-aos="fade-left">
            <h2>Quick Actions</h2>
            <div style="display:flex;flex-direction:column;gap:8px">
              <button class="btn" id="openWithdrawWizard"><i class="fas fa-hand-holding-usd"></i>&nbsp;Withdraw</button>
              <button class="btn ghost" id="openShareBuy"><i class="fas fa-coins"></i>&nbsp;Buy Shares</button>
              <button class="btn ghost" id="openReferral"><i class="fas fa-user-friends"></i>&nbsp;Refer a Friend</button>
            </div>
          </div>

          <!-- Profile -->
          <div class="card" id="profile-area" data-aos="fade-left">
            <h2><i class="fas fa-user-edit"></i> Profile</h2>
            <div style="display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px">
              <input id="profile_fullName" placeholder="Full name">
              <input id="profile_phone" placeholder="Phone">
              <input id="profile_id" placeholder="ID Number">
              <input id="profile_yearJoined" placeholder="Year Joined (e.g. 2021)">
              <input id="profile_dob" type="date" placeholder="Date of Birth">
            </div>
            <div style="display:flex;gap:8px;margin-top:10px">
              <input type="file" id="photoUploadInput" accept="image/*" style="display:none">
              <button class="btn ghost" id="choosePhotoBtn"><i class="fas fa-camera"></i>&nbsp;Upload Photo</button>
              <button class="btn" id="saveProfile">Save Profile</button>
            </div>
            <div class="muted-small" style="margin-top:8px">Profile saved to RTDB and photo to Storage.</div>
          </div>

        </aside>

      </div> <!-- page-inner -->
    </main>
  </div>

  <!-- Hidden forms (withdraw wizard / others) -->
  <div id="withdrawModal" style="display:none">
    <!-- We'll show a wizard similar to loan wizard via JS -->
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Firebase & App logic -->
  <script type="module">
    // Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getDatabase, ref, onValue, get, push, set, update, child, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL, listAll } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    // jsPDF
    const { jsPDF } = window.jspdf;

    // Initialize Firebase (your config supplied earlier)
    const firebaseConfig = {
      apiKey: "AIzaSyA_OCu7HQ5HCH2OYx5dQ2Z1r7YPwQJave4",
      authDomain: "visionary-youth-grou-2024.firebaseapp.com",
      databaseURL: "https://visionary-youth-grou-2024-default-rtdb.firebaseio.com",
      projectId: "visionary-youth-grou-2024",
      storageBucket: "visionary-youth-grou-2024.appspot.com",
      messagingSenderId: "372978592717",
      appId: "1:372978592717:web:1c15aec728ee5f854f3284"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // UI refs
    const toastEl = document.getElementById('toast');
    function showToast(msg, time=3500){
      toastEl.textContent = msg; toastEl.style.display='block';
      setTimeout(()=> toastEl.style.display='none', time);
    }

    // Short helpers
    function formatKsh(n){
      const num = Number(n||0);
      return 'Ksh ' + num.toLocaleString('en-KE');
    }
    function el(sel){ return document.querySelector(sel); }
    function qAll(sel){ return Array.from(document.querySelectorAll(sel)); }

    // AOS init
    import('https://unpkg.com/aos@2.3.1/dist/aos.js').then(mod => { AOS.init({ duration:700, once:true }); }).catch(()=>{});

    // State
    let currentUid = null;
    let profileLoaded = false;

    // Small confetti wrapper
    function celebrate(){
      confetti({particleCount:60,spread:70,origin:{y:0.6}});
    }

    // Chart placeholders
    let sharesChart;
    function initCharts(){
      const ctx = document.getElementById('sharesChart').getContext('2d');
      sharesChart = new Chart(ctx, {
        type:'line',
        data:{
          labels:['Jan','Feb','Mar','Apr','May','Jun'],
          datasets:[{label:'Shares',data:[0,0,0,0,0,0],tension:0.4,fill:true}]
        },
        options:{responsive:true,plugins:{legend:{display:false}}}
      });
    }

    // Build transaction row
    function txRow(tx){
      const tr = document.createElement('tr');
      const d = new Date(tx.ts||Date.now());
      tr.innerHTML = `<td>${d.toLocaleString()}</td><td>${tx.desc || ''}</td><td>${tx.debit?formatKsh(tx.debit):'-'}</td><td>${tx.credit?formatKsh(tx.credit):'-'}</td><td>${formatKsh(tx.balance||0)}</td>`;
      return tr;
    }

    // Listen auth
    onAuthStateChanged(auth, async user => {
      if(!user){
        // For testing you may comment this redirect
        // location.href='index.html';
        // We'll keep using a demo mode if not logged in
        console.warn('Not authenticated â€” demo mode.');
        // For demo, set a demo uid
        // return;
      } else {
        currentUid = user.uid;
      }

      // For both demo and real, try to read profile if currentUid available
      if(currentUid){
        // profile listener
        onValue(ref(db, `members/${currentUid}/profile`), snap=>{
          if(!snap.exists()) return;
          const p = snap.val();
          if(p.name) document.getElementById('welcomeName').textContent = p.name;
          if(p.name) document.getElementById('profile_fullName').value = p.name;
          if(p.phone) document.getElementById('profile_phone').value = p.phone;
          if(p.id) document.getElementById('profile_id').value = p.id;
          if(p.yearJoined) document.getElementById('profile_yearJoined').value = p.yearJoined;
          if(p.dob) document.getElementById('profile_dob').value = p.dob;
          if(p.status) document.getElementById('memberStatus').textContent = p.status;
          if(p.joinedAt) document.getElementById('memberSince').textContent = `Joined: ${new Date(p.joinedAt).getFullYear()}`;
          profileLoaded = true;
        });

        // photo
        onValue(ref(db, `members/${currentUid}/photoURL`), snap=>{
          if(snap.exists()){
            const url = snap.val();
            const a = document.getElementById('topAvatar');
            a.innerHTML = `<img src="${url}" alt="avatar">`;
          }
        });

        // points
        onValue(ref(db, `members/${currentUid}/points`), snap=>{
          const p = snap.exists() ? Number(snap.val()||0) : 0;
          document.getElementById('pointsDisplay').textContent = p;
          document.getElementById('pointsChip').textContent = `${p} pts`;
          const pc = Math.min(100, Math.round((p/100)*100));
          document.getElementById('pointsProgress').style.width = pc+'%';
        });

        // balances
        onValue(ref(db, `members/${currentUid}/savings/monthly`), snap=>{
          const v = snap.exists() ? (typeof snap.val() === 'number' ? snap.val() : computeAmountFromSnap(snap.val())) : 0;
          document.getElementById('monthlyVal').textContent = formatKsh(v);
        });
        onValue(ref(db, `members/${currentUid}/savings/weekly`), snap=>{
          const v = snap.exists() ? (typeof snap.val() === 'number' ? snap.val() : computeAmountFromSnap(snap.val())) : 0;
          document.getElementById('weeklyVal').textContent = formatKsh(v);
        });
        onValue(ref(db, `members/${currentUid}/shares/total`), snap=>{
          const v = snap.exists()? Number(snap.val()||0) : 0;
          document.getElementById('sharesVal').textContent = formatKsh(v);
        });
        onValue(ref(db, `members/${currentUid}/shares/dividends`), snap=>{
          const v = snap.exists()? Number(snap.val()||0) : 0;
          document.getElementById('dividendsVal').textContent = formatKsh(v);
        });

        // loans summary
        onValue(ref(db, `members/${currentUid}/loans/summary`), snap=>{
          const s = snap.exists()? snap.val() : {};
          document.getElementById('totalLoansVal').textContent = formatKsh(s.total||0);
          document.getElementById('outstandingLoansVal').textContent = formatKsh(s.outstanding||0);
          document.getElementById('loanStage').textContent = s.stage || 'â€”';
          document.getElementById('loanInterest').textContent = s.interest ? (s.interest + '%') : 'â€”';
          document.getElementById('nextInstallment').textContent = formatKsh(s.nextInstallment || 0);
          document.getElementById('nextInstallmentDate').textContent = s.nextDue ? new Date(s.nextDue).toLocaleDateString() : 'â€”';
        });

        // notifications (rt DB)
        onValue(ref(db, `notifications`), snap=>{
          const list = document.getElementById('notificationsList');
          list.innerHTML = '';
          if(!snap.exists()){
            list.innerHTML = '<div class="notif-item">No notifications</div>';
            document.getElementById('notifCount').textContent = '0';
            return;
          }
          const obj = snap.val();
          const entries = Object.entries(obj).sort((a,b)=> (b[1].ts||0)-(a[1].ts||0));
          document.getElementById('notifCount').textContent = entries.length;
          entries.slice(0,10).forEach(([k,n])=>{
            const div = document.createElement('div'); div.className='notif-item';
            div.innerHTML = `<strong style="color:var(--primary)">${n.title||'Update'}</strong><div class="muted-small">${n.message||''}</div><small class="muted-small">${new Date(n.ts||Date.now()).toLocaleString()}</small>`;
            list.appendChild(div);
          });
        });

        // activity log (recent)
        onValue(ref(db, `members/${currentUid}/activityLog`), snap=>{
          const el = document.getElementById('activity-timeline');
          el.innerHTML = '';
          if(!snap.exists()){ el.innerHTML = '<li class="muted-small">No recent activity</li>'; return; }
          const arr = Object.values(snap.val()).sort((a,b)=> (b.ts||0)-(a.ts||0)).slice(0,20);
          arr.forEach(it=>{
            const li = document.createElement('li');
            li.className='muted-small';
            li.innerHTML = `<strong>${it.text}</strong> â€¢ <small class="muted-small">${new Date(it.ts||Date.now()).toLocaleString()}</small>`;
            el.appendChild(li);
          });
        });

        // transactions (listen to last 50)
        const txRef = ref(db, `members/${currentUid}/transactions`);
        onValue(txRef, snap=>{
          const tbody = document.getElementById('transactionsBody');
          tbody.innerHTML = '';
          if(!snap.exists()){
            tbody.innerHTML = '<tr><td colspan="5" class="muted">No transactions yet</td></tr>'; return;
          }
          const txs = Object.values(snap.val()).sort((a,b)=> (b.ts||0)-(a.ts||0));
          txs.slice(0,100).forEach(tx=>{
            tbody.appendChild(txRow(tx));
          });
        });

        // downloads: read storage root "members/{uid}/files" or RTDB index
        async function refreshDownloads(){
          const listEl = document.getElementById('downloadsList');
          listEl.innerHTML = '<div class="muted">Loading filesâ€¦</div>';
          try{
            // prefer RTDB index if present
            const idxSnap = await get(ref(db, `members/${currentUid}/uploads`));
            listEl.innerHTML = '';
            if(idxSnap.exists()){
              const files = idxSnap.val();
              Object.entries(files).reverse().forEach(([k,f])=>{
                const card = document.createElement('div');
                card.className='download-card';
                card.innerHTML = `<strong>${f.name||k}</strong><div class="muted-small">${new Date(f.ts||Date.now()).toLocaleDateString()}</div><div style="margin-top:auto;display:flex;gap:8px"><button class="btn ghost small" data-url="${f.url||''}" onclick="(e=>window.open(e.target.dataset.url,'_blank'))(event)">Open</button><button class="btn small" onclick="(e=>downloadByUrl(e))(event)" data-url="${f.url||''}">Download</button></div>`;
                listEl.appendChild(card);
              });
            } else {
              // fallback to listing storage path
              const folder = `members/${currentUid}/uploads`;
              const storageRef = sRef(storage, folder);
              const res = await listAll(storageRef);
              listEl.innerHTML = '';
              if(res.items.length===0){ listEl.innerHTML='<div class="muted">No files uploaded</div>'; return; }
              for(const itemRef of res.items.slice().reverse()){
                const url = await getDownloadURL(itemRef);
                const name = itemRef.name;
                const card = document.createElement('div');
                card.className='download-card';
                card.innerHTML = `<strong>${name}</strong><div class="muted-small">Uploaded file</div><div style="margin-top:auto;display:flex;gap:8px"><button class="btn ghost small" onclick="(e=>window.open('${url}','_blank'))(event)">Open</button><button class="btn small" onclick="(e=>downloadByUrl(e))(event)" data-url="${url}">Download</button></div>`;
                listEl.appendChild(card);
              }
            }
          }catch(err){
            listEl.innerHTML = '<div class="muted">Failed to load files</div>'; console.error(err);
          }
        }

        // expose helper for inline handlers
        window.downloadByUrl = function(e){
          const url = e.target.dataset.url;
          if(!url) return alert('No file URL');
          // open in new tab - browser will handle download for PDFs
          window.open(url,'_blank');
          celebrate();
        };

        // attach refresh downloads to button
        document.getElementById('refreshDownloads').addEventListener('click', refreshDownloads);
        refreshDownloads();

        // set up charts initial
        initCharts();

        // populate shares chart from RTDB monthly history if available
        onValue(ref(db, `members/${currentUid}/analytics/sharesHistory`), snap=>{
          if(!snap.exists()) return;
          const data = snap.val(); // expect array or key->value
          const labels = []; const vals = [];
          Object.entries(data).sort((a,b)=> a[0].localeCompare(b[0])).forEach(([k,v])=>{ labels.push(k); vals.push(Number(v||0)); });
          if(sharesChart){
            sharesChart.data.labels = labels;
            sharesChart.data.datasets[0].data = vals;
            sharesChart.update();
          }
        });

      } // end if currentUid
    }); // end onAuthStateChanged

    // ----------------- WIZARD LOGIC -----------------
    (function wizard(){
      const wizardCard = document.getElementById('loanWizardCard');
      const openBtn = document.getElementById('openLoanWizard');
      const closeBtn = document.getElementById('closeWizard');
      const steps = Array.from(document.querySelectorAll('#loanWizardSteps .step'));
      const stepPanels = Array.from(document.querySelectorAll('.wizard-step'));
      let current = 0; // index

      function goTo(idx){
        if(idx<0||idx>=stepPanels.length) return;
        current = idx;
        steps.forEach(s=> s.classList.remove('active'));
        const activeStep = steps[idx];
        if(activeStep) activeStep.classList.add('active');
        stepPanels.forEach(p=> p.classList.remove('active'));
        const panel = stepPanels[idx];
        if(panel) panel.classList.add('active');
        window.scrollTo({top:0,behavior:'smooth'});
      }

      openBtn && openBtn.addEventListener('click', ()=>{ wizardCard.style.display='block'; wizardCard.scrollIntoView({behavior:'smooth'}); goTo(0); });
      closeBtn && closeBtn.addEventListener('click', ()=> wizardCard.style.display='none');
      // step nav
      wizardCard.addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-action]');
        if(!btn) return;
        const action = btn.dataset.action;
        if(action==='next'){ goTo(Math.min(stepPanels.length-1, current+1)); }
        if(action==='prev'){ goTo(Math.max(0, current-1)); }
      });

      // form submit
      const form = document.getElementById('loanWizardForm');
      form && form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        if(!currentUid) return alert('Not authenticated');
        const agreed = document.getElementById('wizardAgree');
        if(!agreed || !agreed.checked) return alert('Please agree to terms');

        const data = Object.fromEntries(new FormData(form).entries());
        // collect guarantors
        const guarantors = [];
        for(let i=1;i<=3;i++){
          guarantors.push({ mno: data[`g_mno_${i}`]||'', name: data[`g_name_${i}`]||'', phone: data[`g_phone_${i}`]||'', amount: data[`g_amount_${i}`]||'' });
        }
        data.guarantors = guarantors;
        data.appliedAt = Date.now();
        data.status = 'Pending';

        try{
          const appRef = push(ref(db, `members/${currentUid}/loans/applications`));
          await set(appRef, data);
          // update summary rollup (increment total)
          const summaryRef = ref(db, `members/${currentUid}/loans/summary`);
          const ssnap = await get(summaryRef);
          const s = ssnap.exists()? ssnap.val() : { total:0, outstanding:0 };
          s.total = Number(s.total||0) + Number(data.amountFigures||0);
          s.outstanding = Number(s.outstanding||0) + Number(data.amountFigures||0);
          await set(summaryRef, s);

          // add to activity
          const actRef = push(ref(db, `members/${currentUid}/activityLog`));
          await set(actRef, { text: `Submitted loan for ${data.amountFigures}`, ts: Date.now() });

          // PDF generation
          const doc = buildLoanPdfDoc(data, {id: appRef.key});
          doc.save(`Loan_${(data.memberName||'member').replace(/\s+/g,'_')}_${appRef.key}.pdf`);

          showToast('Loan submitted and saved');
          celebrate();
          // reset wizard
          form.reset();
          document.getElementById('loanWizardCard').style.display='none';
        }catch(err){
          console.error(err); alert('Failed to submit application');
        }
      });

      // helper: PDF builder reused
      function buildLoanPdfDoc(data, opts={}){
        const doc = new jsPDF({unit:'pt',format:'a4'});
        let y=40,left=36;
        doc.setFillColor(6,100,60); doc.rect(0,0,595,56,'F');
        doc.setTextColor(255,255,255); doc.setFontSize(14); doc.text('VISIONARY YOUTH GROUP',300,36,{align:'center'});
        doc.setTextColor(0,0,0); y=80;
        doc.setFontSize(12); doc.setFont('helvetica','bold'); doc.text('LOAN APPLICATION',left,y); y+=14;
        doc.setFont('helvetica','normal'); const info = [
          `Name: ${data.memberName||''}`, `Membership No: ${data.membershipNumber||''}`, `Amount: Ksh ${data.amountFigures||''}`, `Purpose: ${data.purpose||''}`, `Applied: ${new Date(data.appliedAt||Date.now()).toLocaleString()}`
        ];
        info.forEach(line => { const wrap = doc.splitTextToSize(line,520); doc.text(wrap,left,y); y+=wrap.length*12; });
        return doc;
      }

    })();

    // ----------------- Download / Upload file handlers -----------------
    (function downloads(){
      const uploadBtn = document.getElementById('uploadPdfBtn');
      uploadBtn && uploadBtn.addEventListener('click', ()=> {
        // open a file picker
        const inp = document.createElement('input'); inp.type='file'; inp.accept='application/pdf,image/*';
        inp.onchange = async (ev)=>{
          const file = ev.target.files[0];
          if(!file) return;
          if(!currentUid) return alert('Please sign in');
          try{
            const path = `members/${currentUid}/uploads/${Date.now()}_${file.name}`;
            const sref = sRef(storage, path);
            await uploadBytes(sref, file);
            const url = await getDownloadURL(sref);
            // record in RTDB index
            const recRef = push(ref(db, `members/${currentUid}/uploadsIndex`));
            await set(recRef, { name: file.name, url, ts: Date.now() });
            showToast('Upload complete');
            celebrate();
            // refresh
            document.getElementById('refreshDownloads').click();
          }catch(err){
            console.error(err); alert('Upload failed');
          }
        };
        inp.click();
      });

      // wire refresh on load
      document.getElementById('refreshDownloads').addEventListener('click', async ()=>{
        // call the refresh function inside auth listener with currentUid
        // fallback: call an ad-hoc function that reads RTDB or Storage
        if(!currentUid) return;
        const listEl = document.getElementById('downloadsList');
        listEl.innerHTML = 'Loadingâ€¦';
        try{
          const idx = await get(ref(db, `members/${currentUid}/uploadsIndex`));
          listEl.innerHTML='';
          if(idx.exists()){
            const arr = Object.entries(idx.val()).reverse();
            arr.forEach(([k,v])=>{
              const card = document.createElement('div'); card.className='download-card';
              card.innerHTML = `<strong>${v.name||k}</strong><div class="muted-small">${new Date(v.ts||Date.now()).toLocaleString()}</div><div style="margin-top:auto;display:flex;gap:8px"><button class="btn ghost small" onclick="window.open('${v.url}','_blank')">Open</button><button class="btn small" onclick="window.open('${v.url}','_blank')">Download</button></div>`;
              listEl.appendChild(card);
            });
          } else {
            listEl.innerHTML = '<div class="muted">No uploads found</div>';
          }
        }catch(err){ console.error(err); listEl.innerHTML='<div class="muted">Failed to load</div>'; }
      });

    })();

    // ----------------- M-Pesa STK push button -----------------
    (function mpesa(){
      const payBtn = document.getElementById('makePaymentBtn');
      payBtn && payBtn.addEventListener('click', async ()=>{
        // ask amount & phone
        const amount = prompt('Enter amount (Ksh):', '100');
        if(!amount || isNaN(Number(amount))) return alert('Invalid amount');
        const phone = prompt('Enter phone number (2547xxxxxxxx):', '');
        if(!phone) return alert('Phone required');

        try{
          showToast('Initiating M-Pesa STK push...');
          // POST request to your backend which performs the Lipa na M-Pesa STK
          // Replace endpoint with your real backend
          const res = await fetch('/mpesa/stk/push', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ amount: Number(amount), phone, uid: currentUid || 'demo' })
          });
          if(!res.ok) throw new Error('STK push failed');
          const data = await res.json();
          showToast('STK push requested â€” check phone');
          // record tentative tx in RTDB
          if(currentUid) {
            const txRef = push(ref(db, `members/${currentUid}/transactions`));
            await set(txRef, { ts: Date.now(), desc: `STK Push: ${amount}`, debit:0, credit: Number(amount), balance:0 });
          }
        }catch(err){
          console.error(err); alert('M-Pesa initiation failed: ' + (err.message||err));
        }
      });
    })();

    // ----------------- Profile save & photo upload -----------------
    document.getElementById('choosePhotoBtn').addEventListener('click', ()=> document.getElementById('photoUploadInput').click());
    document.getElementById('photoUploadInput').addEventListener('change', async (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      if(!currentUid) return alert('Not signed in');
      try{
        const path = `members/${currentUid}/photo_${Date.now()}`;
        const sref = sRef(storage, path);
        await uploadBytes(sref, file);
        const url = await getDownloadURL(sref);
        await set(ref(db, `members/${currentUid}/photoURL`), url);
        showToast('Photo uploaded');
        celebrate();
      }catch(err){ console.error(err); alert('Photo upload failed'); }
    });

    document.getElementById('saveProfile').addEventListener('click', async ()=>{
      if(!currentUid) return alert('Sign in first');
      const payload = {
        name: document.getElementById('profile_fullName').value,
        phone: document.getElementById('profile_phone').value,
        id: document.getElementById('profile_id').value,
        yearJoined: document.getElementById('profile_yearJoined').value,
        dob: document.getElementById('profile_dob').value,
        status: 'Active',
        joinedAt: Date.now()
      };
      try{
        await set(ref(db, `members/${currentUid}/profile`), payload);
        showToast('Profile saved');
        celebrate();
      }catch(err){ console.error(err); alert('Failed to save profile'); }
    });

    // ----------------- Transactions export (PDF) -----------------
    document.getElementById('exportTransactionsPdf').addEventListener('click', async ()=>{
      if(!currentUid) return alert('Please sign in');
      const snap = await get(ref(db, `members/${currentUid}/transactions`));
      if(!snap.exists()) return alert('No transactions to export');
      const txs = Object.values(snap.val()).sort((a,b)=> (a.ts||0)-(b.ts||0));
      const doc = new jsPDF({unit:'pt',format:'a4'}); let y=40;
      doc.setFontSize(14); doc.text('Account Transactions',300,y,{align:'center'}); y+=30;
      doc.setFontSize(10);
      txs.forEach(t=>{
        const date = new Date(t.ts||Date.now()).toLocaleDateString();
        doc.text(`${date} â€¢ ${t.desc || ''} â€¢ Debit: ${t.debit || '-'} â€¢ Credit: ${t.credit || '-'} â€¢ Bal: ${t.balance||0}`, 36, y);
        y += 12;
        if(y>720){ doc.addPage(); y=40; }
      });
      doc.save(`Transactions_${(currentUid||'member')}.pdf`);
      showToast('Transactions PDF ready');
    });

    // ----------------- Activity quick actions -----------------
    function logActivity(msg){
      if(!currentUid) return;
      const aRef = push(ref(db, `members/${currentUid}/activityLog`));
      set(aRef, { text: msg, ts: Date.now() });
    }

    // sidebar nav click
    qAll('.sidebar .navBtn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        qAll('.sidebar .navBtn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const target = btn.dataset.target;
        const el = document.getElementById(target);
        if(el) el.scrollIntoView({behavior:'smooth',block:'start'});
      });
    });

    // toggle sidebar
    document.getElementById('toggleSidebarBtn').addEventListener('click', ()=>{
      const s = document.getElementById('sidebar');
      s.classList.toggle('expanded');
      document.getElementById('toggleSidebarBtn').innerHTML = s.classList.contains('expanded') ? '<i class="fas fa-chevron-left"></i> Collapse' : '<i class="fas fa-chevron-right"></i> Expand';
    });

    // notif open
    document.getElementById('notifOpenBtn').addEventListener('click', ()=>{
      document.getElementById('notificationsList').scrollIntoView({behavior:'smooth'});
    });

    // quick statement
    document.getElementById('quickStatement').addEventListener('click', async ()=>{
      if(!currentUid) return alert('Sign in first');
      // build account statement
      const snapMember = await get(ref(db, `members/${currentUid}/profile`));
      const monthly = (await get(ref(db, `members/${currentUid}/savings/monthly`))).val() || 0;
      const weekly = (await get(ref(db, `members/${currentUid}/savings/weekly`))).val() || 0;
      const doc = new jsPDF({unit:'pt',format:'a4'}); let y=40;
      doc.setFontSize(16); doc.text('Account Statement',300,y,{align:'center'}); y+=30;
      doc.setFontSize(10);
      doc.text(`Member: ${snapMember.exists()? snapMember.val().name : 'Member'}`,36,y); y+=12;
      doc.text(`Monthly: ${formatKsh(monthly)} â€¢ Weekly: ${formatKsh(weekly)}`,36,y); y+=12;
      doc.save(`Statement_${(snapMember.exists()? snapMember.val().name : 'member')}.pdf`);
      showToast('Statement generated');
      celebrate();
    });

    // AGM countdown
    (function agmCountdown(){
      const target = new Date('2025-12-14T13:30:00+03:00').getTime();
      const el = document.getElementById('agmCountdown');
      setInterval(()=>{
        const now = Date.now();
        const diff = Math.max(0, target - now);
        const d = Math.floor(diff/(1000*60*60*24));
        const h = Math.floor((diff%(1000*60*60*24))/(1000*60*60));
        const m = Math.floor((diff%(1000*60*60))/(1000*60));
        el.textContent = `${d}d ${h}h ${m}m`;
      },1000);
    })();

    // UI extras
    document.getElementById('refreshTx').addEventListener('click', ()=> {
      // trigger transactions refresh by re-reading; onValue already listening so just toast
      showToast('Transactions refreshed');
    });

    // initial small activity
    (async ()=> {
      try{ logActivity('Dashboard loaded'); } catch(e){}
    })();

    // small improvement: compute sum for nested savings structures
    function computeAmountFromSnap(obj){
      if(!obj) return 0;
      if(typeof obj === 'number') return obj;
      let total = 0;
      Object.values(obj || {}).forEach(v=>{
        if(typeof v === 'number') total += v;
        else if(v && typeof v === 'object' && ('amount' in v)) total += Number(v.amount||0);
        else if(v && typeof v === 'object') {
          Object.values(v).forEach(c=>{ if(c && typeof c === 'object' && 'amount' in c) total += Number(c.amount||0); });
        }
      });
      return total;
    }

    // Dark mode toggle
    document.getElementById('darkToggle').addEventListener('click', ()=>{
      document.body.classList.toggle('dark');
      if(document.body.classList.contains('dark')){
        document.body.style.background = 'linear-gradient(135deg,#071b0f,#073a1f)';
        document.body.style.color = '#ddd';
      } else {
        document.body.style.background = 'linear-gradient(135deg,var(--bg1),#e9fff0)';
        document.body.style.color = '#122';
      }
    });

    // Responsive: ensure small screens look good (extra tweak)
    window.addEventListener('resize', ()=>{
      if(window.innerWidth < 1100){
        document.getElementById('sidebar').style.display = 'none';
      } else {
        document.getElementById('sidebar').style.display = 'flex';
      }
    });
    // trigger initial
    if(window.innerWidth < 1100) document.getElementById('sidebar').style.display='none';

  </script>

  <!-- AOS init (nice fade-onscroll) -->
  <script>
    if(window.AOS) AOS.init({ duration:700, once:true });
  </script>

</body>
</html>

