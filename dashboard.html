<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Visionary Youth Group — Enhanced Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --dark: #164e2a;
      --accent: #2e7d32;
      --bg1: #e9ffec;
      --card: #ffffff;
      --muted: #6b7280;
      --danger: #dc2626;
      --success: #16a34a;
      --warn: #ea580c;
    }
    * { box-sizing: border-box; }
    body, html { margin:0; padding:0; height:100%; font-family: 'Poppins', sans-serif; background: linear-gradient(120deg, var(--bg1), #f6fff6); color: #123; }
    .topbar {
      position: fixed; left:0; right:0; top:0; height:64px;
      background: linear-gradient(90deg, var(--dark), #26734d);
      color:#fff; display:flex; align-items:center; justify-content:space-between;
      padding:0 18px; z-index:1200; box-shadow:0 6px 20px rgba(6,50,20,0.12);
    }
    .brand { display:flex; align-items:center; gap:12px; }
    .brand h1 { margin:0; font-size:1.05rem; font-weight:700; }
    .hamburger { font-size:1.6rem; cursor:pointer; }
    .user-area { display:flex; align-items:center; gap:12px; }
    .avatar-wrap { width:44px; height:44px; border-radius:8px; overflow:hidden; background:#fff; display:flex; align-items:center; justify-content:center; }
    .avatar-wrap img { width:100%; height:100%; object-fit:cover; }
    .user-info { text-align:right; font-size:0.95rem; }
    .user-info small { color: rgba(255,255,255,0.85); display:block; }
    .menu {
      position: fixed; top:64px; left:12px;
      background: rgba(255,255,255,0.98); max-width:320px;
      border-radius:8px; padding:8px; box-shadow:0 8px 30px rgba(0,0,0,0.12);
      display: none; z-index:1199; transform-origin: top left;
    }
    .menu a { display:flex; align-items:center; gap:10px; padding:10px; border-radius:8px; text-decoration:none; color:#123; }
    .menu a:hover { background: #f1fff1; }
    main.page {
      max-width: 1200px; margin: 92px auto 48px; padding: 0 18px;
      display: grid; grid-template-columns: repeat(12,1fr); gap:18px;
    }
    .hero { grid-column: span 12; background: var(--card); border-radius:12px; padding:16px;
      display:flex; justify-content:space-between; align-items:center; gap:16px;
      box-shadow:0 8px 20px rgba(6,50,20,0.03);
    }
    .welcome { display:flex; flex-direction:column; }
    .welcome h2 { margin:0; color: var(--dark); }
    .quick-actions { display:flex; gap:10px; }
    .card { background: var(--card); border-radius:12px; padding:14px; box-shadow:0 8px 20px rgba(6,50,20,0.05); }
    .balances-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(150px,1fr)); gap:12px; }
    .balance { background: linear-gradient(180deg, #f3fff3, #ffffff); padding:12px; border-radius:10px; text-align:center; }
    .balance .label { color: var(--muted); font-size:0.95rem; }
    .balance .value { font-weight:700; font-size:1.25rem; color: var(--accent); margin-top:8px; }
    section.card.big { grid-column: span 8; }
    section.card.side { grid-column: span 4; }
    .form-grid { display:grid; grid-template-columns: repeat(2,1fr); gap:10px; }
    .form-grid .full { grid-column:1/-1; }
    input, select, textarea {
      width:100%; padding:10px; border-radius:8px; border:1px solid #d1d5db; font-size:0.95rem;
    }
    textarea { min-height:100px; resize: vertical; }
    .btn { background: var(--accent); color:white; padding:10px 14px; border:none; border-radius:8px;
      cursor:pointer; font-weight:700;
    }
    .btn.secondary { background:#fff; color: var(--accent); border:1px solid #e3f1e3; }
    .stages { display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .stage { flex:1; padding:10px; border-radius:8px; background:#f5faf5; text-align:center; }
    .stage.active { background: var(--dark); color:white; font-weight:700; }
    .stage.done { background: #27ae60; color:white; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { padding:8px; border:1px solid #e6f0ea; font-size:0.9rem; text-align:left; }
    .muted { color: var(--muted); }
    @media (max-width: 1000px) {
      section.card.big { grid-column: span 12; }
      section.card.side { grid-column: span 12; }
      .form-grid { grid-template-columns: 1fr; }
      .menu { left:8px; right:8px; max-width: unset; }
    }
    .loan-summary { padding:.6rem .8rem; border-radius:8px; background: var(--card); box-shadow:0 4px 16px rgba(6,50,20,0.05); display:flex; justify-content:space-between; align-items:center; }
    .loan-actions-hidden { display: none; }
    .status-pending { background: #fff7ed; color: #92400e; padding:.3rem .6rem; border-radius:4px; font-weight:600; }
    .status-approved { background: #ecfdf5; color: #065f46; padding:.3rem .6rem; border-radius:4px; font-weight:600; }
    .status-rejected { background: #fff1f2; color: #9f1239; padding:.3rem .6rem; border-radius:4px; font-weight:600; }
    .loan-actions-table { width:100%; border-collapse: collapse; }
    .loan-actions-table th, .loan-actions-table td { padding:.6rem .8rem; border-bottom:1px solid #eef2f7; font-size:0.93rem; }
    .loan-toggle-btn { cursor:pointer; color: var(--accent); text-decoration: underline; background:none; border:none; padding:0; font-size:0.95rem; }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="brand">
      <i class="fas fa-seedling" style="font-size:1.25rem; color: var(--gold)"></i>
      <h1>Visionary Youth Group</h1>
    </div>
    <div class="user-area">
      <div class="avatar-wrap" id="topAvatar"></div>
      <div class="user-info">
        <div id="topEmail">—</div>
        <small id="topStatus">Status: <strong style="color:#9ff2b8">Active</strong></small>
      </div>
      <div style="display:flex; align-items:center; gap:10px">
        <button id="downloadStatementTop" class="btn secondary"><i class="fas fa-file-pdf"></i>&nbsp;Statement</button>
        <i class="fas fa-bars hamburger hamburgerAction" role="button" aria-label="Menu" style="font-size:20px; color:#fff; margin-left:6px"></i>
      </div>
    </div>
  </div>

  <div class="menu" id="menu" aria-hidden="true">
    <a href="#" data-target="overview"><i class="fas fa-home"></i> Overview</a>
    <a href="#" data-target="balancesCard"><i class="fas fa-wallet"></i> Balances</a>
    <a href="#" data-target="loan-wizard-tab"><i class="fas fa-file-signature"></i> Apply Loan</a>
    <a href="#" data-target="loanActionsContainer"><i class="fas fa-money-bill-wave"></i> Loan Actions</a>
    <a href="#" data-target="withdraw-section"><i class="fas fa-hand-holding-usd"></i> Withdraw</a>
    <a href="#" data-target="profile-area"><i class="fas fa-user-edit"></i> Profile</a>
    <a href="#" id="menuLogout"><i class="fas fa-sign-out-alt"></i> Logout</a>
  </div>

  <main class="page" id="pageRoot">
    <div class="hero card" id="overview">
      <div class="welcome">
        <h2 id="welcomeName">Welcome, Member</h2>
        <div style="color: var(--muted); margin-top:6px">Quick snapshot — all in <strong>Ksh</strong></div>
        <div style="margin-top:6px; font-size:0.9rem">Points: <strong id="pointsDisplay">0</strong></div>
      </div>
      <div class="quick-actions">
        <button id="quickApply" class="btn"><i class="fas fa-file-signature"></i>&nbsp;Apply Loan</button>
        <button id="quickStatement" class="btn secondary"><i class="fas fa-file-download"></i>&nbsp;Statement</button>
      </div>
    </div>

    <div class="card big" id="balancesCard">
      <h2>Balances</h2>
      <div class="balances-grid">
        <div class="balance"><div class="label">Monthly Savings</div><div class="value" id="monthlyVal">Ksh 0</div></div>
        <div class="balance"><div class="label">Weekly Savings</div><div class="value" id="weeklyVal">Ksh 0</div></div>
        <div class="balance"><div class="label">Goal Target</div><div class="value" id="goalTargetVal">Ksh 0</div></div>
        <div class="balance"><div class="label">Goal Progress</div><div class="value"><span id="goalProgressPct">0%</span></div></div>
        <div class="balance"><div class="label">Total Loans</div><div class="value" id="totalLoansVal">Ksh 0</div></div>
        <div class="balance"><div class="label">Outstanding</div><div class="value" id="outstandingLoansVal">Ksh 0</div></div>
        <div class="balance"><div class="label">Unpaid Balances</div><div class="value" id="unpaidVal">Ksh 0</div></div>
      </div>
    </div>

    <!-- LOAN WIZARD TAB -->
    <section class="card big" id="loan-wizard-tab" style="display:none;">
      <h2><i class="fas fa-file-signature"></i> Loan Application Wizard</h2>
      <div style="margin-bottom:12px">
        <div class="flex items-center gap-3 text-sm">
          <div id="wizStepLabel">Step 1 / 6</div>
          <div class="flex-1"><div style="height:6px;background:#e5e7eb;border-radius:3px;overflow:hidden;">
            <div id="wizBar" style="height:100%; background: var(--accent); width:0;"></div>
          </div></div>
        </div>
      </div>
      <form id="loanWizardForm">

        <div id="wiz-1" class="wiz-step">
          <div class="form-grid">
            <input name="memberName" placeholder="Full Name" required>
            <input name="nationalId" placeholder="ID / Passport" required>
            <input name="dob" type="date" placeholder="Date of Birth" required>
            <input name="phone" placeholder="Phone" required>
            <input name="email" type="email" placeholder="Email">
            <input class="full" name="selfHelpGroup" placeholder="Self-Help Group">
          </div>
        </div>

        <div id="wiz-2" class="wiz-step">
          <div class="form-grid">
            <input name="county" placeholder="County" required>
            <input name="town" placeholder="Town / City">
            <input name="currentAddress" placeholder="Address" required>
            <input name="areaResidence" placeholder="Area / Estate">
            <input name="monthlyRent" placeholder="Rent / Payment">
            <select name="ownedRented">
              <option value="">Owned / Rented</option><option>Owned</option><option>Rented</option>
            </select>
          </div>
        </div>

        <div id="wiz-3" class="wiz-step">
          <div class="form-grid">
            <input name="employer" placeholder="Employer / Business">
            <input name="position" placeholder="Position">
            <input name="periodEmployment" placeholder="Period">
            <input name="employerAddress" placeholder="Employer Address">
            <input name="monthlyIncome" placeholder="Monthly Income (Ksh)" required>
            <input name="otherIncome" placeholder="Other Income (Ksh)">
          </div>
        </div>

        <div id="wiz-4" class="wiz-step">
          <div style="margin-bottom:6px">Provide 3 guarantors (all required)</div>
          <table>
            <thead><tr><th>#</th><th>Name</th><th>Phone</th><th>ID</th><th>Group</th><th>Amount</th></tr></thead>
            <tbody>
              <tr><td>1</td><td><input name="g1_name" placeholder="Name" required></td><td><input name="g1_phone" placeholder="Phone" required></td><td><input name="g1_id" placeholder="ID" required></td><td><input name="g1_group" placeholder="Group"></td><td><input name="g1_amount" placeholder="Ksh" required></td></tr>
              <tr><td>2</td><td><input name="g2_name" placeholder="Name" required></td><td><input name="g2_phone" placeholder="Phone" required></td><td><input name="g2_id" placeholder="ID" required></td><td><input name="g2_group" placeholder="Group"></td><td><input name="g2_amount" placeholder="Ksh" required></td></tr>
              <tr><td>3</td><td><input name="g3_name" placeholder="Name" required></td><td><input name="g3_phone" placeholder="Phone" required></td><td><input name="g3_id" placeholder="ID" required></td><td><input name="g3_group" placeholder="Group"></td><td><input name="g3_amount" placeholder="Ksh" required></td></tr>
            </tbody>
          </table>
        </div>

        <div id="wiz-5" class="wiz-step">
          <div class="form-grid">
            <input name="amount" placeholder="Amount Requested (Ksh)" required>
            <input name="purpose" placeholder="Purpose of loan" required>
            <input name="repayableMonths" placeholder="Months to repay" required>
            <input name="otherLoans" placeholder="Existing loans / debts">
            <select name="repaymentMode">
              <option value="mpesa">M-Pesa</option><option value="bank">Bank</option><option value="cash">Cash</option>
            </select>
            <input name="accountNumber" placeholder="Account / Till">
          </div>
        </div>

        <div id="wiz-6" class="wiz-step">
          <div class="form-grid">
            <input name="educationLevel" placeholder="Education Level">
            <input name="institution" placeholder="Institution">
            <input name="educationYear" placeholder="Year / Index">
            <input name="course" placeholder="Course / Field">
            <input name="duration" placeholder="Duration (yrs)">
            <input class="full" name="purposeExtra" placeholder="Additional Notes">
          </div>
        </div>

        <div style="margin-top:12px; display:flex; justify-content:space-between;">
          <button type="button" id="wizPrev" class="btn secondary">Back</button>
          <div class="flex gap-4">
            <button type="button" id="wizNext" class="btn">Next</button>
            <button type="submit" id="wizSubmit" class="btn" style="display:none;">Submit & Download PDF</button>
          </div>
        </div>

      </form>
    </section>

    <!-- LOAN ACTIONS SUMMARY & TABLE -->
    <div id="loanActionsContainer" style="grid-column: span 12;">
      <div id="loanSummary" class="loan-summary">
        <div><strong id="loanCount">0</strong> active loans • Outstanding: <span id="loanOutstanding">Ksh 0</span></div>
        <button id="toggleLoanActions" class="loan-toggle-btn">Show actions</button>
      </div>
      <div id="loanActionsPanel" class="loan-actions-hidden card p-3" style="margin-top:8px;">
        <table class="loan-actions-table">
          <thead><tr><th>Loan Date</th><th>Loan</th><th>Amount</th><th>Due Date</th><th>Status</th><th>Progress</th></tr></thead>
          <tbody id="loanActionsBody"></tbody>
        </table>
      </div>
    </div>

    <section class="card big" id="withdraw-section" style="display:none;">
      <h2><i class="fas fa-hand-holding-usd"></i> Withdrawal Form</h2>
      <form id="withdrawForm">
        <div class="form-grid">
          <input name="memberName" placeholder="Member Name" required>
          <input name="membershipNumber" placeholder="Membership Number" required>
          <input name="idNumber" placeholder="ID / Passport" required>
          <input name="phone" placeholder="Phone" required>
          <input name="amountFigures" placeholder="Amount Ksh" required>
          <input name="reason" placeholder="Reason (min. 200 chars)" required>
        </div>
        <div style="margin-top:12px; display:flex; gap:10px; align-items:center">
          <button id="previewWithdrawPdf" type="button" class="btn">Preview PDF</button>
          <button type="submit" id="submitWithdrawBtn" class="btn">Submit & Download PDF</button>
        </div>
      </form>
    </section>

    <section class="card side" id="loansListFull" style="display:none;">
      <h2>Loan Applications & Status</h2>
      <div id="loansListArea">Loading…</div>
    </section>

    <section class="card" id="profile-area" style="display:none;">
      <h2><i class="fas fa-user-edit"></i> Update Profile</h2>
      <div class="profile-grid" style="margin-top:10px">
        <input class="full" id="profile_fullName" placeholder="Full Name">
        <input id="profile_phone" placeholder="Phone">
        <input id="profile_id" placeholder="ID Number">
        <input id="profile_yearJoined" placeholder="Year Joined">
        <input id="profile_dob" type="date" placeholder="Date of Birth">
        <input id="profile_status" placeholder="Status">
      </div>
      <div style="margin-top:12px; display:flex; gap:8px; align-items:center">
        <button id="choosePhotoBtn" class="btn secondary"><i class="fas fa-camera"></i>&nbsp;Upload Photo</button>
        <button id="saveProfile" class="btn">Save Profile</button>
        <button id="profileStatement" class="btn secondary">Download Statement</button>
      </div>
    </section>

  </main>

  <div id="toast" style="position:fixed; right:18px; bottom:18px; z-index:2000; display:none; background:#28a745; color:white; padding:10px 14px; border-radius:8px;"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getDatabase, ref, onValue, push, set, update, get, onChildChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import { getStorage, ref as stRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";
    const { jsPDF } = window.jspdf;

    const firebaseConfig = {
      apiKey: "AIzaSyA_OCu7HQ5HCH2OYx5dQ2Z1r7YPwQJave4",
      authDomain: "visionary-youth-grou-2024.firebaseapp.com",
      databaseURL: "https://visionary-youth-grou-2024-default-rtdb.firebaseio.com",
      projectId: "visionary-youth-grou-2024",
      storageBucket: "visionary-youth-grou-2024.appspot.com",
      messagingSenderId: "372978592717",
      appId: "1:372978592717:web:1c15aec728ee5f854f3284"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // UI elements
    const hamburger = document.querySelector('.hamburgerAction');
    const menu = document.getElementById('menu');
    const toastEl = document.getElementById('toast');
    const topEmail = document.getElementById('topEmail');
    const topStatus = document.getElementById('topStatus');
    const welcomeNameEl = document.getElementById('welcomeName');
    const pointsDisplay = document.getElementById('pointsDisplay');
    const topAvatar = document.getElementById('topAvatar');
    const quickApplyBtn = document.getElementById('quickApply');
    const quickStatementBtn = document.getElementById('quickStatement');

    function showToast(msg, ms=3000) {
      toastEl.textContent = msg;
      toastEl.style.display = 'block';
      setTimeout(() => { toastEl.style.display = 'none'; }, ms);
    }

    function formatKsh(n) {
      const num = Number(n||0);
      return 'Ksh ' + num.toLocaleString('en-KE');
    }

    if (hamburger) {
      hamburger.addEventListener('click', () => {
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
      });
    }

    menu.querySelectorAll('a[data-target]').forEach(a => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        const target = a.dataset.target;
        const el = document.getElementById(target);
        if (el) el.style.display = 'block';
        // hide other main tabs
        ['balancesCard','loan-wizard-tab','withdraw-section','profile-area','loansListFull'].forEach(id => {
          if (id !== target && document.getElementById(id)) document.getElementById(id).style.display = 'none';
        });
        menu.style.display = 'none';
      });
    });

    let currentUid = null;

    // inactivity auto-logout
    let logoutTimer;
    function resetLogoutTimer() {
      clearTimeout(logoutTimer);
      logoutTimer = setTimeout(() => {
        signOut(auth).catch(e=>console.error(e));
        alert('Logged out due to inactivity');
        location.reload();
      }, 3 * 60 * 1000);
    }
    ['mousemove','keydown','click','touchstart'].forEach(ev => window.addEventListener(ev, resetLogoutTimer));

    onAuthStateChanged(auth, async user => {
      if (!user) {
        location.href = 'index.html'; // or login
        return;
      }
      currentUid = user.uid;
      topEmail.textContent = user.email || '—';
      resetLogoutTimer();
      showToast('Welcome back');
      loadProfile();
      subscribeBalances();
      subscribeLoans();
      subscribeLoanActions();
      subscribeGoals();
      // award login point
      await addPoints(5, 'Login');
    });

    // Member profile & photo
    async function loadProfile() {
      const snap = await get(ref(db, `members/${currentUid}/profile`));
      if (snap.exists()) {
        const p = snap.val();
        if (p.name) welcomeNameEl.textContent = p.name;
        if (p.photoURL) setAvatar(p.photoURL);
        if(p.status) topStatus.innerHTML = `Status: <strong style="color:#9ff2b8">${p.status}</strong>`;
      }
    }
    function setAvatar(url) {
      topAvatar.innerHTML = `<img src="${url}" alt="avatar">`;
    }

    // Points and activity
    async function getPoints() {
      const snap = await get(ref(db, `members/${currentUid}/points`));
      return snap.exists() ? Number(snap.val()||0) : 0;
    }
    async function setPoints(n) {
      await set(ref(db, `members/${currentUid}/points`), n);
      pointsDisplay.textContent = String(n);
    }
    async function addPoints(n, reason) {
      if (!currentUid) return;
      const curr = await getPoints();
      const updated = (curr || 0) + n;
      await setPoints(updated);
      await push(ref(db, `members/${currentUid}/activityLog`), { msg: reason, ts: Date.now() });
      showToast(`+${n} pts`);
    }

    // BALANCES subscription
    function subscribeBalances() {
      onValue(ref(db, `members/${currentUid}/savings/monthly`), snap => {
        const v = snap.exists() ? snap.val() : 0;
        document.getElementById('monthlyVal').textContent = formatKsh(v);
      });
      onValue(ref(db, `members/${currentUid}/savings/weekly`), snap => {
        const v = snap.exists() ? snap.val() : 0;
        document.getElementById('weeklyVal').textContent = formatKsh(v);
      });
      onValue(ref(db, `members/${currentUid}/goal/target`), snap => {
        const v = snap.exists() ? snap.val() : 0;
        document.getElementById('goalTargetVal').textContent = formatKsh(v);
      });
      onValue(ref(db, `members/${currentUid}/goal/progressPct`), snap => {
        const v = snap.exists() ? snap.val() : 0;
        document.getElementById('goalProgressPct').textContent = `${v}%`;
      });
      onValue(ref(db, `members/${currentUid}/loans/summary/total`), snap => {
        const v = snap.exists() ? snap.val() : 0;
        document.getElementById('totalLoansVal').textContent = formatKsh(v);
      });
      onValue(ref(db, `members/${currentUid}/loans/summary/outstanding`), snap => {
        const v = snap.exists() ? snap.val() : 0;
        document.getElementById('outstandingLoansVal').textContent = formatKsh(v);
      });
      onValue(ref(db, `members/${currentUid}/unpaidBalances`), snap => {
        const v = snap.exists() ? snap.val() : 0;
        document.getElementById('unpaidVal').textContent = formatKsh(v);
      });
    }

    // LOANS subscription
    function subscribeLoans() {
      onValue(ref(db, `members/${currentUid}/loans`), snap => {
        // loan summary logic if needed, here nothing
      });
    }

    // LOAN ACTIONS summary & table integration
    const loanActionsPanel = document.getElementById('loanActionsPanel');
    const loanActionsBody = document.getElementById('loanActionsBody');
    const toggleLoanActions = document.getElementById('toggleLoanActions');
    const loanCountEl = document.getElementById('loanCount');
    const loanOutstandingEl = document.getElementById('loanOutstanding');

    toggleLoanActions.addEventListener('click', () => {
      const hidden = loanActionsPanel.classList.toggle('loan-actions-hidden');
      toggleLoanActions.textContent = hidden ? 'Show actions' : 'Hide actions';
    });

    function makeLoanRow(loan) {
      const tr = document.createElement('tr');
      const loanDate = loan.appliedAt ? new Date(loan.appliedAt).toLocaleDateString() : '-';
      const dueDate = loan.dueDate ? new Date(loan.dueDate).toLocaleDateString() : '-';
      const amount = loan.amount || loan.amountFigures || 0;
      const status = loan.status || 'Pending';
      const progress = loan.progress || 0;
      let statusClass = 'status-pending';
      if (status.toLowerCase() === 'approved') statusClass = 'status-approved';
      if (status.toLowerCase() === 'paid' || status.toLowerCase() === 'disbursed') statusClass = 'status-approved';
      if (status.toLowerCase() === 'rejected') statusClass = 'status-rejected';

      tr.innerHTML = `
        <td>${loanDate}</td>
        <td>${escapeHtml(loan.purpose || '')}</td>
        <td>${formatKsh(amount)}</td>
        <td>${dueDate}</td>
        <td><span class="${statusClass}">${status}</span></td>
        <td>${progress}%</td>
      `;
      return tr;
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));
    }

    function subscribeLoanActions() {
      onValue(ref(db, `members/${currentUid}/loans/applications`), snap => {
        loanActionsBody.innerHTML = '';
        const obj = snap.exists() ? snap.val() : {};
        const keys = Object.keys(obj);
        let totalOutstanding = 0;
        keys.forEach(k => {
          const loan = obj[k];
          const row = makeLoanRow(loan);
          loanActionsBody.appendChild(row);
          totalOutstanding += Number(loan.amount || loan.amountFigures || 0);
        });
        loanCountEl.textContent = keys.length;
        loanOutstandingEl.textContent = formatKsh(totalOutstanding);
      });
    }

    // GOAL setting tab & logic
    // If user visits “Balances” tab, show input to set goal
    const goalInput = document.createElement('input');
    goalInput.placeholder = 'Set monthly savings goal (Ksh)';
    goalInput.style.margin = '12px 0';
    goalInput.style.padding = '8px';
    goalInput.style.border = '1px solid #d1d5db';
    goalInput.style.borderRadius = '6px';
    goalInput.type = 'number';
    document.getElementById('balancesCard').appendChild(goalInput);
    goalInput.addEventListener('change', async () => {
      const val = Number(goalInput.value);
      if (isNaN(val) || val < 0) return alert('Enter valid number');
      await set(ref(db, `members/${currentUid}/goal/target`), val);
      showToast('Goal target set');
    });

    // REMINDER on due date (cloud function style)
    function setupReminderForLoan(loan) {
      if (!loan.dueDate) return;
      const dueTs = new Date(loan.dueDate).getTime();
      const now = Date.now();
      const msToDue = dueTs - now;
      if (msToDue <= 0) return;
      setTimeout(() => {
        // push to reminders node
        push(ref(db, `reminders`), {
          uid: currentUid,
          title: 'Loan Due Reminder',
          message: `Your loan "${loan.purpose}" is due today.`,
          ts: Date.now()
        });
      }, msToDue);
    }
    // To use: after loan submission, call setupReminderForLoan(newLoanData)

    // WIZARD navigation logic
    let currentStep = 1, totalSteps = 6;
    function showStep() {
      for (let i =1; i <= totalSteps; i++) {
        const el = document.getElementById('wiz-' + i);
        if (el) el.style.display = (i === currentStep ? 'block' : 'none');
      }
      document.getElementById('wizStepLabel').textContent = `Step ${currentStep} / ${totalSteps}`;
      document.getElementById('wizBar').style.width = `${((currentStep-1)/(totalSteps-1))*100}%`;
      document.getElementById('wizPrev').disabled = currentStep === 1;
      if (currentStep === totalSteps) {
        document.getElementById('wizNext').style.display = 'none';
        document.getElementById('wizSubmit').style.display = 'inline-block';
      } else {
        document.getElementById('wizNext').style.display = 'inline-block';
        document.getElementById('wizSubmit').style.display = 'none';
      }
    }
    document.getElementById('wizNext').addEventListener('click', ()=> { if(currentStep < totalSteps) currentStep++; showStep(); });
    document.getElementById('wizPrev').addEventListener('click', ()=> { if(currentStep > 1) currentStep--; showStep(); });
    showStep();

    // Loan form submit
    const wizardForm = document.getElementById('loanWizardForm');
    wizardForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(wizardForm);
      const data = Object.fromEntries(fd.entries());
      data.appliedAt = Date.now();
      data.status = 'Pending';
      data.progress = 0;
      try {
        const refApp = push(ref(db, `members/${currentUid}/loans/applications`));
        const id = refApp.key;
        await set(refApp, data);
        showToast('Application saved. Generating PDF...');
        await addPoints(10, 'Loan applied');
        setupReminderForLoan(data);
        // generate PDF similar to before (call your PDF builder)
        // ...
      } catch(err) {
        console.error(err);
        alert('Failed to submit application');
      }
    });

    // QUICK ACTIONS
    quickApplyBtn?.addEventListener('click', () => {
      document.getElementById('loan-wizard-tab').style.display = 'block';
      ['balancesCard','withdraw-section','profile-area','loansListFull'].forEach(id => {
        if (document.getElementById(id)) document.getElementById(id).style.display = 'none';
      });
      showStep();
    });
    quickStatementBtn?.addEventListener('click', () => {
      // trigger statement download
      // ...
    });

  </script>
</body>
</html>
