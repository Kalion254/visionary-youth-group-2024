<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Visionary Youth Dashboard (FINAL)</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
body{margin:0;font-family:'Segoe UI',sans-serif;background:linear-gradient(to right,#e0f7fa,#e8f5e9);}
header{background:#1565c0;color:white;padding:15px 30px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 6px 20px rgba(0,0,0,0.25);}
nav{display:flex;gap:10px;margin:15px 0;padding:0 20px;}
nav button{flex:1;padding:12px;border:none;border-radius:10px;background:#bbdefb;color:#0d47a1;font-weight:bold;cursor:pointer;transition:0.3s;}
nav button.active{background:#0d47a1;color:white;}
.container{padding:20px;}
.section{display:none;}
.section.active{display:block;}
button{cursor:pointer;}

/* Achievements styling */
.achievements-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
}

.achievement-card {
  background: white;
  padding: 20px;
  border-radius: 15px;
  box-shadow: 0 6px 15px rgba(0,0,0,0.1);
  text-align: center;
  transition: transform 0.2s ease-in-out;
}

.achievement-card:hover {
  transform: translateY(-5px);
}

.achievement-card i {
  font-size: 40px;
  color: #1565c0;
  margin-bottom: 10px;
}

.achievement-card button {
  background: #1565c0;
  color: white;
  padding: 8px 15px;
  border: none;
  border-radius: 8px;
  margin-top: 10px;
  cursor: pointer;
}

.achievement-card button:hover {
  background: #0d47a1;
}
</style>
</head>
<body>
<header>
<h1>Dashboard</h1>
<div id="emailDisplay">email@example.com</div>
<button id="logoutBtn">Logout</button>
</header>

<nav>
<button class="tab-btn active" data-target="financial">Financial Overview</button>
<button class="tab-btn" data-target="profile">Profile</button>
<button class="tab-btn" data-target="loan">Loan Application</button>
<button class="tab-btn" data-target="loanProgress">Loan Progress</button>
<button class="tab-btn" data-target="achievements">Achievements</button>
<button class="tab-btn" data-target="statement">Account Statement</button>
</nav>

<div class="container">
<!-- Financial Overview -->
<div id="financial" class="section active">
<h2>Financial Overview</h2>
<p>Weekly Savings: <span id="weeklySavings">0</span></p>
<p>Monthly Savings: <span id="monthlySavings">0</span></p>
<p>Shares: <span id="shares">0</span></p>
<p>Loan: <span id="loan">0</span></p>
<p>Unpaid Balances: <span id="unpaidBalances">0</span></p>
<p>Dividends: <span id="dividends">0</span></p>
</div>

<!-- Profile -->
<div id="profile" class="section">
<h2>Profile Update</h2>
<form id="profileForm">
<label>Name</label><input id="profileName" required><br>
<label>ID</label><input id="profileID" required><br>
<label>Email</label><input type="email" id="profileEmail" required><br>
<label>Phone</label><input id="profilePhone" required><br>
<label>Origin</label><input id="profileOrigin" required><br>
<label>Member Number</label><input id="profileMember" required><br>
<label>Passport</label><input type="file" id="passport" accept="image/*" required><br>
<button type="submit">Update Profile</button>
</form>
</div>

<!-- Loan Application -->
<div id="loan" class="section">
<h2>Loan Application</h2>
<form id="loanForm">
<label>Name</label><input id="loanName" required><br>
<label>Amount</label><input id="loanAmount" required><br>
<label>Category</label>
<select id="loanCategory" required>
<option value="">Select</option>
<option>Business</option>
<option>Education</option>
<option>Emergency</option>
</select><br>
<label>Guarantor</label><input id="loanGuarantor" required><br>
<label>Phone</label><input id="loanPhone" required><br>
<button type="submit">Apply</button>
</form>
<button id="downloadLoanBtn" style="display:none;">Download Loan CSV</button>
</div>

<!-- Loan Progress -->
<div id="loanProgress" class="section">
<h2>Loan Progress</h2>
<div id="loanTimeline"></div>
</div>

<!-- Achievements -->
<div id="achievements" class="section">
<h2>üéñÔ∏è Achievements & Documents</h2>
<div id="achievementList" class="achievements-grid"></div>
</div>

<!-- Account Statement -->
<div id="statement" class="section">
<h2>Account Statement</h2>
<button id="downloadStatementBtn">Download CSV</button>
</div>
</div>

<script>
const firebaseConfig={
  apiKey:"AIzaSyA_OCu7HQ5HCH2OYx5dQ2Z1r7YPwQJave4",
  authDomain:"visionary-youth-grou-2024.firebaseapp.com",
  databaseURL:"https://visionary-youth-grou-2024-default-rtdb.firebaseio.com/",
  projectId:"visionary-youth-grou-2024",
  storageBucket:"visionary-youth-grou-2024.firebasestorage.app",
  messagingSenderId:"372978592717",
  appId:"1:372978592717:web:624596619d41aab84f3284",
  measurementId:"G-FEHC1GM3B7"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.database();
const storage=firebase.storage();
let currentUserUid;

// Tab navigation
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    document.getElementById(btn.dataset.target).classList.add("active");
    btn.classList.add("active");
  });
});

// Logout
document.getElementById("logoutBtn").addEventListener("click",()=>auth.signOut().then(()=>window.location.href="index.html"));

// Auth check
auth.onAuthStateChanged(user=>{
  if(user){
    currentUserUid=user.uid;
    document.getElementById("emailDisplay").textContent=user.email;
    loadFinancials();
    loadLoanProgress();
    loadAchievements();
  } else {
    window.location.href="index.html";
  }
});

// Profile Update
document.getElementById("profileForm").addEventListener("submit",async e=>{
  e.preventDefault();
  const file=document.getElementById("passport").files[0];
  const storageRef=storage.ref(`passports/${currentUserUid}`);
  await storageRef.put(file);
  const url=await storageRef.getDownloadURL();
  await db.ref(`users/${currentUserUid}/profile`).set({
    name:document.getElementById("profileName").value,
    id:document.getElementById("profileID").value,
    email:document.getElementById("profileEmail").value,
    phone:document.getElementById("profilePhone").value,
    origin:document.getElementById("profileOrigin").value,
    memberNumber:document.getElementById("profileMember").value,
    passportURL:url
  });
  alert("Profile updated successfully!");
});

// Load Financials
function loadFinancials(){
  db.ref(`users/${currentUserUid}/financials`).on("value",snap=>{
    const data=snap.val()||{};
    document.getElementById("weeklySavings").textContent=data.weekly_savings||0;
    document.getElementById("monthlySavings").textContent=data.monthly_savings||0;
    document.getElementById("shares").textContent=data.shares||0;
    document.getElementById("loan").textContent=data.loan||0;
    document.getElementById("unpaidBalances").textContent=data.unpaid_balances||0;
    document.getElementById("dividends").textContent=data.dividends||0;
  });
}

// Loan Application Submit
document.getElementById("loanForm").addEventListener("submit",async e=>{
  e.preventDefault();
  const loanData={
    personal:{name:document.getElementById("loanName").value},
    loanDetails:{amount:document.getElementById("loanAmount").value,category:document.getElementById("loanCategory").value},
    guarantor:{name:document.getElementById("loanGuarantor").value,phone:document.getElementById("loanPhone").value},
    status:"Applied",
    timestamp:Date.now()
  };
  const ref=await db.ref(`users/${currentUserUid}/loan_applications`).push(loanData);
  alert("Loan application submitted successfully!");
  document.getElementById("downloadLoanBtn").style.display="block";
  document.getElementById("downloadLoanBtn").onclick=()=>downloadLoanCSV(ref.key);
});

// Download loan CSV
function downloadLoanCSV(loanKey){
  db.ref(`users/${currentUserUid}/loan_applications/${loanKey}`).once('value').then(snap=>{
    const d=snap.val();
    let csv="Section,Field,Value\n";
    for(let sec in d) for(let key in d[sec]) csv+=`${sec},${key},${d[sec][key]}\n`;
    const blob=new Blob([csv],{type:'text/csv'});
    const link=document.createElement('a');
    link.href=URL.createObjectURL(blob);
    link.download='loan_application.csv';
    link.click();
  });
}

// Loan progress
function loadLoanProgress(){
  const container=document.getElementById("loanTimeline");
  container.innerHTML="";
  db.ref(`users/${currentUserUid}/loan_applications`).on('value',snap=>{
    container.innerHTML="";
    snap.forEach(child=>{
      const loan=child.val();
      const stages=["Applied","Registered","Verified","Allocation","Disbursement in Progress","Disbursed"];
      stages.forEach(stage=>{
        const div=document.createElement("div");
        div.textContent=`${stage} - Amount: ${loan.loanDetails.amount} - Status: ${loan.status}`;
        container.appendChild(div);
      });
    });
  });
}

// Achievements
function loadAchievements() {
  db.ref(`users/${currentUserUid}/achievements`).on("value", snap => {
    const list = document.getElementById("achievementList");
    list.innerHTML = "";
    const data = snap.val() || {};
    if (Object.keys(data).length === 0) {
      list.innerHTML = "<p>No achievements uploaded yet.</p>";
      return;
    }
    for (let key in data) {
      const doc = data[key];
      const div = document.createElement("div");
      div.className = "achievement-card";
      div.innerHTML = `
        <i class="fa fa-file-alt"></i>
        <h3>${doc.title}</h3>
        <small>Uploaded: ${doc.uploadedAt}</small><br>
        <button onclick="window.open('${doc.fileURL}', '_blank')">Download</button>
      `;
      list.appendChild(div);
    }
  });
}

// Download account statement
document.getElementById("downloadStatementBtn").addEventListener("click",()=>{
  db.ref(`users/${currentUserUid}/financials`).once('value').then(snap=>{
    const d=snap.val()||{};
    let csv=`Type,Amount
Weekly Savings,${d.weekly_savings||0}
Monthly Savings,${d.monthly_savings||0}
Shares,${d.shares||0}
Loan,${d.loan||0}
Unpaid Balances,${d.unpaid_balances||0}
Dividends,${d.dividends||0}`;
    const blob=new Blob([csv],{type:'text/csv'});
    const link=document.createElement('a');
    link.href=URL.createObjectURL(blob);
    link.download='account_statement.csv';
    link.click();
  });
});
</script>
</body>
</html>
