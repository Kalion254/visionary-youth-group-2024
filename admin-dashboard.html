 <!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>VYG Admin ‚Äî Full Management (Seku)</title>

<!-- Fonts & icons -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --brand:#004d26; --accent:#ffcc00; --muted:#6b7280; --bg:#f3f6f8;
    --card:#ffffff; --danger:#dc2626;
  }
  *{box-sizing:border-box;font-family:'Poppins',sans-serif}
  body{margin:0;background:var(--bg);color:#0f172a;min-height:100vh}
  /* layout */
  .app {display:flex;min-height:100vh}
  aside{width:260px;background:linear-gradient(180deg,var(--brand),#036b37);color:#fff;padding:18px 12px;position:fixed;left:0;top:0;bottom:0;overflow:auto}
  .brand{display:flex;gap:10px;align-items:center;margin-bottom:14px}
  .brand .logo{width:46px;height:46px;border-radius:10px;background:var(--accent);display:grid;place-items:center;color:#00371a;font-weight:800}
  .brand h1{font-size:18px;margin:0}
  nav ul{list-style:none;padding:0;margin:12px 0}
  nav li{margin:8px 0}
  nav a{display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;color:#e6ffef;text-decoration:none}
  nav a.active, nav a:hover{background:rgba(255,255,255,0.08)}
  main{margin-left:260px;flex:1;padding:18px 22px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
  .search{display:flex;gap:8px;align-items:center}
  .card-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:12px}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
  .card h3{margin:0;font-size:18px}
  .card p{margin:6px 0 0;color:var(--muted)}

  /* tables & layout */
  section{margin-bottom:18px}
  .table-wrap{background:var(--card);border-radius:12px;overflow:auto;padding:8px;box-shadow:0 6px 18px rgba(2,6,23,0.04)}
  table{width:100%;border-collapse:collapse}
  thead th{background:#0b3f2e;color:#fff;padding:10px;text-align:left;font-size:13px}
  tbody td{padding:10px;border-bottom:1px solid #eef2f4;font-size:13px}
  .muted{color:var(--muted);font-size:13px}
  .pill{display:inline-block;padding:6px 8px;border-radius:999px;background:#eef7ee;color:#034d26;font-weight:600;font-size:12px}

  /* buttons */
  .btn{display:inline-block;padding:8px 12px;border-radius:8px;border:none;background:var(--brand);color:#fff;font-weight:600;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--brand);border:1px solid rgba(2,6,23,0.06)}
  .btn.warn{background:var(--accent);color:#00371a}
  .btn.danger{background:var(--danger)}
  .small{padding:6px 8px;font-size:13px}

  /* responsive */
  @media(max-width:880px){
    aside{position:relative;width:100%;height:auto}
    main{margin-left:0;padding:12px}
    .card-grid{grid-template-columns:repeat(auto-fit,minmax(140px,1fr))}
  }

  /* modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.45);z-index:60}
  .modal .panel{width:95%;max-width:780px;background:#fff;padding:18px;border-radius:12px;max-height:90vh;overflow:auto}
  .row{display:flex;gap:10px;align-items:center}
  .col{flex:1}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef0}
  .flex-end{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
  .note{font-size:12px;color:var(--muted);margin-top:8px}
</style>
</head>
<body>

<div class="app">

  <!-- SIDEBAR -->
  <aside>
    <div class="brand">
      <div class="logo">V</div>
      <div><h1>Visionary Youth</h1><div class="muted">Admin Portal</div></div>
    </div>

    <nav>
      <ul>
        <li><a href="#" class="menu-link active" data-section="dashboard">üè† Dashboard</a></li>
        <li><a href="#" class="menu-link" data-section="members">üë• Members</a></li>
        <li><a href="#" class="menu-link" data-section="savings">üí∞ Savings</a></li>
        <li><a href="#" class="menu-link" data-section="loans">üí∏ Loans</a></li>
        <li><a href="#" class="menu-link" data-section="transactions">üîÅ Transactions</a></li>
        <li><a href="#" class="menu-link" data-section="receipts">üìÑ Receipts / PDFs</a></li>
        <li><a href="#" class="menu-link" data-section="settings">‚öôÔ∏è Settings</a></li>
        <li><a href="#" class="menu-link" data-section="investments">üìà Investments</a></li>
<li><a href="#" class="menu-link" data-section="staff">üßë‚Äçüíº Staff</a></li>
<li><a href="#" class="menu-link" data-section="analytics">üìä Analytics</a></li>
<li><a href="#" class="menu-link" data-section="documents">üóÇ Org Documents</a></li>

      </ul>
    </nav>

    <div style="margin-top:18px">
      <button class="btn" id="runAccrualBtn">Run Loan Accrual</button>
      <div class="note">Runs server accrual script (useful if cron missing).</div>
    </div>
  </aside>

  <!-- MAIN -->
  <main>
    <header>
      <div>
        <h2 style="margin:0">Admin Dashboard</h2>
        <div class="muted">Manage members, savings, loans, penalties & PDFs</div>
      </div>
      <div class="search">
        <input id="globalSearch" placeholder="Search members, loans..." style="padding:8px;border-radius:8px;border:1px solid #e6eef0" />
        <button class="btn ghost" onclick="openModal('createAdmin')">+ Admin</button>
        <button class="btn" onclick="logout()">Logout</button>
      </div>
    </header>

    <!-- SECTIONS -->
    <section id="dashboard" class="section">
      <div class="card-grid">
        <div class="card">
          <h3 id="statMembers">0</h3>
          <p>Members</p>
        </div>
        <div class="card">
          <h3 id="statSavings">KES 0</h3>
          <p>Total Savings (incl. penalties)</p>
        </div>
        <div class="card">
          <h3 id="statLoans">KES 0</h3>
          <p>Outstanding Loans</p>
        </div>
        <div class="card">
          <h3 id="statPenalties">KES 0</h3>
          <p>Penalties (collected/pending)</p>
        </div>
      </div>

      <div class="card-grid" style="margin-top:12px">
        <div class="card">
          <h3>Overdue Loans</h3>
          <p id="overdueLoansList" class="muted">Loading‚Ä¶</p>
        </div>
        <div class="card">
          <h3>Savings Overdue</h3>
          <p id="overdueSavingsList" class="muted">Loading‚Ä¶</p>
        </div>
        <div class="card">
          <h3>Quick Actions</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
            <button class="btn warn small" onclick="runPenaltyNow()">Apply Savings Penalties</button>
            <button class="btn ghost small" onclick="fetchAndRender()">Refresh</button>
          </div>
        </div>
      </div>
    </section>

    <!-- MEMBERS -->
    <section id="members" class="section" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3>Members</h3>
        <div>
          <button class="btn ghost" onclick="openModal('addMember')">Add Member</button>
          <button class="btn" onclick="exportMembersCSV()">Export CSV</button>
        </div>
      </div>

      <div class="table-wrap">
        <table id="membersTable">
          <thead><tr><th>Name</th><th>MemberID</th><th>Phone</th><th>Balance</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- SAVINGS -->
    <section id="savings" class="section" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3>Savings ‚Äî Weekly & Monthly</h3>
        <div>
          <button class="btn ghost" onclick="openModal('addSaving')">Add Saving</button>
          <button class="btn" onclick="applySelectedPenalties()">Apply Selected Penalties</button>
        </div>
      </div>

      <div class="table-wrap" style="margin-bottom:12px">
        <h4 style="margin:8px 0">Weekly Savings (penalty KES 10 if unpaid by Sunday)</h4>
        <table id="weeklyTable"><thead><tr><th><input id="wkSelectAll" type="checkbox"></th><th>Member</th><th>Week</th><th>Required</th><th>Paid</th><th>Penalty</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table>
      </div>

      <div class="table-wrap">
        <h4 style="margin:8px 0">Monthly Savings (penalty KES 50 if unpaid by 15th)</h4>
        <table id="monthlyTable"><thead><tr><th><input id="mnSelectAll" type="checkbox"></th><th>Member</th><th>Month</th><th>Required</th><th>Paid</th><th>Penalty</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table>
      </div>
    </section>

    <!-- LOANS -->
    <section id="loans" class="section" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3>Loans</h3>
        <div>
          <button class="btn ghost" onclick="openModal('addLoan')">Create Loan</button>
          <button class="btn warn" onclick="applyLoanAccrualNow()">Accrue Loan Penalties (Now)</button>
        </div>
      </div>

      <div class="table-wrap">
        <table id="loansTable">
          <thead><tr><th>Member</th><th>Principal</th><th>Balance</th><th>Interest</th><th>Due Date</th><th>Overdue Days</th><th>Penalty</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- TRANSACTIONS -->
    <section id="transactions" class="section" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3>Transactions</h3>
        <div><button class="btn ghost" onclick="exportTransactionsCSV()">Export CSV</button></div>
      </div>

      <div class="table-wrap">
        <table id="transactionsTable"><thead><tr><th>Date</th><th>Member</th><th>Type</th><th>Description</th><th>Amount</th></tr></thead><tbody></tbody></table>
      </div>
    </section>

    <section id="investments" class="section" style="display:none">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <h3>Investments</h3>
    <button class="btn ghost" onclick="openModal('addInvestment')">Add Investment</button>
  </div>
<!-- INVESTMENTS -->
  <div class="table-wrap">
    <table id="investmentsTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Amount</th>
          <th>Start Date</th>
          <th>Expected Return</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>
<!-- STAFF -->
<section id="staff" class="section" style="display:none">
  <h3>Staff & Officials</h3>
  <div class="table-wrap">
    <table id="staffTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Role</th>
          <th>Phone</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>
<!-- ORGANIZATION DOCUMENTS -->
<section id="documents" class="section" style="display:none">
  <h3>Organization Documents</h3>
  <input type="file" id="docFile">
  <button class="btn small" onclick="uploadDoc()">Upload</button>

  <div class="table-wrap" style="margin-top:10px">
    <table id="docsTable">
      <thead><tr><th>Name</th><th>Uploaded</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</section>


    <!-- RECEIPTS / PDFs -->
    <section id="receipts" class="section" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3>Receipts & Statements</h3>
        <div>
          <button class="btn" onclick="downloadAllSample()">Download Sample Statement (demo)</button>
        </div>
      </div>

      <div class="card-grid">
        <div class="card">
          <h3>Member Statement</h3>
          <p>Generate a full statement for a member (includes savings, loans, penalties)</p>
          <div style="margin-top:8px">
            <input id="statementMemberId" placeholder="Member ID" style="padding:8px;border-radius:6px;border:1px solid #e6eef0;width:60%">
            <button class="btn small" onclick="downloadFullStatement()">Download</button>
          </div>
        </div>

        <div class="card">
          <h3>Savings Receipt</h3>
          <p>Generate saving receipt for a payment</p>
          <div style="margin-top:8px">
            <input id="receiptMemberId" placeholder="Member ID" style="padding:8px;border-radius:6px;border:1px solid #e6eef0;width:60%">
            <button class="btn small" onclick="downloadSavingReceipt()">Download</button>
          </div>
        </div>

        <div class="card">
          <h3>Loan Receipt</h3>
          <p>Generate loan receipt</p>
          <div style="margin-top:8px">
            <input id="loanReceiptId" placeholder="Loan ID" style="padding:8px;border-radius:6px;border:1px solid #e6eef0;width:60%">
            <button class="btn small" onclick="downloadLoanReceipt()">Download</button>
          </div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="settings" class="section" style="display:none">
      <h3>Settings</h3>
      <div class="card" style="margin-top:8px">
        <label>Weekly penalty (KES)</label>
        <input id="cfgWeekly" type="number" value="10" />
        <label style="margin-top:8px">Monthly penalty (KES)</label>
        <input id="cfgMonthly" type="number" value="50" />
        <label style="margin-top:8px">Loan daily penalty rate (e.g. 0.01 = 1% per day)</label>
        <input id="cfgLoanRate" type="number" step="0.001" value="0.02" />
        <div class="flex-end">
          <button class="btn" onclick="saveSettings()">Save</button>
        </div>
        <div class="note">Settings update will be sent to server (persisted).</div>
      </div>
    </section>

  </main>
</div>

<!-- MODALS -->
<div id="modal" class="modal">
  <div class="panel" id="modalPanel"></div>
</div>

<!-- scripts: jsPDF & autoTable (CDN) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<script>
/*
  Admin Frontend JS (vanilla)
  Expected backend API endpoints (implement these server-side):
    GET  /api/admins
    POST /api/admins
    GET  /api/members
    GET  /api/members/:id
    POST /api/members
    GET  /api/savings/weekly
    GET  /api/savings/monthly
    POST /api/savings (create payment)
    POST /api/savings/apply-penalty (body: { ids: [] })
    GET  /api/loans
    POST /api/loans
    POST /api/loans/accrue  -> run accrual logic on server (recommended)
    POST /api/cron/run-accrual  (optional)
    GET  /api/transactions
    GET  /api/reports/member-statement/:memberId
    POST /api/settings (persist config)
  Note: adapt endpoints and payloads to your backend.
*/

const API_BASE = 'http://localhost:5000/api'; // <-- change to your backend
let SETTINGS = { weeklyPenalty: 10, monthlyPenalty: 50, loanDailyRate: 0.02 };

// simple helpers
const $ = id => document.getElementById(id);
const show = (sec)=>{ document.querySelectorAll('.section').forEach(s=>s.style.display='none'); const el=$(sec); if(el) el.style.display='block'; }
document.querySelectorAll('.menu-link').forEach(a=>{
  a.addEventListener('click', e=>{
    e.preventDefault();
    document.querySelectorAll('.menu-link').forEach(x=>x.classList.remove('active'));
    a.classList.add('active');
    show(a.dataset.section);
  });
});

// modal
function openModal(panel){
  const modal = $('modal'); const mp = $('modalPanel'); modal.style.display='flex';
  if(panel==='createAdmin'){
    mp.innerHTML = `<h3>Create Admin</h3>
      <label>Name</label><input id="ad_name">
      <label>Email</label><input id="ad_email">
      <label>Phone</label><input id="ad_phone">
      <label>Role</label><select id="ad_role"><option>superadmin</option><option>treasurer</option><option>secretary</option></select>
      <div class="flex-end"><button class="btn" onclick="createAdmin()">Save</button><button class="btn ghost" onclick="closeModal()">Close</button></div>`;
  }
  if(panel==='addMember'){
    mp.innerHTML = `<h3>Add Member</h3>
      <label>Name</label><input id="m_name">
      <label>Member ID</label><input id="m_id">
      <label>Phone</label><input id="m_phone">
      <div class="flex-end"><button class="btn" onclick="saveMember()">Save</button><button class="btn ghost" onclick="closeModal()">Close</button></div>`;
  }
  if(panel==='addSaving'){
    mp.innerHTML = `<h3>Add Saving</h3>
      <label>Member ID</label><input id="s_mid" placeholder="memberId or internal ID">
      <label>Member name</label><input id="s_memberName" placeholder="Member full name (required)">
      <label>Type</label><select id="s_type"><option value="weekly">weekly</option><option value="monthly">monthly</option></select>
      <label>Required amount (required)</label><input id="s_requiredAmount" type="number" placeholder="e.g. 200">
      <label>Period (required) ‚Äî e.g. 2025-W10 or 2025-03</label><input id="s_period" placeholder="period identifier">
      <label>Amount paid (optional)</label><input id="s_amount" type="number" placeholder="paid amount">
      <div class="flex-end"><button class="btn" onclick="saveSaving()">Save</button><button class="btn ghost" onclick="closeModal()">Close</button></div>
      <div class="note">Make sure required amount, period and member name are provided to satisfy backend validation.</div>`;
  }
  if(panel==='addLoan'){
    mp.innerHTML = `<h3>Create Loan</h3>
      <label>Member ID</label><input id="l_mid">
      <label>Principal</label><input id="l_amount" type="number">
      <label>Interest (%)</label><input id="l_rate" type="number" value="10">
      <label>Due Date</label><input id="l_due" type="date">
      <div class="flex-end"><button class="btn" onclick="saveLoan()">Create</button><button class="btn ghost" onclick="closeModal()">Close</button></div>`;
  }
}
function closeModal(){ $('modal').style.display='none'; $('modalPanel').innerHTML=''; }

if(panel==='addInvestment'){
  mp.innerHTML = `
    <h3>Add Investment</h3>
    <label>Name</label><input id="inv_name">
    <label>Type</label><select id="inv_type"><option>SACCO</option><option>Fixed Deposit</option><option>Project</option></select>
    <label>Amount (KES)</label><input id="inv_amount" type="number">
    <label>Expected Return (KES)</label><input id="inv_return" type="number">
    <label>Start Date</label><input id="inv_date" type="date">
    <div class="flex-end">
      <button class="btn" onclick="saveInvestment()">Save</button>
      <button class="btn ghost" onclick="closeModal()">Close</button>
    </div>`;
}


// persistence helpers
async function api(path, opts = {}) {
  try {
    const res = await fetch(API_BASE + path, Object.assign({
      headers: { 'Content-Type': 'application/json' }
    }, opts));
    if(!res.ok){
      const txt = await res.text();
      // prefer showing the textual error (server may return HTML with error message)
      let msg = txt || `API error ${res.status}`;
      // try to extract message from HTML if present
      const bodyText = (msg && msg.length > 0) ? msg : `HTTP ${res.status}`;
      throw new Error(bodyText);
    }
    // if no content
    if (res.status === 204) return null;
    return res.json();
  } catch(err){
    console.error('API',path,err);
    throw err;
  }
}

/* -------------------- FETCH & RENDER -------------------- */
async function fetchAndRender(){
  try {
    // stats
    const [members, weekly, monthly, loans, transactions, penalties] = await Promise.all([
      api('/members'),
      api('/savings/weekly'),
      api('/savings/monthly'),
      api('/loans'),
      api('/transactions'),
      api('/penalties/summary').catch(()=>({ total:0 }))
    ]);
    // compute stats
    $('statMembers').innerText = (members && members.length) ? members.length : 0;
    const totalSavings = ( (Array.isArray(weekly) ? weekly : []).reduce((s,r)=>s + (r.paidAmount||0) + (r.penaltyAmount||0),0)
                         + (Array.isArray(monthly) ? monthly : []).reduce((s,r)=>s + (r.paidAmount||0) + (r.penaltyAmount||0),0) );
    $('statSavings').innerText = 'KES ' + numberWithCommas(totalSavings);
    const outstandingLoans = (loans || []).reduce((s,l)=>s + (l.balance||0),0);
    $('statLoans').innerText = 'KES ' + numberWithCommas(outstandingLoans);
    $('statPenalties').innerText = 'KES ' + numberWithCommas((penalties.total||0));

    // overdue lists
    const overdueLoans = (loans || []).filter(l=>l.status==='overdue' || (new Date(l.dueDate) < new Date() && l.status==='active'));
    $('overdueLoansList').innerText = overdueLoans.slice(0,4).map(l=>`${l.memberName || l.memberId} KES ${l.balance}`).join(', ') || 'None';
    const overdueSavings = [ ...(weekly || []).filter(w=>w.status!=='paid' && w.penaltyApplied), ...(monthly || []).filter(m=>m.status!=='paid' && m.penaltyApplied) ];
    $('overdueSavingsList').innerText = overdueSavings.length ? `${overdueSavings.length} overdue items` : 'None';

    // render tables
    renderMembersTable(members || []);
    renderSavingsTables(weekly || [], monthly || []);
    renderLoansTable(loans || []);
    renderTransactionsTable(transactions || []);
  } catch(err){
    // show a compact message (server may return large HTML stacktrace)
    const msg = err && err.message ? err.message.replace(/\s+/g,' ').slice(0,1000) : 'Unknown error';
    alert('Failed to load data: ' + msg);
    console.error(err);
  }
}

/* MEMBERS */
function renderMembersTable(members){
  const tbody = document.querySelector('#membersTable tbody'); tbody.innerHTML='';
  members.forEach(m=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(m.name)}</td><td>${escapeHtml(m.memberId || m._id)}</td><td>${escapeHtml(m.phone||'')}</td><td>KES ${numberWithCommas(m.balance||0)}</td>
      <td>
        <button class="btn small" onclick="openMember('${m.memberId||m._id}')">View</button>
        <button class="btn ghost small" onclick="downloadFullStatement('${m.memberId||m._id}')">Statement</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* SAVINGS */
function renderSavingsTables(weekly, monthly){
  const wtbody = document.querySelector('#weeklyTable tbody'); wtbody.innerHTML='';
  weekly.forEach(w=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><input type="checkbox" data-id="${w._id}" class="wkchk"></td>
      <td>${escapeHtml(w.memberName || w.memberId || '')}</td><td>${escapeHtml(w.week || w.period || '')}</td><td>KES ${numberWithCommas(w.requiredAmount||0)}</td>
      <td>KES ${numberWithCommas(w.paidAmount||w.amount||0)}</td><td>${w.penaltyApplied ? 'KES '+numberWithCommas(w.penaltyAmount||0) : '-'}</td><td><span class="pill">${w.status}</span></td>
      <td>
        <button class="btn small" onclick="markSavingPaid('${w._id}','weekly')">Mark Paid</button>
        <button class="btn ghost small" onclick="applyPenaltySingle('${w._id}','weekly')">Apply Penalty</button>
        <button class="btn small" onclick="downloadSavingReceiptById('${w._id}')">Receipt</button>
      </td>`;
    wtbody.appendChild(tr);
  });

  const mtbody = document.querySelector('#monthlyTable tbody'); mtbody.innerHTML='';
  monthly.forEach(m=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><input type="checkbox" data-id="${m._id}" class="mnchk"></td>
      <td>${escapeHtml(m.memberName || m.memberId || '')}</td><td>${escapeHtml(m.month || m.period || '')}</td><td>KES ${numberWithCommas(m.requiredAmount||0)}</td>
      <td>KES ${numberWithCommas(m.paidAmount||m.amount||0)}</td><td>${m.penaltyApplied ? 'KES '+numberWithCommas(m.penaltyAmount||0) : '-'}</td><td><span class="pill">${m.status}</span></td>
      <td>
        <button class="btn small" onclick="markSavingPaid('${m._id}','monthly')">Mark Paid</button>
        <button class="btn ghost small" onclick="applyPenaltySingle('${m._id}','monthly')">Apply Penalty</button>
        <button class="btn small" onclick="downloadSavingReceiptById('${m._id}')">Receipt</button>
      </td>`;
    mtbody.appendChild(tr);
  });

  // select all
  $('wkSelectAll').onclick = e => document.querySelectorAll('.wkchk').forEach(cb=>cb.checked = e.target.checked);
  $('mnSelectAll').onclick = e => document.querySelectorAll('.mnchk').forEach(cb=>cb.checked = e.target.checked);
}

/* LOANS */
function renderLoansTable(loans){
  const tbody = document.querySelector('#loansTable tbody'); tbody.innerHTML='';
  loans.forEach(l=>{
    const due = new Date(l.dueDate || null); let overdueDays = 0;
    if(l.dueDate && new Date() > due) overdueDays = Math.floor((new Date() - due)/(1000*60*60*24));
    const penalty = (l.penaltiesTotal || 0) + ( (l.penaltyRate || SETTINGS.loanDailyRate) * (l.balance || 0) * overdueDays );
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(l.memberName || l.memberId || '')}</td>
      <td>KES ${numberWithCommas(l.principal||0)}</td>
      <td>KES ${numberWithCommas(l.balance||0)}</td>
      <td>${escapeHtml(l.interestRate || l.interest || '')}%</td>
      <td>${l.dueDate ? (new Date(l.dueDate)).toLocaleDateString() : '-'}</td>
      <td>${overdueDays}</td>
      <td>KES ${numberWithCommas(Math.round(penalty))}</td>
      <td><span class="pill">${l.status}</span></td>
      <td>
        <button class="btn small" onclick="applyLoanPenalty('${l._id}')">Apply Penalty</button>
        <button class="btn ghost small" onclick="downloadLoanReceiptById('${l._id}')">Receipt</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* TRANSACTIONS */
function renderTransactionsTable(tx){
  const tbody = document.querySelector('#transactionsTable tbody'); tbody.innerHTML='';
  (tx || []).forEach(t=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${t.createdAt ? (new Date(t.createdAt)).toLocaleString() : ''}</td>
      <td>${escapeHtml(t.memberName || t.memberId || '')}</td><td>${escapeHtml(t.type || '')}</td><td>${escapeHtml(t.description||'')}</td><td>KES ${numberWithCommas(t.amount||0)}</td>`;
    tbody.appendChild(tr);
  });
}
/* INVESTMENTS */
async function saveInvestment(){
  const payload = {
    name: $('inv_name').value,
    type: $('inv_type').value,
    amount: Number($('inv_amount').value),
    expectedReturn: Number($('inv_return').value),
    startDate: $('inv_date').value
  };
  await api('/investments',{method:'POST',body:JSON.stringify(payload)});
  closeModal(); fetchAndRender();
}

function renderInvestments(inv){
  const tbody = $('investmentsTable').querySelector('tbody');
  tbody.innerHTML='';
  inv.forEach(i=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${i.name}</td>
      <td>${i.type}</td>
      <td>KES ${numberWithCommas(i.amount)}</td>
      <td>${new Date(i.startDate).toLocaleDateString()}</td>
      <td>KES ${numberWithCommas(i.expectedReturn||0)}</td>
      <td><span class="pill">${i.status||'active'}</span></td>
      <td>
        <button class="btn small">View</button>
        <button class="btn ghost small">Edit</button>
      </td>`;
    tbody.appendChild(tr);
  });
}
/* STAFF */
function renderStaff(staff){
  const tbody=$('staffTable').querySelector('tbody');
  tbody.innerHTML='';
  staff.forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${s.name}</td>
      <td>${s.role}</td>
      <td>${s.phone||''}</td>
      <td><span class="pill">${s.status||'active'}</span></td>
      <td>
        <button class="btn small">Edit</button>
        <button class="btn danger small">Deactivate</button>
      </td>`;
    tbody.appendChild(tr);
  });
}


/* -------------------- ACTIONS -------------------- */
async function createAdmin(){
  try {
    const payload = { name: $('ad_name').value, email: $('ad_email').value, phone: $('ad_phone').value, role: $('ad_role').value };
    await api('/admins',{ method:'POST', body: JSON.stringify(payload) });
    closeModal(); fetchAndRender();
  } catch(e){ alert('Create admin failed: '+shortErr(e)); }
}
async function saveMember(){
  try {
    const payload = { name: $('m_name').value, memberId: $('m_id').value, phone: $('m_phone').value };
    await api('/members',{ method:'POST', body: JSON.stringify(payload) });
    closeModal(); fetchAndRender();
  } catch(e){ alert('Save member failed: '+shortErr(e)); }
}
async function saveSaving(){
  try {
    // map to backend-required fields
    const memberId = $('s_mid').value.trim();
    const memberName = $('s_memberName').value.trim();
    const type = $('s_type').value;
    const requiredAmount = Number($('s_requiredAmount').value);
    const period = $('s_period').value.trim();
    const amount = $('s_amount').value ? Number($('s_amount').value) : 0;

    // basic validation to avoid server validation error
    if(!memberName || !requiredAmount || !period){
      return alert('Please provide Member name, Required amount and Period (these are required).');
    }

    // payload: include requiredAmount, period, memberName and paidAmount if provided
    const payload = {
      memberId,
      memberName,
      type,
      requiredAmount,
      period,
      paidAmount: amount || 0
    };

    await api('/savings',{ method:'POST', body: JSON.stringify(payload) });
    closeModal(); fetchAndRender();
  } catch(e){ alert('Save saving failed: '+shortErr(e)); }
}
async function saveLoan(){
  try {
    const payload = { memberId: $('l_mid').value, principal: Number($('l_amount').value), interestRate: Number($('l_rate').value), dueDate: $('l_due').value };
    await api('/loans',{ method:'POST', body: JSON.stringify(payload) });
    closeModal(); fetchAndRender();
  } catch(e){ alert('Save loan failed: '+shortErr(e)); }
}
async function markSavingPaid(id,type){
  if(!confirm('Mark as paid?')) return;
  try {
    await api(`/savings/${id}/mark-paid`, { method:'POST' });
    fetchAndRender();
  } catch(e){ alert('Mark paid failed: '+shortErr(e)); }
}
async function applyPenaltySingle(id,type){
  try {
    const body = { ids: [id], type };
    await api('/savings/apply-penalty', { method:'POST', body: JSON.stringify(body) });
    fetchAndRender();
  } catch(e){ alert('Apply penalty failed: '+shortErr(e)); }
}
async function applySelectedPenalties(){
  try {
    const wIds = Array.from(document.querySelectorAll('.wkchk:checked')).map(n=>n.dataset.id);
    const mIds = Array.from(document.querySelectorAll('.mnchk:checked')).map(n=>n.dataset.id);
    const ids = [...wIds, ...mIds];
    if(!ids.length){ alert('Select items first'); return; }
    await api('/savings/apply-penalty',{ method:'POST', body: JSON.stringify({ ids }) });
    fetchAndRender();
  } catch(e){ alert('Apply selected penalties failed: '+shortErr(e)); }
}

/* LOAN penalty actions */
async function applyLoanPenalty(loanId){
  if(!confirm('Apply loan penalty now?')) return;
  try {
    await api(`/loans/${loanId}/apply-penalty`, { method:'POST' });
    fetchAndRender();
  } catch(e){ alert('Apply loan penalty failed: '+shortErr(e)); }
}
async function runPenaltyNow(){
  try {
    await api('/cron/run-savings-penalties', { method:'POST' });
    fetchAndRender();
    alert('Savings penalty job triggered on server (if endpoint implemented).');
  } catch(e){ alert('Run penalty failed: '+shortErr(e)); }
}
async function applyLoanAccrualNow(){
  try {
    await api('/cron/run-loan-accrual', { method:'POST' });
    fetchAndRender();
    alert('Loan accrual job triggered on server (if endpoint implemented).');
  } catch(e){ alert('Loan accrual failed: '+shortErr(e)); }
}
/* staff render */
function renderStaff(staff){
  const tbody=$('staffTable').querySelector('tbody');
  tbody.innerHTML='';
  staff.forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${s.name}</td>
      <td>${s.role}</td>
      <td>${s.phone||''}</td>
      <td><span class="pill">${s.status||'active'}</span></td>
      <td>
        <button class="btn small">Edit</button>
        <button class="btn danger small">Deactivate</button>
      </td>`;
    tbody.appendChild(tr);
  });
}


/* open member */
async function openMember(memberId){
  try {
    const m = await api('/members/'+memberId);
    const content = `<h3>${escapeHtml(m.name)}</h3>
      <div class="row"><div class="col"><label>Member ID</label><div>${escapeHtml(m.memberId)}</div></div><div class="col"><label>Phone</label><div>${escapeHtml(m.phone||'')}</div></div></div>
      <div class="row"><div class="col"><label>Balance</label><div>KES ${numberWithCommas(m.balance||0)}</div></div><div class="col"><label>Status</label><div>${escapeHtml(m.status||'active')}</div></div></div>
      <div class="flex-end"><button class="btn" onclick="downloadFullStatement('${memberId}')">Download Statement</button><button class="btn ghost" onclick="closeModal()">Close</button></div>`;
    $('modalPanel').innerHTML = content; $('modal').style.display='flex';
  } catch(e){ alert('Open member failed: '+shortErr(e)); }
}


async function uploadDoc(){
  const f=$('docFile').files[0];
  if(!f) return alert('select file');
  const fd=new FormData();
  fd.append('file',f);
  await fetch(API_BASE+'/documents',{method:'POST',body:fd});
  fetchAndRender();
}

/* EXPORTS & CSV */
function exportMembersCSV(){ alert('Implement server CSV export endpoint or build client CSV'); }
function exportTransactionsCSV(){ alert('Implement server CSV export endpoint or build client CSV'); }

/* LOGOUT */
function logout(){ localStorage.removeItem('vyg_token'); window.location.href = '/admin-login.html'; }

/* UTIL */
function numberWithCommas(x){ return (x||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
function escapeHtml(str){ if(!str && str !== 0) return ''; return String(str).replace(/[&<>"'`]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[s])); }
function shortErr(err){ if(!err) return 'Unknown'; const m = err.message || (err.toString && err.toString()) || ''; return m.length>800 ? m.slice(0,800)+'...' : m; }

/* -------------------- PDF GENERATION (jsPDF) -------------------- */
const { jsPDF } = window.jspdf;

async function downloadSavingReceipt(){
  const memberId = $('receiptMemberId').value.trim();
  if(!memberId) return alert('enter member id');
  try {
    const data = await api(`/reports/member-last-saving/${memberId}`);
    generateSavingReceiptPDF(data);
  } catch(e){ alert('Download saving receipt failed: '+shortErr(e)); }
}
async function downloadSavingReceiptById(id){
  try {
    const data = await api(`/savings/${id}`);
    generateSavingReceiptPDF(data);
  } catch(e){ alert('Download saving by id failed: '+shortErr(e)); }
}
function generateSavingReceiptPDF(data){
  const doc = new jsPDF({unit:'pt',format:'a4'});
  doc.setFontSize(18); doc.text('Visionary Youth Group', 40, 50);
  doc.setFontSize(12); doc.text('Savings Receipt', 40, 80);
  doc.setFontSize(10);
  doc.text(`Member: ${data.memberName || data.memberId || ''}`, 40, 110);
  doc.text(`Type: ${data.type || ''}`, 40, 125);
  doc.text(`Amount paid: KES ${data.paidAmount||data.amount||0}`, 40, 140);
  doc.text(`Penalty: KES ${data.penaltyAmount||0}`, 40, 155);
  doc.text(`Date: ${new Date(data.paidOn || data.createdAt).toLocaleString()}`, 40, 170);
  doc.text('Signature: ____________________', 40, 220);
  doc.save(`savings_receipt_${data.memberId || 'unknown'}.pdf`);
}

async function downloadLoanReceipt(){
  const loanId = $('loanReceiptId').value.trim();
  if(!loanId) return alert('enter loan id');
  try {
    const data = await api(`/loans/${loanId}`);
    generateLoanReceiptPDF(data);
  } catch(e){ alert('Download loan receipt failed: '+shortErr(e)); }
}
async function downloadLoanReceiptById(id){
  try {
    const data = await api(`/loans/${id}`);
    generateLoanReceiptPDF(data);
  } catch(e){ alert('Download loan by id failed: '+shortErr(e)); }
}
function generateLoanReceiptPDF(data){
  const doc = new jsPDF({unit:'pt',format:'a4'});
  doc.setFontSize(18); doc.text('Visionary Youth Group', 40, 50);
  doc.setFontSize(12); doc.text('Loan Receipt / Statement', 40, 80);
  doc.setFontSize(10);
  doc.text(`Member: ${data.memberName || data.memberId || ''}`, 40, 110);
  doc.text(`Principal: KES ${numberWithCommas(data.principal||data.amount||0)}`, 40, 125);
  doc.text(`Balance: KES ${numberWithCommas(data.balance||0)}`, 40, 140);
  doc.text(`Interest Rate: ${data.interestRate||data.interest||0}%`, 40, 155);
  doc.text(`Penalties: KES ${numberWithCommas(data.penaltiesTotal||0)}`, 40, 170);
  doc.text(`Due date: ${data.dueDate ? (new Date(data.dueDate)).toLocaleDateString() : '-'}`, 40, 185);
  doc.save(`loan_receipt_${data._id || 'unknown'}.pdf`);
}

/* Full statement (combines savings, loans, penalties) */
async function downloadFullStatement(memberId){
  if(!memberId) memberId = $('statementMemberId').value.trim();
  if(!memberId) return alert('enter member id');
  try {
    const report = await api(`/reports/member-statement/${memberId}`);
    generateFullStatementPDF(report);
  } catch(e){ alert('Download statement failed: '+shortErr(e)); }
}
function generateFullStatementPDF(report){
  const doc = new jsPDF({unit:'pt',format:'a4'});
  doc.setFontSize(18); doc.text('Visionary Youth Group', 40, 50);
  doc.setFontSize(12); doc.text('Member Full Statement', 40, 80);
  doc.setFontSize(10);
  doc.text(`Name: ${report.member.name || report.member.memberId}`, 40, 110);
  doc.text(`Member ID: ${report.member.memberId}`, 40, 125);
  doc.text(`Date: ${new Date().toLocaleString()}`, 40, 140);

  // savings table
  doc.autoTable({
    startY: 160,
    head: [['Type','Period','Paid','Penalty','Status','Date']],
    body: (report.savings || []).map(s=>[s.type, s.period, `KES ${s.paidAmount||0}`, `KES ${s.penaltyAmount||0}`, s.status, (new Date(s.paidOn||s.createdAt)).toLocaleDateString()])
  });

  // loans table
  doc.autoTable({
    startY: doc.lastAutoTable ? doc.lastAutoTable.finalY + 12 : 260,
    head: [['Loan','Principal','Balance','Penalties','Status','Due Date']],
    body: (report.loans || []).map(l=>[l._id, `KES ${l.principal}`, `KES ${l.balance}`, `KES ${l.penaltiesTotal||0}`, l.status, (new Date(l.dueDate)).toLocaleDateString()])
  });

  doc.save(`full_statement_${report.member.memberId}.pdf`);
}

/* SAMPLE download to test without backend */
async function downloadAllSample(){
  const sample = {
    member: { name:'Sample Member', memberId:'S001' },
    savings: [{ type:'weekly', period:'2025-W10', paidAmount:200, penaltyAmount:0, status:'paid', paidOn: new Date() }],
    loans: [{ _id:'L001', principal:5000, balance:2500, penaltiesTotal:50, status:'active', dueDate: new Date() }]
  };
  generateFullStatementPDF(sample);
}

/* -------------------- server commands -------------------- */
$('runAccrualBtn').addEventListener('click', async ()=>{
  try { await api('/cron/run-loan-accrual',{ method:'POST' }); alert('Accrual triggered'); fetchAndRender(); } catch(e){ alert('Failed to trigger accrual: '+shortErr(e)); }
});

/* SETTINGS persistence */
async function saveSettings(){
  SETTINGS.weeklyPenalty = Number($('cfgWeekly').value);
  SETTINGS.monthlyPenalty = Number($('cfgMonthly').value);
  SETTINGS.loanDailyRate = Number($('cfgLoanRate').value);
  try { await api('/settings',{ method:'POST', body: JSON.stringify(SETTINGS) }); alert('Saved'); } catch(e){ alert('Save failed: '+shortErr(e)); }
}

/* INIT load */
fetchAndRender();

// expose functions to global scope used by onclicks (for inline handlers)
window.saveLoan = saveLoan;
window.createAdmin = createAdmin;
window.saveMember = saveMember;
window.saveSaving = saveSaving;
window.openModal = openModal;
window.closeModal = closeModal;
window.applyPenaltySingle = applyPenaltySingle;
window.markSavingPaid = markSavingPaid;
window.applySelectedPenalties = applySelectedPenalties;
window.numberWithCommas = numberWithCommas;
window.downloadSavingReceipt = downloadSavingReceipt;
window.downloadLoanReceipt = downloadLoanReceipt;
window.downloadFullStatement = downloadFullStatement;
window.applyLoanAccrualNow = applyLoanAccrualNow;
window.runPenaltyNow = runPenaltyNow;
window.downloadSavingReceiptById = downloadSavingReceiptById;
window.downloadLoanReceiptById = downloadLoanReceiptById;
window.applyLoanPenalty = applyLoanPenalty;

/* End */
</script>
</body>
</html>

