<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Loan Application — Visionary Youth Group</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f172a;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8}
    *{box-sizing:border-box;font-family:'Poppins',system-ui,Segoe UI,Roboto,Arial}
    body{margin:0;background:linear-gradient(135deg,#071033 0%,#052230 60%), url('') no-repeat center/cover;min-height:100vh;color:#e6eef6}
    .container{max-width:1100px;margin:40px auto;padding:28px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:16px;box-shadow:0 10px 30px rgba(2,6,23,0.7)}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    header h1{font-size:20px;margin:0}
    .wizard{display:flex;gap:12px;margin-bottom:18px;flex-wrap:wrap}
    .step{padding:10px 12px;border-radius:10px;background:rgba(255,255,255,0.03);cursor:pointer}
    .step.active{background:linear-gradient(90deg,var(--accent),#0ea5a9);color:#04202a;font-weight:700}
    form{background:transparent;padding:8px}
    .card{background:var(--card);padding:18px;border-radius:12px;margin-bottom:14px}
    label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
    input[type=text],input[type=date],input[type=number],select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .actions{display:flex;justify-content:space-between;gap:12px}
    button{background:var(--accent);border:none;padding:10px 14px;border-radius:10px;color:#04202a;font-weight:700;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .small{font-size:13px;color:var(--muted)}
    .file-list{margin-top:8px;font-size:13px}
    .guarantors-list, .parents-list{margin-top:8px}
    .add-btn{background:transparent;border:1px dashed rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:var(--muted);cursor:pointer}
    .review{white-space:pre-wrap;font-family:monospace;background:rgba(0,0,0,0.15);padding:12px;border-radius:8px}
    footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
    .note{font-size:13px;color:var(--muted)}
    @media (max-width:720px){.two{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div style="width:56px;height:56px;border-radius:12px;background:linear-gradient(90deg,#06b6d4,#0ea5a9);display:flex;align-items:center;justify-content:center;font-weight:700;color:#021018">VYG</div>
      <div>
        <h1>Loan application (Admin) — Wizard</h1>
        <div class="small">Fill the tabs, verify IDs against members and generate a downloadable PDF on submit.</div>
      </div>
    </header>

    <nav class="wizard" id="wizardNav"></nav>

    <form id="loanForm" class="card">
      <!-- STEP PANES -->
      <div id="stepContainer"></div>

      <div class="actions">
        <button type="button" id="prevBtn" class="ghost">← Back</button>
        <div style="display:flex;gap:8px">
          <button type="button" id="saveDraft">Save draft</button>
          <button type="button" id="nextBtn">Next →</button>
        </div>
      </div>
    </form>

    <footer>
      <div class="note">Files are uploaded to Firebase Storage and application saved to RTDB. Replace the Firebase config inside the script.</div>
      <div class="small">Designed for Visionary Youth Group • Admin</div>
    </footer>
  </div>

  <!-- Libraries -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // ---------- CONFIGURE FIREBASE ----------
    // Replace with your Firebase config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "...",
      appId: "..."
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    // ---------- UI / Steps ----------
    const steps = [
      { id:'personal', title:'Personal Info' },
      { id:'permanent', title:'Permanent Residence' },
      { id:'residence', title:'Residence' },
      { id:'education', title:'Education' },
      { id:'loan', title:'Loan Details' },
      { id:'guarantors', title:'Guarantors' },
      { id:'parents', title:'Parents' },
      { id:'review', title:'Review & Submit' }
    ];

    const wizardNav = document.getElementById('wizardNav');
    const stepContainer = document.getElementById('stepContainer');
    let currentStep = 0;
    const formData = { guarantors: [], parents: [] };

    function renderWizard(){
      wizardNav.innerHTML = '';
      steps.forEach((s,i)=>{
        const el = document.createElement('div');
        el.className = 'step' + (i===currentStep? ' active':'');
        el.textContent = (i+1)+'. '+s.title;
        el.onclick = ()=>{ goToStep(i); };
        wizardNav.appendChild(el);
      });
      renderStep();
    }

    // ---------- DATA SOURCES (counties sample) ----------
    const counties = [
      'Mombasa','Kwale','Kilifi','Tana River','Lamu','Taita-Taveta','Garissa','Wajir','Mandera','Marsabit','Isiolo','Meru','Tharaka-Nithi','Embu','Kitui','Machakos','Makueni','Nyandarua','Nyeri','Kirinyaga','Murang'a','Kiambu','Turkana','West Pokot','Samburu','Trans Nzoia','Uasin Gishu','Elgeyo-Marakwet','Nandi','Baringo','Laikipia','Nakuru','Narok','Kajiado','Kericho','Bomet','Kakamega','Vihiga','Bungoma','Busia','Siaya','Kisumu','Homa Bay','Migori','Kisii','Nyamira','Nairobi'
    ];

    // NOTE: Constituencies and wards are MANY. For correctness, load them from your database or an API.
    // Example structure for dynamic population (replace with full mapping or fetch from RTDB):
    const exampleConstituencies = {
      'Nairobi': ['Westlands','Langata','Starehe','Kasarani'],
      'Kiambu': ['Kiambu','Githunguri','Kabete']
    };
    const exampleWards = {
      'Westlands':['Kangemi','Karura','Parklands'],
      'Langata':['Karen','Langata East']
    };

    // ---------- RENDER STEPS ----------
    function renderStep(){
      const step = steps[currentStep];
      stepContainer.innerHTML = '';
      if(step.id==='personal') stepContainer.appendChild(personalPane());
      if(step.id==='permanent') stepContainer.appendChild(permanentPane());
      if(step.id==='residence') stepContainer.appendChild(residencePane());
      if(step.id==='education') stepContainer.appendChild(educationPane());
      if(step.id==='loan') stepContainer.appendChild(loanPane());
      if(step.id==='guarantors') stepContainer.appendChild(guarantorsPane());
      if(step.id==='parents') stepContainer.appendChild(parentsPane());
      if(step.id==='review') stepContainer.appendChild(reviewPane());
      renderWizard();
    }

    function personalPane(){
      const wrap = document.createElement('div');
      wrap.innerHTML = `
        <h3>Personal information</h3>
        <div class="two">
          <div>
            <label>First name</label><input id="first" type="text">
          </div>
          <div>
            <label>Middle name</label><input id="middle" type="text">
          </div>
        </div>
        <div class="two">
          <div>
            <label>Last name</label><input id="last" type="text">
          </div>
          <div>
            <label>ID number</label><input id="idno" type="text">
          </div>
        </div>
        <div class="two">
          <div><label>Date of birth</label><input id="dob" type="date"></div>
          <div><label>Marital status</label><select id="marital"><option>Single</option><option>Married</option><option>Divorced</option><option>Widowed</option></select></div>
        </div>
        <div class="two">
          <div><label>Telephone</label><input id="phone" type="text"></div>
          <div><label>Gender</label><select id="gender"><option>Male</option><option>Female</option><option>Other</option></select></div>
        </div>
        <div class="two">
          <div><label>Religion</label><input id="religion" type="text"></div>
          <div>
            <label>Upload ID (both sides) + Passport</label>
            <input id="idFront" type="file" accept="image/*,application/pdf"><br>
            <input id="idBack" type="file" accept="image/*,application/pdf"><br>
            <input id="passport" type="file" accept="image/*,application/pdf">
            <div class="file-list" id="fileListPersonal"></div>
          </div>
        </div>
      `;
      return wrap;
    }

    function permanentPane(){
      const wrap = document.createElement('div');
      wrap.innerHTML = `
        <h3>Permanent residence</h3>
        <div class="two">
          <div><label>Box No</label><input id="boxno" type="text"></div>
          <div><label>Postal Code</label><input id="postal" type="text"></div>
        </div>
        <div class="two">
          <div><label>Town</label><input id="town" type="text"></div>
          <div>
            <label>County</label>
            <select id="county"></select>
          </div>
        </div>
        <div class="two">
          <div><label>Constituency</label><select id="constituency"></select></div>
          <div><label>Ward</label><select id="ward"></select></div>
        </div>
        <div class="two">
          <div><label>Location</label><input id="location" type="text"></div>
          <div><label>Sub-location / Village</label><input id="sublocation" type="text"></div>
        </div>
      `;

      // populate counties
      setTimeout(()=>{
        const sel = wrap.querySelector('#county');
        counties.forEach(c=>{ const opt=document.createElement('option');opt.value=c;opt.textContent=c;sel.appendChild(opt);});
        // when county changes, load constituencies from exampleConstituencies or fetch from RTDB
        sel.onchange = (e)=>{
          const val=e.target.value;
          const cons = exampleConstituencies[val]||[];
          const csel = wrap.querySelector('#constituency'); csel.innerHTML='';
          cons.forEach(x=>{const o=document.createElement('option');o.value=x;o.textContent=x;csel.appendChild(o)});
          csel.onchange();
        };
        wrap.querySelector('#county').dispatchEvent(new Event('change'));
        wrap.querySelector('#constituency').onchange = (ev)=>{
          const vv = ev.target.value;
          const wards = exampleWards[vv]||[];
          const wsel = wrap.querySelector('#ward'); wsel.innerHTML='';
          wards.forEach(x=>{const o=document.createElement('option');o.value=x;o.textContent=x;wsel.appendChild(o)});
        };
      },100);

      return wrap;
    }

    function residencePane(){
      const wrap = document.createElement('div');
      wrap.innerHTML = `
        <h3>Residence</h3>
        <div class="two">
          <div><label>Nearest primary school</label><input id="nearestSchool" type="text"></div>
          <div><label>Village</label><input id="village" type="text"></div>
        </div>
        <div class="two">
          <div><label>Street</label><input id="street" type="text"></div>
          <div><label>Town</label><input id="resTown" type="text"></div>
        </div>
        <div class="two">
          <div><label>County</label><select id="resCounty"></select></div>
          <div><label>Constituency</label><select id="resCons"></select></div>
        </div>
      `;
      setTimeout(()=>{ const sel = wrap.querySelector('#resCounty'); counties.forEach(c=>{ const opt=document.createElement('option');opt.value=c;opt.textContent=c;sel.appendChild(opt);}); },50);
      return wrap;
    }

    function educationPane(){
      const wrap = document.createElement('div');
      wrap.innerHTML = `
        <h3>Education</h3>
        <div>
          <label>Level</label>
          <select id="edLevel"><option>KCPE</option><option>KCSE</option><option>Certificate</option><option>Diploma</option><option>Degree</option></select>
        </div>
        <div style="margin-top:12px">
          <label>Provide up to two records for the selected level</label>
          <div class="two">
            <div><label>Exam type</label><select id="examType1"><option>KCSE</option><option>KCPE</option><option>Certificate</option><option>Diploma</option><option>Degree</option></select>
                <label>Exam year</label><input id="examYear1" type="number"></div>
            <div><label>Index / Reg No</label><input id="index1" type="text"><label>Details/School</label><input id="school1" type="text"></div>
          </div>
          <div style="height:8px"></div>
          <div class="two">
            <div><label>Exam type</label><select id="examType2"><option>KCSE</option><option>KCPE</option><option>Certificate</option><option>Diploma</option><option>Degree</option></select>
                <label>Exam year</label><input id="examYear2" type="number"></div>
            <div><label>Index / Reg No</label><input id="index2" type="text"><label>Details/School</label><input id="school2" type="text"></div>
          </div>
        </div>
      `;
      return wrap;
    }

    function loanPane(){
      const wrap = document.createElement('div');
      wrap.innerHTML = `
        <h3>Loan details</h3>
        <div class="two">
          <div><label>Amount (KES)</label><input id="loanAmount" type="number"></div>
          <div><label>Purpose</label><input id="loanPurpose" type="text"></div>
        </div>
        <div class="two">
          <div><label>Installment (KES)</label><input id="installment" type="number"></div>
          <div><label>Date of first installment</label><input id="firstInst" type="date"></div>
        </div>
        <div class="two">
          <div><label>Date of last installment</label><input id="lastInst" type="date"></div>
          <div>
            <label>Upload support document</label>
            <input id="supportDoc" type="file" accept="image/*,application/pdf">
            <div class="file-list" id="fileListLoan"></div>
          </div>
        </div>
      `;
      return wrap;
    }

    function guarantorsPane(){
      const wrap = document.createElement('div');
      wrap.innerHTML = `
        <h3>Guarantors</h3>
        <div class="small">Add at least two guarantors. Guarantors must be registered members in the members DB.</div>
        <div style="margin-top:12px"><button id="addGuarantor" type="button" class="add-btn">+ Add guarantor</button></div>
        <div class="guarantors-list" id="guarantorsList"></div>
        <div style="margin-top:12px">
          <button id="downloadGuarantorPdf" type="button">Download guarantor agreement PDF (template)</button>
        </div>
      `;

      setTimeout(()=>{
        wrap.querySelector('#addGuarantor').onclick = addGuarantorForm;
        wrap.querySelector('#downloadGuarantorPdf').onclick = ()=>{ generateGuarantorPDF(); };
      },50);

      return wrap;
    }

    function parentsPane(){
      const wrap = document.createElement('div');
      wrap.innerHTML = `
        <h3>Parents / Next of kin</h3>
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <button id="addFather" type="button" class="add-btn">+ Add Father</button>
          <button id="addMother" type="button" class="add-btn">+ Add Mother</button>
        </div>
        <div class="parents-list" id="parentsList"></div>
      `;
      setTimeout(()=>{
        wrap.querySelector('#addFather').onclick = ()=> addParent('father');
        wrap.querySelector('#addMother').onclick = ()=> addParent('mother');
      },50);
      return wrap;
    }

    function reviewPane(){
      const wrap = document.createElement('div');
      wrap.innerHTML = `
        <h3>Review & Submit</h3>
        <div class="small">Check all the details then submit. A filled application PDF will download automatically and the record will be saved to RTDB.</div>
        <div style="margin-top:12px">
          <div id="reviewBox" class="review"></div>
        </div>
        <div style="margin-top:12px;display:flex;gap:10px">
          <button id="submitBtn">Submit application & Download PDF</button>
        </div>
      `;
      setTimeout(()=>{ wrap.querySelector('#submitBtn').onclick = submitApplication; updateReview(); },50);
      return wrap;
    }

    // ---------- Helpers to add guarantors / parents ----------
    function addGuarantorForm(){
      const id = Date.now();
      const container = document.getElementById('guarantorsList');
      const div = document.createElement('div');
      div.className='card';
      div.innerHTML = `
        <div class="two">
          <div><label>Name</label><input data-name id="g_name_${id}" type="text"></div>
          <div><label>Member No</label><input id="g_member_${id}" type="text"></div>
        </div>
        <div class="two">
          <div><label>ID no</label><input id="g_id_${id}" type="text"></div>
          <div><label>Phone</label><input id="g_phone_${id}" type="text"></div>
        </div>
        <div class="two">
          <div><label>Email</label><input id="g_email_${id}" type="email"></div>
          <div style="display:flex;align-items:center;gap:8px"><button id="verifyG_${id}" type="button">Verify member</button><button id="removeG_${id}" type="button" class="ghost">Remove</button></div>
        </div>
      `;
      container.appendChild(div);
      document.getElementById(`removeG_${id}`).onclick = ()=>{ div.remove(); }
      document.getElementById(`verifyG_${id}`).onclick = async ()=>{
        const memberNo = document.getElementById(`g_member_${id}`).value.trim();
        if(!memberNo) return alert('Enter member number');
        const ok = await verifyMemberByNumber(memberNo);
        if(ok){ alert('Guarantor is a registered member. Verified.'); } else alert('Member not found or not active');
      }
    }

    function addParent(kind){
      const id = Date.now();
      const container = document.getElementById('parentsList');
      const div = document.createElement('div');
      div.className='card';
      div.innerHTML = `
        <div class="two">
          <div><label>Name (${kind})</label><input id="p_name_${id}" type="text"></div>
          <div><label>Phone</label><input id="p_phone_${id}" type="text"></div>
        </div>
        <div class="two">
          <div><label>ID</label><input id="p_id_${id}" type="text"></div>
          <div><label>Email</label><input id="p_email_${id}" type="email"></div>
        </div>
      `;
      container.appendChild(div);
    }

    // ---------- NAV CONTROLS ----------
    document.getElementById('prevBtn').onclick = ()=>{ if(currentStep>0){ currentStep--; renderStep(); } };
    document.getElementById('nextBtn').onclick = ()=>{ if(currentStep<steps.length-1){ currentStep++; renderStep(); } }
    document.getElementById('saveDraft').onclick = saveDraft;

    function goToStep(i){ currentStep=i; renderStep(); }

    // ---------- SAVE/UPLOAD/VERIFY ----------
    async function saveDraft(){
      collectFormToObject();
      const id = 'draft_'+Date.now();
      await db.ref('loan_applications/'+id).set(formData);
      alert('Draft saved with id: '+id);
    }

    function collectFormToObject(){
      // Personal
      formData.first = document.getElementById('first')?.value||'';
      formData.middle = document.getElementById('middle')?.value||'';
      formData.last = document.getElementById('last')?.value||'';
      formData.idno = document.getElementById('idno')?.value||'';
      formData.dob = document.getElementById('dob')?.value||'';
      formData.marital = document.getElementById('marital')?.value||'';
      formData.phone = document.getElementById('phone')?.value||'';
      formData.gender = document.getElementById('gender')?.value||'';
      formData.religion = document.getElementById('religion')?.value||'';

      // Permanent
      formData.boxno = document.getElementById('boxno')?.value||'';
      formData.postal = document.getElementById('postal')?.value||'';
      formData.town = document.getElementById('town')?.value||'';
      formData.county = document.getElementById('county')?.value||'';
      formData.constituency = document.getElementById('constituency')?.value||'';
      formData.ward = document.getElementById('ward')?.value||'';
      formData.location = document.getElementById('location')?.value||'';
      formData.sublocation = document.getElementById('sublocation')?.value||'';

      // Residence
      formData.nearestSchool = document.getElementById('nearestSchool')?.value||'';
      formData.village = document.getElementById('village')?.value||'';
      formData.street = document.getElementById('street')?.value||'';
      formData.resTown = document.getElementById('resTown')?.value||'';
      formData.resCounty = document.getElementById('resCounty')?.value||'';

      // Education
      formData.level = document.getElementById('edLevel')?.value||'';
      formData.education = [
        {examType:document.getElementById('examType1')?.value, year:document.getElementById('examYear1')?.value, index:document.getElementById('index1')?.value, school:document.getElementById('school1')?.value},
        {examType:document.getElementById('examType2')?.value, year:document.getElementById('examYear2')?.value, index:document.getElementById('index2')?.value, school:document.getElementById('school2')?.value}
      ];

      // Loan
      formData.loan = { amount:document.getElementById('loanAmount')?.value, purpose:document.getElementById('loanPurpose')?.value, installment:document.getElementById('installment')?.value, firstInst:document.getElementById('firstInst')?.value, lastInst:document.getElementById('lastInst')?.value };

      // Guarantors
      const gcont = document.getElementById('guarantorsList');
      formData.guarantors = [];
      if(gcont){
        Array.from(gcont.querySelectorAll('input')).forEach(inp=>{
          const id = inp.id;
          const match = id.match(/g_(name|member|id|phone|email)_(\d+)/);
          if(match){
            const key = match[1]; const idx = match[2];
            let obj = formData.guarantors.find(x=>x.__id==idx);
            if(!obj){ obj={__id:idx}; formData.guarantors.push(obj); }
            obj[key] = inp.value;
          }
        });
      }

      // Parents
      const pcont = document.getElementById('parentsList'); formData.parents=[];
      if(pcont){
        Array.from(pcont.querySelectorAll('input')).forEach(inp=>{
          const id = inp.id; const match = id.match(/p_(name|phone|id|email)_(\d+)/);
          if(match){ const key=match[1]; const idx=match[2]; let obj=formData.parents.find(x=>x.__id==idx); if(!obj){obj={__id:idx};formData.parents.push(obj);} obj[key]=inp.value; }
        });
      }

      // Files: we don't embed them here; we will upload and save links on submit
    }

    async function submitApplication(){
      collectFormToObject();

      // confirm minimum guarantors
      if(!formData.guarantors || formData.guarantors.length<2){ return alert('Please add at least two guarantors'); }

      // Verify guarantors are members
      for(const g of formData.guarantors){
        if(!g.member){
          // try to use member number field
        }
      }

      const appId = 'loan_'+Date.now();
      // upload files then save
      const fileUploads = await uploadAllFiles(appId);
      formData.uploads = fileUploads;
      formData.appliedAt = new Date().toISOString();

      await db.ref('loan_applications/'+appId).set(formData);

      // generate PDF and download
      await generateLoanPDF(formData, appId);
      alert('Application submitted and saved with id: '+appId);
    }

    // ---------- File uploads ----------
    async function uploadAllFiles(appId){
      const storageRoot = storage.ref('loan_applications/'+appId);
      const uploads = {};
      const fids = ['idFront','idBack','passport','supportDoc'];
      for(const fid of fids){
        const el = document.getElementById(fid);
        if(el && el.files && el.files[0]){
          const file = el.files[0];
          const ref = storageRoot.child(fid+'_'+file.name);
          await ref.put(file);
          const url = await ref.getDownloadURL();
          uploads[fid]=url;
        }
      }
      return uploads;
    }

    // ---------- Verification helpers ----------
    async function verifyMemberByNumber(memberNo){
      try{
        const snap = await db.ref('members').orderByChild('memberNo').equalTo(memberNo).once('value');
        return snap.exists();
      }catch(e){ console.error(e); return false; }
    }

    async function verifyKenyaID(idno){
      // Simple check for numeric and length; for authoritative verification you must compare to your members DB
      if(!/^[0-9]{5,12}$/.test(idno)) return false;
      const snap = await db.ref('members').orderByChild('idno').equalTo(idno).once('value');
      return snap.exists();
    }

    // ---------- PDF generation ----------
    async function generateLoanPDF(data, appId){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:'pt', format:'a4'});
      const left=40; let y=40;
      doc.setFontSize(16); doc.text('Visionary Youth Group', left, y); y+=22;
      doc.setFontSize(12); doc.text('Loan Application ('+appId+')', left, y); y+=20;
      doc.setFontSize(10);
      doc.text(`Name: ${data.first||''} ${data.middle||''} ${data.last||''}`, left, y); y+=14;
      doc.text(`ID No: ${data.idno||''}`, left, y); y+=14;
      doc.text(`Phone: ${data.phone||''} | Email: ${data.email||''}`, left, y); y+=18;
      doc.text('---Permanent Residence---', left, y); y+=14;
      doc.text(`County: ${data.county||''} | Constituency: ${data.constituency||''} | Ward: ${data.ward||''}`, left, y); y+=18;
      doc.text('---Education---', left, y); y+=14;
      (data.education||[]).forEach(ed=>{ doc.text(`${ed.examType||''} - ${ed.index||''} (${ed.year||''}) - ${ed.school||''}`, left, y); y+=12; if(y>740){ doc.addPage(); y=40; } });
      y+=8; doc.text('---Loan---', left, y); y+=14;
      doc.text(`Amount: KES ${data.loan?.amount||''} | Purpose: ${data.loan?.purpose||''}`, left, y); y+=14;
      doc.text(`Installment: ${data.loan?.installment||''} | From: ${data.loan?.firstInst||''} To: ${data.loan?.lastInst||''}`, left, y); y+=24;
      doc.text('Guarantors:', left, y); y+=14;
      (data.guarantors||[]).forEach(g=>{ doc.text(`${g.name||g.member||''} | ID: ${g.id||''} | MemberNo: ${g.member||''}`, left, y); y+=12; if(y>740){ doc.addPage(); y=40; } });
      doc.setFontSize(9); doc.text('Generated on: '+new Date().toLocaleString(), left, y+30);

      // Add links to uploaded docs (note: PDFs cannot embed remote files easily; include URLs)
      y+=40; doc.setFontSize(10); doc.text('Attachments (links):', left, y); y+=12;
      const uploads = data.uploads||{}; Object.keys(uploads).forEach(k=>{ doc.text(`${k}: ${uploads[k]}`, left, y); y+=10; if(y>740){ doc.addPage(); y=40; } });

      // trigger download
      doc.save('loan_application_'+appId+'.pdf');
    }

    function generateGuarantorPDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:'pt', format:'a4'});
      doc.setFontSize(16); doc.text('Guarantor Agreement — Visionary Youth Group',40,40);
      doc.setFontSize(11);
      doc.text('I, the undersigned, agree to act as guarantor for the loan applied by the applicant. I confirm that the information I provide is true and I am a registered member of the society.\n\n',40,70);
      doc.text('Guarantor details:',40,120);
      doc.text('Name: ________________________',40,150);
      doc.text('Member No: ____________________',40,175);
      doc.text('ID No: ________________________',40,200);
      doc.text('Phone: ________________________',40,225);
      doc.text('Email: ________________________',40,250);
      doc.text('\nSignature: ______________________    Date: ____________',40,290);
      doc.save('guarantor_agreement_template.pdf');
    }

    // ---------- REVIEW UI ----------
    function updateReview(){ collectFormToObject(); document.getElementById('reviewBox').textContent = JSON.stringify(formData, null, 2); }

    // Update review when fields change (basic)
    document.addEventListener('input', ()=>{ if(steps[currentStep] && steps[currentStep].id==='review') updateReview(); });

    // Initialize
    renderWizard();

  </script>
</body>
</html>

## Wards
- Add full ward list here…
