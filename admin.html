<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Visionary Youth Group — Loan Application (Admin)</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --navy:#0f3b5f;
      --aqua:#3ec5c1;
      --card:#ffffff;
      --accent:#0e8a6e;
      --muted:#6b7280;
      --gold:#ffcc00;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:'Poppins',sans-serif;
      background:linear-gradient(135deg,var(--navy),var(--aqua));
      color:#06292a;
      -webkit-font-smoothing:antialiased;
      min-height:100vh;
      padding:28px;
    }
    .wrap{max-width:1100px;margin:0 auto;background:var(--card);border-radius:12px;padding:18px;box-shadow:0 18px 60px rgba(4,18,20,0.25)}
    header{display:flex;gap:12px;align-items:center;border-bottom:1px solid #eef7f6;padding-bottom:12px;margin-bottom:12px}
    .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--gold),#f0b400);display:flex;align-items:center;justify-content:center;font-weight:700;color:#00371a}
    .title h1{margin:0;font-size:1.15rem}
    .title p{margin:0;color:var(--muted);font-size:0.9rem}

    /* Wizard layout */
    .wizard{display:grid;grid-template-columns:320px 1fr;gap:18px;margin-top:12px}
    .steps{background:#f6fffb;padding:12px;border-radius:10px}
    .step-item{padding:10px;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:10px}
    .step-item.active{background:linear-gradient(90deg,#e8fff6,#f2fff5);border-left:4px solid var(--accent)}
    .step-item .num{width:30px;height:30px;border-radius:8px;background:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent);box-shadow:0 2px 6px rgba(2,50,30,0.06)}
    .content{padding:12px;border-radius:10px}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
    label{display:block;font-size:0.85rem;margin-bottom:6px;color:var(--muted)}
    input[type="text"], input[type="date"], input[type="email"], input[type="number"], select, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #dbeeea;font-size:0.95rem}
    textarea{min-height:90px}
    .full{grid-column:1/-1}
    .actions{display:flex;justify-content:space-between;gap:10px;margin-top:10px}
    .btn{background:var(--accent);color:#fff;padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    .btn.ghost{background:#fff;color:var(--accent);border:1px solid #dbeeea}
    .btn.download{background:linear-gradient(90deg,#145c2e,#0e8a6e)}
    .small{font-size:0.85rem;color:var(--muted)}
    .uploads-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px}
    .upload-preview{border:1px dashed #cfeee8;padding:8px;border-radius:8px;text-align:center;background:#ffffff}
    .mini{font-size:0.8rem;color:var(--muted)}

    /* responsive */
    @media (max-width:940px){
      .wizard{grid-template-columns:1fr}
      .steps{display:flex;gap:6px;overflow:auto}
      .step-item{min-width:180px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" title="Visionary Eye">
        <i class="fas fa-eye" style="font-size:22px;color:#00371a"></i>
      </div>
      <div class="title">
        <h1>Loan Application — Admin Wizard</h1>
        <p>Visionary Youth Group — Integrity · Commitment · Entrepreneurial Nature</p>
      </div>
      <div style="margin-left:auto;text-align:right">
        <div class="small">Tel: 0741453336</div>
        <div class="small">Email: visionaryyouthgroup32@gmail.com</div>
        <div class="small">Nairobi, Kenya</div>
      </div>
    </header>

    <div class="wizard">
      <!-- steps -->
      <aside class="steps" id="steps">
        <div class="step-item active" data-step="1"><div class="num">1</div><div><strong>Personal Info</strong><div class="mini">Name, ID, DOB, Permanent residence & uploads</div></div></div>
        <div class="step-item" data-step="2"><div class="num">2</div><div><strong>Current Residence</strong><div class="mini">Nearest school, street, village, town</div></div></div>
        <div class="step-item" data-step="3"><div class="num">3</div><div><strong>Education</strong><div class="mini">Add multiple levels (KCSE, Degree…)</div></div></div>
        <div class="step-item" data-step="4"><div class="num">4</div><div><strong>Loan Details</strong><div class="mini">Amount, purpose, installments, support docs</div></div></div>
        <div class="step-item" data-step="5"><div class="num">5</div><div><strong>Guarantors</strong><div class="mini">Add at least two; download guarantor PDF</div></div></div>
        <div class="step-item" data-step="6"><div class="num">6</div><div><strong>Parents</strong><div class="mini">Father & Mother details</div></div></div>
        <div class="step-item" data-step="7"><div class="num">7</div><div><strong>Review & Submit</strong><div class="mini">Save to RTDB & download 2-page PDF</div></div></div>
      </aside>

      <!-- content -->
      <section class="content">
        <form id="loanForm">
          <!-- STEP 1 -->
          <div class="step-panel" data-step="1">
            <h3>Personal Information & Permanent Residence</h3>
            <div class="form-row">
              <div>
                <label>First Name</label>
                <input id="firstName" name="firstName" type="text" required />
              </div>
              <div>
                <label>Middle Name</label>
                <input id="middleName" name="middleName" type="text" />
              </div>
            </div>
            <div class="form-row">
              <div>
                <label>Last Name</label>
                <input id="lastName" name="lastName" type="text" required />
              </div>
              <div>
                <label>ID / Passport No.</label>
                <input id="idNo" name="idNo" type="text" required />
              </div>
            </div>
            <div class="form-row">
              <div>
                <label>Date of Birth</label>
                <input id="dob" type="date" />
              </div>
              <div>
                <label>Marital Status</label>
                <select id="marital">
                  <option>Single</option><option>Married</option><option>Divorced</option><option>Widowed</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div>
                <label>Telephone</label>
                <input id="tel" type="text" placeholder="07XXXXXXXX" />
              </div>
              <div>
                <label>Gender</label>
                <select id="gender"><option>Male</option><option>Female</option><option>Other</option></select>
              </div>
            </div>
            <div class="form-row">
              <div class="full">
                <label>Religion</label>
                <input id="religion" type="text" />
              </div>
            </div>

            <hr style="margin:12px 0">

            <h4>Permanent Residence (now inside Personal Info)</h4>
            <div class="form-row">
              <div>
                <label>Box No</label>
                <input id="perm_box" type="text" />
              </div>
              <div>
                <label>Postal Code</label>
                <input id="perm_postal" type="text" />
              </div>
            </div>
            <div class="form-row">
              <div>
                <label>Town</label>
                <input id="perm_town" type="text" />
              </div>
              <div>
                <label>County</label>
                <select id="perm_county" required></select>
              </div>
            </div>
            <div class="form-row">
              <div>
                <label>Constituency</label>
                <select id="perm_const" required><option value="">Select county first</option></select>
              </div>
              <div>
                <label>Ward</label>
                <select id="perm_ward" required><option value="">Select constituency first</option></select>
              </div>
            </div>
            <div class="form-row">
              <div>
                <label>Location</label>
                <input id="perm_location" type="text" />
              </div>
              <div>
                <label>Sub-location / Village</label>
                <input id="perm_subloc" type="text" />
              </div>
            </div>

            <div style="margin-top:10px">
              <label>Upload ID (Front)</label>
              <input id="idFront" type="file" accept="image/*,application/pdf" />
            </div>
            <div style="margin-top:10px">
              <label>Upload ID (Back)</label>
              <input id="idBack" type="file" accept="image/*,application/pdf" />
            </div>
            <div style="margin-top:10px">
              <label>Upload Passport Photo</label>
              <input id="passportPhoto" type="file" accept="image/*" />
            </div>

            <div class="actions">
              <div><button type="button" class="btn ghost" data-action="next">Next →</button></div>
              <div class="small">Step 1 of 7</div>
            </div>
          </div>

          <!-- STEP 2 -->
          <div class="step-panel" data-step="2" style="display:none">
            <h3>Current / Residence Details</h3>
            <div class="form-row">
              <div>
                <label>Nearest Primary School</label>
                <input id="res_school" type="text" />
              </div>
              <div>
                <label>Village</label>
                <input id="res_village" type="text" />
              </div>
            </div>
            <div class="form-row">
              <div>
                <label>Street</label>
                <input id="res_street" type="text" />
              </div>
              <div>
                <label>Town</label>
                <input id="res_town" type="text" />
              </div>
            </div>
            <div class="form-row">
              <div>
                <label>County</label>
                <select id="res_county"></select>
              </div>
              <div>
                <label>Constituency</label>
                <select id="res_const"><option>Select county first</option></select>
              </div>
            </div>
            <div class="form-row">
              <div class="full">
                <label>Any additional directions / notes</label>
                <textarea id="res_notes"></textarea>
              </div>
            </div>

            <div class="actions">
              <div><button type="button" class="btn ghost" data-action="prev">← Back</button></div>
              <div><button type="button" class="btn" data-action="next">Next →</button></div>
            </div>
          </div>

          <!-- STEP 3: Education (dynamic entries) -->
          <div class="step-panel" data-step="3" style="display:none">
            <h3>Education — Add one or more</h3>
            <div id="educationList"></div>
            <div style="margin-top:10px;display:flex;gap:8px">
              <button id="addEducation" type="button" class="btn ghost">+ Add Education</button>
              <button id="clearEducation" type="button" class="btn ghost">Clear</button>
            </div>

            <div class="actions">
              <div><button type="button" class="btn ghost" data-action="prev">← Back</button></div>
              <div><button type="button" class="btn" data-action="next">Next →</button></div>
            </div>
            <p class="small" style="margin-top:8px">For each level add exam type, institution, year, index no and optionally upload certificate.</p>
          </div>

          <!-- STEP 4: Loan details -->
          <div class="step-panel" data-step="4" style="display:none">
            <h3>Loan Details</h3>
            <div class="form-row">
              <div>
                <label>Amount (Ksh)</label>
                <input id="loan_amount" type="number" required />
              </div>
              <div>
                <label>Installment (Ksh)</label>
                <input id="loan_installment" type="number" />
              </div>
            </div>
            <div class="form-row">
              <div>
                <label>First Installment Date</label>
                <input id="loan_first" type="date" />
              </div>
              <div>
                <label>Last Installment Date</label>
                <input id="loan_last" type="date" />
              </div>
            </div>
            <div class="form-row">
              <div class="full">
                <label>Purpose / Use of Loan</label>
                <textarea id="loan_purpose"></textarea>
              </div>
            </div>
            <div style="margin-top:10px">
              <label>Upload supporting document (e.g. business plan)</label>
              <input id="loan_support" type="file" accept="image/*,application/pdf" />
            </div>

            <div class="actions">
              <div><button type="button" class="btn ghost" data-action="prev">← Back</button></div>
              <div><button type="button" class="btn" data-action="next">Next →</button></div>
            </div>
          </div>

          <!-- STEP 5: Guarantors -->
          <div class="step-panel" data-step="5" style="display:none">
            <h3>Guarantors</h3>
            <div id="guarantorList"></div>
            <div style="display:flex;gap:8px;margin-top:10px">
              <button id="addGuarantor" type="button" class="btn ghost">+ Add Guarantor</button>
              <button id="downloadGuarantorTemplate" type="button" class="btn download">Download Guarantor Form (PDF)</button>
            </div>
            <div class="actions">
              <div><button type="button" class="btn ghost" data-action="prev">← Back</button></div>
              <div><button type="button" class="btn" data-action="next">Next →</button></div>
            </div>
            <p class="small" style="margin-top:8px">Add at least two guarantors. You may download a blank guarantor PDF for signatures.</p>
          </div>

          <!-- STEP 6: Parents -->
          <div class="step-panel" data-step="6" style="display:none">
            <h3>Parents / Next of Kin</h3>
            <div id="parentsList"></div>
            <div style="display:flex;gap:8px;margin-top:10px">
              <button id="addFather" type="button" class="btn ghost">+ Add Father</button>
              <button id="addMother" type="button" class="btn ghost">+ Add Mother</button>
            </div>

            <div class="actions">
              <div><button type="button" class="btn ghost" data-action="prev">← Back</button></div>
              <div><button type="button" class="btn" data-action="next">Next →</button></div>
            </div>
          </div>

          <!-- STEP 7: Review & Submit -->
          <div class="step-panel" data-step="7" style="display:none">
            <h3>Review & Submit</h3>
            <div id="reviewArea" style="border:1px solid #e9f7f3;padding:10px;border-radius:8px;background:#fbfffc;min-height:120px">Fill earlier steps then click Review</div>

            <div class="actions" style="margin-top:12px">
              <div><button type="button" class="btn ghost" data-action="prev">← Back</button></div>
              <div style="display:flex;gap:8px">
                <button id="btnPreview" type="button" class="btn ghost">Review</button>
                <button id="submitBtn" type="submit" class="btn download">✅ Submit & Download PDF</button>
              </div>
            </div>
            <p class="small" style="margin-top:8px">On submit the application is saved to Real-Time DB and a professional 2-page PDF is downloaded. Uploaded images are embedded.</p>
          </div>
        </form>
      </section>
    </div>
  </div>

  <!-- firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getDatabase, ref, push, set, get, child, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const { jsPDF } = window.jspdf;

    // ====== firebase config (use yours) ======
    const firebaseConfig = {
      apiKey: "AIzaSyA_OCu7HQ5HCH2OYx5dQ2Z1r7YPwQJave4",
      authDomain: "visionary-youth-grou-2024.firebaseapp.com",
      databaseURL: "https://visionary-youth-grou-2024-default-rtdb.firebaseio.com",
      projectId: "visionary-youth-grou-2024",
      storageBucket: "visionary-youth-grou-2024.appspot.com",
      messagingSenderId: "372978592717",
      appId: "1:372978592717:web:1c15aec728ee5f854f3284"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth ? getAuth(app) : null; // optional - if using auth
    const db = getDatabase(app);

    // UI refs
    const steps = document.querySelectorAll('.step-item');
    const panels = document.querySelectorAll('.step-panel');
    let currentStep = 1;

    // dynamic lists
    const educationList = document.getElementById('educationList');
    const addEducationBtn = document.getElementById('addEducation');
    const clearEducationBtn = document.getElementById('clearEducation');

    const guarantorList = document.getElementById('guarantorList');
    const addGuarantorBtn = document.getElementById('addGuarantor');
    const downloadGuarantorTemplateBtn = document.getElementById('downloadGuarantorTemplate');

    const parentsList = document.getElementById('parentsList');
    const addFatherBtn = document.getElementById('addFather');
    const addMotherBtn = document.getElementById('addMother');

    const permCounty = document.getElementById('perm_county');
    const permConst = document.getElementById('perm_const');
    const permWard = document.getElementById('perm_ward');

    const resCounty = document.getElementById('res_county');
    const resConst = document.getElementById('res_const');

    // basic counties list (47 counties)
    const counties = ["Mombasa","Kwale","Kilifi","Tana River","Lamu","Taita-Taveta","Garissa","Wajir","Mandera","Marsabit","Isiolo","Meru","Tharaka-Nithi","Embu","Kitui","Machakos","Makueni","Nyandarua","Nyeri","Kirinyaga","Murang'a","Kiambu","Turkana","West Pokot","Samburu","Trans-Nzoia","Uasin Gishu","Elgeyo-Marakwet","Nandi","Baringo","Laikipia","Nakuru","Narok","Kajiado","Kericho","Bomet","Kakamega","Vihiga","Bungoma","Busia","Siaya","Kisumu","Homa Bay","Migori","Kisii","Nyamira","Nairobi"];
    function populateCountySelect(s){
      s.innerHTML = '<option value="">Select county</option>';
      counties.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; s.appendChild(o); });
    }
    populateCountySelect(permCounty); populateCountySelect(resCounty);

    // minimal mapping of constituencies (you can expand later)
    const constituencyMap = {
      "Nairobi": ["Embakasi East","Embakasi West","Starehe","Lang'ata","Westlands","Dagoretti North"],
      "Kiambu": ["Kiharu","Githunguri","Thika","Gatundu South","Githunguri"],
      "Mombasa": ["Mvita","Kisauni","Likoni","Nyali"]
      // add more mappings as needed
    };

    function populateConstituencies(county, targetSelect){
      targetSelect.innerHTML = '<option value="">Select constituency</option>';
      if(!county) return;
      const list = constituencyMap[county] || [];
      if(list.length === 0){ targetSelect.innerHTML = '<option value="">(No predefined list) - enter town instead</option>'; return; }
      list.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; targetSelect.appendChild(o); });
    }

    permCounty.addEventListener('change', ()=> populateConstituencies(permCounty.value, permConst));
    resCounty.addEventListener('change', ()=> populateConstituencies(resCounty.value, resConst));
    permConst.addEventListener('change', ()=> { permWard.innerHTML = '<option>(Ward list unavailable)</option>'; });

    // step navigation
    function showStep(n){
      currentStep = n;
      panels.forEach(p => p.style.display = p.dataset.step == n ? 'block' : 'none');
      steps.forEach(s => s.classList.toggle('active', Number(s.dataset.step) === n));
      window.scrollTo({top:0, behavior:'smooth'});
    }
    document.querySelectorAll('[data-action="next"]').forEach(b=> b.addEventListener('click', ()=> showStep(Math.min(7, currentStep+1))));
    document.querySelectorAll('[data-action="prev"]').forEach(b=> b.addEventListener('click', ()=> showStep(Math.max(1, currentStep-1))));
    steps.forEach(s => s.addEventListener('click', ()=> showStep(Number(s.dataset.step))));

    // education dynamic
    function makeEducationEntry(data){
      const idx = Date.now() + Math.random();
      const wrap = document.createElement('div');
      wrap.className = 'edu-entry';
      wrap.style.border = '1px solid #e6f6f1';
      wrap.style.padding = '8px'; wrap.style.marginBottom='8px'; wrap.style.borderRadius='8px';
      wrap.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Education</strong>
          <div style="display:flex;gap:8px">
            <button type="button" class="btn ghost btn-ed-remove">Remove</button>
          </div>
        </div>
        <div class="form-row" style="margin-top:8px">
          <div>
            <label>Level</label>
            <select class="edu-level"><option>KCPE</option><option>KCSE</option><option>Certificate</option><option>Diploma</option><option>Degree</option><option>Other</option></select>
          </div>
          <div>
            <label>Exam Type</label>
            <select class="edu-exam"><option>KCPE</option><option>KCSE</option><option>Certification</option><option>Degree</option><option>Other</option></select>
          </div>
        </div>
        <div class="form-row" style="margin-top:8px">
          <div>
            <label>Institution</label><input class="edu-institution" type="text" />
          </div>
          <div>
            <label>Exam Year</label><input class="edu-year" type="number" />
          </div>
        </div>
        <div class="form-row" style="margin-top:8px">
          <div class="full">
            <label>Index / Reg No</label><input class="edu-index" type="text" />
          </div>
        </div>
        <div style="margin-top:8px">
          <label>Upload Certificate (optional)</label>
          <input class="edu-upload" type="file" accept="image/*,application/pdf" />
        </div>
      `;
      if(data){
        wrap.querySelector('.edu-level').value = data.level || '';
        wrap.querySelector('.edu-exam').value = data.exam || '';
        wrap.querySelector('.edu-institution').value = data.institution || '';
        wrap.querySelector('.edu-year').value = data.year || '';
        wrap.querySelector('.edu-index').value = data.index || '';
      }
      wrap.querySelector('.btn-ed-remove').addEventListener('click', ()=> wrap.remove());
      educationList.appendChild(wrap);
      return wrap;
    }
    addEducationBtn.addEventListener('click', ()=> makeEducationEntry());
    clearEducationBtn.addEventListener('click', ()=> educationList.innerHTML = '');

    // guarantors
    function makeGuarantorEntry(data){
      const wrap = document.createElement('div');
      wrap.className = 'guar-entry';
      wrap.style.border = '1px solid #eef9f5'; wrap.style.padding = '8px'; wrap.style.marginBottom='8px'; wrap.style.borderRadius='8px';
      wrap.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Guarantor</strong>
          <div style="display:flex;gap:8px">
            <button type="button" class="btn ghost btn-guar-remove">Remove</button>
          </div>
        </div>
        <div class="form-row" style="margin-top:8px">
          <div><label>Name</label><input class="guar-name" type="text" /></div>
          <div><label>Member No</label><input class="guar-member" type="text" /></div>
        </div>
        <div class="form-row" style="margin-top:8px">
          <div><label>ID No</label><input class="guar-id" type="text" /></div>
          <div><label>Phone</label><input class="guar-phone" type="text" /></div>
        </div>
        <div style="margin-top:8px"><label>Email</label><input class="guar-email" type="email" /></div>
      `;
      if(data){
        wrap.querySelector('.guar-name').value = data.name || '';
        wrap.querySelector('.guar-member').value = data.memberNo || '';
        wrap.querySelector('.guar-id').value = data.id || '';
        wrap.querySelector('.guar-phone').value = data.phone || '';
        wrap.querySelector('.guar-email').value = data.email || '';
      }
      wrap.querySelector('.btn-guar-remove').addEventListener('click', ()=> wrap.remove());
      guarantorList.appendChild(wrap);
      return wrap;
    }
    addGuarantorBtn.addEventListener('click', ()=> makeGuarantorEntry());

    // parents
    function makeParentEntry(type, data){
      const wrap = document.createElement('div');
      wrap.className = 'parent-entry';
      wrap.style.border = '1px solid #eef9f5'; wrap.style.padding='8px'; wrap.style.marginBottom='8px'; wrap.style.borderRadius='8px';
      wrap.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>${type}</strong>
          <div style="display:flex;gap:8px"><button type="button" class="btn ghost btn-parent-remove">Remove</button></div>
        </div>
        <div class="form-row" style="margin-top:8px">
          <div><label>Name</label><input class="parent-name" type="text" /></div>
          <div><label>Phone</label><input class="parent-phone" type="text" /></div>
        </div>
        <div class="form-row" style="margin-top:8px">
          <div><label>ID</label><input class="parent-id" type="text" /></div>
          <div><label>Email</label><input class="parent-email" type="email" /></div>
        </div>
      `;
      if(data){
        wrap.querySelector('.parent-name').value = data.name || '';
        wrap.querySelector('.parent-phone').value = data.phone || '';
        wrap.querySelector('.parent-id').value = data.id || '';
        wrap.querySelector('.parent-email').value = data.email || '';
      }
      wrap.querySelector('.btn-parent-remove').addEventListener('click', ()=> wrap.remove());
      parentsList.appendChild(wrap);
      return wrap;
    }
    addFatherBtn.addEventListener('click', ()=> makeParentEntry('Father'));
    addMotherBtn.addEventListener('click', ()=> makeParentEntry('Mother'));

    // guarantor template generator (blank)
    downloadGuarantorTemplateBtn.addEventListener('click', ()=> {
      const doc = new jsPDF({unit:'pt', format:'a4'});
      doc.setFontSize(14); doc.text('Guarantor Declaration - Visionary Youth Group', 40, 50);
      doc.setFontSize(11); doc.text('This form is to be completed and signed by the guarantor. The guarantor accepts responsibility to repay if the borrower defaults.', 40, 70);
      let y = 110;
      const fields = ['Applicant Name','Applicant ID','Guarantor Name','Guarantor ID','Guarantor Phone','Guarantor Email','Guarantor Member No','Signature','Date'];
      fields.forEach(f => { doc.text(f+':', 40, y); doc.line(150, y-6, 540, y-6); y += 28; });
      doc.setFontSize(9); doc.text('Address: Tel: 0741453336 | Email: visionaryyouthgroup32@gmail.com', 40, 760);
      doc.save('Guarantor_Template.pdf');
    });

    // helper: read file as dataURL (image or pdf)
    function fileToDataURL(file){ return new Promise((res,rej)=>{
      if(!file) return res(null);
      const reader = new FileReader();
      reader.onload = ()=> res(reader.result);
      reader.onerror = rej;
      reader.readAsDataURL(file);
    }); }

    // collect form data
    async function collectFormData(){
      const data = {};
      // Personal
      data.firstName = document.getElementById('firstName').value.trim();
      data.middleName = document.getElementById('middleName').value.trim();
      data.lastName = document.getElementById('lastName').value.trim();
      data.idNo = document.getElementById('idNo').value.trim();
      data.dob = document.getElementById('dob').value;
      data.marital = document.getElementById('marital').value;
      data.tel = document.getElementById('tel').value;
      data.gender = document.getElementById('gender').value;
      data.religion = document.getElementById('religion').value;

      // Permanent
      data.perm = {
        box: document.getElementById('perm_box').value,
        postal: document.getElementById('perm_postal').value,
        town: document.getElementById('perm_town').value,
        county: document.getElementById('perm_county').value,
        constituency: document.getElementById('perm_const').value,
        ward: document.getElementById('perm_ward').value,
        location: document.getElementById('perm_location').value,
        sublocation: document.getElementById('perm_subloc').value
      };

      // current residence
      data.current = {
        school: document.getElementById('res_school').value,
        village: document.getElementById('res_village').value,
        street: document.getElementById('res_street').value,
        town: document.getElementById('res_town').value,
        county: document.getElementById('res_county').value,
        constituency: document.getElementById('res_const').value,
        notes: document.getElementById('res_notes').value
      };

      // uploads
      const idFrontFile = document.getElementById('idFront').files[0];
      const idBackFile = document.getElementById('idBack').files[0];
      const passportFile = document.getElementById('passportPhoto').files[0];
      data.uploads = {
        idFront: idFrontFile ? await fileToDataURL(idFrontFile) : null,
        idBack: idBackFile ? await fileToDataURL(idBackFile) : null,
        passport: passportFile ? await fileToDataURL(passportFile) : null
      };

      // education
      data.education = [];
      document.querySelectorAll('.edu-entry').forEach(async (node)=>{
        const edu = {
          level: node.querySelector('.edu-level').value,
          exam: node.querySelector('.edu-exam').value,
          institution: node.querySelector('.edu-institution').value,
          year: node.querySelector('.edu-year').value,
          index: node.querySelector('.edu-index').value
        };
        const file = node.querySelector('.edu-upload').files[0];
        // NOTE: synchronous loop with awaiting file converts — we'll instead gather promises below
        data.education.push(edu); // will fill pdf data URLs separately
      });

      // loan details
      data.loan = {
        amount: Number(document.getElementById('loan_amount').value||0),
        installment: Number(document.getElementById('loan_installment').value||0),
        firstInstallment: document.getElementById('loan_first').value,
        lastInstallment: document.getElementById('loan_last').value,
        purpose: document.getElementById('loan_purpose').value
      };
      const loanSupportFile = document.getElementById('loan_support').files[0];
      data.uploads.loanSupport = loanSupportFile ? await fileToDataURL(loanSupportFile) : null;

      // guarantors
      data.guarantors = [];
      document.querySelectorAll('.guar-entry').forEach(n=>{
        data.guarantors.push({
          name: n.querySelector('.guar-name').value,
          memberNo: n.querySelector('.guar-member').value,
          id: n.querySelector('.guar-id').value,
          phone: n.querySelector('.guar-phone').value,
          email: n.querySelector('.guar-email').value
        });
      });

      // parents
      data.parents = [];
      document.querySelectorAll('.parent-entry').forEach(n=>{
        data.parents.push({
          name: n.querySelector('.parent-name').value,
          phone: n.querySelector('.parent-phone').value,
          id: n.querySelector('.parent-id').value,
          email: n.querySelector('.parent-email').value
        });
      });

      // attach education uploaded files (iterate again)
      const eduNodes = document.querySelectorAll('.edu-entry');
      for(let i=0;i<eduNodes.length;i++){
        const file = eduNodes[i].querySelector('.edu-upload').files[0];
        data.education[i].certificate = file ? await fileToDataURL(file) : null;
      }

      return data;
    }

    // build 2-page PDF
    async function buildTwoPagePdf(appData){
      const doc = new jsPDF({unit:'pt', format:'a4'});
      const left = 36; let y = 40;
      // Header
      doc.setFillColor(14,138,110); doc.rect(0,0,595,56,'F');
      doc.setFontSize(16); doc.setTextColor(255,255,255); doc.text('Visionary Youth Group', 40, 34);
      doc.setFontSize(10); doc.text('Loan Application', 500, 34, {align:'right'});
      doc.setTextColor(0,0,0); doc.setFontSize(11);
      y = 80;
      // Personal block
      doc.setFont('helvetica','bold'); doc.text('Personal Information', left, y); y+=14;
      doc.setFont('helvetica','normal');
      doc.text(`Name: ${appData.firstName} ${appData.middleName} ${appData.lastName}`, left, y); y+=12;
      doc.text(`ID/Passport: ${appData.idNo}    DOB: ${appData.dob || '-'}`, left, y); y+=12;
      doc.text(`Phone: ${appData.tel}    Gender: ${appData.gender}    Marital: ${appData.marital}`, left, y); y+=14;

      // Permanent & current
      doc.setFont('helvetica','bold'); doc.text('Permanent Residence', left, y); y+=12;
      doc.setFont('helvetica','normal');
      const perm = appData.perm || {};
      doc.text(`${perm.town || ''} • ${perm.county || ''} • ${perm.constituency || ''} • ${perm.ward || ''}`, left, y); y+=12;
      doc.text(`Location: ${perm.location || ''} • Sub-location: ${perm.sublocation || ''} • P.O. Box: ${perm.box || ''}`, left, y); y+=18;

      doc.setFont('helvetica','bold'); doc.text('Current Residence', left, y); y+=12;
      doc.setFont('helvetica','normal');
      const cur = appData.current || {};
      doc.text(`${cur.street || ''} • ${cur.village || ''} • ${cur.town || ''}`, left, y); y+=12;
      doc.text(`Nearest School: ${cur.school || ''}`, left, y); y+=18;

      // Loan summary
      doc.setFont('helvetica','bold'); doc.text('Loan Summary', left, y); y+=12;
      doc.setFont('helvetica','normal');
      doc.text(`Amount: Ksh ${Number(appData.loan.amount||0).toLocaleString()}`, left, y); y+=12;
      doc.text(`Installment: Ksh ${Number(appData.loan.installment||0).toLocaleString()}  First: ${appData.loan.firstInstallment || '-'}  Last: ${appData.loan.lastInstallment || '-'}`, left, y); y+=12;
      doc.text(`Purpose: ${appData.loan.purpose || ''}`, left, y); y+=18;

      // Education block
      doc.setFont('helvetica','bold'); doc.text('Education', left, y); y+=12;
      doc.setFont('helvetica','normal');
      if(appData.education && appData.education.length){
        appData.education.forEach((ed, i) => {
          const line = `${ed.level || ''} - ${ed.institution || ''} (${ed.year || ''}) - Index: ${ed.index || ''}`;
          const wrap = doc.splitTextToSize(line, 520);
          doc.text(wrap, left, y); y += wrap.length*12;
          if(y > 700){ doc.addPage(); y = 40; }
        });
      } else {
        doc.text('No education details provided', left, y); y+=12;
      }

      // page footer
      doc.setFontSize(9); doc.setTextColor(90,90,90);
      doc.text('Tel: 0741453336 | Email: visionaryyouthgroup32@gmail.com | Nairobi', left, 780);

      // Page 2 - guarantors, parents, attachments
      doc.addPage(); let y2 = 48;
      doc.setFontSize(12); doc.setTextColor(14,138,110);
      doc.text('Guarantors & Parents', 40, 40);
      doc.setFontSize(11); doc.setTextColor(0,0,0);
      y2 = 64;
      if(appData.guarantors && appData.guarantors.length){
        appData.guarantors.forEach((g, idx)=>{
          doc.setFont('helvetica','bold'); doc.text(`Guarantor ${idx+1}`, 40, y2); y2 += 12;
          doc.setFont('helvetica','normal');
          doc.text(`Name: ${g.name || ''}  Member No: ${g.memberNo || ''}`, 40, y2); y2 += 12;
          doc.text(`ID: ${g.id || ''}  Phone: ${g.phone || ''}  Email: ${g.email || ''}`, 40, y2); y2 += 14;
          if(y2 > 700){ doc.addPage(); y2 = 40; }
        });
      } else {
        doc.text('No guarantors added', 40, y2); y2 += 12;
      }

      y2 += 8;
      doc.setFont('helvetica','bold'); doc.text('Parents / Next of Kin', 40, y2); y2 += 12;
      if(appData.parents && appData.parents.length){
        appData.parents.forEach((p, i)=>{
          doc.setFont('helvetica','normal');
          doc.text(`${p.name || ''} — Phone: ${p.phone || ''} — ID: ${p.id || ''} — Email: ${p.email || ''}`, 40, y2); y2 += 12;
          if(y2 > 700){ doc.addPage(); y2 = 40; }
        });
      } else {
        doc.setFont('helvetica','normal'); doc.text('No parent details provided', 40, y2); y2 += 12;
      }

      // Attachments: place small thumbnails if images present
      y2 += 12;
      doc.setFont('helvetica','bold'); doc.text('Attachments (embedded)', 40, y2); y2 += 12;
      const attLeft = 40;
      let thumbY = y2;

      // helper to draw image if data URL
      function drawImageIfDataURL(dataUrl, x, yPos, w=120, h=90){
        try{
          if(!dataUrl) return 0;
          // only embed images (not base64 pdfs). If PDF (application/pdf) skip image draw.
          if(typeof dataUrl === 'string' && dataUrl.startsWith('data:image')){
            doc.addImage(dataUrl, x, yPos, w, h);
            return h + 8;
          }
        }catch(e){ console.warn('Failed to draw image', e); }
        return 0;
      }

      // a list of possible uploads to embed
      const uploads = [
        {key:'idFront', label:'ID Front'},
        {key:'idBack', label:'ID Back'},
        {key:'passport', label:'Passport Photo'},
        {key:'loanSupport', label:'Loan Support'}
      ];
      let xPos = attLeft;
      for(const u of uploads){
        const img = appData.uploads && appData.uploads[u.key];
        if(img){
          const consumed = drawImageIfDataURL(img, xPos, thumbY);
          if(consumed){
            xPos += 140;
            if(xPos > 420){ xPos = attLeft; thumbY += consumed; }
          } else {
            // non-image (pdf) -> add note
            doc.setFont('helvetica','italic'); doc.text(`${u.label}: (attached PDF)`, xPos, thumbY + 10);
            xPos += 200;
            if(xPos > 420){ xPos = attLeft; thumbY += 28; }
          }
        }
      }

      // embed education certificates (if image)
      let certY = Math.max(thumbY + 120, 340);
      if(appData.education && appData.education.length){
        doc.setFont('helvetica','bold'); doc.text('Education Certificates (if provided)', 40, certY); certY += 12;
        let certX = 40;
        for(const ed of appData.education){
          if(ed.certificate && typeof ed.certificate === 'string' && ed.certificate.startsWith('data:image')){
            try{
              doc.addImage(ed.certificate, certX, certY, 120, 90);
              certX += 140;
              if(certX > 420){ certX = 40; certY += 110; }
            }catch(e){ console.warn('cert embed fail', e); }
          }
        }
      }

      // final footer
      doc.setFontSize(9); doc.setTextColor(90,90,90);
      doc.text('Prepared by Visionary Youth Group • Tel:0741453336 • visionaryyouthgroup32@gmail.com', 40, 780);
      return doc;
    }

    // submit handler
    document.getElementById('loanForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      // basic validation: require first/last/id and amount
      if(!document.getElementById('firstName').value.trim() || !document.getElementById('lastName').value.trim() || !document.getElementById('idNo').value.trim()){
        return alert('Please fill required personal fields (Name & ID).');
      }
      if(!document.getElementById('loan_amount').value){
        if(!confirm('Loan amount is empty. Continue?')) return;
      }

      // collect all data (includes awaiting file conversions)
      const appData = await collectFormData();

      // attach timestamp and a reference id
      const timestamp = Date.now();
      appData.submittedAt = timestamp;
      // optionally attach a member id - if using auth you can use auth.currentUser.uid
      // for now we push under /loanApplications/{applicationId}
      try{
        const refRoot = ref(db, `loanApplications`);
        const newRef = push(refRoot); // returns a new key on top-level
        await set(newRef, appData);
        // generate PDF
        const pdf = await buildTwoPagePdf(appData);
        const nameSafe = `${(appData.firstName||'applicant')}_${(appData.lastName||'')}`.replace(/[^\w.-]/g,'');
        pdf.save(`Loan_Application_${nameSafe}.pdf`);
        alert('Application saved and PDF downloaded!');
        // optional: redirect or clear wizard
        // reset form
        // document.getElementById('loanForm').reset();
      }catch(err){
        console.error(err); alert('Failed to save application: ' + (err.message||err));
      }
    });

    // Review button - show short summary
    document.getElementById('btnPreview').addEventListener('click', async ()=>{
      const data = await collectFormData();
      const area = document.getElementById('reviewArea');
      area.innerHTML = `
        <strong>${data.firstName} ${data.middleName} ${data.lastName}</strong><br>
        ID: ${data.idNo} • Phone: ${data.tel || '-'} <br>
        Loan: Ksh ${Number(data.loan.amount||0).toLocaleString()} • Installment: Ksh ${Number(data.loan.installment||0).toLocaleString()}<br>
        Education entries: ${data.education.length} • Guarantors: ${data.guarantors.length} • Parents: ${data.parents.length}
      `;
      area.scrollIntoView({behavior:'smooth'});
    });

    // sample prepopulates for quick testing (optional)
    // make two guarantor slots by default
    makeGuarantorEntry(); makeGuarantorEntry();

    // make two education slots by default
    makeEducationEntry(); makeEducationEntry();

    // prepopulate county selects with items
    
  </script>
</body>
</html>
