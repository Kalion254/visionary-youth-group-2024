<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Visionary Youth Group — Loan Application (Admin)</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg1:#05263a; /* deep navy */
      --bg2:#0f6b66; /* teal */
      --card:#ffffff;
      --accent:#2fe0b3;
      --muted:#9aa6ad;
      --glass: rgba(255,255,255,0.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Poppins',sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff}
    .center-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px}
    .card{
      width:100%;max-width:980px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border-radius:14px;padding:18px 18px 28px 18px;box-shadow:0 20px 60px rgba(0,0,0,0.45);backdrop-filter: blur(6px);
      border:1px solid rgba(255,255,255,0.04)
    }
    .header{display:flex;align-items:center;gap:14px;margin-bottom:8px}
    .logoBox{width:56px;height:56px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#fff,rgba(255,255,255,0.85));padding:6px}
    .logoBox svg{width:42px;height:42px}
    .title{font-weight:700;color:#fff}
    .subtitle{color:var(--muted);font-size:0.95rem;margin-top:4px}

    /* Wizard */
    .wizard{background:transparent;padding:12px;margin-top:8px}
    .steps{display:flex;gap:8px;margin-bottom:12px;align-items:center;flex-wrap:wrap}
    .step{
      background:transparent;color:rgba(255,255,255,0.8);padding:8px 10px;border-radius:9px;border:1px solid rgba(255,255,255,0.04);
      display:flex;align-items:center;gap:8px;font-weight:600;font-size:0.95rem
    }
    .step.active{background:linear-gradient(90deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));border:1px solid rgba(255,255,255,0.08)}
    .progress-bar{height:8px;background:rgba(255,255,255,0.06);border-radius:999px;overflow:hidden;margin-bottom:18px}
    .progress{height:100%;background:linear-gradient(90deg,#00ffd0,#00c6ff);width:0%}

    /* step panel */
    .panel{display:none;padding:8px 2px}
    .panel.active{display:block}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
    .row.single{grid-template-columns:1fr}
    label{display:block;font-size:0.9rem;color:#dffbf0;margin-bottom:6px}
    input[type="text"],input[type="email"],input[type="date"],input[type="number"],select,textarea{
      width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:#fff;
      outline:none;font-size:0.95rem
    }
    textarea{min-height:110px}
    .muted{color:var(--muted);font-size:0.9rem}

    .actions{display:flex;justify-content:space-between;gap:8px;margin-top:12px}
    .btn{background:linear-gradient(90deg,#0bbd94,#06a89a);border:none;color:#04342f;padding:10px 14px;border-radius:8px;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.08)}
    .btn.warn{background:#ffb857;color:#4b2b00}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.08);color:#fff}

    .small{font-size:0.85rem;color:var(--muted)}
    .file-preview{margin-top:6px;font-size:0.85rem;color:#e6fffa}

    /* guarantor/parent lists */
    .list-item{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.03)}
    .flex-row{display:flex;gap:8px;align-items:center}

    @media (max-width:880px){
      .row{grid-template-columns:1fr}
      .header{gap:10px}
      .logoBox{width:48px;height:48px}
    }
  </style>
</head>
<body>
  <div class="center-wrap">
    <div class="card" role="main" aria-labelledby="pageTitle">
      <div class="header">
        <div class="logoBox" aria-hidden="true">
          <!-- Embedded 'eye' SVG logo -->
          <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
            <defs><linearGradient id="g1" x1="0" x2="1"><stop offset="0" stop-color="#00ffd0"/><stop offset="1" stop-color="#00c6ff"/></linearGradient></defs>
            <path d="M2 32C10 12 30 4 32 4c2 0 22 8 30 28-8 20-28 28-30 28-2 0-22-8-30-28z" fill="url(#g1)"/>
            <circle cx="32" cy="32" r="10" fill="#042a20"/>
            <circle cx="32" cy="32" r="5" fill="#fff"/>
          </svg>
        </div>
        <div>
          <div class="title" id="pageTitle">Visionary Youth Group — Loan Application</div>
          <div class="subtitle">Stylish HELB-style wizard • Your contact: Tel: 0741453336 • Email: visionaryyouthgroup32@gmail.com • Nairobi</div>
        </div>
      </div>

      <div class="wizard" id="wizardRoot">
        <div class="steps" id="stepsBar">
          <div class="step active" data-step="0"><i class="fas fa-user"></i> Personal</div>
          <div class="step" data-step="1"><i class="fas fa-house"></i> Residence</div>
          <div class="step" data-step="2"><i class="fas fa-book"></i> Education</div>
          <div class="step" data-step="3"><i class="fas fa-money-check"></i> Loan</div>
          <div class="step" data-step="4"><i class="fas fa-user-friends"></i> Guarantors</div>
          <div class="step" data-step="5"><i class="fas fa-users"></i> Parents</div>
          <div class="step" data-step="6"><i class="fas fa-check-circle"></i> Review</div>
        </div>

        <div class="progress-bar"><div class="progress" id="progress"></div></div>

        <!-- Panels -->
        <form id="loanWizardForm" autocomplete="off">
          <!-- STEP 0: Personal -->
          <div class="panel active" data-panel="0">
            <div class="row">
              <div>
                <label>First Name</label>
                <input id="firstName" type="text" required>
              </div>
              <div>
                <label>Middle Name</label>
                <input id="middleName" type="text">
              </div>
            </div>

            <div class="row">
              <div>
                <label>Last Name</label>
                <input id="lastName" type="text" required>
              </div>
              <div>
                <label>ID / Passport No</label>
                <input id="idNo" type="text" required>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Date of Birth</label>
                <input id="dob" type="date" required>
              </div>
              <div>
                <label>Marital Status</label>
                <select id="maritalStatus">
                  <option>Single</option><option>Married</option><option>Divorced</option><option>Widowed</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Telephone</label>
                <input id="phone" type="text" placeholder="07XXXXXXXX" required>
              </div>
              <div>
                <label>Gender</label>
                <select id="gender"><option>Male</option><option>Female</option><option>Other</option></select>
              </div>
            </div>

            <div class="row single">
              <div>
                <label>Religion</label>
                <input id="religion" type="text" placeholder="e.g. Christianity">
              </div>
            </div>

            <div class="row single">
              <div>
                <label>Upload ID (Front)</label>
                <input id="idFront" type="file" accept="image/*,application/pdf">
                <div id="idFrontPreview" class="file-preview"></div>
              </div>
            </div>

            <div class="row single">
              <div>
                <label>Upload ID (Back)</label>
                <input id="idBack" type="file" accept="image/*,application/pdf">
                <div id="idBackPreview" class="file-preview"></div>
              </div>
            </div>

            <div class="actions">
              <button type="button" class="btn ghost" id="btnPrev" disabled><i class="fas fa-chevron-left"></i> Back</button>
              <div style="margin-left:auto">
                <button type="button" class="btn" id="btnNext0">Save & Continue <i class="fas fa-chevron-right"></i></button>
              </div>
            </div>
          </div>

          <!-- STEP 1: Residence -->
          <div class="panel" data-panel="1">
            <div class="row">
              <div>
                <label>P.O. Box</label>
                <input id="poBox" type="text">
              </div>
              <div>
                <label>Postal Code</label>
                <input id="postalCode" type="text">
              </div>
            </div>

            <div class="row">
              <div>
                <label>Town</label>
                <input id="town" type="text">
              </div>
              <div>
                <label>County</label>
                <select id="county"></select>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Constituency</label>
                <select id="constituency"></select>
              </div>
              <div>
                <label>Ward</label>
                <select id="ward"></select>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Location</label>
                <input id="location" type="text">
              </div>
              <div>
                <label>Sub-location / Village</label>
                <input id="sublocation" type="text">
              </div>
            </div>

            <div class="row single">
              <div>
                <label>Nearest Primary School</label>
                <input id="nearestSchool" type="text">
              </div>
            </div>

            <div class="actions">
              <button type="button" class="btn ghost" id="btnPrev1"><i class="fas fa-chevron-left"></i> Back</button>
              <div style="margin-left:auto">
                <button type="button" class="btn" id="btnNext1">Save & Continue <i class="fas fa-chevron-right"></i></button>
              </div>
            </div>
          </div>

          <!-- STEP 2: Education -->
          <div class="panel" data-panel="2">
            <div id="educationContainer">
              <div class="edu-item" data-edu-index="0">
                <div class="row">
                  <div>
                    <label>Level</label>
                    <select class="edu-level">
                      <option>KCPE</option><option>KCSE</option><option>Certificate</option><option>Diploma</option><option>Degree</option><option>Masters</option>
                    </select>
                  </div>
                  <div>
                    <label>Exam Year</label>
                    <input class="edu-year" type="number" min="1900" max="2099" placeholder="e.g. 2018">
                  </div>
                </div>
                <div class="row">
                  <div>
                    <label>Index / Reg No</label>
                    <input class="edu-index" type="text">
                  </div>
                  <div>
                    <label>Exam Type</label>
                    <select class="edu-examType"><option>National</option><option>Private</option></select>
                  </div>
                </div>
                <div class="row single">
                  <div>
                    <label>Remarks / Subjects (optional)</label>
                    <input class="edu-remarks" type="text">
                  </div>
                </div>
                <hr style="border-color:rgba(255,255,255,0.04)">
              </div>
            </div>

            <div style="display:flex;gap:8px;margin-top:8px;margin-bottom:8px">
              <button type="button" id="addEdu" class="btn secondary">+ Add another education level</button>
              <button type="button" id="removeEdu" class="btn ghost">- Remove last</button>
            </div>

            <div class="actions">
              <button type="button" class="btn ghost" id="btnPrev2"><i class="fas fa-chevron-left"></i> Back</button>
              <div style="margin-left:auto">
                <button type="button" class="btn" id="btnNext2">Save & Continue <i class="fas fa-chevron-right"></i></button>
              </div>
            </div>
          </div>

          <!-- STEP 3: Loan Details -->
          <div class="panel" data-panel="3">
            <div class="row">
              <div>
                <label>Loan Amount (Ksh)</label>
                <input id="loanAmount" type="number" min="0" step="100" required>
              </div>
              <div>
                <label>Installment (Ksh)</label>
                <input id="loanInstallment" type="number" min="0" step="50">
              </div>
            </div>

            <div class="row">
              <div>
                <label>Purpose</label>
                <input id="loanPurpose" type="text" required>
              </div>
              <div>
                <label>Installment Frequency</label>
                <select id="installmentFreq"><option>Monthly</option><option>Quarterly</option><option>Weekly</option></select>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Date of First Installment</label>
                <input id="firstInstallmentDate" type="date">
              </div>
              <div>
                <label>Date of Last Installment</label>
                <input id="lastInstallmentDate" type="date">
              </div>
            </div>

            <div class="row single">
              <div>
                <label>Upload Supporting Document (pdf/image)</label>
                <input id="supportDoc" type="file" accept="application/pdf,image/*">
                <div id="supportDocPreview" class="file-preview"></div>
              </div>
            </div>

            <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
              <button type="button" id="btnApplyRedirect" class="btn ghost" title="Admin apply">Apply (redirect to admin.html)</button>
              <div class="muted" style="margin-left:6px">Or continue to add guarantors & parents</div>
            </div>

            <div class="actions">
              <button type="button" class="btn ghost" id="btnPrev3"><i class="fas fa-chevron-left"></i> Back</button>
              <div style="margin-left:auto">
                <button type="button" class="btn" id="btnNext3">Save & Continue <i class="fas fa-chevron-right"></i></button>
              </div>
            </div>
          </div>

          <!-- STEP 4: Guarantors -->
          <div class="panel" data-panel="4">
            <div id="guarantorsList"></div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button type="button" id="addGuarantorBtn" class="btn secondary"><i class="fas fa-user-plus"></i> Add Guarantor</button>
              <button type="button" id="downloadGuarantorTemplate" class="btn ghost"><i class="fas fa-file-download"></i> Download Guarantor Form</button>
            </div>
            <div class="small" style="margin-top:8px">Require at least 2 guarantors.</div>

            <div class="actions">
              <button type="button" class="btn ghost" id="btnPrev4"><i class="fas fa-chevron-left"></i> Back</button>
              <div style="margin-left:auto">
                <button type="button" class="btn" id="btnNext4">Save & Continue <i class="fas fa-chevron-right"></i></button>
              </div>
            </div>
          </div>

          <!-- STEP 5: Parents -->
          <div class="panel" data-panel="5">
            <div id="parentsList"></div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button type="button" id="addFatherBtn" class="btn secondary">+ Add Father</button>
              <button type="button" id="addMotherBtn" class="btn secondary">+ Add Mother</button>
            </div>

            <div class="actions">
              <button type="button" class="btn ghost" id="btnPrev5"><i class="fas fa-chevron-left"></i> Back</button>
              <div style="margin-left:auto">
                <button type="button" class="btn" id="btnNext5">Save & Continue <i class="fas fa-chevron-right"></i></button>
              </div>
            </div>
          </div>

          <!-- STEP 6: Review & Submit -->
          <div class="panel" data-panel="6">
            <h3 style="margin-top:0;color:#fff">Review Application</h3>
            <div id="reviewArea" style="max-height:380px;overflow:auto;padding-right:6px"></div>

            <div style="display:flex;gap:8px;margin-top:12px;align-items:center;">
              <button type="button" id="btnDownloadPreviewPdf" class="btn secondary"><i class="fas fa-file-pdf"></i> Download Preview PDF</button>
              <button type="button" id="btnClearDraft" class="btn ghost">Clear Draft</button>
              <div style="flex:1"></div>
              <button type="button" id="btnSubmitFinal" class="btn warn"><i class="fas fa-paper-plane"></i> Submit & Download Filled PDF</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Firebase + logic -->
  <script type="module">
    // jsPDF
    const { jsPDF } = window.jspdf;

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getDatabase, ref, push, set, update, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    // ===== YOUR FIREBASE CONFIG (keeps the RTDB URL you used earlier) =====
    const firebaseConfig = {
      apiKey: "AIzaSyA_OCu7HQ5HCH2OYx5dQ2Z1r7YPwQJave4",
      authDomain: "visionary-youth-grou-2024.firebaseapp.com",
      databaseURL: "https://visionary-youth-grou-2024-default-rtdb.firebaseio.com",
      projectId: "visionary-youth-grou-2024",
      storageBucket: "visionary-youth-grou-2024.appspot.com",
      messagingSenderId: "372978592717",
      appId: "1:372978592717:web:1c15aec728ee5f854f3284"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // Wizard logic
    const panels = Array.from(document.querySelectorAll('.panel'));
    const steps = Array.from(document.querySelectorAll('.step'));
    const progressEl = document.getElementById('progress');

    let current = 0;
    function showStep(i){
      current = i;
      panels.forEach(p => p.classList.toggle('active', Number(p.dataset.panel) === i));
      steps.forEach(s => s.classList.toggle('active', Number(s.dataset.step) === i));
      const pct = Math.round((i)/(panels.length-1)*100);
      progressEl.style.width = pct + '%';
      // enable/disable prev
      document.querySelectorAll('#btnPrev, #btnPrev1, #btnPrev2, #btnPrev3, #btnPrev4, #btnPrev5').forEach(b => b.disabled = (i===0));
      window.scrollTo({top:0,behavior:'smooth'});
    }

    // next/prev buttons
    document.getElementById('btnNext0').addEventListener('click', ()=> { showStep(1); });
    document.getElementById('btnNext1').addEventListener('click', ()=> { showStep(2); });
    document.getElementById('btnNext2').addEventListener('click', ()=> { showStep(3); });
    document.getElementById('btnNext3').addEventListener('click', ()=> { showStep(4); });
    document.getElementById('btnNext4').addEventListener('click', ()=> { showStep(5); });
    document.getElementById('btnNext5').addEventListener('click', ()=> { populateReview(); showStep(6); });

    document.getElementById('btnPrev').addEventListener('click', ()=> showStep(0));
    document.getElementById('btnPrev1').addEventListener('click', ()=> showStep(0));
    document.getElementById('btnPrev2').addEventListener('click', ()=> showStep(1));
    document.getElementById('btnPrev3').addEventListener('click', ()=> showStep(2));
    document.getElementById('btnPrev4').addEventListener('click', ()=> showStep(3));
    document.getElementById('btnPrev5').addEventListener('click', ()=> showStep(4));

    // County list (47 counties). For detailed constituency/ward lists you can expand the mapping.
    const counties = [
      "Mombasa","Kwale","Kilifi","Tana River","Lamu","Taita-Taveta","Garissa","Wajir","Mandera",
      "Marsabit","Isiolo","Meru","Tharaka-Nithi","Embu","Kitui","Machakos","Makueni","Nyandarua",
      "Nyeri","Kirinyaga","Muranga","Kiambu","Turkana","West Pokot","Samburu","Trans Nzoia",
      "Uasin Gishu","Elgeyo-Marakwet","Nandi","Baringo","Laikipia","Nakuru","Narok","Kajiado",
      "Kericho","Bomet","Kakamega","Vihiga","Bungoma","Busia","Siaya","Kisumu","Homa Bay",
      "Migori","Kisii","Nyamira","Nairobi"
    ];
    const countyEl = document.getElementById('county');
    counties.forEach(c => { const o = document.createElement('option'); o.value=c; o.textContent=c; countyEl.appendChild(o); });

    // Example minimal constituency mapping (expand as needed). If selected county has no mapping the constituency/ward becomes editable.
    const constituencyMap = {
      "Nairobi": ["Westlands","Roysambu","Dagoretti North","Embakasi South","Mathare","Starehe"],
      "Kiambu": ["Githunguri","Kabete","Kiambaa","Kiambu","Thika Town"],
      "Mombasa": ["Mvita","Nyali","Jomvu","Likoni"]
      // ... expand as needed
    };
    const wardsMap = {
      "Westlands": ["Parklands/Highridge","Kangemi","Kileleshwa"],
      "Mvita": ["Mji wa Kale","Tudor","Tononoka"]
      // ... expand as needed
    };

    function rebuildConstituencyOptions(county){
      const constEl = document.getElementById('constituency');
      constEl.innerHTML = '';
      const list = constituencyMap[county];
      if(Array.isArray(list)){
        list.forEach(c => { const o = document.createElement('option'); o.value=c; o.textContent=c; constEl.appendChild(o); });
        rebuildWardOptions(list[0]);
      } else {
        // no mapped constituency — provide a free text option
        const o = document.createElement('option'); o.value = ''; o.textContent = 'Select / Type...'; constEl.appendChild(o);
        constEl.insertAdjacentHTML('beforeend', '<option value="__other__">Other (type below)</option>');
        rebuildWardOptions();
      }
    }
    function rebuildWardOptions(constituency){
      const wEl = document.getElementById('ward');
      wEl.innerHTML = '';
      if(constituency && Array.isArray(wardsMap[constituency])){
        wardsMap[constituency].forEach(w => { const o = document.createElement('option'); o.value=w; o.textContent=w; wEl.appendChild(o); });
      } else {
        const o = document.createElement('option'); o.value=''; o.textContent = 'Select / Type...'; wEl.appendChild(o);
      }
    }
    countyEl.addEventListener('change', e => rebuildConstituencyOptions(e.target.value));
    document.getElementById('constituency').addEventListener('change', e => rebuildWardOptions(e.target.value));
    // init
    rebuildConstituencyOptions(counties[0]);

    // Education add/remove
    const eduContainer = document.getElementById('educationContainer');
    document.getElementById('addEdu').addEventListener('click', () => {
      const idx = eduContainer.querySelectorAll('.edu-item').length;
      const item = document.createElement('div');
      item.className = 'edu-item'; item.dataset.eduIndex = idx;
      item.innerHTML = `
        <div class="row">
          <div><label>Level</label><select class="edu-level"><option>KCPE</option><option>KCSE</option><option>Certificate</option><option>Diploma</option><option>Degree</option><option>Masters</option></select></div>
          <div><label>Exam Year</label><input class="edu-year" type="number" min="1900" max="2099" placeholder="e.g. 2018"></div>
        </div>
        <div class="row">
          <div><label>Index / Reg No</label><input class="edu-index" type="text"></div>
          <div><label>Exam Type</label><select class="edu-examType"><option>National</option><option>Private</option></select></div>
        </div>
        <div class="row single"><div><label>Remarks / Subjects (optional)</label><input class="edu-remarks" type="text"></div></div>
        <hr style="border-color:rgba(255,255,255,0.04)">
      `;
      eduContainer.appendChild(item);
    });
    document.getElementById('removeEdu').addEventListener('click', ()=> {
      const items = eduContainer.querySelectorAll('.edu-item');
      if(items.length > 1) items[items.length-1].remove();
    });

    // Guarantors & parents data containers
    const guarantorsList = document.getElementById('guarantorsList');
    const parentsList = document.getElementById('parentsList');

    function renderGuarantorItem(obj){
      const idx = (new Date()).getTime().toString(36);
      const div = document.createElement('div'); div.className='list-item'; div.id = 'g_' + idx;
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="flex:1">
            <div style="font-weight:700">${obj.name||'(No name)'}</div>
            <div class="muted">Member No: ${obj.memberNo||'-'} • ID: ${obj.idNo||'-'} • Phone: ${obj.phone||'-'}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
            <button class="btn secondary btn-edit-guarantor" data-id="${idx}">Edit</button>
            <button class="btn ghost btn-remove-guarantor" data-id="${idx}">Remove</button>
          </div>
        </div>
      `;
      guarantorsList.appendChild(div);
      return idx;
    }
    function renderParentItem(obj, which){
      const idx = (new Date()).getTime().toString(36);
      const div = document.createElement('div'); div.className='list-item'; div.id = 'p_' + idx;
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="flex:1">
            <div style="font-weight:700">${obj.name||which}</div>
            <div class="muted">ID: ${obj.id||'-'} • Phone: ${obj.phone||'-'} • Email: ${obj.email||'-'}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
            <button class="btn secondary btn-edit-parent" data-id="${idx}">Edit</button>
            <button class="btn ghost btn-remove-parent" data-id="${idx}">Remove</button>
          </div>
        </div>
      `;
      parentsList.appendChild(div);
      return idx;
    }

    // Add guarantor modal-like inline prompt
    async function promptGuarantor(existing){
      const name = prompt('Guarantor name', existing?.name || '');
      if(name === null) return null;
      const memberNo = prompt('Member No (if any)', existing?.memberNo || '');
      const idNo = prompt('ID / Passport No', existing?.idNo || '');
      const phone = prompt('Phone', existing?.phone || '');
      const email = prompt('Email', existing?.email || '');
      return { name, memberNo, idNo, phone, email };
    }
    document.getElementById('addGuarantorBtn').addEventListener('click', async ()=>{
      const g = await promptGuarantor();
      if(!g) return;
      renderGuarantorItem(g);
    });
    // remove/edit handlers (delegated)
    guarantorsList.addEventListener('click', (e) => {
      if(e.target.closest('.btn-remove-guarantor')){
        const id = e.target.closest('.btn-remove-guarantor').dataset.id;
        document.getElementById('g_' + id).remove();
      } else if(e.target.closest('.btn-edit-guarantor')){
        const id = e.target.closest('.btn-edit-guarantor').dataset.id;
        const node = document.getElementById('g_' + id);
        const currentName = node.querySelector('div > div').textContent;
        promptGuarantor({ name: currentName }).then(updated => {
          if(!updated) return;
          node.querySelector('div > div').textContent = updated.name;
          node.querySelector('.muted').textContent = `Member No: ${updated.memberNo||'-'} • ID: ${updated.idNo||'-'} • Phone: ${updated.phone||'-'}`;
        });
      }
    });

    document.getElementById('addFatherBtn').addEventListener('click', async ()=> {
      const name = prompt('Father name'); if(!name) return;
      const id = prompt('Father ID / Passport No') || '';
      const phone = prompt('Father phone') || '';
      const email = prompt('Father email') || '';
      renderParentItem({ name, id, phone, email }, 'Father');
    });
    document.getElementById('addMotherBtn').addEventListener('click', async ()=> {
      const name = prompt('Mother name'); if(!name) return;
      const id = prompt('Mother ID / Passport No') || '';
      const phone = prompt('Mother phone') || '';
      const email = prompt('Mother email') || '';
      renderParentItem({ name, id, phone, email }, 'Mother');
    });

    // file preview helpers + upload placeholders
    function humanFileName(f){ return f ? (f.name || String(f)) : ''; }
    document.getElementById('idFront').addEventListener('change', e => {
      const f = e.target.files && e.target.files[0];
      document.getElementById('idFrontPreview').textContent = f ? `Selected: ${humanFileName(f)}` : 'No file';
    });
    document.getElementById('idBack').addEventListener('change', e => {
      const f = e.target.files && e.target.files[0];
      document.getElementById('idBackPreview').textContent = f ? `Selected: ${humanFileName(f)}` : 'No file';
    });
    document.getElementById('supportDoc').addEventListener('change', e => {
      const f = e.target.files && e.target.files[0];
      document.getElementById('supportDocPreview').textContent = f ? `Selected: ${humanFileName(f)}` : 'No file';
    });

    // Apply redirect (as requested)
    document.getElementById('btnApplyRedirect').addEventListener('click', ()=> {
      // redirect to admin.html - since we're already admin, for compatibility we can open admin.html in a new tab
      window.open('admin.html', '_blank');
    });

    // Build application object from form
    function collectFormData(){
      const personal = {
        firstName: document.getElementById('firstName').value.trim(),
        middleName: document.getElementById('middleName').value.trim(),
        lastName: document.getElementById('lastName').value.trim(),
        idNo: document.getElementById('idNo').value.trim(),
        dob: document.getElementById('dob').value,
        maritalStatus: document.getElementById('maritalStatus').value,
        phone: document.getElementById('phone').value.trim(),
        gender: document.getElementById('gender').value,
        religion: document.getElementById('religion').value
      };
      const residence = {
        poBox: document.getElementById('poBox').value,
        postalCode: document.getElementById('postalCode').value,
        town: document.getElementById('town').value,
        county: document.getElementById('county').value,
        constituency: document.getElementById('constituency').value,
        ward: document.getElementById('ward').value,
        location: document.getElementById('location').value,
        sublocation: document.getElementById('sublocation').value,
        nearestSchool: document.getElementById('nearestSchool').value
      };
      // education
      const edus = [];
      document.querySelectorAll('.edu-item').forEach(it => {
        edus.push({
          level: it.querySelector('.edu-level').value,
          year: it.querySelector('.edu-year').value,
          indexNo: it.querySelector('.edu-index').value,
          examType: it.querySelector('.edu-examType').value,
          remarks: it.querySelector('.edu-remarks').value
        });
      });
      // loan
      const loan = {
        amount: Number(document.getElementById('loanAmount').value || 0),
        installment: Number(document.getElementById('loanInstallment').value || 0),
        purpose: document.getElementById('loanPurpose').value,
        frequency: document.getElementById('installmentFreq').value,
        firstInstallmentDate: document.getElementById('firstInstallmentDate').value,
        lastInstallmentDate: document.getElementById('lastInstallmentDate').value
      };
      // guarantors
      const guarantors = [];
      guarantorsList.querySelectorAll('.list-item').forEach(node => {
        const title = node.querySelector('div > div').textContent;
        const meta = node.querySelector('.muted').textContent;
        guarantors.push({ display: title, meta });
      });
      // parents
      const parents = [];
      parentsList.querySelectorAll('.list-item').forEach(node => {
        const title = node.querySelector('div > div').textContent;
        const meta = node.querySelector('.muted').textContent;
        parents.push({ display: title, meta });
      });

      return { personal, residence, education: edus, loan, guarantors, parents };
    }

    // Review population
    function populateReview(){
      const data = collectFormData();
      const area = document.getElementById('reviewArea'); area.innerHTML = '';
      const makeRow = (label, value) => `<div style="margin-bottom:6px"><strong style="color:#b8fff0">${label}:</strong> <span class="muted">${value||'-'}</span></div>`;
      area.insertAdjacentHTML('beforeend', '<h4>Personal</h4>');
      for(const k in data.personal) area.insertAdjacentHTML('beforeend', makeRow(k, data.personal[k]));
      area.insertAdjacentHTML('beforeend','<hr>');
      area.insertAdjacentHTML('beforeend','<h4>Residence</h4>');
      for(const k in data.residence) area.insertAdjacentHTML('beforeend', makeRow(k, data.residence[k]));
      area.insertAdjacentHTML('beforeend','<hr>');
      area.insertAdjacentHTML('beforeend','<h4>Education</h4>');
      data.education.forEach((e,i) => area.insertAdjacentHTML('beforeend', `<div class="muted">(${i+1}) ${e.level} • ${e.year} • ${e.indexNo} • ${e.examType}</div>`));
      area.insertAdjacentHTML('beforeend','<hr>');
      area.insertAdjacentHTML('beforeend','<h4>Loan</h4>');
      for(const k in data.loan) area.insertAdjacentHTML('beforeend', makeRow(k, data.loan[k]));
      area.insertAdjacentHTML('beforeend','<hr>');
      area.insertAdjacentHTML('beforeend','<h4>Guarantors</h4>');
      data.guarantors.forEach((g,i)=> area.insertAdjacentHTML('beforeend', `<div class="muted">(${i+1}) ${g.display} • ${g.meta}</div>`));
      area.insertAdjacentHTML('beforeend','<hr>');
      area.insertAdjacentHTML('beforeend','<h4>Parents / Guardians</h4>');
      data.parents.forEach((p,i)=> area.insertAdjacentHTML('beforeend', `<div class="muted">(${i+1}) ${p.display} • ${p.meta}</div>`));
    }

    // Utility: serialize SVG to PNG dataURL for jsPDF header
    async function svgToPngDataUrl(svgElement, width=200, height=200){
      const serializer = new XMLSerializer();
      const svgString = serializer.serializeToString(svgElement);
      const svg64 = btoa(unescape(encodeURIComponent(svgString)));
      const b64Start = 'data:image/svg+xml;base64,';
      const img = new Image();
      const src = b64Start + svg64;
      return new Promise((resolve, reject) => {
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          // white background slight for better PDF appearance
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(0,0,width,height);
          ctx.drawImage(img,0,0,width,height);
          resolve(canvas.toDataURL('image/png'));
        };
        img.onerror = reject;
        img.src = src;
      });
    }

    // Generate Loan Application PDF (professional layout)
    async function generateApplicationPdf(appData){
      const doc = new jsPDF({unit:'pt', format:'a4'});
      const svgEl = document.querySelector('.logoBox svg');
      const imgData = await svgToPngDataUrl(svgEl, 80, 80).catch(()=>null);

      // Header
      doc.setFillColor(6,40,50);
      doc.rect(0,0,595,60,'F');
      if(imgData) doc.addImage(imgData, 'PNG', 36, 16, 48, 48);
      doc.setTextColor(255,255,255); doc.setFontSize(16); doc.setFont('helvetica','bold');
      doc.text('Visionary Youth Group', 100, 30);
      doc.setFontSize(10); doc.setFont('helvetica','normal');
      doc.text('Loan Application Form', 100, 46);
      doc.setTextColor(0,0,0);
      let y = 90;
      doc.setFontSize(11); doc.setFont('helvetica','bold');
      doc.text('Applicant Details', 36, y); y += 14;
      doc.setFont('helvetica','normal'); doc.setFontSize(10);
      const p = appData.personal;
      const r = appData.residence;
      doc.text(`Name: ${p.firstName} ${p.middleName} ${p.lastName}`, 36, y); y+=12;
      doc.text(`ID/Passport: ${p.idNo} • DOB: ${p.dob} • Gender: ${p.gender}`, 36, y); y+=12;
      doc.text(`Phone: ${p.phone} • Religion: ${p.religion} • Marital: ${p.maritalStatus}`, 36, y); y+=16;

      doc.setFont('helvetica','bold'); doc.text('Residence', 36, y); y+=14;
      doc.setFont('helvetica','normal');
      doc.text(`${r.poBox || '-'}, ${r.postalCode || '-'} • ${r.town || '-'} • ${r.county || '-'}`, 36, y); y+=12;
      doc.text(`Constituency: ${r.constituency || '-'} • Ward: ${r.ward || '-'} • Location: ${r.location || '-'} • Sublocation: ${r.sublocation || '-'}`, 36, y); y+=16;

      doc.setFont('helvetica','bold'); doc.text('Education', 36, y); y+=12;
      doc.setFont('helvetica','normal');
      appData.education.forEach((ed, i) => {
        doc.text(`${i+1}. ${ed.level} • ${ed.year || '-'} • ${ed.indexNo || '-'} • ${ed.examType || '-'}`, 36, y); y+=12;
        if(y > 700){ doc.addPage(); y=40; }
      });
      y += 6;
      doc.setFont('helvetica','bold'); doc.text('Loan Details', 36, y); y+=12;
      doc.setFont('helvetica','normal');
      doc.text(`Amount Requested: Ksh ${Number(appData.loan.amount||0).toLocaleString()}`, 36, y); y+=12;
      doc.text(`Purpose: ${appData.loan.purpose || '-'}`, 36, y); y+=12;
      doc.text(`Installment: Ksh ${Number(appData.loan.installment||0).toLocaleString()} • Frequency: ${appData.loan.frequency || '-'}`, 36, y); y+=12;
      doc.text(`First Installment: ${appData.loan.firstInstallmentDate || '-'} • Last Installment: ${appData.loan.lastInstallmentDate || '-'}`, 36, y); y+=20;

      doc.setFont('helvetica','bold'); doc.text('Guarantors', 36, y); y+=12;
      doc.setFont('helvetica','normal');
      appData.guarantors.forEach((g,i) => {
        doc.text(`${i+1}. ${g.display || '-'} • ${g.meta || '-'}`, 36, y); y+=12;
        if(y > 700){ doc.addPage(); y=40; }
      });

      y += 8;
      doc.setFont('helvetica','bold'); doc.text('Parents / Guardians', 36, y); y+=12;
      doc.setFont('helvetica','normal');
      appData.parents.forEach((p,i) => {
        doc.text(`${i+1}. ${p.display || '-'} • ${p.meta || '-'}`, 36, y); y+=12;
        if(y > 700){ doc.addPage(); y=40; }
      });

      // Footer contact & signature placeholders
      if(y > 640) { doc.addPage(); y = 80; }
      doc.setDrawColor(200);
      doc.line(36, y+20, 200, y+20);
      doc.text('Applicant Signature', 36, y+34);
      doc.line(300, y+20, 500, y+20);
      doc.text('Date', 420, y+34);
      doc.setFontSize(9); doc.setTextColor(120,120,120);
      doc.text('Visionary Youth Group — Tel: 0741453336 • visionaryyouthgroup32@gmail.com • Nairobi', 36, 780);

      return doc;
    }

    // Guarantor template PDF
    async function generateGuarantorTemplate(){
      const doc = new jsPDF({unit:'pt', format:'a4'});
      doc.setFontSize(16); doc.setFont('helvetica','bold');
      doc.text('Guarantor Declaration', 40, 50);
      doc.setFontSize(10); doc.setFont('helvetica','normal');
      const lines = [
        'I, the undersigned guarantor, hereby declare that I guarantee the repayment of the loan applied by the applicant.',
        'Guarantor details to fill below and sign.',
        '',
        'Full Name:',
        'Member No:',
        'ID / Passport No:',
        'Phone:',
        'Email:',
        '',
        'Signature: ________________________   Date: ________________',
        '',
        'Note: Submit a copy of the guarantor ID and sign in presence of office staff if required.'
      ];
      let y = 80;
      lines.forEach(line => { doc.text(line, 40, y); y += 16; });
      return doc;
    }

    // Upload file helper (returns storage URL)
    async function uploadFile(file, path){
      const sRef = storageRef(storage, path);
      const snapshot = await uploadBytes(sRef, file);
      const url = await getDownloadURL(snapshot.ref);
      return url;
    }

    // Save application: upload files, push record to RTDB
    async function saveApplicationToRTDB(appData, filesMap){
      // require current user
      const user = auth.currentUser;
      if(!user) throw new Error('Not authenticated');

      // push new application
      const appRef = push(ref(db, `loanApplications/${user.uid}`));
      const appId = appRef.key;

      // if we have filesMap, upload them into storage under loanApplications/{uid}/{appId}/
      const uploadedUrls = {};
      for(const [k, f] of Object.entries(filesMap || {})){
        if(!f) continue;
        const ext = f.name.split('.').pop().slice(0,6);
        const path = `loanApplications/${user.uid}/${appId}/${k}.${ext}`;
        try{
          uploadedUrls[k] = await uploadFile(f, path);
        }catch(err){
          console.error('Upload failed for', k, err);
        }
      }

      // assemble record
      const record = {
        createdAt: Date.now(),
        applicantUid: user.uid,
        applicantEmail: user.email || null,
        data: appData,
        files: uploadedUrls,
        status: 'Submitted'
      };

      await set(appRef, record);
      return { appId, refPath: `loanApplications/${user.uid}/${appId}`, record };
    }

    // On final submit: gather files, upload, save, generate PDF, download
    document.getElementById('btnSubmitFinal').addEventListener('click', async ()=>{
      try{
        const user = auth.currentUser;
        if(!user){
          alert('You must be logged in to submit. Please sign in.');
          return;
        }
        // minimal validation: at least 2 guarantors
        if(guarantorsList.querySelectorAll('.list-item').length < 2){
          if(!confirm('Less than 2 guarantors added. Are you sure you want to continue?')) return;
        }

        // collect data
        const data = collectFormData();

        // gather file inputs
        const idFrontFile = document.getElementById('idFront').files[0];
        const idBackFile = document.getElementById('idBack').files[0];
        const supportFile = document.getElementById('supportDoc').files[0];

        // save to RTDB & upload files
        const savingToast = document.createElement('div'); savingToast.style.cssText='position:fixed;left:20px;bottom:20px;background:#006b4f;padding:8px 12px;border-radius:8px;color:#fff'; savingToast.textContent='Submitting...'; document.body.appendChild(savingToast);
        const { appId } = await saveApplicationToRTDB(data, { idFront: idFrontFile, idBack: idBackFile, supportDoc: supportFile });
        savingToast.textContent = 'Generating PDF...';

        // generate pdf
        const pdf = await generateApplicationPdf(data);
        pdf.save(`Loan_Application_${appId}.pdf`);

        savingToast.textContent = 'Done — application submitted';
        setTimeout(()=> savingToast.remove(), 2200);
        alert('Application submitted successfully. A PDF was downloaded. You can find your application in the dashboard under loan records.');
      }catch(err){
        console.error(err);
        alert('Failed to submit application: ' + (err.message || err));
      }
    });

    // Download preview PDF
    document.getElementById('btnDownloadPreviewPdf').addEventListener('click', async ()=>{
      const data = collectFormData();
      const pdf = await generateApplicationPdf(data);
      pdf.save(`Loan_Application_Preview.pdf`);
    });

    // Download guarantor template
    document.getElementById('downloadGuarantorTemplate').addEventListener('click', async ()=>{
      const doc = await generateGuarantorTemplate();
      doc.save('Guarantor_Template.pdf');
    });

    // Clear draft
    document.getElementById('btnClearDraft').addEventListener('click', () => {
      if(!confirm('Clear all fields? This cannot be undone in this session.')) return;
      document.getElementById('loanWizardForm').reset();
      document.getElementById('guarantorsList').innerHTML = '';
      document.getElementById('parentsList').innerHTML = '';
      populateReview();
      showStep(0);
    });

    // Authentication guard: ensure logged in and populate some user info if available
    onAuthStateChanged(auth, user => {
      if(!user){
        // if not logged in redirect to index or prompt login
        alert('You must be logged in as an admin/member to use the loan application portal. Redirecting to login.');
        window.location.href = 'index.html';
      } else {
        // optionally prefill some fields if profile exists in RTDB
        get(ref(db, `members/${user.uid}/profile`)).then(s => {
          if(s.exists()){
            const p = s.val();
            if(p.name){
              const parts = p.name.split(' ');
              document.getElementById('firstName').value = parts[0] || '';
              document.getElementById('lastName').value = parts.slice(1).join(' ') || '';
            }
            document.getElementById('phone').value = p.phone || '';
            document.getElementById('idNo').value = p.id || '';
            if(p.dob) document.getElementById('dob').value = p.dob;
          }
        });
      }
    });

    // small UX niceties: clicking step toggles show step
    steps.forEach(s => s.addEventListener('click', ()=> showStep(Number(s.dataset.step))));
  </script>
</body>
</html>
