<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Visionary Youth Group — Dashboard</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root{
      --green:#005826;
      --muted:#6b7280;
      --card-bg:#fff;
      --soft:#f7faf7;
      --glass: rgba(255,255,255,0.7);
    }
    *{box-sizing:border-box}
    body{font-family:'Poppins',sans-serif;background:#f1f4f7;color:#111;margin:0;padding:0;line-height:1.45}
    header{background:linear-gradient(90deg,var(--green),#007a3a);color:#fff;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;gap:12px;position:sticky;top:0;z-index:40}
    .brand{display:flex;align-items:center;gap:12px}
    .brand h1{font-size:18px;margin:0}
    .user-summary{display:flex;align-items:center;gap:12px}
    .avatar{width:48px;height:48px;border-radius:10px;background:#fff;color:var(--green);display:flex;align-items:center;justify-content:center;font-weight:700}
    .user-details{line-height:1}
    .user-details .name{font-weight:700}
    .user-details .meta{font-size:13px;color:var(--soft)}
    .top-actions{display:flex;gap:8px;align-items:center}

    .container{max-width:1200px;margin:22px auto;padding:0 18px}
    .grid{display:grid;gap:18px}
    .grid-3{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:14px;margin-bottom:12px}
    .card{background:var(--card-bg);padding:14px;border-radius:12px;box-shadow:0 6px 20px rgba(7,13,21,.05);display:flex;gap:12px;align-items:center}
    .card .icon{width:48px;height:48px;border-radius:10px;background:linear-gradient(180deg,rgba(0,0,0,0.03),rgba(0,0,0,0.02));display:flex;align-items:center;justify-content:center;font-size:20px;color:var(--green)}
    .card .body{flex:1}
    .card .body .label{font-size:13px;color:var(--muted)}
    .card .body .value{font-weight:700;font-size:18px;margin-top:6px}

    /* Action bar / loans */
    .section{background:#fff;padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(7,13,21,.04)}
    .section h2{margin:0 0 12px 0;color:var(--green)}
    #loanActionBar .loan-row{display:flex;justify-content:space-between;gap:12px;align-items:center;padding:12px;border-radius:10px;border:1px solid #eef2f6;margin-bottom:10px}
    .badge{padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px}
    .badge.pending{background:#fff7ed;color:#b45309;border:1px solid #ffedd5}
    .badge.approved{background:#ecfdf5;color:#065f46;border:1px solid #bbf7d0}
    .badge.disbursed{background:#f0f9ff;color:#0369a1;border:1px solid #dbeafe}
    .badge.rejected{background:#fff1f2;color:#9f1239;border:1px solid #ffdef1}

    /* Profile & forms */
    form {display:grid;gap:10px}
    label{font-size:13px;color:var(--muted);font-weight:600}
    input, select, textarea{padding:10px;border-radius:8px;border:1px solid #e6e9ee;font-size:14px}
    .row{display:flex;gap:12px}
    .row .col{flex:1}
    .btn{background:var(--green);color:#fff;padding:10px 14px;border-radius:8px;border:none;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid var(--green);color:var(--green)}
    .muted-note{font-size:13px;color:var(--muted)}

    /* statement area */
    .statement{overflow:auto;padding:12px;border-radius:8px;border:1px dashed #e6eef2;background:linear-gradient(180deg,#fff,#fbfdfc)}
    .statement table{width:100%;border-collapse:collapse}
    .statement th, .statement td{padding:8px;border-bottom:1px solid #f1f5f9;text-align:left;font-size:13px}

    /* menu toggle */
    .menu-toggle{display:flex;gap:8px;align-items:center}
    .hideable{transition:all .25s ease}

    @media (max-width:820px){
      header{flex-direction:column;align-items:flex-start;gap:10px}
      .cards{grid-template-columns:repeat(auto-fit,minmax(140px,1fr))}
    }
  </style>
</head>
<body>

  <header>
    <div class="brand">
      <div style="width:46px;height:46px;border-radius:10px;background:#fff;padding:8px;display:flex;align-items:center;justify-content:center">
        <img src="https://images.unsplash.com/photo-1523475496153-3d6ccf5d1a7a?q=80&w=400&auto=format&fit=crop" alt="logo" style="width:28px;height:28px;object-fit:cover;border-radius:6px">
      </div>
      <div>
        <h1>Visionary Youth Group — Member Portal</h1>
        <div style="font-size:13px;color:rgba(255,255,255,0.9)">Nairobi · Empowering youth through savings & investments</div>
      </div>
    </div>

    <div class="user-summary">
      <div class="user-details">
        <div class="name" id="hdrName">Member</div>
        <div class="meta" id="hdrEmail">email@example.com</div>
      </div>
      <div class="avatar" id="hdrMemberNo">M#</div>
      <div class="top-actions">
        <button class="btn ghost" id="signOutBtnTop">Sign out</button>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- menu -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div style="display:flex;gap:12px;align-items:center">
        <button class="btn ghost" id="toggleMenuBtn"><i class="fa fa-bars"></i> Menu</button>
        <div class="muted-note">Status: <strong id="memberStatus">Mean Member</strong></div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn" id="downloadStatementPdfBtn"><i class="fa fa-file-pdf"></i> Download Statement (PDF)</button>
        <button class="btn ghost" id="downloadCsvBtn"><i class="fa fa-file-csv"></i> CSV</button>
      </div>
    </div>

    <!-- balances -->
    <div id="mainGrid" class="grid">
      <div class="cards">
        <div class="card">
          <div class="icon"><i class="fa fa-calendar-day"></i></div>
          <div class="body">
            <div class="label">Monthly Savings</div>
            <div class="value" id="monthlySavings">Ksh 0</div>
          </div>
        </div>

        <div class="card">
          <div class="icon"><i class="fa fa-calendar-week"></i></div>
          <div class="body">
            <div class="label">Weekly Savings</div>
            <div class="value" id="weeklySavings">Ksh 0</div>
          </div>
        </div>

        <div class="card">
          <div class="icon"><i class="fa fa-chart-line"></i></div>
          <div class="body">
            <div class="label">Shares / Dividends</div>
            <div class="value" id="sharesDividends">Ksh 0</div>
          </div>
        </div>

        <div class="card">
          <div class="icon"><i class="fa fa-hand-holding-dollar"></i></div>
          <div class="body">
            <div class="label">Outstanding Loans</div>
            <div class="value" id="outstandingLoans">Ksh 0</div>
          </div>
        </div>

        <div class="card">
          <div class="icon"><i class="fa fa-balance-scale"></i></div>
          <div class="body">
            <div class="label">Unpaid Balances</div>
            <div class="value" id="unpaidBalances">Ksh 0</div>
          </div>
        </div>

      </div>

      <!-- left column -->
      <div>
        <div class="section hideable" id="loanSection">
          <h2>Loan Action Bar</h2>
          <div id="loanActionBar">
            <p class="muted-note">No loans yet — apply using the Loan Application form below.</p>
          </div>
        </div>

        <div style="height:18px"></div>

        <div class="section hideable" id="loanWizardSection">
          <h2>Loan Application Wizard</h2>
          <div id="loanWizard">
            <!-- stepper -->
            <div id="step1">
              <h3 style="margin-top:0">Step 1 — Identification</h3>
              <form id="loanStep1Form">
                <label>Legal name</label>
                <input id="la_name" required />

                <div class="row">
                  <div class="col">
                    <label>Date of birth</label>
                    <input type="date" id="la_dob" required />
                  </div>
                  <div class="col">
                    <label>Gender</label>
                    <select id="la_gender" required>
                      <option value="">Select</option>
                      <option>Male</option>
                      <option>Female</option>
                      <option>Other</option>
                    </select>
                  </div>
                </div>

                <label>Nationality</label>
                <input id="la_nationality" required />
                <label>Government ID (ID/Passport No)</label>
                <input id="la_govid" required />
                <div style="display:flex;gap:8px;margin-top:8px">
                  <button type="button" class="btn" id="toStep2">Next — Contact</button>
                </div>
              </form>
            </div>

            <div id="step2" style="display:none">
              <h3>Step 2 — Contact & Personal</h3>
              <form id="loanStep2Form">
                <label>Current address</label>
                <input id="la_curr_address" required />
                <label>Permanent address</label>
                <input id="la_perm_address" required />
                <div class="row">
                  <div class="col">
                    <label>Email</label>
                    <input id="la_email" type="email" required />
                  </div>
                  <div class="col">
                    <label>Phone</label>
                    <input id="la_phone" required />
                  </div>
                </div>
                <div class="row">
                  <div class="col">
                    <label>Marital status</label>
                    <select id="la_marital" required><option>Single</option><option>Married</option><option>Other</option></select>
                  </div>
                  <div class="col">
                    <label>Dependents</label>
                    <input id="la_dependents" type="number" min="0" value="0" required />
                  </div>
                </div>
                <div style="display:flex;gap:8px;margin-top:8px">
                  <button type="button" class="btn ghost" id="backToStep1">Back</button>
                  <button type="button" class="btn" id="toStep3">Next — Employment</button>
                </div>
              </form>
            </div>

            <div id="step3" style="display:none">
              <h3>Step 3 — Employment & Income</h3>
              <form id="loanStep3Form">
                <label>Employment status</label>
                <select id="la_emp_status" required>
                  <option value="">Select</option>
                  <option>Permanently Employed</option>
                  <option>On Contract</option>
                  <option>Self-Employed</option>
                  <option>Student</option>
                  <option>Unemployed</option>
                </select>

                <label>Employer / Business name</label>
                <input id="la_employer" />

                <div class="row">
                  <div class="col"><label>Designation / Role</label><input id="la_job_title" /></div>
                  <div class="col"><label>Length of service (yrs)</label><input id="la_service_len" type="number" min="0" /></div>
                </div>

                <div class="row">
                  <div class="col"><label>Gross monthly income</label><input id="la_income_gross" type="number" min="0" /></div>
                  <div class="col"><label>Net monthly income</label><input id="la_income_net" type="number" min="0" /></div>
                </div>

                <label>Upload income docs (link or description)</label>
                <input id="la_income_docs" placeholder="e.g. payslip-aug-2025.pdf (URL or notes)" />

                <div style="display:flex;gap:8px;margin-top:8px">
                  <button type="button" class="btn ghost" id="backToStep2">Back</button>
                  <button type="button" class="btn" id="toStep4">Next — Financials</button>
                </div>
              </form>
            </div>

            <div id="step4" style="display:none">
              <h3>Step 4 — Financials & Security</h3>
              <form id="loanStep4Form">
                <label>Loan amount requested (Ksh)</label>
                <input id="la_amount" type="number" min="0" required />

                <label>Purpose</label>
                <input id="la_purpose" required />

                <label>Repayment period (months)</label>
                <input id="la_period" type="number" min="1" value="12" required />

                <label>Existing credit facilities (describe)</label>
                <textarea id="la_existing_credit" rows="3"></textarea>

                <label>Assets & liabilities (summary)</label>
                <textarea id="la_assets" rows="3"></textarea>

                <label>Security / Collateral (if any)</label>
                <input id="la_collateral" />

                <label>Guarantor (name & contact)</label>
                <input id="la_guarantor" />

                <div style="display:flex;gap:8px;margin-top:8px">
                  <button type="button" class="btn ghost" id="backToStep3">Back</button>
                  <button type="button" class="btn" id="toReview">Review & Submit</button>
                </div>
              </form>
            </div>

            <div id="review" style="display:none">
              <h3>Review & Submit</h3>
              <div id="reviewBox" class="statement" style="margin-bottom:12px">Loading review...</div>
              <div style="display:flex;gap:8px">
                <button class="btn ghost" id="backToStep4">Back</button>
                <button class="btn" id="submitLoanBtn">Submit Loan Application</button>
                <button class="btn ghost" id="downloadLoanPdfBtn">Download Application (PDF)</button>
              </div>
            </div>

          </div>
        </div>

      </div>

      <!-- right column -->
      <div>
        <div class="section" id="profileSection">
          <h2>Profile</h2>
          <form id="profileForm">
            <div class="row">
              <div class="col">
                <label>Full name</label>
                <input id="profile_name" required />
              </div>
              <div class="col">
                <label>Date of birth</label>
                <input type="date" id="profile_dob" />
              </div>
            </div>

            <div class="row">
              <div class="col"><label>ID / Passport</label><input id="profile_id" /></div>
              <div class="col"><label>Member number</label><input id="profile_memberNo" /></div>
            </div>

            <div class="row">
              <div class="col"><label>Email</label><input id="profile_email" type="email" required /></div>
              <div class="col"><label>Phone</label><input id="profile_phone" /></div>
            </div>

            <label>Origin</label><input id="profile_origin" />
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="btn" id="saveProfileBtn">Update Profile</button>
              <button class="btn ghost" id="resetProfileBtn" type="button">Reset</button>
            </div>
            <div style="margin-top:8px" class="muted-note">Profile updates save to your account and will show at the top.</div>
          </form>
        </div>

        <div style="height:14px"></div>

        <div class="section hideable" id="statementSection">
          <h2>Account Statement</h2>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div class="muted-note">Group: Visionary Youth Group — Nairobi</div>
            <div class="muted-note">Watermark + footer included in PDF</div>
          </div>
          <div class="statement" id="onScreenStatement">
            <div style="text-align:center;padding:12px">No transactions yet</div>
          </div>

          <div style="display:flex;gap:8px;margin-top:12px">
            <button class="btn" id="downloadStatementBtn">Download CSV</button>
            <button class="btn ghost" id="awardPointsBtn">Claim Interaction Points</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script type="module">
    // Firebase v9 modular imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getDatabase, ref, onValue, set, push, update, get
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    // ----------------- CONFIG (your provided config) -----------------
    const firebaseConfig = {
      apiKey: "AIzaSyA_OCu7HQ5HCH2OYx5dQ2Z1r7YPwQJave4",
      authDomain: "visionary-youth-grou-2024.firebaseapp.com",
      projectId: "visionary-youth-grou-2024",
      storageBucket: "visionary-youth-grou-2024.appspot.com",
      messagingSenderId: "372978592717",
      appId: "1:372978592717:web:1c15aec728ee5f854f3284",
      measurementId: "G-QP1RBT2ZCP"
      // If you have databaseURL, add it here: databaseURL: "https://<your-db>.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // UI refs
    const hdrName = document.getElementById('hdrName');
    const hdrEmail = document.getElementById('hdrEmail');
    const hdrMemberNo = document.getElementById('hdrMemberNo');
    const memberStatusEl = document.getElementById('memberStatus');

    const monthlyEl = document.getElementById('monthlySavings');
    const weeklyEl = document.getElementById('weeklySavings');
    const sharesEl = document.getElementById('sharesDividends');
    const outstandingEl = document.getElementById('outstandingLoans');
    const unpaidEl = document.getElementById('unpaidBalances');

    const loanActionBar = document.getElementById('loanActionBar');

    // profile form fields
    const profile_name = document.getElementById('profile_name');
    const profile_dob = document.getElementById('profile_dob');
    const profile_id = document.getElementById('profile_id');
    const profile_memberNo = document.getElementById('profile_memberNo');
    const profile_email = document.getElementById('profile_email');
    const profile_phone = document.getElementById('profile_phone');
    const profile_origin = document.getElementById('profile_origin');

    // Statement / CSV buttons
    const downloadCsvBtn = document.getElementById('downloadCsvBtn');
    const downloadStatementBtn = document.getElementById('downloadStatementBtn');
    const downloadStatementPdfBtn = document.getElementById('downloadStatementPdfBtn');

    // Award points
    const awardPointsBtn = document.getElementById('awardPointsBtn');

    // session auto-logout (3 minutes)
    const AUTO_LOGOUT_MS = 3 * 60 * 1000; // 3 minutes
    let inactivityTimer = null;
    function resetInactivityTimer() {
      if (inactivityTimer) clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(() => {
        // sign out and redirect to portal
        signOut(auth).catch(()=>{}).finally(()=> {
          alert("Session expired due to inactivity. You'll be redirected to the portal.");
          window.location.href = "portal.html";
        });
      }, AUTO_LOGOUT_MS);
    }
    // reset on activity
    ['mousemove','mousedown','keypress','touchstart','click'].forEach(evt => {
      window.addEventListener(evt, resetInactivityTimer, {passive:true});
    });

    // small helper
    const toK = n => "Ksh " + (Number(n || 0)).toLocaleString();

    // Keep track of current user data
    let CURRENT_UID = null;
    let CURRENT_USER = null;

    // -------------------------- AUTH LISTENER --------------------------
    onAuthStateChanged(auth, async (user) => {
      resetInactivityTimer();
      if (!user) {
        // not logged in
        window.location.href = "portal.html";
        return;
      }
      CURRENT_UID = user.uid;
      CURRENT_USER = user;
      // load member profile from RTDB
      const memberRef = ref(db, `members/${user.uid}`);
      onValue(memberRef, (snap) => {
        const data = snap.val() || {};
        hdrName.textContent = data.fullName || data.name || user.displayName || "Member";
        hdrEmail.textContent = data.email || user.email || "";
        hdrMemberNo.textContent = data.memberNo ? ("#" + data.memberNo) : (data.memberNumber || "M#");
        memberStatusEl.textContent = data.status || data.memberType || "Mean Member";
        // populate profile form
        profile_name.value = data.fullName || data.name || "";
        profile_dob.value = data.dob || "";
        profile_id.value = data.idNo || data.id || "";
        profile_memberNo.value = data.memberNo || data.memberNumber || "";
        profile_email.value = data.email || user.email || "";
        profile_phone.value = data.phone || "";
        profile_origin.value = data.origin || "";
      });

      // balances listener
      const balancesRef = ref(db, `balances/${user.uid}`);
      onValue(balancesRef, (snap) => {
        const b = snap.val() || {};
        monthlyEl.textContent = toK(b.monthly || 0);
        weeklyEl.textContent = toK(b.weekly || 0);
        sharesEl.textContent = toK(b.shares || 0);
        outstandingEl.textContent = toK(b.outstanding || 0);
        unpaidEl.textContent = toK(b.unpaid || 0);
      });

      // loans listener (action bar)
      const loansRef = ref(db, `loans/${user.uid}`);
      onValue(loansRef, (snap) => {
        loanActionBar.innerHTML = "";
        const loans = snap.val();
        if (!loans) {
          loanActionBar.innerHTML = `<p class="muted-note">No loan records yet.</p>`;
          return;
        }
        // Create array sorted newest first by key (timestamp)
        const rows = Object.entries(loans).sort((a,b)=> b[0]-a[0]);
        rows.forEach(([loanId, loan]) => {
          const loanDate = loan.loanDate || new Date().toLocaleDateString();
          const amount = Number(loan.amount || 0);
          const status = (loan.status || "Pending").toLowerCase();
          const installment = loan.installment || loan.installmentAmount || 0;
          const rem = loan.remaining || 0;

          const div = document.createElement('div');
          div.className = 'loan-row';
          div.innerHTML = `
            <div style="min-width:0">
              <div style="font-weight:700">Ksh ${amount.toLocaleString()}</div>
              <div style="font-size:13px;color:${'#6b7280'}">Date: ${loanDate} · Installment: Ksh ${installment.toLocaleString()}</div>
              <div style="font-size:13px;color:#6b7280">Ref: ${loanId}</div>
            </div>
            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
              <div class="badge ${status==='approved'?'approved':status==='disbursed'?'disbursed':status==='rejected'?'rejected':'pending'}">${(loan.status||'Pending')}</div>
              <div style="font-size:13px;color:#374151">Remaining: ${toK(rem)}</div>
            </div>
          `;
          loanActionBar.appendChild(div);
        });
      });

      // statement (transactions)
      const txRef = ref(db, `transactions/${user.uid}`);
      onValue(txRef, (snap) => {
        const tx = snap.val() || {};
        renderStatement(tx);
      });

      // points
      const pointsRef = ref(db, `points/${user.uid}`);
      onValue(pointsRef, (snap) => {
        // optionally show points in UI later
      });

    });

    // -------------------------- PROFILE SAVE --------------------------
    document.getElementById('saveProfileBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      if (!CURRENT_UID) { alert("Not signed in"); return; }
      const payload = {
        fullName: profile_name.value.trim(),
        dob: profile_dob.value || "",
        idNo: profile_id.value.trim(),
        memberNo: profile_memberNo.value.trim(),
        email: profile_email.value.trim(),
        phone: profile_phone.value.trim(),
        origin: profile_origin.value.trim(),
        status: "Mean Member", // you requested mean default
        updatedAt: new Date().toISOString()
      };
      try {
        await set(ref(db, `members/${CURRENT_UID}`), payload);
        // also update auth email if changed
        // NOTE: updating auth.email requires recent sign-in and auth updateEmail method (omitted here for brevity)
        alert("Profile updated.");
        incrementPoints(5);
      } catch (err) {
        console.error(err);
        alert("Failed to update profile: " + err.message);
      }
    });

    // reset profile fields to last known state
    document.getElementById('resetProfileBtn').addEventListener('click', async () => {
      if (!CURRENT_UID) return;
      const snap = await get(ref(db, `members/${CURRENT_UID}`));
      const data = snap.val() || {};
      profile_name.value = data.fullName || "";
      profile_dob.value = data.dob || "";
      profile_id.value = data.idNo || "";
      profile_memberNo.value = data.memberNo || "";
      profile_email.value = data.email || "";
      profile_phone.value = data.phone || "";
      profile_origin.value = data.origin || "";
      alert("Reset to saved profile.");
    });

    // -------------------------- LOAN WIZARD NAV --------------------------
    const show = (id) => {
      ['step1','step2','step3','step4','review'].forEach(s => {
        document.getElementById(s).style.display = (s===id) ? 'block' : 'none';
      });
    };

    document.getElementById('toStep2').addEventListener('click', ()=> {
      // validate step1 simple
      if(!document.getElementById('la_name').value.trim()) return alert("Enter legal name");
      show('step2');
    });
    document.getElementById('backToStep1').addEventListener('click', ()=> show('step1'));
    document.getElementById('toStep3').addEventListener('click', ()=> {
      if(!document.getElementById('la_curr_address').value.trim()) return alert("Enter address");
      show('step3');
    });
    document.getElementById('backToStep2').addEventListener('click', ()=> show('step2'));
    document.getElementById('toStep4').addEventListener('click', ()=> {
      if(!document.getElementById('la_emp_status').value) return alert("Select employment status");
      show('step4');
    });
    document.getElementById('backToStep3').addEventListener('click', ()=> show('step3'));
    document.getElementById('toReview').addEventListener('click', ()=> {
      // create review summary
      const review = {
        name: document.getElementById('la_name').value,
        dob: document.getElementById('la_dob').value,
        gender: document.getElementById('la_gender').value,
        nationality: document.getElementById('la_nationality').value,
        govid: document.getElementById('la_govid').value,
        email: document.getElementById('la_email').value,
        phone: document.getElementById('la_phone').value,
        emp_status: document.getElementById('la_emp_status').value,
        employer: document.getElementById('la_employer').value,
        gross: document.getElementById('la_income_gross').value,
        net: document.getElementById('la_income_net').value,
        amount: document.getElementById('la_amount').value,
        purpose: document.getElementById('la_purpose').value,
        period: document.getElementById('la_period').value
      };
      // basic affordability check using monthly saving: loan limit logic
      get(ref(db, `balances/${CURRENT_UID}`)).then(snap => {
        const b = snap.exists()? snap.val() : {};
        const monthly = Number(b.monthly || 0);
        // loan limit rules: if monthly >=2000 limit 1000; if >=1000 limit 500; otherwise 0
        let computedLimit = 0;
        if (monthly >= 2000) computedLimit = 1000;
        else if (monthly >= 1000) computedLimit = 500;
        else computedLimit = 0;
        // also compute max allowed proportion (simple) e.g. net*3
        const maxByIncome = Number(review.net || 0) * 3;
        const allowed = Math.min(computedLimit, maxByIncome || computedLimit);

        const html = `
          <div style="display:grid;gap:8px">
            <div><strong>Name:</strong> ${review.name}</div>
            <div><strong>ID:</strong> ${review.govid} · <strong>DOB:</strong> ${review.dob}</div>
            <div><strong>Employment:</strong> ${review.emp_status} · ${review.employer}</div>
            <div><strong>Gross/Net:</strong> ${review.gross}/${review.net}</div>
            <div><strong>Requested:</strong> Ksh ${Number(review.amount || 0).toLocaleString()} · <strong>Period:</strong> ${review.period} months</div>
            <div><strong>Computed Loan Limit (based on monthly saving & income):</strong> Ksh ${allowed.toLocaleString()}</div>
            <div style="font-size:13px;color:#6b7280">If requested amount exceeds your allowed limit, application will be blocked client-side.</div>
          </div>
        `;
        document.getElementById('reviewBox').innerHTML = html;
        show('review');
      });
    });

    // generate loan application PDF (nice)
    document.getElementById('downloadLoanPdfBtn').addEventListener('click', async () => {
      const data = collectLoanForm();
      generateLoanPdf(data);
    });

    // submit loan
    document.getElementById('submitLoanBtn').addEventListener('click', async () => {
      if (!CURRENT_UID) return alert("Login required.");
      const data = collectLoanForm();
      // compute allowed limit again
      const bSnap = await get(ref(db, `balances/${CURRENT_UID}`));
      const b = bSnap.exists() ? bSnap.val() : {};
      const monthly = Number(b.monthly || 0);
      let computedLimit = 0;
      if (monthly >= 2000) computedLimit = 1000;
      else if (monthly >= 1000) computedLimit = 500;
      else computedLimit = 0;
      const maxByIncome = Number(data.net || 0) * 3 || computedLimit;
      const allowed = Math.min(computedLimit, maxByIncome);

      if (Number(data.amount) > allowed) {
        return alert("Requested amount exceeds your allowed loan limit of Ksh " + allowed.toLocaleString());
      }

      try {
        // push loan
        const loanRef = ref(db, `loans/${CURRENT_UID}/${Date.now()}`);
        const payload = {
          loanDate: new Date().toISOString(),
          ...data,
          status: "Pending",
          installmentAmount: Math.round((Number(data.amount)/Math.max(1,Number(data.period))) || 0),
          remaining: Number(data.amount),
          createdAt: new Date().toISOString()
        };
        await set(loanRef, payload);
        alert("Loan submitted — status: Pending. You will see updates in the action bar.");
        incrementPoints(20);
        show('step1'); // reset wizard
      } catch (err) {
        console.error(err);
        alert("Loan submission failed: " + err.message);
      }
    });

    function collectLoanForm(){
      return {
        name: document.getElementById('la_name').value.trim(),
        dob: document.getElementById('la_dob').value,
        gender: document.getElementById('la_gender').value,
        nationality: document.getElementById('la_nationality').value,
        govid: document.getElementById('la_govid').value,
        curr_address: document.getElementById('la_curr_address').value,
        perm_address: document.getElementById('la_perm_address').value,
        email: document.getElementById('la_email').value,
        phone: document.getElementById('la_phone').value,
        marital: document.getElementById('la_marital').value,
        dependents: document.getElementById('la_dependents').value,
        emp_status: document.getElementById('la_emp_status').value,
        employer: document.getElementById('la_employer').value,
        job_title: document.getElementById('la_job_title').value,
        service_len: document.getElementById('la_service_len').value,
        gross: document.getElementById('la_income_gross').value,
        net: document.getElementById('la_income_net').value,
        income_docs: document.getElementById('la_income_docs').value,
        amount: document.getElementById('la_amount').value,
        purpose: document.getElementById('la_purpose').value,
        period: document.getElementById('la_period').value,
        existing_credit: document.getElementById('la_existing_credit').value,
        assets: document.getElementById('la_assets').value,
        collateral: document.getElementById('la_collateral').value,
        guarantor: document.getElementById('la_guarantor').value
      };
    }

    // ---------------- PDF generation (loan & statement) ----------------
    async function generateLoanPdf(data){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:'pt', format:'a4'});
      const left = 40;
      let y = 60;

      // header
      doc.setFontSize(16);
      doc.setTextColor(0,80,38);
      doc.text("Visionary Youth Group — Loan Application", left, y);
      doc.setFontSize(10);
      doc.setTextColor(120);
      doc.text("Nairobi", left, y+16);

      // watermark
      doc.setTextColor(200,200,200);
      doc.setFontSize(48);
      doc.text("VISIONARY", 220, 420, {angle: -30, opacity: 0.08});

      y += 40;
      doc.setTextColor(0);
      doc.setFontSize(11);

      const lines = [
        `Full name: ${data.name}`,
        `ID / Passport: ${data.govid}`,
        `DOB: ${data.dob} · Gender: ${data.gender}`,
        `Nationality: ${data.nationality}`,
        `Email: ${data.email} · Phone: ${data.phone}`,
        `Employment: ${data.emp_status} · Employer: ${data.employer}`,
        `Gross/Net income: ${data.gross} / ${data.net}`,
        `Requested amount: Ksh ${Number(data.amount).toLocaleString()} · Period: ${data.period} months`,
        `Purpose: ${data.purpose}`,
        `Collateral: ${data.collateral || '—'}`,
        `Guarantor: ${data.guarantor || '—'}`,
      ];

      lines.forEach(line => {
        doc.text(line, left, y += 18);
      });

      // footer
      doc.setFontSize(9);
      doc.setTextColor(120);
      doc.text("Visionary Youth Group — Nairobi · Generated: " + new Date().toLocaleString(), left, 760);
      doc.save(`loan-application-${Date.now()}.pdf`);
    }

    // pdf for statement
    async function generateStatementPdf(transactions = []){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:'pt', format:'a4'});
      const left = 40;
      let y = 60;

      // header
      doc.setFontSize(16);
      doc.setTextColor(0,80,38);
      doc.text("Visionary Youth Group — Account Statement", left, y);
      doc.setFontSize(10);
      doc.setTextColor(120);
      doc.text("Group: Visionary Youth Group · Nairobi", left, y+14);

      // watermark
      doc.setTextColor(200);
      doc.setFontSize(48);
      doc.text("VISIONARY", 160, 420, {angle: -30, opacity: 0.06});

      y += 40;
      // table header
      doc.setFontSize(11);
      doc.setTextColor(0);
      doc.text("Date", left, y);
      doc.text("Description", left + 120, y);
      doc.text("Debit", left + 340, y);
      doc.text("Credit", left + 430, y);
      doc.text("Balance", left + 510, y);
      y += 8;

      doc.setDrawColor(230);
      doc.line(left, y+2, 560, y+2);
      y += 18;

      const perPage = 25;
      let count = 0;
      for (const t of transactions) {
        doc.setFontSize(10);
        doc.setTextColor(40);
        doc.text(t.date || '-', left, y);
        doc.text(t.desc || '-', left+120, y);
        doc.text((t.debit? t.debit.toString() : '-') , left+340, y);
        doc.text((t.credit? t.credit.toString() : '-') , left+430, y);
        doc.text((t.balance? t.balance.toString() : '-') , left+510, y);
        y += 16;
        count++;
        if (count % perPage === 0) {
          doc.addPage();
          y = 60;
        }
      }

      // footer
      doc.setFontSize(9);
      doc.setTextColor(120);
      doc.text("This statement is computer generated and valid without signature.", left, 760);
      doc.save(`statement-${Date.now()}.pdf`);
    }

    // ---------------- STATEMENT RENDER + CSV ----------------
    function renderStatement(txObj){
      const onScreen = document.getElementById('onScreenStatement');
      const arr = [];
      if (!txObj || Object.keys(txObj).length === 0) {
        onScreen.innerHTML = `<div style="text-align:center;padding:12px">No transactions yet</div>`;
        return;
      }
      // convert and sort by date (if stored as timestamps keys)
      Object.entries(txObj).sort((a,b)=> a[0]-b[0]).forEach(([k,v]) => {
        arr.push({
          date: v.date || (v.createdAt ? new Date(v.createdAt).toLocaleDateString() : ''),
          desc: v.description || v.description || v.desc || 'Transaction',
          debit: v.debit || 0,
          credit: v.credit || 0,
          balance: v.balance || ''
        });
      });

      // build HTML table
      let html = `<table><thead><tr><th>Date</th><th>Description</th><th>Debit</th><th>Credit</th><th>Balance</th></tr></thead><tbody>`;
      arr.forEach(r => {
        html += `<tr><td>${r.date}</td><td>${r.desc}</td><td>${r.debit || "-"}</td><td>${r.credit || "-"}</td><td>${r.balance || "-"}</td></tr>`;
      });
      html += `</tbody></table>`;
      onScreen.innerHTML = html;

      // store for downloads
      onScreen.dataset.csv = JSON.stringify(arr);
    }

    downloadCsvBtn.addEventListener('click', () => {
      const csvData = JSON.parse(document.getElementById('onScreenStatement').dataset.csv || "[]");
      if (!csvData.length) return alert("No transactions to download.");
      const rows = [["Date","Description","Debit","Credit","Balance"], ...csvData.map(r=>[r.date,r.desc,r.debit,r.credit,r.balance])];
      const csv = rows.map(r=> r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(",")).join("\n");
      const url = URL.createObjectURL(new Blob([csv], {type:"text/csv"}));
      const a = document.createElement('a'); a.href = url; a.download = `statement-${Date.now()}.csv`; a.click();
      URL.revokeObjectURL(url);
    });

    downloadStatementBtn.addEventListener('click', async () => {
      const snap = await get(ref(db, `transactions/${CURRENT_UID}`));
      const tx = snap.exists() ? Object.values(snap.val()) : [];
      generateStatementPdf(tx);
      incrementPoints(2);
    });

    downloadStatementPdfBtn.addEventListener('click', async () => {
      const snap = await get(ref(db, `transactions/${CURRENT_UID}`));
      const tx = snap.exists() ? Object.values(snap.val()) : [];
      generateStatementPdf(tx);
    });

    // ---------------- POINTS ----------------
    async function incrementPoints(n=1){
      if (!CURRENT_UID) return;
      const pRef = ref(db, `points/${CURRENT_UID}`);
      const snap = await get(pRef);
      let cur = snap.exists() ? (snap.val().points||0) : 0;
      await set(pRef, { points: cur + n, updatedAt: new Date().toISOString() });
    }
    awardPointsBtn.addEventListener('click', ()=> {
      incrementPoints(3);
      alert("Awarded 3 points for interacting!");
    });

    // ---------------- MENU toggle ----------------
    const toggleBtn = document.getElementById('toggleMenuBtn');
    let hidden = false;
    toggleBtn.addEventListener('click', () => {
      hidden = !hidden;
      document.querySelectorAll('.hideable').forEach(el => {
        el.style.display = hidden ? 'none' : 'block';
      });
      toggleBtn.textContent = hidden ? 'Show' : 'Hide';
    });

    // ---------------- SIGN OUT ----------------
    document.getElementById('signOutBtnTop').addEventListener('click', async () => {
      await signOut(auth);
      window.location.href = "portal.html";
    });

    // ---------------- simple helper to update loan statuses externally --------------
    // Admins should update /loans/<uid>/<loanId>/status to "Approved","Disbursed","Rejected"
    // This client shows changes in real time.

    // ---------------- initial view state ---------------
    show('step1');

    // ----------------- auto reset inactivity once on load -------------
    resetInactivityTimer();

    // Done.
  </script>
</body>
</html>
